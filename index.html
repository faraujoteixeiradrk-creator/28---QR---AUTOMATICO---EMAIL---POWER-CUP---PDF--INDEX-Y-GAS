<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador Multitarifa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos QRCode.js y jsQR.min.js para el manejo de QR -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- LibrerÃ­as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- TAILWIND CONFIGURATION ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8', /* Lighter Blue for Active Hover */
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1', /* AÃ‘ADIDO */
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            400: '#a3e635', /* Lighter Green for Active Hover */
                            500: '#84cc16',
                            600: '#65a30d',
                            700: '#4d7c0f', /* AÃ‘ADIDO */
                            800: '#3f6212',
                            900: '#365314',
                            'yellow-flash': '#facc15',
                        },
                        // Nuevos colores para asegurar el verde en el flujo de resultados y CTA
                        'cta-green': {
                            500: '#16a34a', /* Usado para los ahorros */
                            600: '#15803d',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* === SISTEMA PANTALLAS === */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Estilos base y animaciones */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { border: 2px solid; }

        /* Estilos de los botones de selecciÃ³n de tarifa (Landing Page) */
        .tariff-select-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        
        /* DRK Active Hover Styles (Default) */
        .drk-active .tariff-select-btn:hover {
            border-color: #0ea5e9; /* drk-500 */
            background-color: #f0f9ff; /* drk-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .drk-active .tariff-select-btn:hover .arrow-icon {
            color: #0ea5e9; /* drk-500 */
        }

        /* POWER CUP Active Hover Styles */
        .powercup-active .tariff-select-btn:hover {
            border-color: #84cc16; /* powercup-500 */
            background-color: #f7fee7; /* powercup-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .powercup-active .tariff-select-btn:hover .arrow-icon {
            color: #84cc16; /* powercup-500 */
        }

        .icon-wrapper {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .arrow-icon {
            margin-left: auto;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            transition: color 0.3s ease;
        }

        /* Estilos QR */
        #qr-content-wrapper { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        #qr-content-wrapper.active { max-height: 500px; opacity: 1; }
        #qr-visual-container { 
            position: relative; 
            display: inline-block; 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        /* Texto central del QR */
        #qr-visual-container::before { 
            content: var(--qr-center-text, "DRK"); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; /* TamaÃ±o reducido para no cubrir tanto */
            font-weight: bold; 
            color: #ffffff; 
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 4px 8px; /* Padding reducido */
            border-radius: 6px; 
            z-index: 10; 
            opacity: 0.95; 
            min-width: 60px;
            text-align: center;
        }
        
        /* Ocultar elementos dependiendo del tipo de tarifa */
        .hidden-period { display: none; }
        
        /* Estilos para el campo de pegado temporal (FIX para Ctrl+V) */
        #paste-catcher {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* Oculto por defecto */
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.15s ease-in-out;
            resize: none;
        }

        #paste-catcher.pasting-active {
            width: 200px; 
            height: 100px; 
            opacity: 0.01; /* Debe ser casi transparente, pero no 0 */
            z-index: 1000; /* Siempre visible cuando activo */
            border: 4px dashed var(--qr-border-color, #0ea5e9);
            background-color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 drk-active">

    <!-- Navbar -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight cursor-pointer" onclick="resetToLanding()">
                <span id="app-logo-main">DRK</span> <span class="text-drk-500" id="app-logo-accent">EnergÃ­a</span>
            </h1>
            <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100" id="app-subtitle">Selector</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">

        <!-- MODO DE COMPARACIÃ“N (Siempre visible al inicio) -->
        <div id="modo-comparacion-section" class="fade-in mb-6">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                <p class="text-sm font-bold text-drk-800 mb-3 text-center uppercase tracking-wider">MODO DE COMPARACIÃ“N</p>
                <div class="flex flex-wrap justify-center gap-2 text-sm">
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-300 text-drk-700 bg-white hover:bg-drk-100 hover:border-drk-400">
                        <input type="radio" name="comparison_mode" value="drk_only" class="hidden">
                        <span class="font-semibold flex items-center justify-between w-full">DRK Ãšnicamente<svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                    </label>
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600">
                        <input type="radio" name="comparison_mode" value="drk_prioritized" class="hidden" checked>
                        <span class="font-semibold flex items-center justify-between w-full">DRK Prioritario<svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                    </label>
                    <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-powercup-300 text-powercup-700 bg-white hover:bg-powercup-100 hover:border-powercup-400">
                        <input type="radio" name="comparison_mode" value="overall_best" class="hidden">
                        <span class="font-black flex flex-col items-center justify-center w-full leading-tight">
                            <span class="text-base">POWER CUP</span><span class="text-xs font-semibold -mt-0.5">Global</span>
                        </span>
                        <svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </label>
                </div>
            </div>
        </div>

        <!-- PANTALLA INICIAL: Solo selector de servicio -->
        <div id="screen-inicio" class="screen active">
            <div class="fade-in flex flex-col items-center justify-center min-h-[40vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500">
                    <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                        <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                            <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                            <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                            <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                            <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                            <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                    <p class="text-slate-500 mb-6 text-center">Selecciona el tipo de suministro.</p>
                    
                    <!-- SELECTOR DE SERVICIO -->
                    <div class="pt-4 border-t border-slate-200">
                        <p class="text-sm font-bold text-drk-800 mb-4 text-center uppercase tracking-wider">TIPO DE SUMINISTRO</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="goToElectricidad()" style="padding: 2rem; border-radius: 1.5rem; border: 4px solid #cbd5e1; background: white; text-align: center; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">âš¡</div>
                                <div style="font-size: 1.25rem; font-weight: 900; color: #1e3a8a;">ELECTRICIDAD</div>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">MULTICUPS Â· 2.0 TD Â· 3.0 TD</div>
                            </button>
                            
                            <button onclick="goToGas()" style="padding: 2rem; border-radius: 1.5rem; border: 4px solid #cbd5e1; background: white; text-align: center; cursor: pointer;">
                                <div style="font-size: 3rem; margin-bottom: 0.75rem;">ðŸ”¥</div>
                                <div style="font-size: 1.25rem; font-weight: 900; color: #dc2626;">GAS</div>
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">RL1 Â· RL2 Â· RL3 Â· RL4 Â· RL5 Â· RL6</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: ELECTRICIDAD (landing-view original) -->
        <div id="screen-electricidad" class="screen">
            <button onclick="goToInicio()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                Volver
            </button>
        <!-- 1. Landing View -->
        <div id="landing-view" class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="landing-card">
                <div id="landing-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                <h2 id="landing-title" class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                <p class="text-slate-500 mb-6 text-center">Selecciona la tarifa que deseas analizar.</p>
                
                <!-- Comparison Mode Selector (OCULTO - ahora estÃ¡ fuera) -->
                <div id="mode-selector-container" style="display: none;" class="mb-8 pt-4 border-t border-slate-200">
                    <p class="text-sm font-bold text-drk-800 mb-3 text-center uppercase tracking-wider">MODO DE COMPARACIÃ“N</p>
                    <div id="comparison-mode-selectors" class="flex flex-wrap justify-center gap-2 text-sm">
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-300 text-drk-700 bg-white hover:bg-drk-100 hover:border-drk-400">
                            <input type="radio" name="comparison_mode" value="drk_only" class="hidden">
                            <span class="font-semibold flex items-center justify-between w-full">DRK Ãšnicamente<svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                        </label>
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600">
                            <input type="radio" name="comparison_mode" value="drk_prioritized" class="hidden" checked>
                            <span class="font-semibold flex items-center justify-between w-full">DRK Prioritario<svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                        </label>
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-powercup-300 text-powercup-700 bg-white hover:bg-powercup-100 hover:border-powercup-400">
                            <input type="radio" name="comparison_mode" value="overall_best" class="hidden">
                            <span class="font-black flex flex-col items-center justify-center w-full leading-tight">
                                <span class="text-base">POWER CUP</span><span class="text-xs font-semibold -mt-0.5">Global</span>
                            </span>
                            <svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </label>
                    </div>
                </div>
                
                
                <!-- Tariff Selection Buttons -->
                <div class="w-full space-y-4">
                    <button onclick="selectTariffType('MULTICUPS')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">MULTICUPS</span>
                            <span class="block text-xs text-slate-500">Gestor de mÃºltiples contratos (2.0TD + 3.0TD)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('2.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Hogar / PequeÃ±o Negocio (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('3.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Industria / Gran Consumo (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <!-- QR Link Section -->
                <div id="pwa-install-section" class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <label class="flex items-center justify-center cursor-pointer mb-3 text-drk-800 hover:text-drk-900 transition">
                        <input type="checkbox" id="qr-toggle-checkbox" class="h-4 w-4 text-drk-500 border-gray-300 rounded focus:ring-drk-500 mr-2">
                        <span class="text-xs font-bold uppercase tracking-wider underline decoration-drk-500 decoration-2 underline-offset-4">Abrir en el Movil</span>
                    </label>
                    <div id="qr-content-wrapper" class="opacity-0 max-h-0">
                        <div id="qr-visual-container" class="mx-auto w-44 h-44 p-2">
                            <div id="qr-code-container"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-3">Haz una foto del QR y Ã¡brelo en tu mÃ³vil.</p>
                    </div>
                </div>

            </div>
        </div>
        </div> <!-- Cierre screen-electricidad -->
        
        <!-- PANTALLA 3: GAS -->
        <div id="screen-gas" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    <button onclick="goToInicio()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Volver
                    </button>
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">ðŸ”¥</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">GAS</h2>
                    <p class="text-slate-500 mb-6 text-center">Selecciona la regulaciÃ³n de gas.</p>
                    
                    <div class="w-full space-y-4">
                        <button onclick="selectGasTariff('RL1')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL1</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 1</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL2')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL2</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 2</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL3')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL3</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 3</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL4')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL4</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 4</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL5')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL5</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 5</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>

                        <button onclick="selectGasTariff('RL6')" class="tariff-select-btn group">
                            <div class="icon-wrapper bg-red-50 text-red-600 group-hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                            </div>
                            <div class="text-left">
                                <span class="text-lg font-bold text-drk-900">RL6</span>
                                <span class="block text-xs text-slate-500">RegulaciÃ³n de Gas - Nivel 6</span>
                            </div>
                            <span class="arrow-icon group-hover:text-red-500">&rarr;</span>
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- Cierre screen-gas -->
        
        <!-- MODAL: Entrada manual de datos GAS -->
        <div id="gas-manual-input-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md border-t-4 border-red-500 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h3 class="text-2xl font-black text-red-600 mb-2 text-center">Datos de la Factura de GAS</h3>
                    <p class="text-sm text-slate-500 mb-4 text-center">Tarifa: <span id="gas-selected-tariff" class="font-bold text-red-600"></span></p>
                    
                    <div class="space-y-4">
                        <!-- DÃ­as de facturaciÃ³n -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                DÃ­as de facturaciÃ³n
                            </label>
                            <input 
                                type="number" 
                                id="gas-dias" 
                                placeholder="Ej: 30" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="1"
                                step="1"
                            >
                        </div>
                        
                        <!-- kWh consumidos -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                kWh consumidos
                            </label>
                            <input 
                                type="number" 
                                id="gas-kwh" 
                                placeholder="Ej: 250" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- Total cliente -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                Total factura actual (â‚¬)
                            </label>
                            <input 
                                type="number" 
                                id="gas-total-cliente" 
                                placeholder="Ej: 45.50" 
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                                min="0"
                                step="0.01"
                            >
                        </div>
                        
                        <!-- SELECTOR: Comparar Indexada vs Fija -->
                        <div class="pt-4 border-t border-slate-200">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="gas-compare-indexed-fixed" 
                                    class="w-5 h-5 text-red-600 rounded focus:ring-red-500"
                                    onchange="toggleGasComparisonMode()"
                                >
                                <span class="text-sm font-bold text-slate-700">Comparar Indexada vs Fija</span>
                            </label>
                            <p class="text-xs text-slate-500 mt-1 ml-8">
                                Activa para comparar automÃ¡ticamente tarifa indexada DRK contra tarifas fijas.
                            </p>
                        </div>
                        
                        <!-- OPCIONES DE SELECCIÃ“N -->
                        <div class="pt-4 border-t border-slate-200">
                            <p class="text-sm font-bold text-slate-700 mb-3">Modo de selecciÃ³n:</p>
                            
                            <!-- OpciÃ³n 1: Mejores tarifas -->
                            <label class="flex items-start gap-3 mb-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="best" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    checked
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Mejores tarifas</span>
                                    <p class="text-xs text-slate-500" id="gas-best-description">
                                        El sistema calcularÃ¡ automÃ¡ticamente las mejores opciones.
                                    </p>
                                </div>
                            </label>
                            
                            <!-- OpciÃ³n 2: Elegir entre resultados -->
                            <label class="flex items-start gap-3 cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:border-red-300 transition">
                                <input 
                                    type="radio" 
                                    name="gas-selection-mode" 
                                    value="manual" 
                                    class="mt-1 w-4 h-4 text-red-600"
                                    onchange="updateGasSelectionUI()"
                                >
                                <div>
                                    <span class="font-bold text-slate-800">Elegir entre resultados</span>
                                    <p class="text-xs text-slate-500">
                                        Selecciona manualmente las tarifas que deseas comparar.
                                    </p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Botones FIJA/INDEXADA (solo cuando selector NO marcado y modo "best") -->
                        <div id="gas-type-buttons" class="pt-4 border-t border-slate-200 space-y-2">
                            <p class="text-sm font-bold text-slate-700 mb-2">Tipo de tarifa:</p>
                            <button 
                                onclick="calculateGasWithType('fija')" 
                                class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition"
                            >
                                ðŸ”µ Tarifa Fija
                            </button>
                            <button 
                                onclick="calculateGasWithType('indexada')" 
                                class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition"
                            >
                                ðŸŸ  Tarifa Indexada
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button 
                            onclick="closeGasModal()" 
                            class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                        >
                            Cancelar
                        </button>
                        <button 
                            id="gas-calculate-btn"
                            onclick="proceedToGasCalculation()" 
                            class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                        >
                            Continuar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANTALLA 4: Resultados GAS -->
        <div id="screen-gas-results" class="screen">
            <div class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-red-500">
                    <button onclick="goToGas()" style="background:none;border:none;padding:0.5rem;margin-bottom:1rem;cursor:pointer;" class="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Volver
                    </button>
                    
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner">
                        <span class="text-4xl">ðŸ”¥</span>
                    </div>
                    <h2 class="text-3xl font-black text-red-600 mb-2 text-center">Resultados GAS</h2>
                    <p class="text-slate-500 mb-6 text-center" id="gas-results-subtitle">Comparativa de tarifas</p>
                    
                    <!-- Contenedor de resultados -->
                    <div id="gas-results-container" class="mt-6">
                        <!-- Los resultados se insertarÃ¡n aquÃ­ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2. MultiCups Saga View (Intermediate Step) -->
        <div id="multicups-saga-view" class="fade-in hidden flex flex-col items-center justify-center min-h-[60vh] py-8">
            <button onclick="resetToLanding()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver a selecciÃ³n de modo
            </button>
            
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="multicups-saga-card">
                <div id="initial-icon-bg-saga" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                
                <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                <p class="text-slate-500 mb-6 text-center" id="saga-instruction-text">
                    Selecciona el tipo de contrato que deseas aÃ±adir.<br>
                    Total de suministros actuales: <span class="font-bold text-drk-800" id="saga-total-cups">0</span>
                </p>
                
                <p id="loading-status-saga" class="text-center text-sm text-slate-400 mt-4 mb-4">Cargando tarifas 2.0TD y 3.0TD...</p>

                <div id="saga-button-wrapper" class="w-full space-y-4 pt-4 border-t border-slate-200">
                    <button onclick="selectMultiCupType('2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Permite EscÃ¡ner QR, Imagen y Entrada Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectMultiCupType('3.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Solo Entrada de Datos Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <button id="multicups-finalize-btn-saga" onclick="finalizeMultiCups()" class="w-full bg-cta-green-500 hover:bg-cta-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mt-8 hidden">
                    FINALIZAR Y COMPARAR (<span id="saga-finalize-count">0</span> Suministros)
                </button>
            </div>
        </div>

        <!-- 3. Initial Input View (Scan/Manual) -->
        <div id="initial-view" class="fade-in hidden">
            <button onclick="currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : resetToLanding()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver <span id="back-button-label">a selecciÃ³n</span>
            </button>

            <div id="initial-card" class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div id="tariff-badge" class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    <span id="current-tariff-label">2.0TD</span> - <span id="tariff-display-badge">0</span>
                </div>
                
                <!-- VERSION -->
                <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    v2024.12.20
                </div>
                
                
                <div id="initial-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600"></div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6" id="scan-instruction-text">Escanea el cÃ³digo QR o introduce datos manualmente.</p>
                
                <div id="qr-buttons-container">
                    <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>ESCANEAR QR AHORA</span>
                    </button>
                    <input type="file" id="image-file-input" accept="image/*" class="hidden">
                    <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1m-4-5l-1-1m0 0l-1-1m0 0l-1-1M12 12v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>OPCIONES QR MANUAL</span>
                    </button>
                </div>
                <button id="manual-input-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>DATOS A MANO</span>
                </button>

                <button id="multicups-finalize-btn-main" class="hidden"></button>

                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>

            </div>
        </div>

        <!-- 4. Scanner View -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <div id="scanner-guide" class="absolute inset-0 border-2 border-drk-500 opacity-50 m-8 rounded-lg pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-64 h-1 bg-red-500 opacity-50"></div></div>
            </div>
            <p class="text-center text-sm text-slate-500 mb-4">Enfoca el cÃ³digo QR de la CNMC.</p>
            <button id="capture-photo-btn" class="w-full bg-white border-2 border-drk-500 text-drk-800 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2">Capturar Foto Manualmente</button>
        </div>

        <!-- 5. Results View -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <!-- Banner de Empresa -->
            <div id="company-banner" class="mb-8 rounded-2xl overflow-hidden shadow-lg">
                <!-- El contenido del banner se generarÃ¡ dinÃ¡micamente segÃºn la marca activa -->
            </div>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> AnÃ¡lisis Completado
                </div>
                <h2 class="2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500" id="results-cups-list">CUPS: <span class="font-mono text-slate-700" id="cups-value"></span></p>
            </div>

            <div id="result-card" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div id="result-header" class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1" id="best-offer-label">LA MEJOR OPCIÃ“N PARA TI ES</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <!-- offer.description del CSV -->
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">DescripciÃ³n</p> 
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p id="savings-label" class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-cta-green-500 tracking-tight">- â‚¬</p>
                        </div>
                        <div id="price-columns" class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-period-cost-display">0,00 â‚¬</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label">Total Periodo</p> 
                                </div>
                                <div><p class="text-lg font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-annual-cost-display">0,00 â‚¬/aÃ±o</p></div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase" id="new-cost-label">TU NUEVO COSTE DRK</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 â‚¬/mes</p>
                                    <p class="text-xs text-drk-800 font-medium" id="monthly-label">Estimado Mensual</p>
                                </div>
                                <div><p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 â‚¬/aÃ±o</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-8">
                <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1" id="details-toggle-btn">Ver desglose detallado del cÃ¡lculo</button>
            </div>
            
            <div id="details-container" class="hidden space-y-6">
            </div>

            <div class="mt-8">
                <button onclick="resetToLanding()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                    Realizar Nueva ComparaciÃ³n
                </button>
            </div>
        </div>

        <!-- 6. Manual Input Modal -->
        <div id="manual-input-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="manual-modal-title">Entrada de Datos Manual</h3>
                
                <div id="manual-tariff-selector-wrapper" class="hidden mb-4">
                    <label for="manual-input-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="manual-input-tariff-select" onchange="toggleMultiCupsInputPeriods(this.value, 'input')" class="w-full p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Hogar/Negocio)</option>
                        <option value="3.0TD">3.0 TD (Industria/Gran Consumo)</option>
                    </select>
                </div>

                <div class="border-b border-slate-200 pb-3 mb-4 bg-slate-50 p-3 rounded-lg">
                    <h4 class="font-bold text-slate-800 mb-2">Datos Generales</h4>
                    <input type="text" id="input-cups" placeholder="NÃºmero CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    <input type="number" id="input-billing-days" placeholder="DÃ­as Facturados" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 class="font-bold text-slate-800 mb-2">Potencias (kW)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.01" id="input-p1-kw" placeholder="P1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p2-kw" placeholder="P2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p3-kw" placeholder="P3" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p4-kw" placeholder="P4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p5-kw" placeholder="P5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p6-kw" placeholder="P6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 class="font-bold text-slate-800 mb-2">EnergÃ­a (kWh)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="1" id="input-e1-kwh" placeholder="E1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e2-kwh" placeholder="E2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e3-kwh" placeholder="E3" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e4-kwh" placeholder="E4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e5-kwh" placeholder="E5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e6-kwh" placeholder="E6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>

                <div class="pb-3 mb-3">
                    <input type="number" step="0.01" id="input-total-bill" placeholder="Total Factura (â‚¬)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <button id="execute-manual-input-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">CALCULAR</button>
                <button onclick="closeManualInputModal()" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 7. QR Confirmation Modal (MultiCups) -->
        <div id="qr-confirm-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-2">Confirmar Suministro</h3>
                <p class="text-sm text-slate-500 mb-4">Revisa los datos extraÃ­dos y selecciona el tipo de tarifa para aÃ±adir a la lista.</p>

                <div class="mb-4" id="tariff-selector-wrapper">
                    <label for="confirm-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="confirm-tariff-select" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option>
                        <option value="3.0TD">3.0 TD (6 Periodos)</option>
                    </select>
                </div>

                <div id="qr-data-summary" class="bg-slate-50 p-3 rounded-lg text-sm mb-4">
                    </div>

                <button id="confirm-save-supply-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">AÃ‘ADIR A LA LISTA DE CUPS</button>
                <button onclick="document.getElementById('qr-confirm-modal').classList.add('hidden');" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 8. QR Options Modal (Upload/Paste) -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-qr-title">Seleccione OpciÃ³n QR</h3>
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden'); document.getElementById('qr-options-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl">Cancelar</button>
            </div>
        </div>

        <!-- 9. Send Offer Modal (Copy HTML) -->
        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-client-data-title">Datos del Comercial y Cliente</h3>
                <p class="text-sm text-slate-600 mb-3">Rellene sus datos. El resumen profesional de la oferta se copiarÃ¡ a su portapapeles (Ctrl+V).</p>
                
                <input type="text" id="comercial-code-input" placeholder="CÃ“DIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="tel" id="client-phone-input" placeholder="TelÃ©fono" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="email" id="client-email-input" placeholder="Email" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                
                <!-- Nota informativa para iPhone -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-amber-600 text-xl">âš ï¸</span>
                        <div class="text-xs text-amber-800">
                            <p class="font-bold mb-1">NOTA PARA USUARIOS DE iPHONE:</p>
                            <p class="leading-relaxed">Si copias desde iPhone, el formato puede no verse correctamente en algunos correos. Para mejor resultado:</p>
                            <ul class="mt-1 ml-3 space-y-0.5">
                                <li>âœ“ Copia desde un <strong>ordenador</strong></li>
                                <li>âœ“ O usa <strong>Gmail/Outlook web</strong> en el navegador mÃ³vil</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-black py-3 rounded-xl shadow-md mb-3">
                    ðŸ“§ COPIAR COMPARATIVO (HTML)
                </button>
                <button id="execute-pdf-offer-btn" class="w-full bg-drk-600 hover:bg-drk-700 text-white font-black py-3 rounded-xl shadow-md mb-3">
                    ðŸ“„ CREAR PDF COMPARATIVO
                </button>
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden'); document.getElementById('send-offer-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 9.8. Modal de DecisiÃ³n (Mejor OpciÃ³n vs Elegir) -->
        <div id="offer-decision-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white">
                    <h3 class="text-2xl font-black">âœ… CÃ¡lculo Completado</h3>
                    <p class="text-drk-100 text-sm mt-1">Hemos encontrado ofertas con ahorro. Â¿CÃ³mo quieres continuar?</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <!-- NUEVO: Checkbox para comparaciÃ³n con tarifas indexadas (SOLO POWER CUP) -->
                    <div id="powercup-indexed-comparison-checkbox" class="hidden mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border-2 border-blue-200">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input 
                                type="checkbox" 
                                id="compare-indexed-checkbox" 
                                class="mt-1 w-5 h-5 text-drk-600 border-2 border-slate-300 rounded focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                onchange="toggleIndexedComparison(this.checked)"
                            >
                            <div class="flex-1">
                                <p class="font-black text-base text-slate-900 mb-1 group-hover:text-drk-600 transition">
                                    âš¡ Comparar FIJO vs INDEXADO
                                </p>
                                <p class="text-sm text-slate-600">
                                    Genera comparativa dual: tarifa fija y tarifa indexada DRK INDEX (precio variable del mercado).
                                </p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex flex-col gap-4">
                        <!-- OpciÃ³n 1: Mejor OpciÃ³n (CON SELECTOR PARA DRK) -->
                        <div class="rounded-xl border-2 border-slate-300 bg-white overflow-hidden">
                            <!-- Cabecera clickeable -->
                            <button onclick="handleBestOptionClick()" class="w-full text-left p-6 hover:bg-drk-50 transition group">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0 group-hover:bg-yellow-200">
                                        ðŸ†
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-black text-lg text-slate-900 mb-2">VER MEJOR OPCIÃ“N</p>
                                        <p class="text-sm text-slate-600">Muestra automÃ¡ticamente la oferta con mayor ahorro y genera la comparativa</p>
                                    </div>
                                    <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </button>
                            
                            <!-- Selector de tipo de tarifa (SOLO para DRK Individual) -->
                            <div id="best-option-tariff-selector" class="hidden border-t-2 border-slate-200 bg-slate-50 p-4">
                                <p class="text-sm font-bold text-slate-700 mb-3">ðŸŽ¯ Â¿QuÃ© tipo de tarifa DRK quieres ver?</p>
                                <div class="space-y-2">
                                    <!-- Tarifa FIJA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-drk-500 bg-drk-50 cursor-pointer transition hover:bg-drk-100" id="best-fija-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="fija" 
                                            checked
                                            class="w-4 h-4 text-drk-600 border-2 border-slate-300 focus:ring-2 focus:ring-drk-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('fija')"
                                        >
                                        <div class="flex-1">
                                            <p class="font-bold text-sm text-slate-900">âš¡ Tarifa FIJA</p>
                                            <p class="text-xs text-slate-600">Precio fijo estable (excluye DRK INDEX)</p>
                                        </div>
                                    </label>
                                    
                                    <!-- Tarifa INDEXADA -->
                                    <label class="flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-green-50" id="best-indexada-label">
                                        <input 
                                            type="radio" 
                                            name="best-option-tariff-type" 
                                            value="indexada"
                                            class="w-4 h-4 text-green-600 border-2 border-slate-300 focus:ring-2 focus:ring-green-500 cursor-pointer"
                                            onchange="updateBestOptionTariffChoice('indexada')"
                                        >
                                        <div class="flex-1">
                                            <p class="font-bold text-sm text-slate-900">ðŸŒ± Tarifa INDEXADA (DRK INDEX)</p>
                                            <p class="text-xs text-slate-600">Solo muestra DRK INDEX del mercado</p>
                                        </div>
                                    </label>
                                </div>
                                
                                <!-- BotÃ³n de confirmaciÃ³n -->
                                <button onclick="selectBestOptionWithChoice()" class="w-full mt-3 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-lg transition">
                                    Continuar con esta opciÃ³n â†’
                                </button>
                            </div>
                        </div>
                        
                        <!-- OpciÃ³n 2: Elegir Manual -->
                        <button onclick="selectFromResults()" class="text-left p-6 rounded-xl border-2 border-slate-300 bg-white hover:border-drk-500 hover:bg-drk-50 transition group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200">
                                    ðŸ“‹
                                </div>
                                <div class="flex-1">
                                    <p class="font-black text-lg text-slate-900 mb-2">ELEGIR ENTRE RESULTADOS</p>
                                    <p class="text-sm text-slate-600">Revisa todas las ofertas con ahorro positivo y elige la que prefieras</p>
                                </div>
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Info adicional -->
                    <div class="mt-6 p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-600">
                            ðŸ’¡ <strong>Consejo:</strong> Si quieres ver rÃ¡pidamente la mejor oferta, elige la primera opciÃ³n. 
                            Si necesitas comparar varias opciones o el cliente tiene preferencias especÃ­ficas, elige la segunda.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9.9. Modal de SelecciÃ³n de Oferta -->
        <div id="offer-selection-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white flex-shrink-0">
                    <h3 class="text-2xl font-black">ðŸ“‹ SELECCIONA TU OFERTA</h3>
                    <p class="text-drk-100 text-sm mt-1">Hemos calculado todas las opciones con ahorro. Elige la que prefieras.</p>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Info del CUPS -->
                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <p class="text-xs font-bold text-slate-600 mb-2">ðŸ“‹ DATOS DEL SUMINISTRO</p>
                        <p class="text-sm font-mono" id="modal-selection-cups"></p>
                    </div>
                    
                    <!-- NUEVO: Controles de Filtrado y OrdenaciÃ³n -->
                    <div class="bg-white border-2 border-drk-200 rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- Filtro por nombre -->
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-2">ðŸ” BUSCAR POR NOMBRE</label>
                                <input 
                                    type="text" 
                                    id="offer-search-input" 
                                    placeholder="Escribe nombre de comercializadora..."
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm"
                                    onkeyup="filterAndSortOffers()"
                                >
                            </div>
                            
                            <!-- OrdenaciÃ³n -->
                            <div class="md:w-64">
                                <label class="block text-xs font-bold text-slate-600 mb-2">ðŸ“Š ORDENAR POR</label>
                                <select 
                                    id="offer-sort-select" 
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm font-medium"
                                    onchange="filterAndSortOffers()"
                                >
                                    <option value="savings_desc">ðŸ’° Mayor ahorro primero</option>
                                    <option value="savings_asc">ðŸ’¸ Menor ahorro primero</option>
                                    <option value="name_asc">ðŸ”¤ Nombre (A-Z)</option>
                                    <option value="name_desc">ðŸ”¤ Nombre (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Contador de resultados -->
                        <div class="mt-3 flex items-center justify-between">
                            <p class="text-xs text-slate-500">
                                <span class="font-bold text-drk-600" id="offers-visible-count">0</span> de <span id="offers-total-count">0</span> ofertas
                            </p>
                            <button 
                                onclick="clearOfferFilters()" 
                                class="text-xs text-drk-600 hover:text-drk-800 font-bold hover:underline"
                            >
                                ðŸ”„ Limpiar filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de ofertas con radio buttons -->
                    <div id="offers-radio-list" class="space-y-3 mb-6">
                        <!-- Se rellenarÃ¡ dinÃ¡micamente -->
                    </div>
                    
                    <!-- Mensaje cuando no hay resultados -->
                    <div id="no-offers-message" class="hidden text-center py-8">
                        <p class="text-slate-400 text-lg mb-2">ðŸ”</p>
                        <p class="text-slate-600 font-bold">No se encontraron ofertas</p>
                        <p class="text-slate-500 text-sm">Prueba con otros criterios de bÃºsqueda</p>
                    </div>
                </div>
                
                <!-- Footer con botones -->
                <div class="p-6 border-t border-slate-200 flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="closeOfferSelectionModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition">
                            â† Volver
                        </button>
                        <button id="confirm-offer-selection-btn" class="flex-1 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                            Generar Comparativa â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10. Error/Message Modal -->
        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">Â¡AtenciÃ³n!</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <div class="space-y-2">
                    <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
                    <button id="secondary-action-btn" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm mt-2 hidden">AcciÃ³n Secundaria</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paste Catcher (Hidden element for capturing pasted image data) -->
    <textarea id="paste-catcher" aria-hidden="true" title="Ãrea de pegado (invisible)"></textarea>

    <script>
        // --- CONFIGURACIÃ“N DE TIPO DE TARIFAS ---
        // **ATENCIÃ“N: Los IDs de las hojas deben ser pÃºblicos para funcionar (CSV)**
        // Eliminamos 6.1TD de la configuraciÃ³n
        const TARIFF_CONFIG = {
            '2.0TD': { sheetId: '19CBiWVvxHoWW0fqdbSbLGs-hoISQGORAfebBztFYi3w', periods: 3, powerPeriods: 2, label: '2.0 TD', isHighVoltage: false, requiresQR: true, isMulti: false },
            '3.0TD': { sheetId: '18nieA7yMD9Ytc2Z3EnktoNDZokuMrBet_ETGyhNZDuo', periods: 6, powerPeriods: 6, label: '3.0 TD', isHighVoltage: true, requiresQR: false, isMulti: false },
            'MULTICUPS': { sheetId: 'MULTICUPS_MIXED_TARIF_SHEET_ID', periods: 6, powerPeriods: 6, label: 'MULTICUPS', isHighVoltage: false, requiresQR: true, isMulti: true, baseTariffType: '2.0TD' }
        };

        const BRANDS = {
            DRK: {
                NAME: 'DRK', ACCENT: 'drk-500', ACCENT_TEXT: 'EnergÃ­a',
                FULL_NAME: 'DRK ENERGÃA', // AÃ‘ADIDO
                TITLE: 'DRK COMPARADOR', // TÃ­tulo en mayÃºsculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'DRK',
                QR_BORDER_COLOR: '#0ea5e9', // drk-500
                QR_CENTER_BG: '#075985', // drk-800
                PRIMARY_BG_GRADIENT: 'from-drk-800 to-drk-600', 
                PRIMARY_BUTTON: 'from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-drk-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-drk-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-drk-800', SECONDARY_BG: 'bg-drk-50', SECONDARY_TEXT: 'text-drk-600', BORDER: 'border-drk-500',
                LOGO_SVG: `<svg class="w-8 h-8" viewBox="0 0 100 100" fill="none"><style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style><circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/><circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/><circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/><circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/></svg>`,
                NAV_BG: 'bg-drk-900', NAV_SUBTITLE_BG: 'bg-drk-800', NAV_SUBTITLE_TEXT: 'text-drk-100'
            },
            POWER_CUP: {
                NAME: 'POWER CUP', ACCENT: 'powercup-500', ACCENT_TEXT: '',
                FULL_NAME: 'POWER CUP', // AÃ‘ADIDO
                TITLE: 'POWER CUP COMPARADOR', // TÃ­tulo en mayÃºsculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/',
                QR_TEXT: 'POWER',
                QR_BORDER_COLOR: '#84cc16', // powercup-500
                QR_CENTER_BG: '#3f6212', // powercup-800
                PRIMARY_BG_GRADIENT: 'from-powercup-900 to-powercup-800', 
                PRIMARY_BUTTON: 'from-powercup-600 to-powercup-800 hover:from-powercup-500 hover:to-powercup-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-powercup-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-powercup-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-powercup-800', SECONDARY_BG: 'bg-powercup-50', SECONDARY_TEXT: 'text-powercup-600', BORDER: 'border-powercup-500',
                LOGO_SVG: `<svg width="40" height="40" viewBox="0 0 100 100" fill="none"><path d="M78 40V70C78 80.25 70.25 88 60 88H30C19.75 88 12 80.25 12 70V40C12 29.75 19.75 22 30 22H60C70.25 22 78 29.75 78 40Z" fill="#3f6212"/><circle cx="45" cy="95" r="5" fill="#365314" opacity="0.8"/><rect x="20" y="80" width="50" height="5" rx="2.5" fill="#365314"/><rect x="20" y="30" width="50" height="50" fill="#f7fee7" rx="5"/><rect x="25" y="65" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="50" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="35" width="40" height="10" rx="2" fill="#84cc16"/><path d="M80 20L60 35L70 45L50 60L75 60L65 80L85 65L75 55L85 45L65 45L75 25Z" fill="#facc15" stroke="#3f6212" stroke-width="2" stroke-linejoin="round"/><path d="M78 40C88 40 88 50 88 60C88 70 88 80 78 80" stroke="#3f6212" stroke-width="8" stroke-linecap="round"/></svg>`,
                NAV_BG: 'bg-powercup-900', NAV_SUBTITLE_BG: 'bg-powercup-800', NAV_SUBTITLE_TEXT: 'text-powercup-100'
            }
        };

        const EXTERNAL_APP_URL = 'https://faraujoteixeiradrk-creator.github.io/QR-21-POWER-2-0-TD---3.0-TD-Con-PDF/';
        
        // Estado Global
        // Eliminamos 6.1TD del estado inicial
        let currentTariffs = {
            '2.0TD': [],
            '3.0TD': []
        };
        let currentTariffType = '2.0TD';
        let lastComparisonResult = null;
        let lastIndexedResult = null; // Para almacenar el resultado de tarifa indexada
        let comparisonMode = 'drk_prioritized';
        let compareWithIndexed = false; // Control para comparaciÃ³n con tarifas indexadas
        let bestOptionTariffChoice = 'fija'; // NUEVO: ElecciÃ³n de tarifa para VER MEJOR OPCIÃ“N ('fija' o 'indexada')
        let activeBrand = BRANDS.DRK;
        let qrCodeInstance = null; // Instancia de QRCode.js
        
        // Nuevas variables para selecciÃ³n avanzada de ofertas
        let availableOffers = []; // Array de todas las ofertas con ahorro positivo
        let manuallySelectedOffer = null; // Oferta seleccionada manualmente

        // Estado Multicups
        let multiCupsData = [];
        let tempQrData = null; // Almacenamiento temporal para datos de QR antes de la confirmaciÃ³n
        let multiCupsAddType = null; // NEW: Holds '2.0TD' or '3.0TD' when adding a single CUPS in MultiCups mode.
        
        // Variables EscÃ¡ner
        let scannerRunning = false;
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;

        // --- FUNCIONES DE FORMATO ROBUSTAS ---
        const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
        const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
        const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);

        // FunciÃ³n para obtener TODAS las ofertas Ãºnicas usadas en los resultados
        function getWinningOffersPerType(results) {
            // Cambio: Ahora guardamos arrays de ofertas Ãºnicas
            const winningOffers = { '2.0TD': [], '3.0TD': [] };
            let hasDrkWinner = false;
            
            results.forEach(resItem => {
                const type = resItem.originalTariffType;
                const winnerOffer = resItem.offer;
                
                // Track if any DRK offer won
                if (winnerOffer.isDrk && winnerOffer.name !== 'Tu Tarifa Actual') {
                    hasDrkWinner = true;
                }

                // Collect ALL unique winning offers for this type
                if (type === '2.0TD' || type === '3.0TD') {
                    const key = type;
                    
                    if (winnerOffer.name !== 'Tu Tarifa Actual') {
                        // Crear un identificador Ãºnico basado en los precios (no solo el nombre)
                        // Esto permite diferenciar ofertas con el mismo nombre pero diferentes precios
                        const offerSignature = type === '2.0TD' 
                            ? `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}`
                            : `${winnerOffer.name}_${winnerOffer.p1_price}_${winnerOffer.p2_price}_${winnerOffer.p3_price}_${winnerOffer.p4_price}`;
                        
                        // Verificar si esta oferta ya estÃ¡ (por firma Ãºnica)
                        const alreadyExists = winningOffers[key].some(o => {
                            const existingSignature = type === '2.0TD'
                                ? `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}`
                                : `${o.name}_${o.p1_price}_${o.p2_price}_${o.p3_price}_${o.p4_price}`;
                            return existingSignature === offerSignature;
                        });
                        
                        if (!alreadyExists) {
                            winningOffers[key].push({
                                ...winnerOffer,
                                totalAnnual: resItem.totalAnnual
                            });
                        }
                    }
                }
            });

            return { winningOffers, hasDrkWinner };
        }
        
        // --- FUNCIONES DE MODALES Y UI ---
        
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            cleanupPasteCatcher();
        };

        function setModalContent(msg, title, isError) {
            const brand = activeBrand;
            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = msg;

            if (isError) {
                document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            } else {
                document.getElementById('error-icon').className = `w-12 h-12 bg-${basePrefix}-100 text-${basePrefix}-500 rounded-full flex items-center justify-center mx-auto mb-4`;
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            if (mainButton) {
                mainButton.textContent = "Entendido";
                mainButton.onclick = hideErrorModal;
            }

            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
            
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
        }

        window.showMessageModal = (msg, title="Ã‰xito") => setModalContent(msg, title, false);
        window.showErrorModal = (msg, title="Â¡AtenciÃ³n!") => setModalContent(msg, title, true);
        
        function cleanupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.classList.remove('pasting-active');
            pasteCatcher.blur();  
            pasteCatcher.style.width = '0';
            pasteCatcher.style.height = '0';
            pasteCatcher.style.zIndex = '-1';
            pasteCatcher.style.pointerEvents = 'none';
            pasteCatcher.value = '';  
        }

        function showPasteModal(onCancel) {
            const pasteCatcher = document.getElementById('paste-catcher');
            
            // 1. Activar el campo de pegado
            pasteCatcher.classList.add('pasting-active');
            
            // Intentar asegurar el foco despuÃ©s de un breve momento para mayor fiabilidad.
            setTimeout(() => {
                pasteCatcher.focus();
            }, 50);
            
            // 2. Establecer contenido del modal
            setModalContent("Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura.", "Esperando Pegado (Ctrl+V)", false);

            // 3. Configurar el botÃ³n de Cancelar dinÃ¡micamente
            let secondaryBtn = document.getElementById('secondary-action-btn');
            secondaryBtn.textContent = "Cancelar Pegado";
            secondaryBtn.onclick = () => { onCancel(); hideErrorModal(); };
            secondaryBtn.classList.remove('hidden');
            
            // 4. Configurar botÃ³n principal para que tambiÃ©n cancele
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            mainButton.textContent = "Continuar Pegando";  
            mainButton.onclick = () => { hideErrorModal(); };
        }
        
        function setupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            const modalPasteBtn = document.getElementById('modal-paste-image-btn');
            
            modalPasteBtn.addEventListener('click', () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                showPasteModal(cleanupPasteCatcher);
            });

            pasteCatcher.addEventListener('paste', (e) => {
                e.preventDefault();
                hideErrorModal();
                cleanupPasteCatcher();
                
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let imageFound = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            decodeQRFromImage(file);
                            imageFound = true;
                            break;
                        }
                    }
                }
                
                if (!imageFound) window.showErrorModal("No se detectÃ³ ninguna imagen en el portapapeles.");
            });
        }
        
        // FunciÃ³n para aplicar estilos de marca
        function applyBrandStyles(brand) {
            activeBrand = brand;
            const isDrk = brand.NAME.includes('DRK');
            
            const accent500 = isDrk ? 'drk-500' : 'powercup-500';
            const bg50 = isDrk ? 'bg-drk-50' : 'bg-powercup-50';
            const text800 = isDrk ? 'text-drk-800' : 'text-powercup-800';
            const borderColor = isDrk ? 'border-drk-500' : 'border-powercup-500';
            
            // --- CORE BRAND SWITCH (BODY CLASS) ---
            document.body.classList.toggle('powercup-active', !isDrk);
            document.body.classList.toggle('drk-active', isDrk);

            // 1. NAVBAR
            document.getElementById('app-logo-main').textContent = isDrk ? 'DRK' : 'POWER';
            document.getElementById('app-logo-accent').textContent = brand.ACCENT_TEXT;
            document.getElementById('app-logo-accent').className = `text-${brand.ACCENT}`;

            document.getElementById('navbar').className = `w-full ${brand.NAV_BG} text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300`;
            document.getElementById('app-subtitle').className = `text-xs ${brand.NAV_SUBTITLE_BG} px-2 py-1 rounded ${brand.NAV_SUBTITLE_TEXT}`;

            // 2. LANDING PAGE CONTENT
            document.getElementById('landing-title').textContent = brand.TITLE; // Set main title in CAPS
            document.getElementById('landing-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('landing-icon-bg').innerHTML = brand.LOGO_SVG; // Set main logo

            // 3. INITIAL VIEW ICON (Used when user proceeds to scan view)
            document.getElementById('initial-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('initial-icon-bg').innerHTML = brand.LOGO_SVG;
            // Also apply to Saga View
            const sagaIcon = document.getElementById('initial-icon-bg-saga');
            if (sagaIcon) {
                sagaIcon.className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
                sagaIcon.innerHTML = brand.LOGO_SVG;
            }
            
            // 4. MAIN ACTION BUTTONS (Scanner/Input View)
            const primaryButtonClass = `w-full bg-gradient-to-r ${brand.PRIMARY_BUTTON} text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3`;
            const startScanBtn = document.getElementById('start-scan-btn');
            if (startScanBtn) startScanBtn.className = primaryButtonClass; // Apply to scan button if visible

            const secondaryButtonBase = `w-full ${brand.SECONDARY_BUTTON_BG} ${isDrk ? 'hover:bg-drk-100' : 'hover:bg-powercup-100'} ${brand.SECONDARY_BUTTON_TEXT} font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3`;
            const uploadMenuBtn = document.getElementById('upload-menu-btn');
            if (uploadMenuBtn) uploadMenuBtn.className = secondaryButtonBase; // Apply to upload button if visible
            
            // Apply unique style to Manual Input button
            const manualInputBtn = document.getElementById('manual-input-btn');
            if (manualInputBtn) {
                // Remove all previous style classes related to color/bg/hover
                manualInputBtn.className = manualInputBtn.className.split(' ').filter(c => 
                    !c.startsWith('bg-') && !c.startsWith('hover:bg-') && !c.startsWith('text-') && !c.includes('from-') && !c.includes('to-')
                ).join(' ');
                
                // If QR is hidden (3.0TD individual flow), use the Primary style for manual input
                const isManualPrimary = !isDrk && currentTariffType !== 'MULTICUPS' && !TARIFF_CONFIG[currentTariffType]?.requiresQR;
                
                if (isManualPrimary) {
                    manualInputBtn.classList.add('w-full', 'text-white', 'font-bold', 'py-4', 'px-6', 'rounded-2xl', 'shadow-lg', 'transform', 'transition', 'active:scale-95', 'flex', 'items-center', 'justify-center', 'gap-3');
                    // AÃ±adir clases de gradiente por separado
                    const gradientClasses = isDrk 
                        ? ['bg-gradient-to-r', 'from-drk-600', 'to-drk-800', 'hover:from-drk-700', 'hover:to-drk-900']
                        : ['bg-gradient-to-r', 'from-powercup-600', 'to-powercup-800', 'hover:from-powercup-500', 'hover:to-powercup-900'];
                    manualInputBtn.classList.add(...gradientClasses);
                } else { // DRK active, MULTICUPS, or 2.0TD flow (uses secondary style)
                    manualInputBtn.classList.add('w-full', 'font-bold', 'py-3', 'px-6', 'rounded-xl', 'shadow-sm', 'transform', 'transition', 'active:scale-95', ...brand.SECONDARY_BUTTON_BG.split(' '), ...brand.SECONDARY_BUTTON_TEXT.split(' '));
                }

                // Re-add mt-3 if QR buttons are visible
                if (!document.getElementById('qr-buttons-container')?.classList.contains('hidden')) {
                    manualInputBtn.classList.add('mt-3');
                } else {
                    manualInputBtn.classList.remove('mt-3');
                }
            }
            
            const focusColorClass = isDrk ? 'focus:border-drk-500' : 'focus:border-powercup-500';  
            const calcBtnBg = isDrk ? 'bg-drk-500 hover:bg-drk-600' : 'bg-powercup-500 hover:bg-powercup-600';
            
            // 5. MANUAL INPUT MODAL STYLES
            const manualModal = document.getElementById('manual-input-modal');
            manualModal.querySelector('h3#manual-modal-title').className = `text-xl font-bold ${text800} mb-4`;
            manualModal.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                input.classList.remove('focus:border-drk-500', 'focus:border-powercup-500');
                input.classList.add(focusColorClass);
            });
            manualModal.querySelector('#execute-manual-input-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 6. QR OPTIONS MODAL STYLES (Modal 8)
            const qrOptionsModal = document.getElementById('qr-options-modal');
            qrOptionsModal.querySelector('h3#modal-qr-title').className = `text-xl font-bold ${text800} mb-4`;

            const uploadBtn = document.getElementById('modal-upload-file-btn');
            const pasteBtn = document.getElementById('modal-paste-image-btn');
            
            if (uploadBtn) {
                uploadBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 transform transition active:scale-95 ${isDrk ? 'bg-drk-800 hover:bg-drk-900' : 'bg-powercup-800 hover:bg-powercup-900'}`;
            }

            if (pasteBtn) {
                pasteBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4 transform transition active:scale-95 ${isDrk ? 'bg-drk-600 hover:bg-drk-800' : 'bg-powercup-600 hover:bg-powercup-800'}`;
            }

            // 7. QR CONFIRM MODAL STYLES (Modal 7)
            const qrConfirmModal = document.getElementById('qr-confirm-modal');
            qrConfirmModal.querySelector('h3').className = `text-xl font-bold ${text800} mb-2`;
            qrConfirmModal.querySelector('#confirm-save-supply-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 8. SCANNER VIEW
            document.getElementById('scanner-guide').classList.remove('border-drk-500', 'border-powercup-500');
            document.getElementById('scanner-guide').classList.add(borderColor);
            
            const captureBtn = document.getElementById('capture-photo-btn');
            if (captureBtn) {
                captureBtn.classList.remove('border-drk-500', 'text-drk-800', 'border-powercup-500', 'text-powercup-800');
                captureBtn.classList.add('border-2', 'bg-white', borderColor, text800);
            }

            document.getElementById('paste-catcher').style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);


            // 9. Result Header Gradient & Card Borders
            document.getElementById('result-header').className = `bg-gradient-to-r ${brand.PRIMARY_BG_GRADIENT} p-6 text-white text-center relative overflow-hidden`;
            document.getElementById('initial-card').className = `bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 ${borderColor} relative`;
            document.getElementById('landing-card').className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor}`;
            
            const sagaCard = document.getElementById('multicups-saga-card');
            if (sagaCard) sagaCard.className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor} relative`;

            // 10. TARIFF BADGE COLOR (In Initial View)
            const tariffBadge = document.getElementById('tariff-badge');
            tariffBadge.classList.remove('bg-drk-500', 'bg-powercup-500');  
            tariffBadge.classList.add(`bg-${accent500}`);

            // 11. Landing Page Tariff Buttons 
            document.querySelectorAll('.tariff-select-btn').forEach(btn => {
                const iconWrapper = btn.querySelector('.icon-wrapper');
                const arrowIcon = btn.querySelector('.arrow-icon');
                
                // Limpiar clases de color
                iconWrapper.className = iconWrapper.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('group-hover')).join(' ');
                arrowIcon.classList.remove('group-hover:text-drk-500', 'group-hover:text-powercup-500');
                btn.classList.remove('border-drk-300', 'hover:border-drk-500', 'border-powercup-300', 'hover:border-powercup-500');

                if (isDrk) {
                    iconWrapper.classList.add('bg-drk-50', 'group-hover:bg-drk-100', 'text-drk-600');
                    arrowIcon.classList.add('group-hover:text-drk-500');
                    btn.classList.add('border-drk-300', 'hover:border-drk-500');
                } else {
                    iconWrapper.classList.add('bg-powercup-50', 'group-hover:bg-powercup-100', 'text-powercup-600');
                    arrowIcon.classList.add('group-hover:text-powercup-500');
                    btn.classList.add('border-powercup-300', 'hover:border-powercup-500');
                }
            });
        }
        
        // --- FUNCIONES DE LIMPIEZA ---

        function clearManualInputs(prefix = 'input') {
            document.getElementById(`${prefix}-cups`).value = '';
            document.getElementById(`${prefix}-billing-days`).value = '';
            document.getElementById(`${prefix}-total-bill`).value = '';
            for (let i = 1; i <= 6; i++) {
                const pInput = document.getElementById(`${prefix}-p${i}-kw`);
                if (pInput) pInput.value = '';
                const eInput = document.getElementById(`${prefix}-e${i}-kwh`);
                if (eInput) eInput.value = '';
            }
        }
        
        function closeManualInputModal() {
            document.getElementById('manual-input-modal').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.remove('flex');
            // Si estÃ¡bamos en modo MultiCups, volvemos al selector 2.0/3.0
            if (currentTariffType === 'MULTICUPS') {
                showMultiCupsSagaView();
            }
        }

        // FUNCIÃ“N GLOBAL: Hacer accesible desde onclick en HTML
        window.resetToLanding = function() {
            console.log('resetToLanding llamada');
            stopScanner();
            
            // CRÃTICO: Limpiar TODAS las variables globales
            lastComparisonResult = null;
            lastIndexedResult = null; // Limpiar resultado indexado
            multiCupsData = []; // Limpiar datos de multicups
            multiCupsAddType = null; // NEW: Reset sub-type
            availableOffers = [];
            manuallySelectedOffer = null;
            compareWithIndexed = false; // Resetear comparaciÃ³n indexada
            bestOptionTariffChoice = 'fija'; // NUEVO: Resetear elecciÃ³n de tarifa
            
            // Resetear checkbox de comparaciÃ³n indexada
            const checkboxIndexed = document.getElementById('compare-indexed-checkbox');
            if (checkboxIndexed) {
                checkboxIndexed.checked = false;
            }
            
            // Resetear selector de tipo de tarifa
            const fijaRadio = document.querySelector('input[name="best-option-tariff-type"][value="fija"]');
            if (fijaRadio) {
                fijaRadio.checked = true;
            }
            
            // Restaurar la marca activa segÃºn el modo de comparaciÃ³n
            const brandToApply = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            applyBrandStyles(brandToApply);  
            
            // Asegurarse de que el radio button correcto estÃ© checked y dispare el evento para el branding.
            const selectorInput = document.querySelector(`input[name="comparison_mode"][value="${comparisonMode}"]`);
            if (selectorInput) {
                selectorInput.checked = true;
                updateComparisonMode(comparisonMode); // Llamar directamente para asegurar el styling
            }

            // COMENTADO: Ya no mostramos landing-view automÃ¡ticamente - ahora se muestra screen-inicio
            // document.getElementById('landing-view').classList.remove('hidden');
            
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden'); // NEW: Cleanup saga view
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.add('hidden');  
            document.getElementById('manual-input-modal').classList.remove('flex');
            
            document.getElementById('multicups-finalize-btn-main')?.classList.add('hidden'); // Old MultiCups button
            document.getElementById('manual-tariff-selector-wrapper').classList.add('hidden');

            document.querySelectorAll('.hidden-period').forEach(el => el.style.display = 'none');
            document.getElementById('tariff-display-badge').textContent = '0'; // Resetear el contador de tarifas
            
            console.log('resetToLanding completada');
        };

        function toggleMultiCupsInputPeriods(tariffType, prefix = 'input') {
            // Eliminamos la referencia a 6.1TD en la comprobaciÃ³n
            const isHighVoltage = tariffType === '3.0TD';
            const periods = document.querySelectorAll(`[id^="${prefix}-p3-kw"], [id^="${prefix}-p4-kw"], [id^="${prefix}-p5-kw"], [id^="${prefix}-p6-kw"], [id^="${prefix}-e4-kwh"], [id^="${prefix}-e5-kwh"], [id^="${prefix}-e6-kwh"]`);
            
            periods.forEach(el => {
                el.style.display = isHighVoltage ? 'block' : 'none';
            });
            // Ocultar/Mostrar campos de E1/E2/E3
            document.getElementById('input-e1-kwh').placeholder = isHighVoltage ? 'E1' : 'E1 (Punta)';
            document.getElementById('input-e2-kwh').placeholder = isHighVoltage ? 'E2' : 'E2 (Llano)';
            document.getElementById('input-e3-kwh').placeholder = isHighVoltage ? 'E3' : 'E3 (Valle)';
        }

        function selectTariffType(type) {
            currentTariffType = type;
            const config = TARIFF_CONFIG[type];
            const qrButtonsContainer = document.getElementById('qr-buttons-container');

            clearManualInputs();  

            if (config.isMulti) {
                // NEW: FLujo MULTICUPS: Va a la vista SAGA intermedia
                // CRÃTICO: Limpiar TODAS las variables globales al iniciar MultiCups
                multiCupsData = [];  
                multiCupsAddType = null; // Reset sub-type
                availableOffers = [];
                lastComparisonResult = null;
                manuallySelectedOffer = null;
                
                document.getElementById('landing-view').classList.add('hidden');
                showMultiCupsSagaView();

                // Forzar carga de tarifas 2.0TD y 3.0TD
                fetchTariffsForMultiCups();
                
            } else {
                // Flujo Individual (2.0TD, 3.0TD)
                document.getElementById('manual-input-btn').textContent = "DATOS A MANO";
                document.getElementById('multicups-finalize-btn-main').classList.add('hidden');
                
                // --- FIX: Loading status displayed during fetch (Issue 1) ---
                document.getElementById('loading-status').textContent = `Cargando tarifas ${config.label}...`;
                document.getElementById('loading-status').classList.remove('hidden');
                document.getElementById('tariff-display-badge').textContent = '0';

                // --- FIX: 3.0TD always manual ---
                if (config.requiresQR && type === '2.0TD') { // 2.0TD is the only single tariff with QR
                    qrButtonsContainer.classList.remove('hidden');
                    document.getElementById('manual-input-btn').classList.add('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Escanea el cÃ³digo QR o introduce datos manualmente.";
                } else { // 3.0TD (Siempre manual)
                    qrButtonsContainer.classList.add('hidden');
                    document.getElementById('manual-input-btn').classList.remove('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Introduce los datos de la factura manualmente.";
                    document.getElementById('qr-toggle-checkbox').checked = false;
                    document.getElementById('qr-content-wrapper').classList.remove('active');
                }

                document.getElementById('current-tariff-label').textContent = config.label;
                document.getElementById('app-subtitle').textContent = `Comparador ${config.label}`;
                
                // Mostrar/Ocultar inputs P3-P6/E4-E6
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('initial-view').classList.remove('hidden');
                
                // Cargar tarifas al seleccionar tipo
                fetchTariffsFromSheet(currentTariffType);

                if (document.getElementById('qr-toggle-checkbox').checked) {
                    generateQRCode(activeBrand);
                }
            }
        }
        
        function generateQRCode(brand) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrVisualContainer = document.getElementById('qr-visual-container');

            // En modo MULTICUPS el QR siempre enlaza con 2.0TD ya que es el Ãºnico compatible con QR
            const tariffParam = currentTariffType === 'MULTICUPS' ? '2.0TD' : currentTariffType;  
            const fullUrl = `${brand.QR_URL}?tariff=${tariffParam}`;  

            qrContainer.innerHTML = '';
            qrCodeInstance = null;

            qrVisualContainer.style.setProperty('--qr-center-text', `'${brand.QR_TEXT}'`);
            qrVisualContainer.style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);
            qrVisualContainer.style.setProperty('--qr-center-bg', brand.QR_CENTER_BG);
            
            qrCodeInstance = new QRCode(qrContainer, {
                text: fullUrl,
                width: 140,
                height: 140,
                colorDark : brand.QR_CENTER_BG,
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- CÃLCULOS Y COMPARACIÃ“N INDIVIDUAL/MULTICUPS ---
        
        function calculateDays(startDateStr, endDateStr) {
             try {
                 const [d1, m1, y1] = startDateStr.split('/').map(Number);
                 const [d2, m2, y2] = endDateStr.split('/').map(Number);

                 const date1 = new Date(y1, m1 - 1, d1);
                 const date2 = new Date(y2, m2 - 1, d2);
                 
                 if (isNaN(date1.getTime()) || isNaN(date2.getTime())) return 30;

                 const ONE_DAY_MS = 1000 * 60 * 60 * 24;
                 const diffDays = (date2.getTime() - date1.getTime()) / ONE_DAY_MS;
                 return Math.round(diffDays) + 1;
             } catch (e) {
                 return 30;
             }
        }
        
        const formatIsoToDmy = (iso) => {
             if (!iso) return null;
             const parts = iso.split('-');
             if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;  
             return null;
        };

        function calculateTariffCost(tariff, data, tariffType) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; // Impuesto ElÃ©ctrico base
            const ANNUAL_DAYS = 365;
            const config = TARIFF_CONFIG[tariffType];  
            
            let subPower = 0;
            let powerCosts = [];
            
            // CÃ¡lculo de Coste de Potencia
            for (let i = 1; i <= (config?.powerPeriods || 6); i++) {
                // Usamos 6 por defecto si no estÃ¡ definido (aunque TARIFF_CONFIG estÃ¡ bien definido ahora)
                const kw = data[`potencia_p${i}_kw`] || 0;
                const priceAnnual = tariff[`p_potencia_${i}`] || 0;
                const priceDay = priceAnnual / ANNUAL_DAYS;
                const cost = kw * data.dias_facturados * priceDay;
                subPower += cost;
                powerCosts.push({ period: i, cost: cost, priceDay: priceDay, kw: kw, priceAnnual: priceAnnual });
            }

            let subEnergy = 0;
            let energyCosts = [];
            
            // LÃ³gica de consumo: usa los campos del data object
            for (let i = 1; i <= (config?.periods || 6); i++) {
                let kwh = 0;
                let price = 0;

                if (tariffType === '2.0TD') {
                    // 2.0TD usa nombres de campo especÃ­ficos para consumo: punta, llano, valle.
                    kwh = i === 1 ? data.consumo_punta : i === 2 ? data.consumo_llano : i === 3 ? data.consumo_valle : 0;
                    price = tariff[`p${i}_price`] || 0;
                } else {
                    // 3.0TD (y 6.1TD, aunque este Ãºltimo se eliminÃ³ de la UI, el cÃ¡lculo usa la estructura de 6 periodos)
                    kwh = data[`consumo_p${i}`] || 0;
                    price = tariff[`p${i}_price`] || 0;
                }
                
                const cost = kwh * price;
                energyCosts.push({ period: i, cost: cost, price: price, kwh: kwh });
                subEnergy += cost;
            }

            // Aplicar Descuento
            const discountRate = (tariff.descuento || 0) / 100;
            const discountAmount = subEnergy * discountRate;
            const subEnergyNet = subEnergy - discountAmount;

            // Base Imponible e Impuestos
            const subBase = subPower + subEnergyNet;
            const costIE = subBase * IE_RATE; // Impuesto ElÃ©ctrico
            const baseImp = subBase + costIE;
            const costIVA = baseImp * IVA_RATE;
            const totalPeriod = baseImp + costIVA;
            
            // CÃ¡lculo Anualizado
            const factorAnual = ANNUAL_DAYS / (data.dias_facturados || 30); // Prevenir divisiÃ³n por cero/NaN
            const totalAnnual = totalPeriod * factorAnual;
            const originalBillAnnual = data.importe_total * factorAnual;

            const result = {
                ...data,
                tariffType: tariffType, // Tipo de tarifa usada en el cÃ¡lculo (e.g. 2.0TD)
                powerCosts, energyCosts,
                subPower, subEnergy, subEnergyNet,
                discountRate, discountAmount,
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                originalBillAnnual,
                savings: originalBillAnnual - totalAnnual,
                offer: deepCopyOffer(tariff),  // COPIA PROFUNDA para evitar referencias compartidas
                ieRate: IE_RATE
            };
            
            // Si el ahorro es negativo, forzar la tarifa actual como mejor
            if (result.savings <= 0) {
                result.isNegativeSavings = true;
                result.savings = 0;
                result.totalAnnual = result.originalBillAnnual;  
                result.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opciÃ³n detectada", isDrk: false };
            }
            
            return result;
        }

        function compareOffers(data) {
            try {
                console.log('compareOffers called with data:', data);
                console.log('currentTariffType:', currentTariffType);
                
                const tariffType = currentTariffType;  
                const tariffsToCompare = currentTariffs[tariffType] || [];

                console.log(`Tarifas disponibles para ${tariffType}:`, tariffsToCompare.length);

                if (tariffsToCompare.length === 0) {
                    console.error(`No hay tarifas cargadas para ${tariffType}`);
                    return window.showErrorModal(`Las tarifas ${tariffType} no estÃ¡n cargadas. Por favor, espere un momento e intente de nuevo.`);
                }

                const results = tariffsToCompare.map(t => calculateTariffCost(t, data, tariffType));
                console.log('Results calculated:', results.length);
                
                let bestOverall = null;
                let bestDrk = null;

                results.forEach(r => {
                    // Siempre comparamos por el coste anual
                    const annualCost = r.totalAnnual;
                    
                    // Best overall is the one with the lowest annual cost
                    if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                        bestOverall = r;
                    }

                    // Best DRK is the DRK one with the lowest annual cost
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                        }
                    }
                });

                if (!bestOverall) {
                    console.error('No se encontrÃ³ ningÃºn resultado vÃ¡lido');
                    return window.showErrorModal("Sin resultados vÃ¡lidos. AsegÃºrate de que las tarifas estÃ¡n cargadas.");
                }
                
                console.log('Best overall:', bestOverall.offer.name, bestOverall.totalAnnual);
                console.log('Best DRK:', bestDrk ? bestDrk.offer.name : 'None', bestDrk ? bestDrk.totalAnnual : 0);
                
                // --- GUARDAR OFERTAS CON AHORRO POSITIVO ---
                availableOffers = results.filter(r => {
                    r.savings = r.originalBillAnnual - r.totalAnnual;
                    const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                    
                    // Si modo es "DRK ÃšNICAMENTE", filtrar solo ofertas DRK
                    if (comparisonMode === 'drk_only') {
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                    
                    // En otros modos, mostrar todas las ofertas con ahorro
                    return hasPositiveSavings;
                });
                console.log('Available offers with savings (filtered by mode):', availableOffers.length);
                console.log('Comparison mode:', comparisonMode);
                
                let final = bestOverall;
                let brand = activeBrand;

                // --- LÃ“GICA DE SELECCIÃ“N Y BRANDING (Individual) ---
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    final = bestOverall;
                    
                    // Aplicar branding segÃºn quiÃ©n ganÃ³
                    if (final.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        final = bestDrk || bestOverall;
                        // DRK ÃšNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        final = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si ganÃ³ una comercializadora NO-DRK
                        if (final.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
                
                console.log('Final selection:', final.offer.name, 'Brand:', brand.NAME);
                
                // Recalcular el ahorro basado en el resultado final seleccionado
                final.savings = final.originalBillAnnual - final.totalAnnual;
                
                // Manejar casos sin ahorro
                if (final.savings <= 0) {
                    final.isNegativeSavings = true;
                    final.savings = 0;
                    final.totalAnnual = final.originalBillAnnual;
                    final.offer = { 
                        name: "Tu Tarifa Actual", 
                        description: "Es la mejor opciÃ³n detectada", 
                        isDrk: false 
                    };
                    // Mantener el branding segÃºn el modo seleccionado
                    brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
                }
                // Add originalTariffType for consistent logic in HTML generation
                final.originalTariffType = tariffType;

                lastComparisonResult = final;
                
                console.log('About to apply brand styles. Brand:', brand.NAME);
                try {
                    applyBrandStyles(brand);
                    console.log('Brand styles applied successfully');
                } catch (styleError) {
                    console.error('Error in applyBrandStyles:', styleError);
                    throw styleError;
                }
                
                // Guardar el resultado temporalmente
                lastComparisonResult = final;
                lastComparisonResult.isMulti = false;
                
                console.log('Checking available offers...');
                console.log('availableOffers.length:', availableOffers.length);
                console.log('final.savings:', final.savings);
                console.log('currentTariffType:', currentTariffType);
                
                // NUEVA LÃ“GICA: Si hay ofertas con ahorro, mostrar modal de decisiÃ³n
                // PERO SOLO en modo individual, NO en MultiCups
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';
                
                if (!isMultiCupsMode && availableOffers.length > 1) {
                    console.log('Showing decision modal with', availableOffers.length, 'offers');
                    showOfferDecisionModal();
                    return; // No mostrar resultados todavÃ­a, esperar decisiÃ³n del usuario
                }
                
                // Si es MultiCups, solo hay 1 oferta, o ninguna, mostrar resultados directamente
                console.log('About to render UI...');
                renderResultsUI(final);
                
                console.log('Showing results view...');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                console.log('compareOffers completed successfully');
            } catch (error) {
                console.error('Error in compareOffers:', error);
                window.showErrorModal(`Error al calcular: ${error.message}. Por favor, intente de nuevo.`);
            }
        }


        // --- LÃ“GICA MULTICUPS ---

        /**
         * Nueva vista intermedia para seleccionar 2.0TD o 3.0TD en modo MultiCups.
         */
        function showMultiCupsSagaView() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.remove('hidden');
            document.getElementById('app-subtitle').textContent = TARIFF_CONFIG.MULTICUPS.label;
            
            // Mostrar secciÃ³n de tipo de selecciÃ³n de oferta

            updateMultiCupsSagaView();
        }
        
        /**
         * Actualiza el contador y el botÃ³n de finalizar en la vista SAGA.
         */
        function updateMultiCupsSagaView() {
            const totalCount = multiCupsData.length;
            document.getElementById('saga-total-cups').textContent = totalCount;
            document.getElementById('saga-finalize-count').textContent = totalCount;
            
            const finalizeBtn = document.getElementById('multicups-finalize-btn-saga');
            if (totalCount > 0) {
                finalizeBtn.classList.remove('hidden');
            } else {
                finalizeBtn.classList.add('hidden');
            }

            // Habilitar botones si las tarifas estÃ¡n cargadas
            const loadingEl = document.getElementById('loading-status-saga');
            const isReady = currentTariffs['2.0TD'].length > 0 && currentTariffs['3.0TD'].length > 0;
            const sagaButtonWrapper = document.getElementById('saga-button-wrapper');

            if (isReady) {
                loadingEl.classList.add('hidden');
                sagaButtonWrapper.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                loadingEl.classList.remove('hidden');
                sagaButtonWrapper.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        /**
         * Se llama al pulsar 2.0TD o 3.0TD en la vista SAGA.
         * @param {string} type - '2.0TD' or '3.0TD'
         */
        window.selectMultiCupType = (type) => {
            multiCupsAddType = type;
            
            // 1. Ocultar Saga, Mostrar Vista de entrada
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('initial-view').classList.remove('hidden');
            
            // 2. Configurar el botÃ³n de volver
            document.getElementById('back-button-label').textContent = "a MultiCups";
            
            // 3. Configurar Vista de entrada
            const qrButtonsContainer = document.getElementById('qr-buttons-container');
            const manualInputBtn = document.getElementById('manual-input-btn');
            const currentTariffLabel = document.getElementById('current-tariff-label');
            const scanInstructionText = document.getElementById('scan-instruction-text');

            currentTariffLabel.textContent = `MULTICUPS (${type})`;
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length; // Keep existing count

            if (type === '2.0TD') {
                // 2.0TD: QR and Manual
                qrButtonsContainer.classList.remove('hidden');
                manualInputBtn.classList.add('mt-3');
                scanInstructionText.textContent = "Escanea el cÃ³digo QR (2.0TD) o introduce datos manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            } else if (type === '3.0TD') {
                // 3.0TD: ONLY Manual
                qrButtonsContainer.classList.add('hidden');
                manualInputBtn.classList.remove('mt-3');
                scanInstructionText.textContent = "Introduce los datos de la factura 3.0TD manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            }
            
            manualInputBtn.textContent = "AÃ‘ADIR SUMINISTRO MANUAL";
            // Asegurarse de aplicar los estilos correctos al botÃ³n manual
            applyBrandStyles(activeBrand);  
            // Ocultar status de carga, ya que ya estÃ¡n cargadas desde la vista SAGA
            document.getElementById('loading-status').classList.add('hidden');
        }

        function finalizeMultiCups() {
            if (multiCupsData.length === 0) return window.showErrorModal("AÃ±ada al menos un suministro.");

            compareMultiOffers();
        }

        function compareMultiOffers() {
            if (multiCupsData.length === 0) return window.showErrorModal("No hay suministros para comparar.");
            
            console.log('=== DIAGNÃ“STICO AHORRO CONSOLIDADO ===');
            console.log('Total CUPS:', multiCupsData.length);
            
            // Verificar si hay comparaciones indexadas
            const hasIndexedComparisons = multiCupsData.some(d => d.indexedComparison);
            console.log('Â¿Hay comparaciones indexadas?', hasIndexedComparisons);
            
            // Mostrar datos de cada CUPS antes de la suma
            multiCupsData.forEach((cups, idx) => {
                console.log(`CUPS ${idx + 1}:`, cups.cups);
                console.log(`  - Original Annual: ${cups.originalBillAnnual}`);
                console.log(`  - Total Annual (Fijo): ${cups.totalAnnual}`);
                console.log(`  - Savings (Fijo): ${cups.savings}`);
                if (cups.indexedComparison) {
                    console.log(`  - âœ… TIENE indexedComparison:`, cups.indexedComparison.offer.name);
                    console.log(`  - Total Annual (Indexado): ${cups.indexedComparison.totalAnnual}`);
                    console.log(`  - Savings (Indexado): ${cups.indexedComparison.savings}`);
                    console.log(`  - originalTariffType (Indexado): ${cups.indexedComparison.originalTariffType}`);
                } else {
                    console.log(`  - âŒ NO tiene indexedComparison`);
                }
            });
            
            // 1. Acumular Totales y Consumos (FIJO)
            const total = multiCupsData.reduce((acc, current) => {
                const newAnnual = current.totalAnnual;  
                
                acc.originalBillAnnual += current.originalBillAnnual;
                acc.totalAnnual += newAnnual;
                acc.totalPeriod += current.importe_total;

                // AcumulaciÃ³n de Potencias y EnergÃ­as
                const type = current.originalTariffType;
                
                for (let i = 1; i <= 6; i++) {
                    const kwKey = `potencia_p${i}_kw`;
                    if (current[kwKey] !== undefined) {
                        const groupKey = (type === '2.0TD' ? '2.0TD' : '3.0TD');
                        
                        if (TARIFF_CONFIG[type]?.powerPeriods >= i || type === '3.0TD') {
                            acc.aggregatedData[groupKey].power[`p${i}`] += current[kwKey] || 0;
                        }
                    }
                }

                if (type === '2.0TD') {
                    acc.aggregatedData[type].energy.e1 += current.consumo_punta || 0;
                    acc.aggregatedData[type].energy.e2 += current.consumo_llano || 0;
                    acc.aggregatedData[type].energy.e3 += current.consumo_valle || 0;
                } else if (type === '3.0TD') {
                    for (let i = 1; i <= 6; i++) {
                        acc.aggregatedData['3.0TD'].energy[`e${i}`] += current[`consumo_p${i}`] || 0;
                    }
                }
                
                return acc;
            }, {
                originalBillAnnual: 0,
                totalAnnual: 0,
                totalPeriod: 0,
                diasFacturados: 0,
                aggregatedData: {
                    '2.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } },
                    '3.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } }
                }
            });

            // 1b. Si hay comparaciones indexadas, acumular tambiÃ©n esos totales
            let totalIndexed = null;
            if (hasIndexedComparisons) {
                totalIndexed = multiCupsData.reduce((acc, current) => {
                    if (current.indexedComparison) {
                        acc.totalAnnual += current.indexedComparison.totalAnnual;
                    }
                    return acc;
                }, {
                    originalBillAnnual: total.originalBillAnnual, // Mismo original
                    totalAnnual: 0,
                    totalPeriod: total.totalPeriod
                });
                
                totalIndexed.savings = totalIndexed.originalBillAnnual - totalIndexed.totalAnnual;
                console.log('Total Indexado acumulado:', totalIndexed);
            }

            // 2. Calcular Ahorro Final Consolidado (FIJO)
            total.savings = total.originalBillAnnual - total.totalAnnual;
            
            console.log('=== TOTALES ACUMULADOS ===');
            console.log('Total originalBillAnnual:', total.originalBillAnnual);
            console.log('Total totalAnnual:', total.totalAnnual);
            console.log('Total savings calculado:', total.savings);

            // 3. Determinar la Oferta de Referencia para el resumen
            let bestOverallWinner = multiCupsData.reduce((best, current) => {
                // If this item has more savings, it becomes the reference.
                if (current.savings > best.savings) return { savings: current.savings, offer: current.offer, originalTariffType: current.originalTariffType };
                return best;
            }, { 
                savings: -1, 
                offer: { name: 'Resultado Consolidado', description: 'N/A', isDrk: false },
                originalTariffType: 'N/A'
            });

            if (total.savings <= 0) {
                bestOverallWinner.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opciÃ³n consolidada", isDrk: false };
                total.savings = 0; // Ensure consistency
            } else {
                // Ahorro positivo: Usar un nombre genÃ©rico para la cabecera
                const genericName = activeBrand.NAME.includes('DRK') ? 'DRK EnergÃ­a' : 'POWER CUP';
                const genericDescription = `Ofrece el mayor ahorro consolidado con ${genericName}.`;

                bestOverallWinner.offer = { 
                    name: genericName, 
                    description: genericDescription, 
                    // Se usa la bandera isDrk basada en el modo de comparaciÃ³n para el styling/branding
                    isDrk: activeBrand.NAME.includes('DRK') 
                };
            }

            const finalResult = {
                cups: `${multiCupsData.length} CUPS`, // String for display
                multiCupsList: multiCupsData.map(d => `${d.cups} (${d.originalTariffType})`).join(', '),
                dias_facturados: total.diasFacturados, // Should remain N/A or 0 for multi-cups
                importe_total: total.totalPeriod,
                originalBillAnnual: total.originalBillAnnual,
                totalAnnual: total.totalAnnual,
                savings: total.savings,
                offer: bestOverallWinner.offer, // Use the (potentially generic) offer for the header display
                isMulti: true,
                isMultiCups: true, // IMPORTANTE: AÃ±adir esta propiedad para que se detecte correctamente
                individualResults: multiCupsData, // AÃ±adir resultados individuales para el desglose HTML
                aggregatedData: total.aggregatedData,
                // AÃ±adir datos indexados si existen
                indexedTotals: totalIndexed // SerÃ¡ null si no hay comparaciones indexadas
            };
            
            console.log('finalResult created:', finalResult);
            if (totalIndexed) {
                console.log('finalResult incluye datos indexados:', totalIndexed);
            }
            
            lastComparisonResult = finalResult;
            
            // --- LÃ“GICA DE BRANDING (MultiCups) ---
            let brandToApply = activeBrand;
            
            if (comparisonMode === 'overall_best') {
                // REQUERIMIENTO DEL USUARIO: Si es modo Power Cup Global, siempre usa Power Cup.
                brandToApply = BRANDS.POWER_CUP;
            } else {
                // DRK modes (drk_only, drk_prioritized)
                if (finalResult.savings <= 0) {
                    // No savings, stick to the initial DRK brand
                    brandToApply = BRANDS.DRK;
                } else if (bestOverallWinner.offer.isDrk) {
                    // DRK won overall combo -> Use DRK brand
                    brandToApply = BRANDS.DRK;
                } else {
                    // Competitor won overall combo in a DRK mode -> Use Power Cup (general market/non-DRK saving)
                    brandToApply = BRANDS.POWER_CUP;
                }
            }
            
            applyBrandStyles(brandToApply);
            
            renderMultiResultsUI(finalResult);
            
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('animate-fade-in-up');
        }


        // Nueva funciÃ³n para renderizar comparaciÃ³n dual en MULTICUPS
        function renderMultiDualComparisonUI(res) {
            console.log('renderMultiDualComparisonUI llamada', res);
            
            // IMPORTANTE: Asegurar que la variable global estÃ© guardada
            if (!lastComparisonResult) {
                lastComparisonResult = res;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CRÃTICO: Colores dinÃ¡micos segÃºn marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BOTÃ“N ROJO DE VOLVER (RECARGA PÃGINA)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>â¬…ï¸ VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”„ RECARGANDO PÃGINA (MULTICUPS)...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN BOTÃ“N ROJO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Banner
            const companyBanner = document.getElementById('company-banner');
            
            // CRÃTICO: Usar colores dinÃ¡micos segÃºn marca
            if (isDrk) {
                // DRK - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">Liderando el ahorro y la eficiencia energÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            }
            
            // CUPS list
            document.getElementById('results-cups-list').innerHTML = `
                Total: ${res.cups} - <span class="text-xs">${res.multiCupsList}</span>
            `;
            
            // Calcular totales indexados
            const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            // Vista con TRES COLUMNAS (similar a individual pero con totales MULTICUPS)
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <h2 class="text-xl font-black text-slate-800 mb-4 text-center">
                        ðŸ“Š COMPARATIVA MULTICUPS: ${res.cups}
                    </h2>
                    
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">TU FACTURA ACTUAL</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(res.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">Total Periodo (${res.dias_facturados || 'varios'} dÃ­as)</p>
                                <p class="text-2xl font-black text-red-600">${eur(res.originalBillAnnual)}/aÃ±o</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCIÃ“N - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS FIJAS</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(res.totalAnnual / 12)}/mes</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3">Estimado Mensual</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(res.totalAnnual)}/aÃ±o</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCIÃ“N - INDEXADO (Verde) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${isDrk ? 'DRK' : 'POWER CUP'} - TARIFAS INDEXADAS</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(totalIndexadoAnual / 12)}/mes</p>
                                <p class="text-xs text-green-700 mb-3">Estimado Mensual</p>
                                <p class="text-2xl font-black text-green-900">${eur(totalIndexadoAnual)}/aÃ±o</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">ðŸ’¼ TU AHORRO CON TARIFAS FIJAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(res.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado total</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">âš¡ TU AHORRO CON TARIFAS INDEXADAS</p>
                            <p class="text-4xl font-black text-green-600">${eur(ahorroIndexado)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado total</p>
                        </div>
                    </div>
                    
                    <!-- LISTADO DE CUPS -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-4">
                        <h3 class="text-sm font-black text-slate-800 mb-3 text-center">
                            ðŸ“‹ DETALLE POR SUMINISTRO
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4 text-xs">
                            <!-- Lista FIJAS -->
                            <div>
                                <p class="font-bold text-blue-700 mb-2">ðŸ’¼ TARIFAS FIJAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => `
                                        <div class="bg-white rounded p-2 border border-blue-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups.slice(-12)}</span>
                                                <span class="font-bold text-green-600">${eur(supply.savings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${supply.offer.name}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Lista INDEXADAS -->
                            <div>
                                <p class="font-bold text-green-700 mb-2">âš¡ TARIFAS INDEXADAS:</p>
                                <div class="space-y-2">
                                    ${res.individualResults.map((supply, idx) => {
                                        const indexedOffer = supply.indexedComparison ? supply.indexedComparison.offer : null;
                                        const indexedSavings = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                                        return `
                                        <div class="bg-white rounded p-2 border border-green-200">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-mono text-slate-600">${supply.cups.slice(-12)}</span>
                                                <span class="font-bold text-green-600">${eur(indexedSavings)}</span>
                                            </div>
                                            <div class="text-slate-700">
                                                <span class="font-semibold">${indexedOffer ? indexedOffer.name : 'N/A'}</span>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>âš ï¸ Importante:</strong> El PDF y HTML incluirÃ¡n el desarrollo detallado de cÃ¡lculos para cada CUPS, 
                            mostrando las fÃ³rmulas completas de potencia y energÃ­a tanto para tarifas fijas como indexadas.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el botÃ³n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que estÃ© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el botÃ³n "Realizar Nueva ComparaciÃ³n" estÃ© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        /**
         * Rellena la vista de resultados con los datos acumulados para MULTICUPS.
         * @param {Object} res - Resultado final de la comparaciÃ³n acumulada.
         */
        function renderMultiResultsUI(res) {
            // Si hay resultados indexados, usar vista de comparaciÃ³n dual
            if (res.indexedTotals) {
                renderMultiDualComparisonUI(res);
                return;
            }
            
            // Si no hay resultados indexados, continuar con la vista normal
            const offer = res.offer;
            let brand = activeBrand; // Use activeBrand set by comparisonMode
            const individualResults = res.individualResults;
            const aggregatedData = res.aggregatedData;
            const isDrk = brand.NAME.includes('DRK');
            
            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa dinÃ¡mico para MultiCups
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERGÃA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">Liderando el ahorro y la eficiencia energÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen Global
            document.getElementById('results-cups-list').innerHTML = `
                CUPS Procesadas: ${individualResults.length}
            `;

            // MODIFICACIÃ“N: Mostrar Nombre y DescripciÃ³n.
            // Si el nombre es genÃ©rico ("Tu Mejor ElecciÃ³n"), solo mostramos el nombre en H2 y la descripciÃ³n en el pÃ¡rrafo.
            if (res.isMulti && res.savings > 0 && offer.name !== "Tu Tarifa Actual") {
                document.getElementById('best-offer-name').textContent = offer.name;
                document.getElementById('best-offer-desc').textContent = offer.description;
            } else {
                // OpciÃ³n 'Tu Tarifa Actual' o individual (mantiene el formato combinado)
                document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
                document.getElementById('best-offer-desc').textContent = offer.description;
            }
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color dinÃ¡micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.savings <= 0) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "Â¡ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">Actualmente estÃ¡s en una buena tarifa.</div><div class="text-sm mt-3 leading-relaxed">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL CONSOLIDADO";
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');
            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                newCostLabelEl.textContent = `TU NUEVO COSTE ${brand.NAME.includes('DRK') ? 'DRK' : 'POWER CUP'} CONSOLIDADO`;
                oldCostPeriodEl.classList.add('line-through', 'text-red-400', 'decoration-red-400/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + "/aÃ±o";
            document.getElementById('old-period-days-label').textContent = `Total Periodo (Variado)`; // DÃ­as varÃ­an por factura
            
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + "/mes";
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + "/aÃ±o";
            
            
            // 2. Nuevo: Resumen de Suministros (Tipo, CUPS, Ahorro Individual)
            let summaryListHTML = individualResults.map((resItem, index) => {
                // MODIFICACIÃ“N #2: Eliminar "Sin Ahorro" en la vista interna, dejando un espacio.
                const savingsText = resItem.isNegativeSavings ? `&nbsp;` : `(Ahorro: ${eur(resItem.savings)})`;
                return `<div class="flex justify-between items-center py-1 border-b border-slate-100 last:border-b-0">
                    <span class="font-bold text-sm text-slate-700">${resItem.cups}</span>
                    <span class="text-xs text-drk-800 font-semibold">${resItem.originalTariffType}</span>
                    <span class="text-xs ${resItem.isNegativeSavings ? 'text-slate-500' : 'text-cta-green-600 font-medium'}">${savingsText}</span>
                </div>`;
            }).join('');

            const supplySummarySection = `
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-3" style="border-left-color: ${brand.QR_CENTER_BG};">Resumen de Suministros AÃ±adidos</h3>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6 space-y-1">
                    ${summaryListHTML}
                </div>
            `;


            // 3. Datos Acumulados Agrupados por Tarifa
            let totalEnergy = 0;
            Object.keys(aggregatedData).forEach(type => {
                // Solo iteramos 2.0TD y 3.0TD, ya que 6.1TD ya no existe en el estado global
                Object.values(aggregatedData[type].energy).forEach(kwh => {
                    totalEnergy += kwh;
                });
            });
            
            // Helper para generar el HTML del grupo
            function generateGroupedDataHTML(type, data, powerPeriods, energyPeriods) {
                const is20TD = type === '2.0TD';
                
                const hasPower = Object.values(data.power).slice(0, powerPeriods).some(v => v > 0);
                const hasEnergy = Object.values(data.energy).slice(0, energyPeriods).some(v => v > 0);
                
                if (!hasPower && !hasEnergy) return '';  

                let energyRows = '';
                let totalGroupEnergy = 0;
                for (let i = 1; i <= energyPeriods; i++) {
                    const kwh = data.energy[`e${i}`] || 0;
                    if (kwh > 0) {
                        let label = `E${i}`;
                        if (is20TD) {
                            if (i === 1) label += ' (Punta)';
                            if (i === 2) label += ' (Llano)';
                            if (i === 3) label += ' (Valle)';
                        }
                        energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label} (Acumulado)</span><span class="font-mono">${num(kwh, 0)} kWh</span></div>`;
                        totalGroupEnergy += kwh;
                    }
                }

                let powerRows = '';
                for (let i = 1; i <= powerPeriods; i++) {
                    const kw = data.power[`p${i}`] || 0;
                    if (kw > 0) {
                        powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${i} (Acumulado)</span><span class="font-mono">${num(kw, 2)} kW</span></div>`;
                    }
                }

                // Eliminamos la referencia a 6.1 TD en el tÃ­tulo, ya que el tipo 3.0TD ahora lo engloba todo
                const title = is20TD ? '2.0 TD (Hogar/Negocio)' : '3.0 TD (Industria/Gran Consumo)';

                return `
                    <div class="border-t pt-4 mt-4 first:border-t-0 first:pt-0 first:mt-0">
                        <p class="font-black text-base ${brand.PRIMARY_TEXT} mb-3">${title}</p>
                        
                        <p class="font-bold text-slate-700 mt-2 mb-1">Consumos (kWh)</p>
                        ${energyRows || '<p class="text-xs text-slate-400">No hay consumos para este tipo.</p>'}
                        ${totalGroupEnergy > 0 ? `<div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1 border-slate-200"><span>Total Consumo ${type}</span><span>${num(totalGroupEnergy, 0)} kWh</span></div>` : ''}
                        
                        <p class="font-bold text-slate-700 mt-4 mb-1">Potencias (kW)</p>
                        ${powerRows || '<p class="text-xs text-slate-400">No hay potencias para este tipo.</p>'}
                    </div>
                `;
            }

            let accumulatedSectionsHTML = '';
            accumulatedSectionsHTML += generateGroupedDataHTML('2.0TD', aggregatedData['2.0TD'], 2, 3);  
            accumulatedSectionsHTML += generateGroupedDataHTML('3.0TD', aggregatedData['3.0TD'], 6, 6);  

            const correctedConsumptionHTML = `
                <div class="grid grid-cols-1 gap-4">
                    <div class="col-span-1 border-b pb-2 mb-2">
                        <div class="flex justify-between items-center ${brand.PRIMARY_TEXT}">
                            <span class="text-sm font-black uppercase">TOTAL ENERGÃA</span>
                            <span class="text-xl font-black">${num(totalEnergy, 0)} kWh</span>
                        </div>
                    </div>
                    ${accumulatedSectionsHTML}
                </div>
            `;

            // --- 4. Precios de la Oferta Consolidada (Dynamic Winner) ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);
            let tariffPricesHTML = '';
            const consolidatedPrices = [];
            const brandPrimaryText = brand.PRIMARY_TEXT;
            const isPowerCupMode = comparisonMode === 'overall_best';

            // Determine the label for the price section
            let priceSectionLabel;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                // Modo DRK con ofertas DRK
                priceSectionLabel = 'Precios de las Ofertas Seleccionadas (DRK ENERGÃA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                // Modo POWER CUP sin DRK
                priceSectionLabel = 'Precios de las Ofertas Seleccionadas (POWER CUP GLOBAL)';
            } else {
                // Mixto o general
                priceSectionLabel = 'Precios de las Ofertas Seleccionadas';
            }

            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            const color800 = brand.PRIMARY_TEXT.replace('text-', ''); // Get dynamic color: text-drk-800 -> drk-800

            // Add 2.0TD Prices - TODAS las ofertas Ãºnicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`;
                    
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</h5>
                            <div class="grid grid-cols-2 gap-x-4 text-xs">
                                <p class="text-slate-500">P1 (â‚¬/kW/dÃ­a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p1)}</p>
                                <p class="text-slate-500">P2 (â‚¬/kW/dÃ­a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p2)}</p>
                                <p class="text-slate-500 mt-2 col-span-2 font-bold text-cta-green-600">ENERGÃA (â‚¬/kWh)</p>
                                <p class="text-slate-500">E1 (Punta):</p><p class="font-mono font-bold text-right">${numPriceFormula(e1)}</p>
                                <p class="text-slate-500">E2 (Llano):</p><p class="font-mono font-bold text-right">${numPriceFormula(e2)}</p>
                                <p class="text-slate-500">E3 (Valle):</p><p class="font-mono font-bold text-right">${numPriceFormula(e3)}</p>
                            </div>
                        </div>
                    `);
                });
            }

            // Add 3.0TD Prices - TODAS las ofertas Ãºnicas
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<p class="text-slate-500">P${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</p>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<p class="text-slate-500">E${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p${i}_price`])}</p>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-red-500 mb-1">POTENCIA (â‚¬/kW/dÃ­a)</div>
                                ${pRows}
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-green-600 mt-2 mb-1 border-t pt-2">ENERGÃA (â‚¬/kWh)</div>
                                ${eRows}
                            </div>
                        </div>
                    `);
                });
            }

            if (consolidatedPrices.length > 0) {
                tariffPricesHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                        <h4 class="font-bold text-lg ${brandPrimaryText} mb-3">${priceSectionLabel}</h4>
                        ${consolidatedPrices.join('')}
                        <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS aÃ±adidas.</p>
                    </div>
                `;
            }

            // 5. Desglose detallado de CADA CUPS (Se mantiene)

            let allBreakdownsHTML = '';

            individualResults.forEach((resItem, index) => {
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                // MODIFICACIÃ“N: Usar el campo con mÃ¡s informaciÃ³n para DRK
                const appliedOfferName = resItem.offer.isDrk 
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                let energyBreakdown = '';
                resItem.energyCosts.forEach(e => {
                    let label = `E${e.period}`;
                    if (resItem.originalTariffType === '2.0TD') {
                        if (e.period === 1) label += ' (Punta)';
                        if (e.period === 2) label += ' (Llano)';
                        if (e.period === 3) label += ' (Valle)';
                    }
                    
                    if (e.period <= periods) {
                        energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span><span>${num(e.cost, 2)} â‚¬</span></div>`;
                    }
                });

                let powerBreakdown = '';
                resItem.powerCosts.forEach(p => {
                    if (p.period <= powerPeriods) {
                        powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/dÃ­a)</span><span>${num(p.cost, 2)} â‚¬</span></div>`;
                    }
                });
                
                const statusText = resItem.isNegativeSavings ? 
                    `<p class="text-sm font-bold text-cta-red-600 mb-2">âš ï¸ TU TARIFA ACTUAL es la mejor</p>` :
                    `<p class="text-sm font-bold text-cta-green-600 mb-2">ðŸ’° AHORRO ANUAL: ${eur(resItem.savings)}</p>`;

                allBreakdownsHTML += `
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-lg text-sm">
                               <h4 class="text-lg font-black text-slate-800 border-b pb-2 mb-3">Suministro ${index + 1}: ${resItem.cups} (${resItem.originalTariffType})</h4>
                               ${statusText}
                               <p class="text-xs text-slate-500 mb-3">Tarifa aplicada en el cÃ¡lculo: <span class="font-bold text-slate-700">${appliedOfferName}</span></p>
                               <div class="grid grid-cols-2 gap-4 border-b border-slate-200 pb-3 mb-3">
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">Factura Actual Periodo</p>
                                       <p class="font-bold text-cta-red-500">${eur(resItem.importe_total)}</p>
                                   </div>
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">Nuevo Coste Periodo</p>
                                       <p class="font-black ${brand.PRIMARY_TEXT}">${eur(resItem.totalPeriod)}</p>
                                   </div>
                               </div>

                               <p class="font-bold text-slate-800 mb-2">Desglose (${appliedOfferName}):</p>
                               
                               <div class="pl-2 space-y-2 font-mono text-xs">
                                   <p class="font-bold text-slate-700">POTENCIA</p>
                                   ${powerBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>Subtotal Potencia</span><span>${num(resItem.subPower, 2)} â‚¬</span></div>
                                   
                                   <p class="font-bold text-slate-700 pt-2">ENERGÃA</p>
                                   ${energyBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>Subtotal EnergÃ­a (Neto)</span><span>${num(resItem.subEnergyNet, 2)} â‚¬</span></div>
                                   
                                   <div class="flex justify-between font-black ${brand.PRIMARY_TEXT} pt-2"><span>TOTAL CON IMPUESTOS</span><span>${eur(resItem.totalPeriod)}</span></div>
                               </div>
                    </div>
                `;
            });


            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                ${supplySummarySection}
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos Acumulados</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${correctedConsumptionHTML}</div>
                
                ${tariffPricesHTML}
                
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">Desglose Individual por Suministro</h3>
                <p class="text-sm text-slate-500 mb-4 pl-3">A continuaciÃ³n, se muestra el cÃ¡lculo detallado de la mejor oferta para cada CUPS, por orden de introducciÃ³n:</p>
                <div id="cost-breakdown-multi" class="space-y-4">
                    ${allBreakdownsHTML}
                </div>
            `;
        }
        
        /**
         * Rellena la vista de resultados con los datos calculados (UNIDAD).
         * @param {Object} res - Resultado final de la comparaciÃ³n.
         */
        // Nueva funciÃ³n para renderizar comparaciÃ³n dual (Fijo vs Indexado)
        function renderDualComparisonUI(resFijo, resIndexed) {
            console.log('ðŸ”¥ðŸ”¥ðŸ”¥ renderDualComparisonUI INICIADO ðŸ”¥ðŸ”¥ðŸ”¥');
            console.log('renderDualComparisonUI llamada', resFijo, resIndexed);
            
            // IMPORTANTE: Asegurar que las variables globales estÃ©n guardadas
            if (!lastComparisonResult) {
                lastComparisonResult = resFijo;
            }
            if (!lastIndexedResult) {
                lastIndexedResult = resIndexed;
            }
            
            const brand = activeBrand;
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            
            // CRÃTICO: Colores dinÃ¡micos segÃºn marca
            const isDrk = brand.NAME.includes('DRK');
            const brandPrefix = isDrk ? 'drk' : 'powercup';  // drk (azul) o powercup (verde)
            
            console.log('ðŸŽ¨ Marca detectada:', brand.NAME, '| isDrk:', isDrk, '| Prefix:', brandPrefix);
            console.log('ðŸŽ¨ Preparando para generar banner...');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BOTÃ“N ROJO DE VOLVER (RECARGA PÃGINA)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let backButtonContainer = document.getElementById('back-button-top-container');
            if (!backButtonContainer) {
                backButtonContainer = document.createElement('div');
                backButtonContainer.id = 'back-button-top-container';
                backButtonContainer.className = 'fixed top-0 left-0 right-0 z-[100] bg-white shadow-lg p-3 border-b-4 border-red-500';
                backButtonContainer.innerHTML = `
                    <div class="max-w-lg mx-auto">
                        <button id="force-back-button" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black py-4 px-6 rounded-xl shadow-2xl transform transition active:scale-95 flex items-center justify-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>â¬…ï¸ VOLVER AL INICIO</span>
                        </button>
                    </div>
                `;
                document.body.insertBefore(backButtonContainer, document.body.firstChild);
                
                document.getElementById('force-back-button').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”„ RECARGANDO PÃGINA...');
                    window.location.reload();
                });
            }
            backButtonContainer.style.display = 'block';
            
            const resultsView = document.getElementById('results-view');
            if (resultsView) {
                resultsView.style.paddingTop = '80px';
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN BOTÃ“N ROJO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Banner de empresa
            const companyBanner = document.getElementById('company-banner');
            
            // CRÃTICO: Usar colores dinÃ¡micos segÃºn marca
            if (isDrk) {
                // DRK - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">Liderando el ahorro y la eficiencia energÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado y mÃ¡s grande
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">${brand.FULL_NAME}</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
                console.log('âœ… Banner POWER CUP GENERADO en renderDualComparisonUI');
            }
            
            console.log('ðŸŽ¨ Banner generado. Continuando con CUPS...');
            
            // CUPS
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700">${resFijo.cups}</span>
            `;
            
            // Vista con TRES COLUMNAS
            const resultCard = document.getElementById('result-card');
            resultCard.innerHTML = `
                <div class="p-4">
                    <!-- TRES COLUMNAS -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <!-- COLUMNA 1: TU FACTURA ACTUAL -->
                        <div class="text-center">
                            <div class="bg-slate-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">TU FACTURA ACTUAL</p>
                            </div>
                            <div class="bg-white border-2 border-slate-300 rounded-b-lg p-3">
                                <p class="text-xs text-slate-500 mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <p class="text-2xl font-black text-red-600 line-through mb-2">${eur(resFijo.originalBillPeriod || resFijo.importe_total)}</p>
                                <p class="text-xs text-slate-500 mb-3">Total Periodo (${resFijo.dias_facturados || 0} dÃ­as)</p>
                                <p class="text-2xl font-black text-red-600">${eur(resFijo.originalBillAnnual)}/aÃ±o</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 2: LA MEJOR OPCIÃ“N - FIJO (Color de marca) -->
                        <div class="text-center">
                            <div class="${isDrk ? 'bg-drk-600' : 'bg-powercup-600'} text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="${isDrk ? 'bg-drk-50 border-drk-400' : 'bg-powercup-50 border-powercup-400'} border-2 rounded-b-lg p-3">
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-2 font-bold">${resFijo.offer.name}</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'} mb-2">${eur(resFijo.totalAnnual / 12)}/mes</p>
                                <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mb-3">Estimado Mensual</p>
                                <p class="text-2xl font-black ${isDrk ? 'text-drk-900' : 'text-powercup-900'}">${eur(resFijo.totalAnnual)}/aÃ±o</p>
                            </div>
                        </div>
                        
                        <!-- COLUMNA 3: LA MEJOR OPCIÃ“N PARA TI ES [MARCA] (INDEXADO) -->
                        <div class="text-center">
                            <div class="bg-green-600 text-white py-2 px-2 rounded-t-lg">
                                <p class="text-xs font-bold uppercase">LA MEJOR OPCIÃ“N PARA TI ES ${isDrk ? 'DRK' : 'POWER CUP'}</p>
                            </div>
                            <div class="bg-green-50 border-2 border-green-400 rounded-b-lg p-3">
                                <p class="text-xs text-green-700 mb-2 font-bold">${resIndexed.offer.name}</p>
                                <p class="text-2xl font-black text-green-900 mb-2">${eur(resIndexed.totalAnnual / 12)}/mes</p>
                                <p class="text-xs text-green-700 mb-3">Estimado Mensual</p>
                                <p class="text-2xl font-black text-green-900">${eur(resIndexed.totalAnnual)}/aÃ±o</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AHORROS -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="${isDrk ? 'bg-drk-100 border-drk-400' : 'bg-powercup-100 border-powercup-400'} border-2 rounded-xl p-4 text-center">
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} font-bold uppercase mb-2">ðŸ’¼ TU AHORRO CON TARIFA FIJA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resFijo.savings)}</p>
                            <p class="text-xs ${isDrk ? 'text-drk-700' : 'text-powercup-700'} mt-1">Ahorro anual estimado</p>
                        </div>
                        <div class="bg-green-100 border-2 border-green-400 rounded-xl p-4 text-center">
                            <p class="text-xs text-green-700 font-bold uppercase mb-2">âš¡ TU AHORRO CON TARIFA INDEXADA</p>
                            <p class="text-4xl font-black text-green-600">${eur(resIndexed.savings)}</p>
                            <p class="text-xs text-green-700 mt-1">Ahorro anual estimado</p>
                        </div>
                    </div>
                    
                    <!-- NOTA IMPORTANTE -->
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900">
                            <strong>âš ï¸ Importante:</strong> La tarifa indexada puede variar mensualmente segÃºn el mercado elÃ©ctrico. 
                            Los valores mostrados son estimaciones basadas en precios actuales.
                        </p>
                    </div>
                </div>
            `;
            
            // Configurar el botÃ³n existente (NO crear uno nuevo)
            const sendOfferBtn = document.getElementById('send-offer-btn');
            if (sendOfferBtn) {
                sendOfferBtn.style.display = 'flex'; // Asegurar que estÃ© visible
                sendOfferBtn.onclick = () => {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                };
            }
            
            // Ocultar detalles
            document.getElementById('details-toggle-btn').style.display = 'none';
            document.getElementById('details-container').style.display = 'none';
            
            // IMPORTANTE: Asegurar que el botÃ³n "Realizar Nueva ComparaciÃ³n" estÃ© visible y funcional
            const resetButton = document.querySelector('#results-view button[onclick="resetToLanding()"]');
            if (resetButton) {
                resetButton.style.display = 'flex';
                resetButton.style.visibility = 'visible';
                resetButton.classList.remove('hidden');
            }
        }
        function renderResultsUI(res, resIndexed = null) {
            // Si hay resultado indexado, usar vista de comparaciÃ³n dual
            if (resIndexed) {
                renderDualComparisonUI(res, resIndexed);
                return;
            }
            
            // Si no hay resultado indexado, renderizar como siempre
            try {
                console.log('renderResultsUI called with:', res);
                
                const offer = res.offer;
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.tariffType || currentTariffType;
                // Usamos TARIFF_CONFIG[tariffType] y si no existe (ej: 6.1TD residual), se usa un fallback seguro, aunque ya hemos limpiado el estado
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD']; 

                console.log('Rendering with tariffType:', tariffType, 'Brand:', brand.NAME);

            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa dinÃ¡mico
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // DRK - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">DRK ENERGÃA</h1>
                                <p class="text-drk-100 text-lg md:text-xl font-semibold">Liderando el ahorro y la eficiencia energÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-drk-100 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-drk-100 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                // POWER CUP - Banner mejorado
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-powercup-700 via-powercup-600 to-powercup-500 p-8 md:p-12 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex flex-col md:flex-row items-center gap-6 flex-1">
                            <div class="transform scale-125">
                                ${brand.LOGO_SVG}
                            </div>
                            <div class="text-center md:text-left">
                                <h1 class="text-white text-4xl md:text-5xl font-black tracking-tight mb-2">POWER CUP</h1>
                                <p class="text-powercup-50 text-lg md:text-xl font-semibold">AsesorÃ­a EnergÃ©tica</p>
                            </div>
                        </div>
                        <div class="text-center md:text-right bg-white/10 backdrop-blur-sm rounded-xl p-4">
                            <p class="text-white text-sm md:text-base font-bold uppercase tracking-wider">ðŸ“Š ESTUDIO DE AHORRO</p>
                            <p class="text-powercup-50 text-xl md:text-2xl font-black mt-1">COMPARATIVA</p>
                            <p class="text-powercup-50 text-base md:text-lg font-bold">PROFESIONAL</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700" id="cups-value">${res.cups}</span>
            `;
            
            // MODIFICACIÃ“N: Mostrar Comercializadora - Tarifa
            document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
            document.getElementById('best-offer-desc').textContent = offer.description;
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color dinÃ¡micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.isNegativeSavings) {
                // Mensaje especial cuando no hay ahorro
                document.getElementById('savings-label').textContent = "Â¡ENHORABUENA!";
                savingsEl.innerHTML = `<div class="text-lg leading-tight font-bold">Actualmente estÃ¡s en una buena tarifa.</div><div class="text-sm mt-3 leading-relaxed">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</div>`;
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                savingsEl.classList.remove('text-5xl', 'font-black');
                savingsEl.classList.add('text-base');
                
                // Ocultar columnas de precios
                document.getElementById('price-columns').style.display = 'none';
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL";
                
                // Si no hay ahorro, el coste actual es el "bueno", sin tachar
                oldCostPeriodEl.classList.remove('line-through');
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through');
                oldCostAnnualEl.classList.add('text-cta-green-500');

            } else {
                document.getElementById('savings-label').textContent = "TU AHORRO ANUAL ESTIMADO";
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                savingsEl.classList.add('text-5xl', 'font-black');
                savingsEl.classList.remove('text-base');
                
                // Mostrar columnas de precios
                document.getElementById('price-columns').style.display = 'grid';
                
                newCostLabelEl.textContent = `TU NUEVO COSTE ${isDrk ? 'DRK' : 'POWER CUP'}`;
                
                // Tachar el coste antiguo
                oldCostPeriodEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + "/aÃ±o";
            document.getElementById('old-period-days-label').textContent = `Total Periodo (${res.dias_facturados} dÃ­as)`;
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + "/mes";
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + "/aÃ±o";
            
            // 2. Desglose (Datos ExtraÃ­dos)
            let energyRows = '';
            res.energyCosts.forEach(e => {
                let label = `E${e.period}`;
                if (tariffType === '2.0TD') {
                    if (e.period === 1) label += ' (Punta)';
                    if (e.period === 2) label += ' (Llano)';
                    if (e.period === 3) label += ' (Valle)';
                }
                if(e.kwh > 0 || e.period <= config.periods) {
                    energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label}</span><span class="font-mono">${num(e.kwh, 0)} kWh</span></div>`;
                }
            });
            const totalEnergy = res.energyCosts.reduce((sum, e) => sum + e.kwh, 0);

            let powerRows = '';
            res.powerCosts.forEach(p => {
                if(p.kw > 0 || p.period <= config.powerPeriods) {
                    powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${p.period}</span><span class="font-mono">${num(p.kw, 2)} kW</span></div>`;
                }
            });

            const consumptionHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">Periodo</p><p class="font-bold text-slate-700">${res.dias_facturados} dÃ­as</p></div>
                    <div><p class="text-xs text-slate-500">Fechas</p><p class="font-bold text-slate-700 text-xs">${res.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Consumo por Periodo (kWh)</p>
                        ${energyRows}
                        <div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1"><span>Total Consumo</span><span>${num(totalEnergy, 0)} kWh</span></div>  
                    </div>
                    <div class="col-span-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Potencia Contratada (kW)</p>
                        ${powerRows}
                    </div>
                </div>
            `;

            // 3. Desglose (CÃ¡lculo Oficial)
            let powerBreakdown = '';
            res.powerCosts.forEach(p => {
                if (p.kw > 0 || p.period <= config.powerPeriods) {
                    powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/dÃ­a)</span><span>${num(p.cost, 2)} â‚¬</span></div>`;
                }
                });
                
            let energyBreakdown = '';
            res.energyCosts.forEach(e => {
                if (e.kwh > 0 || e.period <= config.periods) {
                    let label = `E${e.period}`;
                    if (tariffType === '2.0TD') {
                        if (e.period === 1) label += ' (Punta)';
                        if (e.period === 2) label += ' (Llano)';
                        if (e.period === 3) label += ' (Valle)';
                    }
                    energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span><span>${num(e.cost, 2)} â‚¬</span></div>`;
                }
                });

            let discountRowsHtml = res.discountAmount > 0 ? `
                <div class="flex justify-between font-bold text-cta-red-500 mt-2">
                    <span>Descuento Aplicado (${num(res.discountRate * 100, 0)}%)</span>
                    <span>-${num(res.discountAmount, 2)} â‚¬</span>
                </div>
                <div class="flex justify-between font-bold text-slate-800 border-t border-dashed mt-1 pt-1">
                    <span>Subtotal EnergÃ­a (Neto)</span>
                    <span>${num(res.subEnergyNet, 2)} â‚¬</span>
                </div>
            ` : '';

            const breakdownHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>SimulaciÃ³n ${res.dias_facturados} dÃ­as</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">POTENCIA (â‚¬/kW DÃ­a)</p>
                        ${powerBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal Potencia</span><span>${num(res.subPower, 2)} â‚¬</span></div>
                    </div>

                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">ENERGÃA (â‚¬/kWh)</p>
                        ${energyBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal EnergÃ­a (Bruto)</span><span>${num(res.subEnergy, 2)} â‚¬</span></div>
                        ${discountRowsHtml}
                    </div>

                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span>SUBTOTAL BASE (P+E)</span><span>${num(res.subBase, 2)} â‚¬</span></div>
                        <div class="flex justify-between"><span>Imp. ElÃ©c. (${num(res.ieRate * 100, 3)}%)</span><span>${num(res.costIE, 2)} â‚¬</span></div>
                        <div class="flex justify-between font-bold text-lg border-t mt-1 pt-1"><span>BASE IMPONIBLE</span><span>${num(res.baseImp, 2)} â‚¬</span></div>
                        <div class="flex justify-between"><span>IVA (21%)</span><span>${num(res.costIVA, 2)} â‚¬</span></div>
                    </div>
                    
                    <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1 mt-4"><span>TOTAL FACTURA</span><span>${eur(res.totalPeriod)}</span></div>
                    <div class="text-center mt-2 ${brand.PRIMARY_TEXT} font-bold">Total Anual Estimado: ${eur(res.totalAnnual)}</div>
                </div>
            `;
            
            // NUEVO: Generar resumen de precios consolidados
            let preciosHTML = '';
            if (offer.name !== 'Tu Tarifa Actual') {
                const nombreCompleto = offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name;
                
                if (tariffType === '2.0TD') {
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 2.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 gap-x-4 text-xs">
                                    <p class="text-slate-500">P1 (â‚¬/kW/dÃ­a):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[0].priceDay)}</p>
                                    <p class="text-slate-500">P2 (â‚¬/kW/dÃ­a):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[1].priceDay)}</p>
                                    <p class="text-slate-500 mt-2 col-span-2 font-bold text-green-600">ENERGÃA (â‚¬/kWh)</p>
                                    <p class="text-slate-500">E1 (Punta):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[0].price)}</p>
                                    <p class="text-slate-500">E2 (Llano):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[1].price)}</p>
                                    <p class="text-slate-500">E3 (Valle):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[2].price)}</p>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                } else if (tariffType === '3.0TD') {
                    let filasPotencia = '';
                    for(let i = 0; i < 6; i++) {
                        filasPotencia += `<p class="text-slate-500">P${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[i].priceDay)}</p>`;
                    }
                    let filasEnergia = '';
                    for(let i = 0; i < 6; i++) {
                        filasEnergia += `<p class="text-slate-500">E${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[i].price)}</p>`;
                    }
                    
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 3.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                    <div class="col-span-2 md:col-span-4 font-bold text-red-500 mb-1">POTENCIA (â‚¬/kW/dÃ­a)</div>
                                    ${filasPotencia}
                                    <div class="col-span-2 md:col-span-4 font-bold text-green-600 mt-2 mb-1 border-t pt-2">ENERGÃA (â‚¬/kWh)</div>
                                    ${filasEnergia}
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                }
            }
            
            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos ExtraÃ­dos</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${consumptionHTML}</div>
                ${preciosHTML}
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">CÃ¡lculo Oficial</h3>
                <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm">
                    ${breakdownHTML}
                </div>
            `;
            
            console.log('renderResultsUI completed successfully');
            } catch (error) {
                console.error('Error in renderResultsUI:', error);
                window.showErrorModal(`Error al mostrar resultados: ${error.message}`);
            }
        }
        
        // --- COPIA HTML MEJORADA ---

        async function handleCopyOffer() {
            console.log('handleCopyOffer llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed
            });
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaciÃ³n.");
            }
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el CÃ³digo Comercial.");

            try {
                // 1. Generar el HTML
                let htmlContent = '';
                
                // IMPORTANTE: Detectar si hay resultado indexado para generar HTML dual
                if (lastIndexedResult && compareWithIndexed) {
                    // Si hay resultado indexado, generar HTML dual
                    if (lastComparisonResult.isMultiCups) {
                        // MULTICUPS con Ã­ndice - generar HTML especial
                        htmlContent = generateMultiDualStyledHtmlOffer(commercialCode);
                    } else {
                        // Individual con Ã­ndice - generar HTML especial
                        htmlContent = generateDualStyledHtmlOffer(commercialCode, lastComparisonResult, lastIndexedResult);
                    }
                } else {
                    // Modo normal (sin indexado)
                    if (lastComparisonResult.isMulti) {
                        htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                    } else {
                        htmlContent = generateStyledHtmlOffer(commercialCode);
                    }
                }
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                // Seleccionar y copiar
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal("âœ… Â¡Oferta copiada con Ã©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseÃ±o visual en su correo de escritorio.");
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal("No se pudo copiar el diseÃ±o visual. Intente desde un PC o contacte a soporte.");
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        // --- GENERACIÃ“N DE PDF CON COMPARACIÃ“N DUAL (FIJO VS INDEXADO) CON DESARROLLO COMPLETO ---
        
        async function generatePDF_Dual(resFijo, resIndexed) {
            try {
                console.log('=== generatePDF_Dual INICIADO ===');
                console.log('resFijo:', resFijo);
                console.log('resFijo tiene powerCosts?:', !!resFijo.powerCosts);
                console.log('resFijo tiene energyCosts?:', !!resFijo.energyCosts);
                console.log('resIndexed:', resIndexed);
                console.log('resIndexed tiene powerCosts?:', !!resIndexed.powerCosts);
                console.log('resIndexed tiene energyCosts?:', !!resIndexed.energyCosts);
                
                // CRÃTICO: Si no tienen powerCosts/energyCosts, recalcularlos
                if (!resFijo.powerCosts || !resFijo.energyCosts) {
                    console.warn('resFijo no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resFijo, resFijo.offer);
                    resFijo.powerCosts = recalculated.powerCosts;
                    resFijo.energyCosts = recalculated.energyCosts;
                    resFijo.subPower = recalculated.subPower;
                    resFijo.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resFijo recalculado:', resFijo);
                }
                
                if (!resIndexed.powerCosts || !resIndexed.energyCosts) {
                    console.warn('resIndexed no tiene powerCosts/energyCosts, recalculando...');
                    const recalculated = recalculateCostsForOffer(resIndexed, resIndexed.offer);
                    resIndexed.powerCosts = recalculated.powerCosts;
                    resIndexed.energyCosts = recalculated.energyCosts;
                    resIndexed.subPower = recalculated.subPower;
                    resIndexed.subEnergyNet = recalculated.subEnergyNet;
                    console.log('resIndexed recalculado:', resIndexed);
                }
                
                window.showMessageModal("â³ Generando PDF con comparaciÃ³n Fijo vs Indexado... Por favor espere.");
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const brand = activeBrand;
                const tariffType = resFijo.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                
                const commercialCode = document.getElementById('comercial-code-input').value.trim();
                const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
                
                // Colores dinÃ¡micos segÃºn la marca activa
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CRÃTICO: Colores segÃºn marca (DRK = azul, POWER CUP = verde)
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const brandColorLight = isDrk ? [59, 130, 246] : [22, 163, 74];  // Para ahorros
                const blueColor = brandColor;  // Alias para compatibilidad (usado en PÃ¡gina 2 y 3)
                const greenIndexColor = [22, 163, 74];  // Verde para INDEXADA (siempre verde)
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                
                // === PÃGINA 1: RESUMEN ===
                
                // CABECERA con degradado
                const headerHeight = 35;
                
                // CRÃTICO: Color del header segÃºn marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto segÃºn marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text('Liderando el ahorro y la', logoX + 12, 20);
                    doc.text('eficiencia energÃ©tica.', logoX + 12, 24);
                } else {
                    doc.text('AsesorÃ­a EnergÃ©tica', logoX + 12, 20);
                }
                
                // Texto derecha
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTUDIO DE AHORRO', pageWidth - margin, 12, { align: 'right' });
                
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin, 18, { align: 'right' });
                
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin, 24, { align: 'right' });
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // TÃ­tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);  // Gris oscuro
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text('CLIENTE: ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                doc.text('CUPS TOTALES: ' + (resFijo.isMulti ? resFijo.cups : '1'), margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCIÃ“N ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CRÃTICO: Color de fondo segÃºn marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // DescripciÃ³n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = `Ofrece el mayor ahorro consolidado con ${brand.FULL_NAME}.`;
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === DISEÃ‘O LIMPIO SIN MARCOS (3 COLUMNAS) ===
                
                const col1X = margin;
                const col2X = margin + (contentWidth / 3);
                const col3X = margin + (contentWidth / 3) * 2;
                const colWidth = contentWidth / 3;
                
                // === COLUMNA 1: TU FACTURA ACTUAL (IZQUIERDA) - BAJADA AL MEDIO ===
                
                let y1 = yPos + 25;
                
                // TÃ­tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text('TU FACTURA ACTUAL', col1X, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(resFijo.originalBillPeriod || resFijo.importe_total);
                doc.text(precioMensualActual, col1X, y1);
                
                // LÃ­nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 4, col1X + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text(`Total Periodo (${resFijo.dias_facturados || 0} dÃ­as)`, col1X, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(resFijo.originalBillAnnual) + '/aÃ±o';
                doc.text(precioAnualActual, col1X, y1);
                
                // LÃ­nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(col1X, y1 - 3, col1X + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) - CAJA SUBIDA ===
                
                let y2 = yPos;
                
                // CRÃTICO: Color de caja segÃºn marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + (colWidth - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resFijo.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text('TU NUEVO COSTE ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual / 12) + '/mes', col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Estimado Mensual', col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(resFijo.totalAnnual) + '/aÃ±o', col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) - CAJA SUBIDA ===
                
                let y3 = yPos;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, colWidth - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + (colWidth - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.savings), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text('TU NUEVO COSTE ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual / 12) + '/mes', col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Estimado Mensual', col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(resIndexed.totalAnnual) + '/aÃ±o', col3X, y3);
                
                // Actualizar yPos al mÃ¡ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // LÃNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // LÃ­nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // LÃ­nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // === PÃGINA 2: DESGLOSE DETALLADO POR SUMINISTRO ===
                doc.addPage();
                yPos = 15;
                
                // TÃ­tulo verde con bordes redondeados
                doc.setFillColor(34, 197, 94);
                doc.roundedRect(margin, yPos, contentWidth, 14, 4, 4, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DESGLOSE DETALLADO POR SUMINISTRO', pageWidth / 2, yPos + 10, { align: 'center' });
                yPos += 22;
                
                const col2Width = (contentWidth - 6) / 2;
                const leftX = margin;
                const rightX = margin + col2Width + 6;
                
                // FunciÃ³n para generar desglose con cajas grises
                function generarDesgloseConCajasGrises(res, x, width, esFijo) {
                    if (!res || !res.powerCosts || !res.energyCosts) {
                        console.error('ERROR: res no tiene la estructura necesaria', res);
                        return;
                    }
                    
                    let y = yPos;
                    
                    // === CABECERA GRIS OSCURA CON CUPS ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${res.originalTariffType || tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`DÃ­as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = res.offer.name || brand.NAME;
                    const nombreTarifa = res.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y EnergÃ­a)
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA:', x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales
                    if (res.powerCosts.length > 0) {
                        doc.text(`P1: ${num(res.powerCosts[0].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 8);
                    }
                    if (res.powerCosts.length > 1) {
                        doc.text(`P2: ${num(res.powerCosts[1].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 11);
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERGÃA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energÃ­a reales
                    if (res.energyCosts.length > 0) {
                        doc.text(`E1: ${num(res.energyCosts[0].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 8);
                    }
                    if (res.energyCosts.length > 1) {
                        doc.text(`E2: ${num(res.energyCosts[1].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 11);
                    }
                    if (res.energyCosts.length > 2) {
                        doc.text(`E3: ${num(res.energyCosts[2].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 14);
                    }
                    y += 20;
                    
                    // === SECCIÃ“N POTENCIA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCIÃ“N ENERGÃA ===
                    doc.setFillColor(100, 116, 139);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGÃA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energÃ­a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    res.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let periodoNombre = '';
                            if (tariffType === '2.0TD') {
                                if (i === 0) periodoNombre = ' (Punta)';
                                else if (i === 1) periodoNombre = ' (Llano)';
                                else if (i === 2) periodoNombre = ' (Valle)';
                            }
                            const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} â‚¬/kWh)`;
                            doc.text(texto, x + 3, y);
                            doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(71, 85, 105);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL (${res.dias_facturados || 0} DÃAS)`, x + 3, y + 6);
                    doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                // Generar desgloses en dos columnas
                generarDesgloseConCajasGrises(resFijo, leftX, col2Width, true);
                generarDesgloseConCajasGrises(resIndexed, rightX, col2Width, false);
                
                yPos += 120;
                
                // === PÃGINA 3: EXPLICACIÃ“N ===
                doc.addPage();
                yPos = 15;
                
                // Definir variables para las dos columnas de la explicaciÃ³n
                const colWidthPage3 = (contentWidth - 3) / 2;
                const leftXPage3 = margin;
                const rightXPage3 = margin + colWidthPage3 + 3;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('CUAL ES LA DIFERENCIA?', pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda - Tarifa Fija
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text('POR QUE TARIFA FIJA?', leftXPage3 + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const fijaTextFull = [
                    'â€¢ Implica un precio fijo por los kilovatios que',
                    '  consumes (kWh).',
                    '',
                    'â€¢ El precio se mantiene estable,',
                    '  independientemente de cÃ³mo se comporten los',
                    '  precios en el mercado elÃ©ctrico.',
                    '',
                    'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                    '  cliente estÃ¡ protegido frente a sobresaltos.',
                    '',
                    'â€¢ No tendrÃ¡s que estar pendiente de las',
                    '  variaciones del mercado y podrÃ¡s seguir',
                    '  usando la electricidad como siempre.'
                ];
                
                fijaTextFull.forEach(line => {
                    doc.text(line, leftXPage3 + 2, leftColY, { maxWidth: colWidthPage3 - 4 });
                    leftColY += 3.5;
                });
                
                // Columna derecha - Tarifa Indexada
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text('POR QUE TARIFA INDEXADA?', rightXPage3 + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const indexadaTextFull = [
                    'â€¢ Implica un precio variable por los kilovatios',
                    '  que consumes (kWh) cada mes.',
                    '',
                    'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                    '  real de la energÃ­a mes a mes.',
                    '',
                    'â€¢ Al contratarla, el cliente evita pagar',
                    '  mÃ¡rgenes adicionales cuando el precio de la',
                    '  electricidad es mÃ¡s barato.',
                    '',
                    'â€¢ A largo plazo, con un indexado 100%',
                    '  funcional, se puede obtener un ahorro',
                    '  aproximado de hasta un 20% en Ã©pocas de',
                    '  mejor precio.'
                ];
                
                indexadaTextFull.forEach(line => {
                    doc.text(line, rightXPage3 + 2, rightColY, { maxWidth: colWidthPage3 - 4 });
                    rightColY += 3.5;
                });
                
                // Guardar PDF
                const filename = `Comparacion_Fijo_vs_Indexado_${resFijo.cups.slice(-6)}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`âœ… PDF generado con Ã©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }


        async function generateMultiPDF_Dual(res) {
            try {
                console.log('=== generateMultiPDF_Dual INICIADO ===');
                console.log('res recibido:', res);
                console.log('res.individualResults:', res.individualResults);
                
                if (res.individualResults && res.individualResults.length > 0) {
                    console.log('Primer supply:', res.individualResults[0]);
                    console.log('Primer supply tiene indexedComparison?:', !!res.individualResults[0].indexedComparison);
                    if (res.individualResults[0].indexedComparison) {
                        console.log('indexedComparison:', res.individualResults[0].indexedComparison);
                        console.log('indexedComparison.powerCosts?:', !!res.individualResults[0].indexedComparison.powerCosts);
                        console.log('indexedComparison.energyCosts?:', !!res.individualResults[0].indexedComparison.energyCosts);
                    }
                }
                
                console.log('ðŸŸ¢ ANTES de showMessageModal');
                window.showMessageModal("â³ Generando PDF MULTICUPS con comparaciÃ³n Fijo vs Indexado... Por favor espere.");
                console.log('ðŸŸ¢ DESPUÃ‰S de showMessageModal');
                
                console.log('ðŸŸ¢ ANTES de obtener jsPDF');
                const { jsPDF } = window.jspdf;
                console.log('ðŸŸ¢ DESPUÃ‰S de obtener jsPDF, creando documento...');
                const doc = new jsPDF('p', 'mm', 'a4');
                console.log('ðŸŸ¢ Documento PDF creado exitosamente');
                
                console.log('âœ… PASO 1: Objeto PDF creado');
                
                const darkColor = [107, 125, 142];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                
                // CRÃTICO: Colores segÃºn marca activa
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const brandColor = isDrk ? [59, 130, 246] : [132, 204, 22];  // Azul DRK o Verde POWER CUP
                const blueColor = brandColor;  // Alias para compatibilidad
                
                const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
                const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
                const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
                
                // Obtener nombre del cliente
                const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 12;
                const contentWidth = pageWidth - (2 * margin);
                const colWidth = (contentWidth / 2) - 3;
                const leftX = margin;
                const rightX = margin + colWidth + 6;
                
                console.log('âœ… PASO 2: Variables definidas - leftX:', leftX, 'rightX:', rightX, 'colWidth:', colWidth);
                
                // === PÃGINA 1: RESUMEN GENERAL ===
                const headerHeight = 35;
                
                // CRÃTICO: Color del header segÃºn marca
                const headerColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    const r = Math.round(headerColor[0] + (240 - headerColor[0]) * ratio);
                    const g = Math.round(headerColor[1] + (245 - headerColor[1]) * ratio);
                    const b = Math.round(headerColor[2] + (250 - headerColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 12;
                const logoRadius = 5;
                
                if (isDrk) {
                    // Logo DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55);
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244);
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0);
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88);
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con rayo)
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Rayo dentro de la taza (amarillo/oro)
                    doc.setFillColor(255, 215, 0);
                    doc.setLineWidth(0.3);
                    const rayoX = logoX - 0.5;
                    const rayoY = logoY;
                    doc.line(rayoX, rayoY - 1, rayoX - 0.7, rayoY + 0.5);
                    doc.line(rayoX - 0.7, rayoY + 0.5, rayoX + 0.3, rayoY + 0.3);
                    doc.line(rayoX + 0.3, rayoY + 0.3, rayoX, rayoY + 2);
                    doc.line(rayoX, rayoY + 2, rayoX + 0.7, rayoY + 0.2);
                    doc.line(rayoX + 0.7, rayoY + 0.2, rayoX - 0.3, rayoY + 0.5);
                }
                
                // Texto del nombre de marca
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(brand.NAME.toUpperCase(), logoX + 12, 14);
                
                // Subtexto segÃºn marca
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                if (isDrk) {
                    doc.text('Liderando el ahorro y la', logoX + 12, 20);
                    doc.text('eficiencia energÃ©tica.', logoX + 12, 24);
                } else {
                    doc.text('AsesorÃ­a EnergÃ©tica', logoX + 12, 20);
                }
                
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('MULTICUPS', pageWidth - margin, 12, { align: 'right' });
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('FIJO VS INDEXADO', pageWidth - margin, 18, { align: 'right' });
                doc.setFontSize(9);
                doc.setTextColor(100, 120, 140);
                doc.text(`Total: ${res.cups}`, pageWidth - margin, 24, { align: 'right' });
                
                console.log('âœ… PASO 3: Encabezado completo creado (logo + tÃ­tulo + Total CUPS:', res.cups, ')');
                
                yPos = headerHeight + 8;
                
                // === PÃGINA 1: RESUMEN VISUAL MEJORADO MULTICUPS ===
                
                yPos = headerHeight + 8;
                
                // === DATOS DEL CLIENTE ===
                
                // TÃ­tulo "COMPARATIVA PROFESIONAL - DRK"
                doc.setTextColor(55, 65, 81);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPARATIVA PROFESIONAL - ' + brand.NAME.toUpperCase(), margin, yPos);
                yPos += 8;
                
                // Info del cliente
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text('CLIENTE: ' + clientName.toUpperCase(), margin, yPos);
                yPos += 6;
                doc.text('CUPS TOTALES: ' + res.cups, margin, yPos);
                yPos += 12;
                
                // === CAJA GRANDE CON LA MEJOR OPCIÃ“N ===
                
                const bigBoxY = yPos;
                const bigBoxHeight = 45;
                const bigBoxMargin = 20;
                const bigBoxWidth = contentWidth - (bigBoxMargin * 2);
                const bigBoxX = margin + bigBoxMargin;
                
                // CRÃTICO: Color de fondo segÃºn marca
                const bigBoxColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                doc.setFillColor(...bigBoxColor);
                doc.roundedRect(bigBoxX, bigBoxY, bigBoxWidth, bigBoxHeight, 4, 4, 'F');
                
                // Texto "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, bigBoxY + 12, { align: 'center' });
                
                // Nombre de la marca en grande
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.text(brand.NAME.toUpperCase(), pageWidth / 2, bigBoxY + 26, { align: 'center' });
                
                // DescripciÃ³n
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                const descripcion = 'Ofrece el mayor ahorro consolidado con ' + brand.FULL_NAME + '.';
                doc.text(descripcion, pageWidth / 2, bigBoxY + 37, { align: 'center' });
                
                yPos = bigBoxY + bigBoxHeight + 10;
                
                // === TRES CAJAS GRANDES ===
                const boxWidth = (contentWidth - 4) / 3;
                const box1X = margin;
                const box2X = margin + boxWidth + 2;
                const box3X = margin + (boxWidth + 2) * 2;
                const boxHeight = 60;
                
                // Calcular totales
                const totalIndexadoAnual = res.indexedTotals ? res.indexedTotals.totalAnnual : 0;
                const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
                
                // FunciÃ³n para dibujar caja (igual que en PDF individual)
                function drawVisualBox(x, headerColor, headerText, label, mainPrice, subLabel, bottomPrice, isCrossed = false) {
                    let y = yPos;
                    
                    // Cabecera de color
                    doc.setFillColor(...headerColor);
                    doc.roundedRect(x, y, boxWidth, 9, 1.5, 1.5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    const headerLines = doc.splitTextToSize(headerText, boxWidth - 2);
                    doc.text(headerLines, x + boxWidth / 2, y + 4, { align: 'center' });
                    y += 10;
                    
                    // Cuerpo de la caja
                    const bodyColor = headerColor[0] === 75 ? [248, 249, 250] : (headerColor[0] === 59 ? [239, 246, 255] : [240, 253, 244]);
                    doc.setFillColor(...bodyColor);
                    doc.setDrawColor(...headerColor);
                    doc.setLineWidth(1.5);
                    doc.roundedRect(x, y, boxWidth, boxHeight - 10, 1.5, 1.5, 'FD');
                    
                    // Label
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(label.toUpperCase(), x + boxWidth / 2, y + 7, { align: 'center' });
                    
                    // Precio principal (grande)
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    const mainPriceText = mainPrice;
                    doc.text(mainPriceText, x + boxWidth / 2, y + 18, { align: 'center' });
                    
                    // Tachar si es necesario
                    if (isCrossed) {
                        const textWidth = doc.getTextWidth(mainPriceText);
                        doc.setDrawColor(220, 38, 38);
                        doc.setLineWidth(0.7);
                        doc.line(x + boxWidth / 2 - textWidth / 2, y + 17, x + boxWidth / 2 + textWidth / 2, y + 17);
                    }
                    
                    // Sublabel
                    doc.setFontSize(5.5);
                    doc.setTextColor(120, 120, 120);
                    doc.setFont('helvetica', 'normal');
                    doc.text(subLabel, x + boxWidth / 2, y + 24, { align: 'center' });
                    
                    // LÃ­nea separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(x + 5, y + 30, x + boxWidth - 5, y + 30);
                    
                    // Precio inferior (anual)
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isCrossed ? 220 : headerColor[0], isCrossed ? 38 : headerColor[1], isCrossed ? 38 : headerColor[2]);
                    doc.text(bottomPrice, x + boxWidth / 2, y + 42, { align: 'center' });
                }
                
                // CAJA 1: TU FACTURA ACTUAL (GRIS) - REEMPLAZADA CON DISEÃ‘O LIMPIO
                
                console.log('âœ… PASO 4: Iniciando dibujo de 3 columnas (Factura Actual, Fijo, Indexado)');
                
                // === COLUMNA 1: TU FACTURA ACTUAL (DISEÃ‘O LIMPIO) ===
                let y1 = yPos + 25;
                
                // TÃ­tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(107, 114, 128);
                doc.text('TU FACTURA ACTUAL', margin, y1);
                y1 += 12;
                
                // Precio mensual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor(220, 38, 38);
                const precioMensualActual = eur(res.importe_total);
                doc.text(precioMensualActual, margin, y1);
                
                // LÃ­nea tachada
                const tw1 = doc.getTextWidth(precioMensualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 4, margin + tw1, y1 - 4);
                y1 += 10;
                
                // Subtexto
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Total Periodo (varios dÃ­as)', margin, y1);
                y1 += 14;
                
                // Precio anual (TACHADO)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(220, 38, 38);
                const precioAnualActual = eur(res.originalBillAnnual) + '/aÃ±o';
                doc.text(precioAnualActual, margin, y1);
                
                // LÃ­nea tachada
                const tw2 = doc.getTextWidth(precioAnualActual);
                doc.setDrawColor(220, 38, 38);
                doc.setLineWidth(1.5);
                doc.line(margin, y1 - 3, margin + tw2, y1 - 3);
                
                // === COLUMNA 2: AHORRO + NUEVO COSTE FIJO (CENTRO) ===
                
                let y2 = yPos;
                const col2X = margin + (contentWidth / 3);
                
                // CRÃTICO: Color de caja segÃºn marca
                const cajaHeaderColor = isDrk ? [100, 116, 139] : [115, 130, 95]; // Gris azulado (DRK) o Verde oliva (POWER)
                
                // Caja superior "TU AHORRO ANUAL FIJO"
                const boxHeaderHeight = 12;
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col2X - 2, y2, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL FIJO', col2X + ((contentWidth / 3) - 8) / 2 - 2, y2 + 8, { align: 'center' });
                y2 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(res.savings), col2X, y2);
                y2 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text('TU NUEVO COSTE ' + brand.NAME.toUpperCase(), col2X, y2);
                y2 += 12;
                
                // Precio mensual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual / 12) + '/mes', col2X, y2);
                y2 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Estimado Mensual', col2X, y2);
                y2 += 12;
                
                // Precio anual nuevo (color de marca)
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...brandColor);
                doc.text(eur(res.totalAnnual) + '/aÃ±o', col2X, y2);
                
                // === COLUMNA 3: AHORRO + NUEVO COSTE INDEXADO (DERECHA) ===
                
                let y3 = yPos;
                const col3X = margin + (contentWidth / 3) * 2;
                
                // Caja superior "TU AHORRO ANUAL INDEXADO" (con mismo color que FIJO)
                doc.setFillColor(...cajaHeaderColor);
                doc.roundedRect(col3X - 2, y3, (contentWidth / 3) - 8, boxHeaderHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('TU AHORRO ANUAL INDEXADO', col3X + ((contentWidth / 3) - 8) / 2 - 2, y3 + 8, { align: 'center' });
                y3 += boxHeaderHeight + 12;
                
                // Ahorro en verde GRANDE
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(30);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(ahorroIndexado), col3X, y3);
                y3 += 18;
                
                // "TU NUEVO COSTE [MARCA]"
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text('TU NUEVO COSTE ' + brand.NAME.toUpperCase(), col3X, y3);
                y3 += 12;
                
                // Precio mensual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual / 12) + '/mes', col3X, y3);
                y3 += 10;
                
                // Subtexto "Estimado Mensual"
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175);
                doc.text('Estimado Mensual', col3X, y3);
                y3 += 12;
                
                // Precio anual nuevo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74);
                doc.text(eur(totalIndexadoAnual) + '/aÃ±o', col3X, y3);
                
                // Actualizar yPos al mÃ¡ximo de las tres columnas
                const maxY = Math.max(y1, y2, y3);
                
                // LÃNEAS VERTICALES SEPARADORAS
                const lineStartY = yPos - 5;
                const lineEndY = maxY + 5;
                
                // LÃ­nea entre columna 1 y 2
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(col2X - 10, lineStartY, col2X - 10, lineEndY);
                
                // LÃ­nea entre columna 2 y 3
                doc.line(col3X - 10, lineStartY, col3X - 10, lineEndY);
                
                yPos = maxY + 15;
                
                // Nota
                doc.setFillColor(255, 251, 235);
                doc.setDrawColor(245, 158, 11);
                doc.setLineWidth(0.3);
                doc.roundedRect(margin, yPos, contentWidth, 18, 1, 1, 'FD');
                
                doc.setTextColor(146, 64, 14);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('âš ï¸ IMPORTANTE:', margin + 2, yPos + 5);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                const noteText = doc.splitTextToSize(
                    'A continuaciÃ³n encontrarÃ¡ el desarrollo detallado de cÃ¡lculos para cada suministro, mostrando el desglose completo de costes tanto para tarifas fijas como indexadas.',
                    contentWidth - 4
                );
                let noteY = yPos + 10;
                noteText.forEach(line => {
                    doc.text(line, margin + 2, noteY);
                    noteY += 3;
                });
                
                // === PÃGINAS 2-N: DESARROLLO DETALLADO DE CADA CUPS ===
                
                // FunciÃ³n auxiliar para generar desglose detallado
                function generarDesgloseDetalladoCUPS(supply, x, width, color, titulo, usarIndexado = false) {
                    const resultado = usarIndexado && supply.indexedComparison ? supply.indexedComparison : supply;
                    
                    // VERIFICACIÃ“N CRÃTICA: Asegurar que resultado tiene los datos necesarios
                    if (!resultado || !resultado.powerCosts || !resultado.energyCosts) {
                        console.error('ERROR: resultado no tiene la estructura necesaria', resultado);
                        doc.setTextColor(220, 38, 38);
                        doc.setFontSize(8);
                        doc.text('Error: Datos incompletos para este suministro', x + 2, yPos + 10);
                        return;
                    }
                    
                    const tariffType = resultado.originalTariffType || currentTariffType;
                    const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD'];
                    
                    // COLORES SEGÃšN MARCA (PowerCup usa verde oliva en lugar de gris)
                    const headerDarkColor = isDrk ? [71, 85, 105] : [95, 110, 75];   // Gris oscuro DRK o Verde oliva oscuro PowerCup
                    const headerMedColor = isDrk ? [100, 116, 139] : [110, 125, 90]; // Gris medio DRK o Verde oliva medio PowerCup
                    
                    let y = yPos;
                    
                    // === CABECERA OSCURA CON CUPS ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`[${supply.cups.slice(-12)}]`, x + 3, y + 4);
                    doc.text(`Tipo: ${tariffType}`, x + width - 3, y + 4, { align: 'right' });
                    doc.text(`DÃ­as: ${resultado.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                    
                    // Nombre completo: Comercializadora - Tarifa
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'normal');
                    const comercializadora = resultado.offer.name || brand.NAME;
                    const nombreTarifa = resultado.offer.description || 'N/A';
                    const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                    doc.text(nombreCompleto, x + 3, y + 11);
                    
                    y += 16;
                    
                    // === CAJA PRECIOS APLICADOS ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                    y += 10;
                    
                    // Info de precios (Potencia y EnergÃ­a)
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA:', x + 3, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de potencia reales
                    if (resultado.powerCosts.length > 0) {
                        doc.text(`P1: ${num(resultado.powerCosts[0].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 8);
                    }
                    if (resultado.powerCosts.length > 1) {
                        doc.text(`P2: ${num(resultado.powerCosts[1].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 11);
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(6);
                    doc.text('ENERGÃA:', x + width/2, y + 4);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(5.5);
                    
                    // Mostrar precios de energÃ­a reales
                    if (resultado.energyCosts.length > 0) {
                        doc.text(`E1: ${num(resultado.energyCosts[0].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 8);
                    }
                    if (resultado.energyCosts.length > 1) {
                        doc.text(`E2: ${num(resultado.energyCosts[1].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 11);
                    }
                    if (resultado.energyCosts.length > 2) {
                        doc.text(`E3: ${num(resultado.energyCosts[2].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 14);
                    }
                    y += 20;
                    
                    // === SECCIÃ“N POTENCIA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose potencia
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.powerCosts.forEach(p => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(p.cost, 2)} â‚¬`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === SECCIÃ“N ENERGÃA ===
                    doc.setFillColor(...headerMedColor);
                    doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGÃA', x + 3, y + 5);
                    y += 9;
                    
                    // Desglose energÃ­a
                    doc.setTextColor(55, 65, 81);
                    doc.setFontSize(6);
                    doc.setFont('helvetica', 'normal');
                    resultado.energyCosts.forEach(e => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ' (Punta)';
                                if (e.period === 2) label += ' (Llano)';
                                if (e.period === 3) label += ' (Valle)';
                            }
                            const formula = `${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)`;
                            doc.text(formula, x + 3, y);
                            doc.text(`${num(e.cost, 2)} â‚¬`, x + width - 3, y, { align: 'right' });
                            y += 4;
                        }
                    });
                    y += 2;
                    
                    // === TOTAL ===
                    doc.setFillColor(...headerDarkColor);
                    doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL (${resultado.dias_facturados || 0} DÃAS)`, x + 3, y + 6);
                    doc.text(eur(resultado.totalPeriod || 0), x + width - 3, y + 6, { align: 'right' });
                    y += 12;
                    
                    // === AHORRO ===
                    doc.setFillColor(220, 38, 38);
                    doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.text('AHORRO:', x + width - 52, y + 4);
                    doc.setFontSize(9);
                    doc.text(eur(resultado.savings || 0), x + width - 28, y + 7, { align: 'center' });
                }
                
                console.log('âœ… PASO 5: FunciÃ³n generarDesgloseDetalladoCUPS definida');
                console.log('âœ… PASO 6: res.individualResults existe?', !!res.individualResults);
                console.log('âœ… PASO 6B: res.individualResults.length:', res.individualResults ? res.individualResults.length : 'undefined');
                
                // Generar pÃ¡ginas de desarrollo para cada CUPS
                console.log('ðŸ”§ Iniciando forEach de pÃ¡ginas detalladas para', res.individualResults ? res.individualResults.length : 0, 'suministros');
                res.individualResults.forEach((supply, idx) => {
                    console.log(`  ðŸ“„ Generando pÃ¡gina detallada ${idx + 1}/${res.individualResults.length} para CUPS:`, supply.cups);
                    doc.addPage();
                    yPos = 15;
                    
                    // ENCABEZADO PROFESIONAL CON FONDO DE COLOR
                    const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90]; // Gris para DRK, verde oliva para POWER CUP
                    const headerHeight = 12;
                    
                    doc.setFillColor(...headerBgColor);
                    doc.roundedRect(margin, yPos, contentWidth, headerHeight, 3, 3, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`DESARROLLO DETALLADO - SUMINISTRO ${idx + 1} DE ${res.individualResults.length}`, pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    yPos += headerHeight + 4;
                    
                    // Dos columnas con desarrollo
                    generarDesgloseDetalladoCUPS(
                        supply,
                        leftX,
                        colWidth,
                        blueColor,
                        `TARIFA FIJA: ${supply.offer.name}`,
                        false
                    );
                    
                    generarDesgloseDetalladoCUPS(
                        supply,
                        rightX,
                        colWidth,
                        greenColor,
                        `TARIFA INDEXADA: ${supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A'}`,
                        true
                    );
                });
                
                // === NUEVA PÃGINA: RESUMEN DE TODOS LOS SUMINISTROS ===
                doc.addPage();
                yPos = 20;
                
                // Encabezado con color segÃºn marca
                const headerBgColor = isDrk ? [140, 150, 160] : [110, 125, 90];
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(margin, yPos, contentWidth, 14, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMEN DE TODOS LOS SUMINISTROS', pageWidth / 2, yPos + 9.5, { align: 'center' });
                yPos += 20;
                
                // Cabeceras de columnas (mismo color que el encabezado principal)
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(leftX, yPos, colWidth, 8, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text('TARIFAS FIJAS', leftX + colWidth / 2, yPos + 5.5, { align: 'center' });
                
                doc.setFillColor(...headerBgColor);
                doc.roundedRect(rightX, yPos, colWidth, 8, 1, 1, 'F');
                doc.text('TARIFAS INDEXADAS', rightX + colWidth / 2, yPos + 5.5, { align: 'center' });
                yPos += 12;
                
                // Listar cada suministro
                let totalFijas = 0;
                let totalIndexadas = 0;
                
                res.individualResults.forEach((supply, idx) => {
                    // FIJO
                    doc.setFillColor(239, 246, 255);
                    doc.roundedRect(leftX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups.slice(-12), leftX + 2, yPos + 4);
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(supply.savings), leftX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreFija = supply.offer.name || 'N/A';
                    doc.text(nombreFija.substring(0, 35), leftX + 2, yPos + 8.5);
                    
                    // INDEXADO
                    doc.setFillColor(240, 253, 244);
                    doc.roundedRect(rightX, yPos, colWidth, 11, 1, 1, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text(supply.cups.slice(-12), rightX + 2, yPos + 4);
                    const savingsIdx = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(7);
                    doc.text(eur(savingsIdx), rightX + colWidth - 2, yPos + 4, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(5.5);
                    doc.setFont('helvetica', 'normal');
                    const nombreIdx = supply.indexedComparison ? supply.indexedComparison.offer.name : 'N/A';
                    doc.text(nombreIdx.substring(0, 35), rightX + 2, yPos + 8.5);
                    
                    totalFijas += supply.savings || 0;
                    totalIndexadas += savingsIdx;
                    yPos += 13;
                });
                
                // Espacio antes de los totales
                yPos += 5;
                
                // CAJAS ROJAS CON TOTALES
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(leftX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL FIJAS:', leftX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalFijas), leftX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(rightX, yPos, colWidth, 13, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('AHORRO TOTAL INDEXADAS:', rightX + 3, yPos + 6);
                doc.setFontSize(11);
                doc.text(eur(totalIndexadas), rightX + colWidth - 3, yPos + 9.5, { align: 'right' });
                
                // === PÃGINA FINAL: EXPLICACIÃ“N ===
                doc.addPage();
                yPos = 15;
                
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(margin, yPos, contentWidth, 120, 2, 2, 'F');
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('CUAL ES LA DIFERENCIA?', pageWidth / 2, yPos + 8, { align: 'center' });
                
                yPos += 15;
                
                // Columna izquierda
                let leftColY = yPos;
                doc.setFontSize(9);
                doc.setTextColor(...blueColor);
                doc.setFont('helvetica', 'bold');
                doc.text('POR QUE TARIFA FIJA?', leftX + 2, leftColY);
                leftColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const fijaExplText = [
                    'â€¢ Implica un precio fijo por los kilovatios que',
                    '  consumes (kWh).',
                    '',
                    'â€¢ El precio se mantiene estable,',
                    '  independientemente de cÃ³mo se comporten los',
                    '  precios en el mercado elÃ©ctrico.',
                    '',
                    'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                    '  cliente estÃ¡ protegido frente a sobresaltos.',
                    '',
                    'â€¢ No tendrÃ¡s que estar pendiente de las',
                    '  variaciones del mercado y podrÃ¡s seguir',
                    '  usando la electricidad como siempre.'
                ];
                
                fijaExplText.forEach(line => {
                    doc.text(line, leftX + 2, leftColY, { maxWidth: colWidth - 4 });
                    leftColY += 3.5;
                });
                
                // Columna derecha
                let rightColY = yPos;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenColor);
                doc.text('POR QUE TARIFA INDEXADA?', rightX + 2, rightColY);
                rightColY += 6;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                const indexExplText = [
                    'â€¢ Implica un precio variable por los kilovatios',
                    '  que consumes (kWh) cada mes.',
                    '',
                    'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                    '  real de la energÃ­a mes a mes.',
                    '',
                    'â€¢ Al contratarla, el cliente evita pagar',
                    '  mÃ¡rgenes adicionales cuando el precio de la',
                    '  electricidad es mÃ¡s barato.',
                    '',
                    'â€¢ A largo plazo, con un indexado 100%',
                    '  funcional, se puede obtener un ahorro',
                    '  aproximado de hasta un 20% en Ã©pocas de',
                    '  mejor precio.'
                ];
                
                indexExplText.forEach(line => {
                    doc.text(line, rightX + 2, rightColY, { maxWidth: colWidth - 4 });
                    rightColY += 3.5;
                });
                
                // Guardar
                const filename = `MULTICUPS_Fijo_vs_Indexado_${new Date().getTime()}.pdf`;
                doc.save(filename);
                
                window.showMessageModal(`âœ… PDF generado con Ã©xito: ${filename}`);
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (error) {
                console.error('Error generando PDF MULTICUPS dual:', error);
                window.showErrorModal(`Error al generar PDF: ${error.message}`);
            }
        }

        
        // --- GENERACIÃ“N DE PDF PROFESIONAL COMPLETO ---
        
        async function handleGeneratePDF() {
            console.log('handleGeneratePDF llamada', {
                lastComparisonResult: lastComparisonResult,
                lastIndexedResult: lastIndexedResult,
                compareWithIndexed: compareWithIndexed
            });
            
            if (!lastComparisonResult) {
                console.error('ERROR: lastComparisonResult es null o undefined');
                return window.showErrorModal("Primero realice una comparaciÃ³n.");
            }
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim();
            const clientEmail = document.getElementById('client-email-input').value.trim();
            
            if (!commercialCode) return window.showErrorModal("Indique el CÃ³digo Comercial.");
            
            // IMPORTANTE: Detectar si hay resultado indexado para generar PDF dual
            // Puede estar en lastIndexedResult (individual) o en indexedTotals (MULTICUPS)
            const hasIndexedData = (lastIndexedResult && compareWithIndexed) || 
                                    (lastComparisonResult.isMultiCups && lastComparisonResult.indexedTotals);
            
            console.log('ðŸ” hasIndexedData:', hasIndexedData);
            console.log('ðŸ” lastIndexedResult:', lastIndexedResult);
            console.log('ðŸ” indexedTotals:', lastComparisonResult.indexedTotals);
            
            if (hasIndexedData) {
                // Si hay resultado indexado, generar PDF dual
                if (lastComparisonResult.isMultiCups) {
                    // MULTICUPS con Ã­ndice
                    console.log('âœ… Generando PDF MULTICUPS DUAL');
                    await generateMultiPDF_Dual(lastComparisonResult);
                } else {
                    // Individual con Ã­ndice
                    console.log('âœ… Generando PDF INDIVIDUAL DUAL');
                    await generatePDF_Dual(lastComparisonResult, lastIndexedResult);
                }
                
                // Cerrar modal
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                window.showMessageModal("â³ Generando PDF profesional... Por favor espere.");
                
                // Importar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const brand = activeBrand;
                const res = lastComparisonResult;
                const offer = res.offer;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.originalTariffType || currentTariffType;
                const config = TARIFF_CONFIG[tariffType];
                
                // Colores corporativos
                const primaryColor = isDrk ? [90, 120, 145] : [130, 145, 100]; // DRK: azul grisÃ¡ceo | POWER: verde oliva claro
                const darkColor = isDrk ? [107, 125, 142] : [115, 130, 95]; // DRK: gris azulado | POWER: verde oliva oscuro
                const lightBg = isDrk ? [240, 245, 250] : [245, 248, 240];
                const greenColor = [22, 163, 74];
                const redColor = [220, 38, 38];
                const grayBg = [245, 245, 245];
                
                let yPos = 0;
                const pageWidth = 210;
                const margin = 15;
                const contentWidth = pageWidth - (2 * margin);
                
                // === NUEVA CABECERA CON DEGRADADO HORIZONTAL Y LOGO ===
                // Fondo con degradado de oscuro a claro (izquierda a derecha)
                const headerHeight = 45;
                for (let i = 0; i < pageWidth; i++) {
                    const ratio = i / pageWidth;
                    // De azul oscuro a azul claro/blanco
                    const r = Math.round(darkColor[0] + (240 - darkColor[0]) * ratio);
                    const g = Math.round(darkColor[1] + (245 - darkColor[1]) * ratio);
                    const b = Math.round(darkColor[2] + (250 - darkColor[2]) * ratio);
                    doc.setFillColor(r, g, b);
                    doc.rect(i, 0, 1, headerHeight, 'F');
                }
                
                // Logo segÃºn marca
                const logoX = margin + 8;
                const logoY = 15;
                const logoRadius = 6;
                
                if (isDrk) {
                    // Logo circular DRK (anillo multicolor)
                    doc.setFillColor(219, 68, 55); // Rojo
                    doc.circle(logoX - 1, logoY + 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(66, 133, 244); // Azul
                    doc.circle(logoX + 1, logoY - 1, logoRadius * 0.8, 'F');
                    doc.setFillColor(244, 180, 0); // Amarillo
                    doc.circle(logoX - 1, logoY - 1, logoRadius * 0.7, 'F');
                    doc.setFillColor(15, 157, 88); // Verde
                    doc.circle(logoX + 1, logoY + 1, logoRadius * 0.7, 'F');
                    
                    // CÃ­rculo central blanco
                    doc.setFillColor(255, 255, 255);
                    doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
                } else {
                    // Logo POWER CUP (taza con niveles de energÃ­a y rayo)
                    
                    // Plato/base (verde oscuro)
                    doc.setFillColor(60, 90, 50);
                    doc.rect(logoX - 5, logoY + 4, 10, 1, 'F');
                    
                    // Borde de la taza (verde oscuro)
                    doc.setDrawColor(60, 90, 50);
                    doc.setLineWidth(1.2);
                    doc.roundedRect(logoX - 3.5, logoY - 2, 7, 6, 0.5, 0.5, 'S');
                    
                    // Asa de la taza (usando lÃ­nea curva)
                    doc.setLineWidth(1);
                    doc.line(logoX + 3.5, logoY, logoX + 5, logoY - 0.5);
                    doc.line(logoX + 5, logoY - 0.5, logoX + 5.5, logoY + 1);
                    doc.line(logoX + 5.5, logoY + 1, logoX + 5, logoY + 2.5);
                    doc.line(logoX + 5, logoY + 2.5, logoX + 3.5, logoY + 2);
                    
                    // Niveles de energÃ­a dentro de la taza (lÃ­neas verdes horizontales)
                    doc.setFillColor(100, 150, 70);
                    doc.rect(logoX - 3, logoY + 2.5, 6, 0.8, 'F');  // Nivel 1
                    doc.rect(logoX - 3, logoY + 0.8, 6, 0.8, 'F');  // Nivel 2
                    doc.rect(logoX - 3, logoY - 0.9, 6, 0.8, 'F');  // Nivel 3
                    
                    // Rayo amarillo encima de la taza
                    doc.setFillColor(255, 200, 0);
                    const rayX = logoX;
                    const rayY = logoY - 7;
                    // Parte superior del rayo
                    doc.triangle(rayX - 1, rayY, rayX - 2, rayY + 2.5, rayX, rayY + 2, 'F');
                    // Parte inferior del rayo
                    doc.triangle(rayX, rayY + 2, rayX - 1, rayY + 4.5, rayX + 1.5, rayY + 4.5, 'F');
                }
                
                yPos = 12;
                
                // Texto "DRK ENERGÃA" a la derecha del logo
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                const brandText = isDrk ? 'DRK' : 'POWER CUP';
                doc.text(brandText, logoX + 12, yPos + 3);
                
                // "ENERGÃA" debajo
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('ENERGÃA', logoX + 12, yPos + 11);
                
                // Tagline
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 220, 240);
                doc.text('Liderando el ahorro y la', logoX + 12, yPos + 19);
                doc.text('eficiencia energÃ©tica.', logoX + 12, yPos + 24);
                
                // Texto derecha "ESTUDIO DE AHORRO COMPARATIVA PROFESIONAL"
                doc.setTextColor(40, 60, 80);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTUDIO DE AHORRO', pageWidth - margin - 3, yPos + 5, { align: 'right' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COMPARATIVA', pageWidth - margin - 3, yPos + 13, { align: 'right' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 120, 140);
                doc.text('PROFESIONAL', pageWidth - margin - 3, yPos + 21, { align: 'right' });
                
                yPos = 50;
                
                // === INFORMACIÃ“N DEL CLIENTE (REDISEÃ‘ADA) ===
                // Barra superior verde
                doc.setFillColor(...greenColor); // VERDE
                doc.roundedRect(margin, yPos, contentWidth, 8, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTUDIO DE AHORRO', margin + 5, yPos + 5.5);
                
                // Caja blanca con borde azul
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(...darkColor);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos + 8, contentWidth, 20, 3, 3, 'FD');
                
                doc.setTextColor(...darkColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`COMPARATIVA PROFESIONAL - ${isDrk ? 'DRK' : 'POWER CUP'}`, margin + 5, yPos + 14);
                
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`CLIENTE: ${clientName}`, margin + 5, yPos + 20);
                if (!res.isMulti) {
                    doc.text(`CUPS: ${res.cups}`, margin + 5, yPos + 25);
                } else {
                    doc.text(`CUPS TOTALES: ${res.individualResults.length}`, margin + 5, yPos + 25);
                }
                
                // Comercial en caja destacada
                doc.setFillColor(...lightBg);
                doc.roundedRect(pageWidth - margin - 45, yPos + 17, 45, 8, 2, 2, 'F');
                doc.setTextColor(...darkColor);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(`COMERCIAL: ${commercialCode}`, pageWidth - margin - 43, yPos + 22.5);
                
                yPos += 35;
                
                // Definir savingsText para usarlo en la seccion comun al final
                const savingsText = res.savings > 0 ? eur(res.savings) : '0,00 â‚¬';
                
                // Funcion auxiliar para nueva pagina (disponible para todos)
                const checkNewPage = function(neededSpace) {
                    if (yPos + neededSpace > 270) {
                        doc.addPage();
                        yPos = 20;
                        return true;
                    }
                    return false;
                };
                
                // ================================================================
                // BIFURCACION: Si es MultiCups, generar PDF especial MultiCups
                // ================================================================
                
                if (res.isMulti && res.individualResults && res.individualResults.length > 0) {
                    // === INICIO MULTICUPS - DISEÃ‘O COMPACTO TIPO TARJETA ===
                    
                    // === CABECERA AZUL (MÃS PEQUEÃ‘A) ===
                    doc.setFillColor(...primaryColor);
                    doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                    
                    // "LA MEJOR OPCIÃ“N PARA TI ES"
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Marca o Tarifa
                    const brandNameMulti = isDrk ? 'DRK' : 'POWER CUP';
                    // Usar description si estÃ¡ disponible, sino name
                    const displayOfferName = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                    
                    if (!isDrk) {
                        // POWER CUP MultiCups: Solo mostrar "POWER CUP" (puede haber mÃºltiples tarifas)
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POWER CUP', pageWidth / 2, yPos + 20, { align: 'center' });
                    } else {
                        // DRK: Mostrar DRK y nombre de tarifa
                        doc.setFontSize(26);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(displayOfferName, pageWidth / 2, yPos + 27, { align: 'center' });
                    }
                    
                    yPos += 37;
                    
                    // === CAJA BLANCA COMPACTA ===
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    const boxHeight = res.savings > 0 ? 75 : 65; // Altura ajustada para mensaje
                    doc.roundedRect(margin, yPos, contentWidth, boxHeight, 4, 4, 'FD');
                    
                    if (res.savings > 0) {
                        // Ahorro positivo - diseÃ±o normal
                        doc.setTextColor(120, 120, 140);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('TU AHORRO ANUAL ESTIMADO', pageWidth / 2, yPos + 8, { align: 'center' });
                        
                        // Cifra de ahorro en VERDE (grande pero ajustado)
                        doc.setTextColor(...greenColor);
                        doc.setFontSize(32);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        yPos += 32;
                    } else {
                        // Sin ahorro - mensaje grande centrado
                        doc.setTextColor(...primaryColor);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Â¡ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                        
                        doc.setTextColor(60, 60, 60);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Actualmente estÃ¡s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                        doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                        
                        yPos += 67;
                        // Saltar la secciÃ³n de precios - no mostrarlos
                        yPos += 50;
                    }
                    
                    // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                    if (res.savings > 0) {
                    const colWidthMulti = (contentWidth - 20) / 2;
                    
                    // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                    const leftXMulti = margin + 10;
                    
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TU FACTURA ACTUAL', leftXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual tachado en rojo
                    const oldPriceMulti = `${eur(res.originalBillAnnual / 12)}/mes`;
                    doc.setTextColor(...redColor);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    const oldXMulti = leftXMulti + colWidthMulti / 2;
                    const oldYMulti = yPos + 12;
                    doc.text(oldPriceMulti, oldXMulti, oldYMulti, { align: 'center' });
                    
                    // LÃ­nea tachada
                    const oldWidthMulti = doc.getTextWidth(oldPriceMulti);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldXMulti - oldWidthMulti/2 - 2, oldYMulti - 3, oldXMulti + oldWidthMulti/2 + 2, oldYMulti - 3);
                    
                    // "Total Periodo (Variado)"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Total Periodo (Variado)', leftXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual tachado
                    const oldAnnualMulti = eur(res.originalBillAnnual);
                    doc.setTextColor(...redColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    const oldAnnualXMulti = leftXMulti + colWidthMulti / 2;
                    const oldAnnualYMulti = yPos + 32;
                    doc.text(`${oldAnnualMulti}/aÃ±o`, oldAnnualXMulti, oldAnnualYMulti, { align: 'center' });
                    
                    // LÃ­nea tachada
                    const oldAnnualWidthMulti = doc.getTextWidth(`${oldAnnualMulti}/aÃ±o`);
                    doc.setDrawColor(...redColor);
                    doc.setLineWidth(1.5);
                    doc.line(oldAnnualXMulti - oldAnnualWidthMulti/2 - 2, oldAnnualYMulti - 3, oldAnnualXMulti + oldAnnualWidthMulti/2 + 2, oldAnnualYMulti - 3);
                    
                    // SEPARADOR VERTICAL
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                    
                    // COLUMNA DERECHA - TU NUEVO COSTE
                    const rightXMulti = margin + 10 + colWidthMulti + 10;
                    
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    const newLabelMulti = `TU NUEVO COSTE ${brandNameMulti}`;
                    doc.text(newLabelMulti, rightXMulti + colWidthMulti / 2, yPos, { align: 'center' });
                    
                    // Precio mensual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual / 12)}/mes`, rightXMulti + colWidthMulti / 2, yPos + 13, { align: 'center' });
                    
                    // "Estimado Mensual"
                    doc.setTextColor(140, 150, 160);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Estimado Mensual', rightXMulti + colWidthMulti / 2, yPos + 19, { align: 'center' });
                    
                    // Precio anual en azul
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${eur(res.totalAnnual)}/aÃ±o`, rightXMulti + colWidthMulti / 2, yPos + 32, { align: 'center' });
                    
                    yPos += 50;
                    } // Fin del condicional de columnas de precios
                    
                    // === RESUMEN DE SUMINISTROS (DISEÃ‘O MEJORADO) ===
                    checkNewPage(50);
                    
                    // Titulo resumen (verde)
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`RESUMEN DE ${res.individualResults.length} SUMINISTROS`, margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // Cabecera tabla (azul oscuro con texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 7, 2, 2, 'F');
                    doc.text('NÂº', margin + 2, yPos + 5);
                    doc.text('CUPS', margin + 12, yPos + 5);
                    doc.text('TIPO', margin + 95, yPos + 5);
                    doc.text('DÃAS', margin + 115, yPos + 5);
                    doc.text('AHORRO', pageWidth - margin - 28, yPos + 5);
                    yPos += 7;
                    
                    // Filas (alternadas con borde sutil)
                    doc.setFont('helvetica', 'normal');
                    res.individualResults.forEach((supply, idx) => {
                        checkNewPage(8);
                        
                        // Fondo alternado
                        if (idx % 2 === 0) {
                            doc.setFillColor(248, 250, 252); // Azul muy claro
                            doc.rect(margin, yPos, contentWidth, 7, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        doc.text(`[${idx + 1}]`, margin + 2, yPos + 4.5);
                        doc.setFontSize(7);
                        doc.text(supply.cups.substring(0, 18) + '...', margin + 12, yPos + 4.5);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(supply.originalTariffType, margin + 95, yPos + 4.5);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${supply.dias_facturados}`, margin + 118, yPos + 4.5, { align: 'center' });
                        
                        const savSupply = supply.isNegativeSavings ? '0,00 â‚¬' : eur(supply.savings);
                        const colorSupply = supply.isNegativeSavings ? [150, 150, 150] : greenColor;
                        doc.setTextColor(...colorSupply);
                        doc.setFont('helvetica', 'bold');
                        doc.text(savSupply, pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                        yPos += 7;
                    });
                    
                    yPos += 10;
                    
                    // === NUEVA PÃGINA PARA DESGLOSE DETALLADO ===
                    doc.addPage();
                    yPos = 20;
                    
                    // TÃ­tulo desglose detallado (en pÃ¡gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DESGLOSE DETALLADO POR SUMINISTRO', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    // FunciÃ³n auxiliar para generar desglose en MULTICUPS (estilo dual)
                    function generarDesgloseMultiCups(supply, supplyIndexed, x, width, esColumnaIzq) {
                        const res = esColumnaIzq ? supply : supplyIndexed;
                        if (!res || !res.powerCosts || !res.energyCosts) {
                            console.error('ERROR: res no tiene la estructura necesaria', res);
                            return;
                        }
                        
                        let y = yPos;
                        
                        // === CABECERA GRIS OSCURA CON CUPS ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 14, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`[${res.cups || 'N/A'}]`, x + 3, y + 4);
                        doc.text(`Tipo: ${res.originalTariffType || ''}`, x + width - 3, y + 4, { align: 'right' });
                        doc.text(`DÃ­as: ${res.dias_facturados || 0}`, x + width - 3, y + 8, { align: 'right' });
                        
                        // Nombre completo: Comercializadora - Tarifa
                        doc.setFontSize(6.5);
                        doc.setFont('helvetica', 'normal');
                        const comercializadora = res.offer.name || brand.NAME;
                        const nombreTarifa = res.offer.description || 'N/A';
                        const nombreCompleto = `${comercializadora} - ${nombreTarifa}`;
                        doc.text(nombreCompleto, x + 3, y + 11);
                        
                        y += 16;
                        
                        // === CAJA PRECIOS APLICADOS ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 8, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('PRECIOS APLICADOS:', x + 3, y + 6);
                        y += 10;
                        
                        // Info de precios (Potencia y EnergÃ­a)
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 16, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POTENCIA:', x + 3, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de potencia reales
                        if (res.powerCosts.length > 0) {
                            doc.text(`P1: ${num(res.powerCosts[0].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 8);
                        }
                        if (res.powerCosts.length > 1) {
                            doc.text(`P2: ${num(res.powerCosts[1].priceDay || 0, 6)} â‚¬/kW/dÃ­a`, x + 3, y + 11);
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(6);
                        doc.text('ENERGÃA:', x + width/2, y + 4);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(5.5);
                        
                        // Mostrar precios de energÃ­a reales
                        if (res.energyCosts.length > 0) {
                            doc.text(`E1: ${num(res.energyCosts[0].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 8);
                        }
                        if (res.energyCosts.length > 1) {
                            doc.text(`E2: ${num(res.energyCosts[1].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 11);
                        }
                        if (res.energyCosts.length > 2) {
                            doc.text(`E3: ${num(res.energyCosts[2].price || 0, 6)} â‚¬/kWh`, x + width/2, y + 14);
                        }
                        y += 20;
                        
                        // === SECCIÃ“N POTENCIA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('POTENCIA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose potencia
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.powerCosts.forEach((p, i) => {
                            if (p.kw > 0) {
                                const texto = `P${i+1}: (${num(p.kw, 2)} kW x ${num(p.priceDay, 6)} â‚¬/kW/dÃ­a)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(p.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === SECCIÃ“N ENERGÃA ===
                        doc.setFillColor(100, 116, 139);
                        doc.roundedRect(x, y, width, 7, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ENERGÃA', x + 3, y + 5);
                        y += 9;
                        
                        // Desglose energÃ­a
                        doc.setTextColor(55, 65, 81);
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        res.energyCosts.forEach((e, i) => {
                            if (e.kwh > 0) {
                                let periodoNombre = '';
                                if (res.originalTariffType === '2.0TD') {
                                    if (i === 0) periodoNombre = ' (Punta)';
                                    else if (i === 1) periodoNombre = ' (Llano)';
                                    else if (i === 2) periodoNombre = ' (Valle)';
                                }
                                const texto = `E${i+1}${periodoNombre}: (${num(e.kwh, 0)} kWh x ${num(e.price, 6)} â‚¬/kWh)`;
                                doc.text(texto, x + 3, y);
                                doc.text(eur(e.cost), x + width - 3, y, { align: 'right' });
                                y += 4;
                            }
                        });
                        y += 2;
                        
                        // === TOTAL ===
                        doc.setFillColor(71, 85, 105);
                        doc.roundedRect(x, y, width, 9, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`TOTAL (${res.dias_facturados || 0} DÃAS)`, x + 3, y + 6);
                        doc.text(eur(res.totalPeriod || res.importe_total || 0), x + width - 3, y + 6, { align: 'right' });
                        y += 12;
                        
                        // === AHORRO ===
                        doc.setFillColor(220, 38, 38);
                        doc.roundedRect(x + width - 55, y, 52, 10, 2, 2, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AHORRO:', x + width - 52, y + 4);
                        doc.setFontSize(9);
                        doc.text(eur(res.savings || 0), x + width - 28, y + 7, { align: 'center' });
                    }
                    
                    // Por cada suministro
                    res.individualResults.forEach((supply, idx) => {
                        // Verificar si tiene comparaciÃ³n indexada
                        const tieneIndexado = supply.indexedComparison && 
                                             supply.indexedComparison.powerCosts && 
                                             supply.indexedComparison.energyCosts;
                        
                        if (tieneIndexado) {
                            // DISEÃ‘O DUAL: DOS COLUMNAS (FIJO vs INDEXADO)
                            const col2Width = (contentWidth - 6) / 2;
                            const leftXDual = margin;
                            const rightXDual = margin + col2Width + 6;
                            
                            const neededSpace = 140;
                            checkNewPage(neededSpace);
                            
                            // TÃ­tulo del suministro
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`SUMINISTRO ${idx + 1}`, margin + 3, yPos + 5.5);
                            yPos += 12;
                            
                            // Generar desgloses en dos columnas
                            generarDesgloseMultiCups(supply, supply.indexedComparison, leftXDual, col2Width, true);
                            generarDesgloseMultiCups(supply, supply.indexedComparison, rightXDual, col2Width, false);
                            
                            yPos += 135;
                            
                        } else {
                            // DISEÃ‘O SIMPLE: UNA SOLA COLUMNA (solo FIJO)
                            const neededSpace = supply.originalTariffType === '3.0TD' ? 140 : 100;
                            checkNewPage(neededSpace);
                            
                            // === CABECERA DEL SUMINISTRO (AZUL OSCURO) ===
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 12, 3, 3, 'FD');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`[${idx + 1}] ${supply.cups}`, margin + 3, yPos + 5);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            
                            // Mostrar nombre completo: Comercializadora - Tarifa
                            const comercializadoraName = supply.offer.name || '';
                            const tarifaName = supply.offer.description || supply.offer.name;
                            const fullOfferName = isDrk 
                                ? tarifaName 
                                : `${comercializadoraName} - ${tarifaName}`;
                            doc.text(`Tipo: ${supply.originalTariffType} | DÃ­as: ${supply.dias_facturados} | ${fullOfferName}`, margin + 3, yPos + 9);
                            yPos += 14;
                            
                            // === PRECIOS APLICADOS ARRIBA (DISEÃ‘O MEJORADO CON TÃTULOS) ===
                            const priceBoxH = supply.originalTariffType === '2.0TD' ? 38 : 52;
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(1);
                            doc.roundedRect(margin, yPos, contentWidth, priceBoxH, 3, 3, 'FD');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text('PRECIOS APLICADOS:', margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // === POTENCIA (con tÃ­tulo) ===
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('POTENCIA:', margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            if (supply.originalTariffType === '2.0TD') {
                                const p1S = supply.offer.p_potencia_1 / 365;
                                const p2S = supply.offer.p_potencia_2 / 365;
                                doc.text(`P1: ${numPriceFormula(p1S)} â‚¬/kW/dÃ­a`, margin + 8, yPos);
                                doc.text(`P2: ${numPriceFormula(p2S)} â‚¬/kW/dÃ­a`, margin + 70, yPos);
                                yPos += 6;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const pDS = (supply.offer[`p_potencia_${i}`] || 0) / 365;
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`P${i}: ${numPriceFormula(pDS)} â‚¬/kW/dÃ­a`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // === ENERGÃA (con tÃ­tulo) ===
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 5, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'bold');
                            if (supply.originalTariffType === '2.0TD') {
                                doc.text(`E1: ${numPriceFormula(supply.offer.p1_price)}`, margin + 8, yPos);
                                doc.text(`E2: ${numPriceFormula(supply.offer.p2_price)}`, margin + 50, yPos);
                                doc.text(`E3: ${numPriceFormula(supply.offer.p3_price)}`, margin + 95, yPos);
                                yPos += 8;
                            } else {
                                // 3.0TD - compacto
                                for (let i = 1; i <= 6; i++) {
                                    const col = i <= 3 ? margin + 8 : margin + 70;
                                    const row = i <= 3 ? i : i - 3;
                                    doc.text(`E${i}: ${numPriceFormula(supply.offer[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                                }
                                yPos += 12;
                            }
                            
                            // Espacio variable segÃºn tarifa
                            yPos += supply.originalTariffType === '3.0TD' ? 12 : 8;
                            
                            // === DESGLOSE DE CÃLCULOS (FUERA DE LA CAJA AZUL) ===
                            // TÃ­tulo POTENCIA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('POTENCIA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.powerCosts.forEach(p => {
                                if (p.kw > 0 || p.period <= 2) {
                                    checkNewPage(4);
                                    doc.text(`P${p.period} (${num(p.kw, 2)} kW x ${supply.dias_facturados}d x ${numPriceFormula(p.priceDay)})`, margin + 4, yPos);
                                    doc.text(`${num(p.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 4;
                            
                            // TÃ­tulo ENERGÃA
                            doc.setFillColor(...darkColor);
                            doc.roundedRect(margin, yPos, contentWidth / 2 - 2, 6, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA', margin + 2, yPos + 4);
                            yPos += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(7);
                            supply.energyCosts.forEach(e => {
                                const maxPeriod = supply.originalTariffType === '2.0TD' ? 3 : 6;
                                if (e.kwh > 0 || e.period <= maxPeriod) {
                                    checkNewPage(4);
                                    let labelE = `E${e.period}`;
                                    if (supply.originalTariffType === '2.0TD') {
                                        if (e.period === 1) labelE += ' (Punta)';
                                        if (e.period === 2) labelE += ' (Llano)';
                                        if (e.period === 3) labelE += ' (Valle)';
                                    }
                                    doc.text(`${labelE} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`, margin + 4, yPos);
                                    doc.text(`${num(e.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                                    yPos += 3.5;
                                }
                            });
                            
                            yPos += 3;
                            
                            // Total del suministro
                            doc.setFillColor(...darkColor);
                            doc.rect(margin, yPos, contentWidth, 7, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TOTAL (${supply.dias_facturados} DÃAS)`, margin + 2, yPos + 4.5);
                            doc.text(eur(supply.totalPeriod), pageWidth - margin - 2, yPos + 4.5, { align: 'right' });
                            yPos += 9;
                            
                            // === AHORRO INDIVIDUAL (DEBAJO DEL TOTAL) ===
                            if (!supply.isNegativeSavings) {
                                const ahorroWidth = 55;
                                const ahorroHeight = 8;
                                const ahorroX = pageWidth - margin - ahorroWidth;
                                
                                doc.setFillColor(...redColor);
                                doc.roundedRect(ahorroX, yPos, ahorroWidth, ahorroHeight, 2, 2, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'bold');
                                doc.text('AHORRO:', ahorroX + 2, yPos + 3.5);
                                doc.setFontSize(10);
                                doc.text(eur(supply.savings), ahorroX + ahorroWidth - 2, yPos + 6, { align: 'right' });
                                yPos += ahorroHeight + 4;
                            } else {
                                yPos += 3;
                            }
                        }
                    });
                    
                    // === PRECIOS CONSOLIDADOS (REDISEÃ‘ADO) ===
                    checkNewPage(35);
                    
                    // TÃ­tulo principal con fondo verde
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRECIOS DE LAS OFERTAS SELECCIONADAS', margin + 3, yPos + 6.5);
                    yPos += 14;
                    
                    const winningOffers = getWinningOffersPerType(res.individualResults);
                    const offers20MC = winningOffers.winningOffers['2.0TD'];
                    if (offers20MC && offers20MC.length > 0) {
                        offers20MC.forEach((offer20, index) => {
                            checkNewPage(35);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 32, 3, 3, 'FD');
                            
                            // TÃ­tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 2.0TD #${index + 1}: ${offer20.description || offer20.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con tÃ­tulo)
                            doc.setFontSize(7);
                            doc.text('POTENCIA:', margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            const p120 = offer20.p_potencia_1 / 365;
                            const p220 = offer20.p_potencia_2 / 365;
                            doc.text(`P1: ${numPriceFormula(p120)} â‚¬/kW/dÃ­a`, margin + 5, yPos);
                            doc.text(`P2: ${numPriceFormula(p220)} â‚¬/kW/dÃ­a`, margin + 70, yPos);
                            yPos += 5;
                            
                            // ENERGÃA (con tÃ­tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 3, yPos);
                            yPos += 4;
                            
                            doc.text(`E1: ${numPriceFormula(offer20.p1_price)}`, margin + 5, yPos);
                            doc.text(`E2: ${numPriceFormula(offer20.p2_price)}`, margin + 48, yPos);
                            doc.text(`E3: ${numPriceFormula(offer20.p3_price)}`, margin + 93, yPos);
                            
                            yPos += 20; // MÃ¡s espacio entre tarifas (antes 12)
                        });
                    }
                    
                    const offers30MC = winningOffers.winningOffers['3.0TD'];
                    if (offers30MC && offers30MC.length > 0) {
                        offers30MC.forEach((offer30, index) => {
                            checkNewPage(60);
                            
                            // Caja con fondo azul oscuro y borde blanco
                            doc.setFillColor(...darkColor);
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(2);
                            doc.roundedRect(margin, yPos, contentWidth, 56, 3, 3, 'FD');
                            
                            // TÃ­tulo de la tarifa (blanco)
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(9);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`TARIFA 3.0TD #${index + 1}: ${offer30.description || offer30.name}`, margin + 3, yPos + 5);
                            yPos += 10;
                            
                            // POTENCIA (con tÃ­tulo)
                            doc.setFontSize(7);
                            doc.text('POTENCIA:', margin + 3, yPos);
                            yPos += 4;
                            
                            doc.setFont('helvetica', 'normal');
                            for (let i = 1; i <= 6; i++) {
                                const pDay30 = (offer30[`p_potencia_${i}`] || 0) / 365;
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`P${i}: ${numPriceFormula(pDay30)} â‚¬/kW/dÃ­a`, col, yPos + (row - 1) * 3.5);
                            }
                            yPos += 12;
                            
                            // ENERGÃA (con tÃ­tulo)
                            doc.setFont('helvetica', 'bold');
                            doc.text('ENERGÃA:', margin + 3, yPos);
                            yPos += 4;
                            
                            for (let i = 1; i <= 6; i++) {
                                const col = i <= 3 ? margin + 5 : margin + 70;
                                const row = i <= 3 ? i : i - 3;
                                doc.text(`E${i}: ${numPriceFormula(offer30[`p${i}_price`] || 0)}`, col, yPos + (row - 1) * 3.5);
                            }
                            
                            yPos += 20; // MÃ¡s espacio despuÃ©s de 3.0TD (antes 18)
                        });
                    }
                    
                    // FIN SECCION MULTICUPS
                    
                } else {
                    // === INICIO INDIVIDUAL - DISEÃ‘O COMPACTO TIPO TARJETA ===
                
                // === CABECERA AZUL (MÃS PEQUEÃ‘A) ===
                doc.setFillColor(...primaryColor);
                doc.roundedRect(margin, yPos, contentWidth, 32, 4, 4, 'F');
                
                // "LA MEJOR OPCIÃ“N PARA TI ES"
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, yPos + 8, { align: 'center' });
                
                // Comercializadora y Tarifa
                const comercializadora = offer.name; // Nombre corto (ej: ELEIA)
                const tarifaCompleta = (offer.description && offer.description !== 'N/A') ? offer.description : offer.name;
                const brandName = isDrk ? 'DRK' : 'POWER CUP';
                
                if (!isDrk) {
                    // POWER CUP Individual: Solo mostrar comercializadora (nombre corto)
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(comercializadora.toUpperCase(), pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    // POWER CUP debajo
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('POWER CUP', pageWidth / 2, yPos + 27, { align: 'center' });
                } else {
                    // DRK: Mostrar solo DRK y nombre de tarifa
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DRK', pageWidth / 2, yPos + 18, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(tarifaCompleta, pageWidth / 2, yPos + 27, { align: 'center' });
                }
                
                yPos += 37;
                
                // === CAJA BLANCA COMPACTA ===
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                const boxHeightIndiv = res.savings > 0 ? 75 : 65;
                doc.roundedRect(margin, yPos, contentWidth, boxHeightIndiv, 4, 4, 'FD');
                
                if (res.savings > 0) {
                    // Ahorro positivo - diseÃ±o normal
                    doc.setTextColor(120, 120, 140);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TU AHORRO ANUAL ESTIMADO', pageWidth / 2, yPos + 8, { align: 'center' });
                    
                    // Cifra de ahorro en VERDE (grande pero ajustado)
                    doc.setTextColor(...greenColor);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(savingsText, pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    yPos += 32;
                } else {
                    // Sin ahorro - mensaje grande centrado
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Â¡ENHORABUENA!', pageWidth / 2, yPos + 12, { align: 'center' });
                    
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Actualmente estÃ¡s en una buena tarifa.', pageWidth / 2, yPos + 25, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Seguiremos estudiando el mercado y te avisaremos cuando', pageWidth / 2, yPos + 38, { align: 'center' });
                    doc.text('encontremos alguna tarifa que se adapte a tu perfil de consumo.', pageWidth / 2, yPos + 45, { align: 'center' });
                    
                    yPos += 67;
                }
                
                // === DOS COLUMNAS COMPACTAS === (Solo si hay ahorro)
                if (res.savings > 0) {
                const colWidthResumen = (contentWidth - 20) / 2;
                
                // COLUMNA IZQUIERDA - TU FACTURA ACTUAL
                const leftXResumen = margin + 10;
                
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('TU FACTURA ACTUAL', leftXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio periodo (mensual estimado) tachado en rojo
                const diasPeriodo = res.dias_facturados || 30;
                const precioMensualEstimado = (res.originalBillAnnual / 365) * 30;
                const oldPrice = `${eur(precioMensualEstimado)}/mes`;
                doc.setTextColor(...redColor);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const oldX = leftXResumen + colWidthResumen / 2;
                const oldY = yPos + 12;
                doc.text(oldPrice, oldX, oldY, { align: 'center' });
                
                // LÃ­nea tachada
                const oldWidth = doc.getTextWidth(oldPrice);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldX - oldWidth/2 - 2, oldY - 3, oldX + oldWidth/2 + 2, oldY - 3);
                
                // "Total Periodo"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total Periodo (${diasPeriodo} dÃ­as)`, leftXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual tachado
                const oldAnnual = eur(res.originalBillAnnual);
                doc.setTextColor(...redColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                const oldAnnualX = leftXResumen + colWidthResumen / 2;
                const oldAnnualY = yPos + 32;
                doc.text(`${oldAnnual}/aÃ±o`, oldAnnualX, oldAnnualY, { align: 'center' });
                
                // LÃ­nea tachada
                const oldAnnualWidth = doc.getTextWidth(`${oldAnnual}/aÃ±o`);
                doc.setDrawColor(...redColor);
                doc.setLineWidth(1.5);
                doc.line(oldAnnualX - oldAnnualWidth/2 - 2, oldAnnualY - 3, oldAnnualX + oldAnnualWidth/2 + 2, oldAnnualY - 3);
                
                // SEPARADOR VERTICAL
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.line(pageWidth / 2, yPos - 5, pageWidth / 2, yPos + 38);
                
                // COLUMNA DERECHA - TU NUEVO COSTE
                const rightXResumen = margin + 10 + colWidthResumen + 10;
                
                doc.setTextColor(...primaryColor);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                const newLabel = `TU NUEVO COSTE ${brandName}`;
                doc.text(newLabel, rightXResumen + colWidthResumen / 2, yPos, { align: 'center' });
                
                // Precio mensual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual / 12)}/mes`, rightXResumen + colWidthResumen / 2, yPos + 13, { align: 'center' });
                
                // "Estimado Mensual"
                doc.setTextColor(140, 150, 160);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text('Estimado Mensual', rightXResumen + colWidthResumen / 2, yPos + 19, { align: 'center' });
                
                // Precio anual en azul
                doc.setTextColor(...primaryColor);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${eur(res.totalAnnual)}/aÃ±o`, rightXResumen + colWidthResumen / 2, yPos + 32, { align: 'center' });
                
                yPos += 50;
                } // Fin del condicional de columnas de precios en Individual
                
                // === PRECIOS DE LA OFERTA EN PÃGINA 1 (sin check de espacio) ===
                if (!res.isMulti) {
                    // Titulo con fondo VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - DescripciÃ³n"
                    // Si no, solo mostrar el nombre
                    const fullOfferTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`PRECIOS DE LA OFERTA: ${fullOfferTitle}`, margin + 5, yPos + 6.5);
                    yPos += 12;
                    
                    // Caja con FONDO AZUL OSCURO y BORDE BLANCO
                    doc.setFillColor(...darkColor);
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(3);
                    const priceBoxHeight = tariffType === '2.0TD' ? 40 : 75;
                    doc.roundedRect(margin, yPos, contentWidth, priceBoxHeight, 3, 3, 'FD');
                    
                    // POTENCIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('POTENCIA:', margin + 5, yPos + 6);
                    yPos += 9;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        const p1 = offer.p_potencia_1 / 365;
                        const p2 = offer.p_potencia_2 / 365;
                        doc.text(`P1 (â‚¬/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p1), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`P2 (â‚¬/kW/dia):`, margin + 8, yPos);
                        doc.text(numPriceFormula(p2), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            const pDay = (offer[`p_potencia_${i}`] || 0) / 365;
                            doc.text(`P${i} (â‚¬/kW/dia):`, margin + 8, yPos);
                            doc.text(numPriceFormula(pDay), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 3;
                    }
                    
                    // ENERGIA (texto blanco)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ENERGIA:', margin + 5, yPos);
                    yPos += 5;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    
                    if (tariffType === '2.0TD') {
                        doc.text(`E1 - Punta (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p1_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E2 - Llano (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p2_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 5;
                        doc.text(`E3 - Valle (â‚¬/kWh):`, margin + 8, yPos);
                        doc.text(numPriceFormula(offer.p3_price), pageWidth - margin - 8, yPos, { align: 'right' });
                        yPos += 7;
                    } else {
                        for (let i = 1; i <= 6; i++) {
                            doc.text(`E${i} (â‚¬/kWh):`, margin + 8, yPos);
                            doc.text(numPriceFormula(offer[`p${i}_price`] || 0), pageWidth - margin - 8, yPos, { align: 'right' });
                            yPos += 4.5;
                        }
                        yPos += 5;
                    }
                    
                    // === NUEVA PÃGINA PARA EL DESGLOSE ===
                    doc.addPage();
                    yPos = 20;
                }
                
                // === DESGLOSE DETALLADO ===
                if (!res.isMulti) {
                    // TÃ­tulo del desglose (ahora en pÃ¡gina 2) - VERDE
                    doc.setFillColor(...greenColor); // VERDE
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    // Mostrar Comercializadora - Tarifa completa
                    // Si description existe y es diferente de name, usar "Comercializadora - DescripciÃ³n"
                    // Si no, solo mostrar el nombre
                    const fullDesgloseTitle = (tarifaCompleta !== comercializadora) 
                        ? `${comercializadora} - ${tarifaCompleta}` 
                        : comercializadora;
                    doc.text(`DESGLOSE DETALLADO DE LA SIMULACIÃ“N (${fullDesgloseTitle})`, margin + 3, yPos + 6.5);
                    
                    yPos += 14;
                    
                    // === TÃ‰RMINO POTENCIA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.powerCosts.forEach((p, idx) => {
                        if (p.kw > 0 || p.period <= config.powerPeriods) {
                            const formula = `P${p.period} (${num(p.kw, 2)} kW x ${res.dias_facturados}d x ${numPriceFormula(p.priceDay)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(p.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal potencia
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primaryColor);
                    doc.text('SUBTOTAL POTENCIA', margin + 2, yPos);
                    doc.text(`${num(res.subPower, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                    
                    // === TÃ‰RMINO ENERGÃA ===
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', margin, yPos);
                    yPos += 6;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    
                    res.energyCosts.forEach((e, idx) => {
                        if (e.kwh > 0 || e.period <= config.periods) {
                            let label = `E${e.period}`;
                            if (tariffType === '2.0TD') {
                                if (e.period === 1) label += ' - Punta';
                                if (e.period === 2) label += ' - Llano';
                                if (e.period === 3) label += ' - Valle';
                            }
                            const formula = `${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)})`;
                            doc.text(formula, margin + 2, yPos);
                            doc.text(`${num(e.cost, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                            yPos += 5;
                        }
                    });
                    
                    // Subtotal energÃ­a bruto
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(80, 80, 80);
                    doc.text('Subtotal EnergÃ­a (Bruto)', margin + 2, yPos);
                    doc.text(`${num(res.subEnergy, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Descuento si existe
                    if (res.discountAmount > 0) {
                        doc.setTextColor(...redColor);
                        doc.text(`Descuento Aplicado (${num(res.discountRate * 100, 0)}%)`, margin + 2, yPos);
                        doc.text(`-${num(res.discountAmount, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text('Subtotal EnergÃ­a (Neto)', margin + 2, yPos);
                        doc.text(`${num(res.subEnergyNet, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                        yPos += 5;
                    }
                    
                    yPos += 3;
                    
                    // === TOTALES ===
                    // LÃ­nea separadora
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    
                    // Subtotal base
                    doc.text('SUBTOTAL BASE (P+E)', margin + 2, yPos);
                    doc.text(`${num(res.subBase, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Impuesto elÃ©ctrico
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Imp. ElÃ©c. (${num(res.ieRate * 100, 3)}%)`, margin + 2, yPos);
                    doc.text(`${num(res.costIE, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // Base imponible
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text('BASE IMPONIBLE', margin + 2, yPos);
                    doc.text(`${num(res.baseImp, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 5;
                    
                    // IVA
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text('IVA (21%)', margin + 2, yPos);
                    doc.text(`${num(res.costIVA, 2)} â‚¬`, pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 7;
                    
                    // TOTAL FACTURA
                    doc.setFillColor(...darkColor);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`TOTAL FACTURA (${res.dias_facturados} DÃAS)`, margin + 3, yPos + 6.5);
                    doc.text(eur(res.totalPeriod), pageWidth - margin - 3, yPos + 6.5, { align: 'right' });
                    yPos += 14;
                    
                    // Total aÃ±o
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(10);
                    doc.text('TOTAL AÃ‘O (PROYECTADO)', margin + 2, yPos);
                    doc.text(eur(res.totalAnnual), pageWidth - margin - 2, yPos, { align: 'right' });
                    yPos += 8;
                }
                
                } // FIN del else - cierre de seccion individual
                
                // === RESUMEN DE AHORRO FINAL (COMÃšN PARA INDIVIDUAL Y MULTICUPS) ===
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                } else {
                    yPos += 15; // Espacio antes de la caja verde (para que no se solape con tarifas consolidadas)
                }
                
                doc.setFillColor(...redColor); // ROJO
                doc.roundedRect(margin, yPos, contentWidth, 20, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TU AHORRO ANUAL ESTIMADO ES:', margin + 5, yPos + 7);
                
                doc.setFontSize(22);
                doc.text(`${savingsText} / AÃ‘O`, margin + 5, yPos + 16);
                
                yPos += 30; // MÃ¡s espacio despuÃ©s de la caja verde (antes 25)
                
                // === CUADRO DE FORMALIZACION CON FONDO AZUL OSCURO ===
                checkNewPage(60);
                
                // Cuadro principal con FONDO AZUL OSCURO y BORDE BLANCO
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(3);
                doc.setFillColor(...darkColor);
                doc.roundedRect(margin, yPos, contentWidth, 55, 3, 3, 'FD');
                
                // Encabezado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('PARA FORMALIZAR ESTE CONTRATO:', margin + 5, yPos + 8);
                
                yPos += 13;
                
                // Instruccion principal (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                if (res.isMulti) {
                    doc.text(`Responde a este email adjuntando la documentacion de los ${res.individualResults.length} CUPS:`, margin + 5, yPos);
                } else {
                    doc.text('Responde a este email adjuntando la siguiente documentacion:', margin + 5, yPos);
                }
                
                yPos += 6;
                
                // Lista de documentos (texto blanco)
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(255, 255, 255);
                
                const docs = [
                    '1. Foto del DNI/CIF (anverso y reverso)',
                    '2. Ultima factura (minimo 3 meses de antiguedad)',
                    '3. Email de contacto para validacion',
                    '4. Telefono de contacto',
                    '5. Numero de cuenta bancaria (IBAN)'
                ];
                
                docs.forEach((docItem, idx) => {
                    doc.text(docItem, margin + 8, yPos);
                    yPos += 4.5;
                });
                
                yPos += 2;
                
                // Separador (blanco)
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);
                doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                yPos += 4;
                
                // Email de contacto destacado (texto blanco)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Envia la documentacion al comercial:', margin + 5, yPos);
                yPos += 4;
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(commercialCode, margin + 5, yPos);
                
                yPos += 10;
                
                // === PIE DE PÃGINA ===
                const footerY = 280;
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(1.5);
                doc.line(margin, footerY, pageWidth - margin, footerY);
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`[Colaborador: ${commercialCode}] | Este resumen es una simulacion ${res.isMulti ? `consolidada de ${res.individualResults.length} suministros` : 'basada en su ultima factura'}.`, margin, footerY + 5);
                
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`Generado el ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin - 35, footerY + 5);
                
                // === GUARDAR PDF ===
                const fileName = res.isMulti 
                    ? `Comparativa_MultiCups_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`
                    : `Comparativa_${res.cups.substring(0, 10)}_${clientName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`;
                
                doc.save(fileName);
                
                // Cerrar modal y mostrar Ã©xito
                hideErrorModal();
                window.showMessageModal(`âœ… Â¡PDF generado con Ã©xito!\n\nSe ha descargado: ${fileName}\n\nPuedes adjuntarlo directamente en el email para tu cliente.`);
                document.getElementById('send-offer-modal').classList.add('hidden');
                document.getElementById('send-offer-modal').classList.remove('flex');
                
            } catch (e) {
                console.error("Error al generar PDF:", e);
                window.showErrorModal(`Error al generar PDF: ${e.message}`);
            }
        }
        
        // --- GENERACIÃ“N DE HTML PARA COMPARACIÃ“N DUAL (FIJO VS INDEXADO) ---
        
        function generateDualStyledHtmlOffer(commercialCode, resFijo, resIndexed) {
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCIÃ“N DE POWER CUP
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores dinÃ¡micos
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = resFijo.savings;
            const ahorroIndexado = resIndexed.savings;
            
            // Generar desglose de precios FIJO
            let preciosFijoHtml = '';
            preciosFijoHtml += '<div><strong>POTENCIA:</strong></div>';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                }
            });
            preciosFijoHtml += '<div style="margin-top: 4px;"><strong>ENERGÃA:</strong></div>';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosFijoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                }
            });
            
            // Generar desglose de precios INDEXADO
            let preciosIndexadoHtml = '';
            preciosIndexadoHtml += '<div><strong>POTENCIA:</strong></div>';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                }
            });
            preciosIndexadoHtml += '<div style="margin-top: 4px;"><strong>ENERGÃA:</strong></div>';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    preciosIndexadoHtml += `<div style="font-size: 9px;">E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                }
            });
            
            // Generar desglose detallado FIJO
            let detallesFijoHtml = '';
            resFijo.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            let energiaFijoHtml = '';
            resFijo.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resFijo.originalTariffType === '2.0TD') {
                        if (i === 0) label += ' (Punta)';
                        else if (i === 1) label += ' (Llano)';
                        else if (i === 2) label += ' (Valle)';
                    }
                    energiaFijoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            // Generar desglose detallado INDEXADO
            let detallesIndexadoHtml = '';
            resIndexed.powerCosts.forEach((p, i) => {
                if (p.kw > 0) {
                    detallesIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>P${i+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                            <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            let energiaIndexadoHtml = '';
            resIndexed.energyCosts.forEach((e, i) => {
                if (e.kwh > 0) {
                    let label = `E${i+1}`;
                    if (resIndexed.originalTariffType === '2.0TD') {
                        if (i === 0) label += ' (Punta)';
                        else if (i === 1) label += ' (Llano)';
                        else if (i === 2) label += ' (Valle)';
                    }
                    energiaIndexadoHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                            <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                            <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                        </div>
                    `;
                }
            });
            
            // EMAIL BODY con precios detallados
            const LB = '%0A';
            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA COMPARATIVA${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica que detallo a continuaciÃ³n:${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“‹ DATOS DEL SUMINISTRO${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ”Œ CUPS: ${resFijo.cups}${LB}` +
                             `ðŸ“Š Tipo: ${resFijo.originalTariffType}${LB}` +
                             `ðŸ“… DÃ­as facturados: ${resFijo.dias_facturados}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’° COMPARACIÃ“N DE AHORROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ’¼ Ahorro con Tarifa FIJA: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste: ${eur(resFijo.totalAnnual / 12)}/mes (${eur(resFijo.totalAnnual)}/aÃ±o)${LB}${LB}` +
                             `âš¡ Ahorro con Tarifa INDEXADA: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste: ${eur(resIndexed.totalAnnual / 12)}/mes (${eur(resIndexed.totalAnnual)}/aÃ±o)${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¡ PRECIOS DETALLADOS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“˜ OPCIÃ“N FIJA (${resFijo.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resFijo.powerCosts.map((p, i) => p.kw > 0 ? `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}` : '').join('') +
                             `${LB}   EnergÃ­a:${LB}` +
                             resFijo.energyCosts.map((e, i) => e.kwh > 0 ? `   â€¢ E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}` : '').join('') +
                             `${LB}ðŸ“— OPCIÃ“N INDEXADA (${resIndexed.offer.name}):${LB}` +
                             `   Potencia:${LB}` +
                             resIndexed.powerCosts.map((p, i) => p.kw > 0 ? `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}` : '').join('') +
                             `${LB}   EnergÃ­a:${LB}` +
                             resIndexed.energyCosts.map((e, i) => e.kwh > 0 ? `   â€¢ E${i+1}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}` : '').join('') +
                             `${LB}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `âœ… MI DECISIÃ“N (Marca con X):${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[ ] ACEPTO TARIFA FIJA${LB}` +
                             `    Ahorro: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual: ${eur(resFijo.totalAnnual / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFA INDEXADA${LB}` +
                             `    Ahorro: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual: ${eur(resIndexed.totalAnnual / 12)}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“› Nombre: ${clientName}${LB}` +
                             `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                             `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `âœ“ DNI/CIF (anverso y reverso)${LB}` +
                             `âœ“ Ãšltima factura${LB}` +
                             `âœ“ Email Â· TelÃ©fono Â· IBAN${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Quedo a la espera de confirmaciÃ³n.${LB}${LB}` +
                             `Atentamente,${LB}${clientName}${LB}${LB}` +
                             `Comercial: ${commercialCode}`;
            
            const subject = `âœ… FORMALIZACIÃ“N - ${resFijo.cups} - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <!-- HEADER ESTILO PDF -->
                    ${isPowerCup ? `
                        <!-- POWER CUP Header -->
                        <div style="border: 3px solid #84cc16; background-color: white; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: #3f6212; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">POWER CUP</h1>
                                        <p style="color: #65a30d; font-size: 16px; margin: 8px 0 0 0; font-weight: 600;">AsesorÃ­a EnergÃ©tica</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: #84cc16; font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: #3f6212; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    ` : `
                        <!-- DRK Header -->
                        <div style="background-color: #2e5266; padding: 25px 30px; border-radius: 8px; margin-bottom: 20px;">
                            <table cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td style="width: 50%; vertical-align: middle;">
                                        <h1 style="color: white; font-size: 42px; font-weight: bold; margin: 0; letter-spacing: -1px;">DRK ENERGÃA</h1>
                                        <p style="color: rgba(255,255,255,0.9); font-size: 16px; margin: 8px 0 0 0;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle;">
                                        <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 0 0 5px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">ESTUDIO DE AHORRO</p>
                                        <p style="color: white; font-size: 18px; margin: 0; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    `}
                    
                    <!-- CAJA PRINCIPAL -->
                    <div style="background-color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">LA MEJOR OPCIÃ“N PARA TI ES</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">Ofrece el mayor ahorro consolidado con ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <!-- TRES COLUMNAS -->
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <!-- FACTURA ACTUAL -->
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;">TU FACTURA ACTUAL</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillPeriod)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;">Total Periodo</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(resFijo.originalBillAnnual)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO FIJO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">TU AHORRO ANUAL FIJO</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">TU NUEVO COSTE ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual / 12)}/mes</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;">Estimado Mensual</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(resFijo.totalAnnual)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- AHORRO INDEXADO -->
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">TU AHORRO ANUAL INDEXADO</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">TU NUEVO COSTE ${BRAND_DISPLAY}</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual / 12)}/mes</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;">Estimado Mensual</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(resIndexed.totalAnnual)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- DESGLOSE DETALLADO -->
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESGLOSE DETALLADO POR SUMINISTRO</div>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                        <tr>
                            <!-- COLUMNA FIJO -->
                            <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resFijo.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resFijo.originalTariffType} | DÃ­as: ${resFijo.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} - ${resFijo.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosFijoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERGÃA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaFijoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resFijo.dias_facturados} DÃAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resFijo.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroFijo)}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- COLUMNA INDEXADO -->
                            <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${resIndexed.cups}]</div>
                                        <div style="font-size: 9px; opacity: 0.9;">Tipo: ${resIndexed.originalTariffType} | DÃ­as: ${resIndexed.dias_facturados}</div>
                                        <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${BRAND_DISPLAY} INDEX - ${resIndexed.offer.name}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                                        <div style="font-size: 9px;">${preciosIndexadoHtml}</div>
                                    </div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">POTENCIA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${detallesIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">ENERGÃA</div>
                                    <div style="padding: 10px; background-color: #f8fafc;">${energiaIndexadoHtml}</div>
                                    
                                    <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                        <span style="font-size: 11px; font-weight: bold;">TOTAL (${resIndexed.dias_facturados} DÃAS)</span>
                                        <span style="font-size: 13px; font-weight: bold;">${eur(resIndexed.totalPeriod)}</span>
                                    </div>
                                    
                                    <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                                        <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                                        <div style="font-size: 18px; font-weight: bold;">${eur(ahorroIndexado)}</div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- EXPLICACIÃ“N -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                        <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                        <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOTÃ“N EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">ðŸ“Š</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>Haz clic en el botÃ³n de abajo</li>
                                <li>Se abrirÃ¡ tu cliente de email</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">Adjunta documentaciÃ³n del CUPS</strong></li>
                                <li>EnvÃ­a el email</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                âœ… CONFIRMAR OFERTA CONSOLIDADA
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>ðŸ“Ž Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FOOTER -->
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }
        
        function generateMultiDualStyledHtmlOffer(commercialCode) {
            const res = lastComparisonResult;
            const brand = activeBrand;
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // DETECCIÃ“N DE POWER CUP para cambiar colores
            const isPowerCup = brand.NAME.includes('POWER');
            
            // Colores dinÃ¡micos segÃºn la marca - TODO EN VERDE OLIVA PARA POWER CUP
            const HEADER_BLUE = isPowerCup ? '#738257' : '#6B7D8E';  // Verde oliva para PowerCup
            const DRK_BLUE = isPowerCup ? '#84cc16' : '#0ea5e9';     // Verde para PowerCup
            const GREEN_SAVE = '#16a34a';
            const RED_CTA = '#DC2626';
            const SLATE_DARK = isPowerCup ? '#5a6b47' : '#475569';   // Verde oliva oscuro para PowerCup
            const SLATE_MED = isPowerCup ? '#738257' : '#64748b';    // Verde oliva medio para PowerCup
            
            const BRAND_DISPLAY = isPowerCup ? 'POWER CUP' : 'DRK';  // Nombre a mostrar
            
            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const ahorroFijo = res.savings;
            const ahorroIndexado = res.indexedTotals ? res.indexedTotals.savings : 0;
            
            let facturaActualTotal = 0;
            let nuevoCosteAnualFijo = 0;
            let nuevoCosteAnualIndexado = 0;
            
            res.individualResults.forEach(supply => {
                facturaActualTotal += supply.originalBillAnnual || 0;
                nuevoCosteAnualFijo += supply.totalAnnual || 0;
                if (supply.indexedComparison) {
                    nuevoCosteAnualIndexado += supply.indexedComparison.totalAnnual || 0;
                }
            });
            
            // Generar emailBody para MULTICUPS con PRECIOS DETALLADOS
            const LB = '%0A';
            let cupsList = '';
            res.individualResults.forEach((supply, idx) => {
                cupsList += `   ${idx + 1}. ${supply.cups}${LB}`;
            });
            
            // Generar desglose detallado de precios por cada CUPS
            let preciosDetalladosHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    preciosDetalladosHtml += `${LB}â”â”â” CUPS ${idx + 1}: ${supply.cups} â”â”â”${LB}${LB}`;
                    
                    // OPCIÃ“N FIJA
                    preciosDetalladosHtml += `ðŸ“˜ OPCIÃ“N FIJA (${supply.offer.name || 'DRK FIJO'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    supply.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   EnergÃ­a:${LB}`;
                    supply.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   â€¢ ${label}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   ðŸ“Š Coste Anual: ${eur(supply.totalAnnual / 12)}/mes (${eur(supply.totalAnnual)}/aÃ±o)${LB}`;
                    preciosDetalladosHtml += `   ðŸ’° Ahorro: ${eur(supply.savings)}${LB}${LB}`;
                    
                    // OPCIÃ“N INDEXADA
                    const indexData = supply.indexedComparison;
                    preciosDetalladosHtml += `ðŸ“— OPCIÃ“N INDEXADA (${indexData.offer.name || 'DRK INDEX'}):${LB}`;
                    preciosDetalladosHtml += `   Potencia:${LB}`;
                    indexData.powerCosts.forEach((p, i) => {
                        if (p.kw > 0) {
                            preciosDetalladosHtml += `   â€¢ P${i+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   EnergÃ­a:${LB}`;
                    indexData.energyCosts.forEach((e, i) => {
                        if (e.kwh > 0) {
                            let label = `E${i+1}`;
                            if (supply.originalTariffType === '2.0TD') {
                                if (i === 0) label += ' (Punta)';
                                else if (i === 1) label += ' (Llano)';
                                else if (i === 2) label += ' (Valle)';
                            }
                            preciosDetalladosHtml += `   â€¢ ${label}: ${numPriceFormula(e.price)} â‚¬/kWh${LB}`;
                        }
                    });
                    preciosDetalladosHtml += `${LB}   ðŸ“Š Coste Anual: ${eur(indexData.totalAnnual / 12)}/mes (${eur(indexData.totalAnnual)}/aÃ±o)${LB}`;
                    preciosDetalladosHtml += `   ðŸ’° Ahorro: ${eur(indexData.savings)}${LB}${LB}`;
                }
            });
            
            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA MULTICUPS${LB}${LB}` +
                             `Estimado equipo de ${brand.NAME.toUpperCase()},${LB}${LB}` +
                             `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica consolidada que detallo a continuaciÃ³n:${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“‹ DATOS DE LOS SUMINISTROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“Š Total de CUPS: ${res.cups}${LB}${LB}` +
                             `ðŸ”Œ CUPS incluidos:${LB}${cupsList}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’° COMPARACIÃ“N DE AHORROS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ’¼ Ahorro Total con Tarifas FIJAS: ${eur(ahorroFijo)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualFijo)} (${eur(nuevoCosteAnualFijo / 12)}/mes)${LB}${LB}` +
                             `âš¡ Ahorro Total con Tarifas INDEXADAS: ${eur(ahorroIndexado)}${LB}` +
                             `   Nuevo Coste Anual: ${eur(nuevoCosteAnualIndexado)} (${eur(nuevoCosteAnualIndexado / 12)}/mes)${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¡ PRECIOS DETALLADOS POR CUPS${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${preciosDetalladosHtml}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `âœ… MI DECISIÃ“N (Marca con X):${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS FIJAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroFijo)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualFijo / 12)}${LB}${LB}` +
                             `[ ] ACEPTO TARIFAS INDEXADAS para todos los CUPS${LB}` +
                             `    Ahorro total: ${eur(ahorroIndexado)}${LB}` +
                             `    Coste mensual estimado: ${eur(nuevoCosteAnualIndexado / 12)}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `ðŸ“› Nombre completo: ${clientName}${LB}` +
                             `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                             `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA (Por cada CUPS)${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Adjunto la siguiente documentaciÃ³n para formalizar los ${res.cups} contratos:${LB}${LB}` +
                             `âœ“ DNI/CIF (anverso y reverso)${LB}` +
                             `âœ“ Ãšltima factura de cada CUPS${LB}` +
                             `âœ“ Email Â· TelÃ©fono Â· IBAN${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                             `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                             `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                             `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n de los contratos.${LB}${LB}` +
                             `Atentamente,${LB}` +
                             `${clientName}${LB}${LB}` +
                             `Comercial: ${commercialCode}`;
            
            const subject = `âœ… FORMALIZACIÃ“N MULTICUPS - ${res.cups} CUPS - ${brand.NAME.toUpperCase()}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
            
            function generarColumnaDesglosePro(supply, isIndexed) {
                const data = isIndexed ? supply.indexedComparison : supply;
                if (!data || !data.powerCosts || !data.energyCosts) return '';
                
                // Usar el nombre correcto de la marca
                const marcaNombre = isPowerCup ? 'POWER CUP' : 'DRK';
                const nombreTarifa = isIndexed ? 
                    `${marcaNombre} INDEX - ${data.offer.name || (isPowerCup ? 'POWER CUP INDEX 4 2026' : 'DRK INDEX 4 2026')}` : 
                    `${marcaNombre} - ${data.offer.name || (isPowerCup ? 'POWER CUP FIJO 6 META 4' : 'DRK FIJO 6 META 4')}`;
                
                let htmlPotencia = '';
                data.powerCosts.forEach((p, idx) => {
                    if (p.kw > 0) {
                        htmlPotencia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>P${idx+1}: (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a)</span>
                                <span style="font-weight: bold;">${num(p.cost, 2)} â‚¬</span>
                            </div>
                        `;
                    }
                });
                
                let htmlEnergia = '';
                data.energyCosts.forEach((e, idx) => {
                    if (e.kwh > 0) {
                        let label = `E${idx+1}`;
                        if (supply.originalTariffType === '2.0TD') {
                            if (idx === 0) label += ' (Punta)';
                            else if (idx === 1) label += ' (Llano)';
                            else if (idx === 2) label += ' (Valle)';
                        }
                        htmlEnergia += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; color: #374151;">
                                <span>${label}: (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} â‚¬/kWh)</span>
                                <span style="font-weight: bold;">${num(e.cost, 2)} â‚¬</span>
                            </div>
                        `;
                    }
                });
                
                let preciosPotenciaHtml = '';
                data.powerCosts.forEach((p, idx) => {
                    preciosPotenciaHtml += `<div style="font-size: 9px;">P${idx+1}: ${numPriceFormula(p.priceDay)} â‚¬/kW/dÃ­a</div>`;
                });
                
                let preciosEnergiaHtml = '';
                data.energyCosts.forEach((e, idx) => {
                    preciosEnergiaHtml += `<div style="font-size: 9px;">E${idx+1}: ${numPriceFormula(e.price)} â‚¬/kWh</div>`;
                });
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; border-radius: 12px 12px 0 0;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">[${data.cups}]</div>
                            <div style="font-size: 9px; opacity: 0.9;">Tipo: ${data.originalTariffType} | DÃ­as: ${data.dias_facturados}</div>
                            <div style="font-size: 9px; margin-top: 4px; opacity: 0.95;">${nombreTarifa}</div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 10px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">PRECIOS APLICADOS:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">POTENCIA:</div>
                                    ${preciosPotenciaHtml}
                                </div>
                                <div>
                                    <div style="font-size: 9px; font-weight: bold; margin-bottom: 3px;">ENERGÃA:</div>
                                    ${preciosEnergiaHtml}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 1px; font-size: 10px; font-weight: bold;">
                            POTENCIA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlPotencia}
                        </div>
                        
                        <div style="background-color: ${SLATE_MED}; color: white; padding: 8px; margin-top: 6px; font-size: 10px; font-weight: bold;">
                            ENERGÃA
                        </div>
                        <div style="padding: 10px; background-color: #f8fafc;">
                            ${htmlEnergia}
                        </div>
                        
                        <div style="background-color: ${SLATE_DARK}; color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 11px; font-weight: bold;">TOTAL (${data.dias_facturados} DÃAS)</span>
                            <span style="font-size: 13px; font-weight: bold;">${eur(data.totalPeriod)}</span>
                        </div>
                        
                        <div style="background-color: ${RED_CTA}; color: white; padding: 12px; text-align: center; border-radius: 0 0 12px 12px;">
                            <div style="font-size: 10px; font-weight: bold; margin-bottom: 3px;">AHORRO:</div>
                            <div style="font-size: 18px; font-weight: bold;">${eur(data.savings)}</div>
                        </div>
                    </div>
                `;
            }
            
            let desarrolloDetalladoHtml = '';
            res.individualResults.forEach((supply, idx) => {
                const tieneIndexado = supply.indexedComparison && 
                                     supply.indexedComparison.powerCosts && 
                                     supply.indexedComparison.energyCosts;
                
                if (tieneIndexado) {
                    desarrolloDetalladoHtml += `
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 25px 0 15px 0; border-radius: 12px; text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; letter-spacing: 1px;">DESARROLLO DETALLADO - SUMINISTRO ${idx + 1} DE ${res.individualResults.length}</div>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px;">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 10px;">
                                    ${generarColumnaDesglosePro(supply, false)}
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 10px;">
                                    ${generarColumnaDesglosePro(supply, true)}
                                </td>
                            </tr>
                        </table>
                    `;
                }
            });
            
            let resumenTablaFijoHtml = '';
            let resumenTablaIndexadoHtml = '';
            
            res.individualResults.forEach((supply, idx) => {
                const ahorroFijoSupply = supply.savings || 0;
                const ahorroIndexadoSupply = supply.indexedComparison ? supply.indexedComparison.savings : 0;
                
                resumenTablaFijoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY}</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroFijoSupply)}</td>
                    </tr>
                `;
                
                resumenTablaIndexadoHtml += `
                    <tr style="background-color: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${supply.cups}</td>
                        <td style="padding: 8px; font-size: 11px; border-bottom: 1px solid #e5e7eb;">${BRAND_DISPLAY} INDEX</td>
                        <td style="padding: 8px; font-size: 12px; font-weight: bold; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${GREEN_SAVE};">${eur(ahorroIndexadoSupply)}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px;">
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="background: linear-gradient(135deg, ${HEADER_BLUE} 0%, #8B9AA8 100%); border-radius: 16px 16px 0 0; margin-bottom: 0;">
                        <tr>
                            <td style="padding: 25px 30px;">
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr>
                                        <td style="vertical-align: middle; width: 60%;">
                                            <div style="background-color: white; width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                                <span style="font-size: 24px;">âš¡</span>
                                            </div>
                                            <h1 style="color: white; font-size: 16px; margin: 0 0 5px 0; font-weight: normal; letter-spacing: 0.5px;">
                                                ${brand.NAME.toUpperCase()}
                                            </h1>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 11px; margin: 0;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                                        </td>
                                        <td style="text-align: right; vertical-align: middle; width: 40%;">
                                            <p style="color: rgba(255,255,255,0.7); font-size: 9px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: bold;">MULTICUPS</p>
                                            <p style="color: white; font-size: 12px; margin: 0; font-weight: bold;">FIJO VS INDEXADO</p>
                                            <p style="color: rgba(255,255,255,0.9); font-size: 10px; margin: 5px 0 0 0;">Total: ${res.cups} CUPS</p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 15px 30px; border-bottom: 2px solid #e5e7eb;">
                        <p style="margin: 0; font-size: 12px; color: #374151;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #6b7280;">CUPS TOTALES: ${res.cups} CUPS</p>
                    </div>
                    
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 16px 16px; margin-bottom: 20px;">
                        <div style="background-color: ${HEADER_BLUE}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                            <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">LA MEJOR OPCIÃ“N PARA TI ES</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold;">${BRAND_DISPLAY}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.95;">Ofrece el mayor ahorro consolidado con ${brand.NAME.toUpperCase()}.</p>
                        </div>
                        
                        <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="padding: 15px; border-right: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 8px 0; font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;">TU FACTURA ACTUAL</p>
                                        <div style="margin: 10px 0;">
                                            <p style="margin: 0; font-size: 24px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}</p>
                                            <p style="margin: 3px 0 0 0; font-size: 9px; color: #9ca3af;">Total Periodo</p>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${RED_CTA}; text-decoration: line-through;">${eur(facturaActualTotal)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${DRK_BLUE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">TU AHORRO ANUAL FIJO</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroFijo)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">TU NUEVO COSTE DRK</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo / 12)}/mes</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;">Estimado Mensual</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${DRK_BLUE};">${eur(nuevoCosteAnualFijo)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                                
                                <td style="width: 35%; vertical-align: top; text-align: center; padding: 0 10px;">
                                    <div style="background-color: ${GREEN_SAVE}; color: white; padding: 10px 8px; border-radius: 8px 8px 0 0;">
                                        <p style="margin: 0; font-size: 9px; font-weight: bold; text-transform: uppercase;">TU AHORRO ANUAL INDEXADO</p>
                                    </div>
                                    <div style="padding: 15px 10px;">
                                        <p style="margin: 0; font-size: 32px; font-weight: bold; color: ${GREEN_SAVE};">${eur(ahorroIndexado)}</p>
                                        <div style="margin: 15px 0 0 0;">
                                            <p style="margin: 0 0 3px 0; font-size: 10px; color: #6b7280; font-weight: 600;">TU NUEVO COSTE DRK</p>
                                            <p style="margin: 0; font-size: 22px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado / 12)}/mes</p>
                                            <p style="margin: 3px 0 0 0; font-size: 8px; color: #9ca3af;">Estimado Mensual</p>
                                            <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: ${GREEN_SAVE};">${eur(nuevoCosteAnualIndexado)}/aÃ±o</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 15px; margin: 20px 0; border-radius: 6px;">
                            <p style="margin: 0; font-size: 11px; color: #92400e; line-height: 1.5;">
                                <strong>âš ï¸ IMPORTANTE:</strong> A continuaciÃ³n encontrarÃ¡s el desglose detallado de cÃ¡lculos para cada suministro, mostrando los desgloses completos de costes tanto para tarifas fijas como indexadas.
                            </p>
                        </div>
                    </div>
                    
                    ${desarrolloDetalladoHtml}
                    
                    <div style="background-color: ${HEADER_BLUE}; color: white; padding: 12px 20px; margin: 30px 0 15px 0; border-radius: 12px; text-align: center;">
                        <h2 style="margin: 0; font-size: 16px; font-weight: bold; letter-spacing: 0.5px;">RESUMEN DE TODOS LOS SUMINISTROS</h2>
                    </div>
                    
                    <table cellpadding="0" cellspacing="0" width="100%" style="margin-bottom: 30px; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <tr>
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS FIJAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaFijoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL FIJAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroFijo)}</p>
                                </div>
                            </td>
                            
                            <td style="width: 4%;"></td>
                            
                            <td style="width: 48%; vertical-align: top; padding: 20px;">
                                <div style="background-color: ${HEADER_BLUE}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; font-size: 13px; font-weight: bold;">TARIFAS INDEXADAS</h3>
                                </div>
                                <table cellpadding="0" cellspacing="0" width="100%">
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">CUPS</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: left; color: #374151; font-weight: bold;">TARIFA</th>
                                        <th style="padding: 8px; font-size: 10px; text-align: right; color: #374151; font-weight: bold;">AHORRO</th>
                                    </tr>
                                    ${resumenTablaIndexadoHtml}
                                </table>
                                <div style="background-color: ${RED_CTA}; color: white; padding: 15px; margin-top: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0 0 5px 0; font-size: 12px; font-weight: bold;">AHORRO TOTAL INDEXADAS:</p>
                                    <p style="margin: 0; font-size: 24px; font-weight: bold;">${eur(ahorroIndexado)}</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; text-align: center; color: #1f2937;">CUAL ES LA DIFERENCIA?</h3>
                        
                        <table cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td style="width: 48%; vertical-align: top; padding-right: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${DRK_BLUE};">POR QUE TARIFA FIJA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                        <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                        <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                        <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                                    </ul>
                                </td>
                                <td style="width: 4%;"></td>
                                <td style="width: 48%; vertical-align: top; padding-left: 15px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: ${GREEN_SAVE};">POR QUE TARIFA INDEXADA?</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #374151;">
                                        <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                        <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                        <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                        <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- BOTÃ“N DE CONFIRMACIÃ“N POR EMAIL -->
                    <div style="background-color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 3px solid ${isPowerCup ? '#84cc16' : '#0ea5e9'};">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <span style="font-size: 20px; margin-right: 8px;">ðŸ“Š</span>
                                <span style="font-size: 16px; font-weight: bold; color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">
                                    Para formalizar esta oferta consolidada:
                                </span>
                            </div>
                            
                            <ol style="margin: 20px 0; padding-left: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 14px; color: #374151; line-height: 2;">
                                <li>Haz clic en el botÃ³n de abajo</li>
                                <li>Se abrirÃ¡ tu cliente de email</li>
                                <li><strong style="color: ${isPowerCup ? '#3f6212' : '#0c4a6e'};">Adjunta documentaciÃ³n de los ${res.cups} CUPS</strong></li>
                                <li>EnvÃ­a el email</li>
                            </ol>
                            
                            <a href="${formalizationLink}" style="display: inline-block; background-color: ${RED_CTA}; color: white; padding: 18px 40px; border-radius: 12px; text-decoration: none; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); margin: 20px 0;">
                                âœ… CONFIRMAR OFERTA CONSOLIDADA
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">
                                    <strong>ðŸ“Ž Por cada CUPS adjuntar:</strong>
                                </p>
                                <p style="margin: 0; font-size: 11px; color: #6b7280;">
                                    DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #6b7280;">Comercial: <strong>${commercialCode}</strong></p>
                        <p style="margin: 0; font-size: 9px; color: #9ca3af;">Documento generado por ${brand.NAME.toUpperCase()}</p>
                    </div>
                    
                </div>
            `;
        }

        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const brand = activeBrand;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Dynamic Branding Setup ---
            // If activeBrand is POWER_CUP (comparisonMode === 'overall_best')
            const D_PRIMARY_DARK = brand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = brand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = brand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = brand.NAME;
            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const BG_LIGHT = brand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const p1PricePerDay = bd.powerCosts.find(p => p.period === 1)?.priceDay || 0;
            const p2PricePerDay = bd.powerCosts.find(p => p.period === 2)?.priceDay || 0;
            const p3PricePerDay = bd.powerCosts.find(p => p.period === 3)?.priceDay || 0;
            const p4PricePerDay = bd.powerCosts.find(p => p.period === 4)?.priceDay || 0;
            const p5PricePerDay = bd.powerCosts.find(p => p.period === 5)?.priceDay || 0;
            const p6PricePerDay = bd.powerCosts.find(p => p.period === 6)?.priceDay || 0;
            const e1Price = bd.energyCosts.find(e => e.period === 1)?.price || 0;
            const e2Price = bd.energyCosts.find(e => e.period === 2)?.price || 0;
            const e3Price = bd.energyCosts.find(e => e.period === 3)?.price || 0;
            const e4Price = bd.energyCosts.find(e => e.period === 4)?.price || 0;
            const e5Price = bd.energyCosts.find(e => e.period === 5)?.price || 0;
            const e6Price = bd.energyCosts.find(e => e.period === 6)?.price || 0;

            const monthlyEstimate = eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.energyCosts.reduce((sum, e) => sum + e.kwh, 0), 0) + ' kWh';
            
            const LB = '%0A';
            const discountLine = bd.discountRate > 0 ? `Descuento: ${num(bd.discountRate * 100, 0)}% aplicado a EnergÃ­a.${LB}` : '';

            // MODIFICACIÃ“N: Nombre completo de la tarifa
            const commercialTariffName = bd.isNegativeSavings 
                ? "Tu Tarifa Actual" 
                : (offer.isDrk 
                    ? ((offer.description?.length > offer.name?.length) ? offer.description : offer.name)
                    : offer.name);
            const commercializadoraName = offer.isDrk ? offer.name?.toUpperCase() : (offer.name?.toUpperCase() === 'TU TARIFA ACTUAL' ? 'TU COMERCIALIZADORA' : offer.name?.toUpperCase());

            const emailBody = `âœ… CONFIRMACIÃ“N DE ACEPTACIÃ“N DE OFERTA${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica que detallo a continuaciÃ³n:${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“‹ DATOS DEL SUMINISTRO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ”Œ CUPS:${LB}${bd.cups}${LB}${LB}` +
                                 `âš¡ TARIFA CONTRATADA:${LB}${commercialTariffName}${LB}${LB}` +
                                 `ðŸŒ Zona GeogrÃ¡fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `ðŸ“Š Consumo Facturado: ${totalConsumption}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’° BENEFICIO ECONÃ“MICO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ’µ Ahorro Anual Estimado: ${eur(bd.savings)}${LB}` +
                                 `ðŸ“… Coste Mensual Estimado: ${monthlyEstimate}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¡ PRECIOS CONTRATADOS${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ”´ POTENCIA:${LB}` +
                                 `   â€¢ P1: ${numPriceFormula(p1PricePerDay)} â‚¬/kW/dÃ­a${LB}` +
                                 `   â€¢ P2: ${numPriceFormula(p2PricePerDay)} â‚¬/kW/dÃ­a${LB}${LB}` +
                                 `ðŸŸ¢ ENERGÃA:${LB}` +
                                 `   â€¢ E1 (Punta): ${numPriceFormula(e1Price)} â‚¬/kWh${LB}` +
                                 `   â€¢ E2 (Llano): ${numPriceFormula(e2Price)} â‚¬/kWh${LB}` +
                                 `   â€¢ E3 (Valle): ${numPriceFormula(e3Price)} â‚¬/kWh${LB}${LB}` +
                                 `${discountLine}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ“› Nombre completo: ${clientName}${LB}` +
                                 `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                                 `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Ž DOCUMENTACIÃ“N ADJUNTA${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Adjunto la siguiente documentaciÃ³n para formalizar el contrato:${LB}${LB}` +
                                 `âœ“ 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `âœ“ 2. Ãšltima factura de luz (mÃ­n. 3 meses)${LB}` +
                                 `âœ“ 3. Email de contacto${LB}` +
                                 `âœ“ 4. TelÃ©fono de contacto${LB}` +
                                 `âœ“ 5. NÃºmero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n del contrato.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `âœ… FORMALIZACIÃ“N CONTRATO - CUPS: ${bd.cups}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555; vertical-align: top;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right; white-space: nowrap; vertical-align: top;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;
            const GREEN_SAVE_COLOR = '#16a34a';
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;

            // --- PLANTILLA PARA AHORRO NEGATIVO ---
            if (bd.isNegativeSavings) {
                const isDrkBrand = brand.NAME.includes('DRK');
                const companyBanner = isDrkBrand ? `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                ` : `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                `;
                
                return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                        <tr><td colspan="2" style="${headerCell}">
                            <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                            <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">TU TARIFA ACTUAL ES LA MÃS COMPETITIVA</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 15px;">
                            <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                        </td></tr>
                        <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 25px 20px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                            <div style="font-size: 60px; color: ${GREEN_SAVE_COLOR}; margin-bottom: 10px; line-height: 1;">&#9989;</div>
                            <p style="margin: 0; color: ${D_PRIMARY_DARK}; font-size: 22px; font-weight: bold;">Â¡Excelente Noticia!</p>
                            <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 18px; font-weight: normal;">TU TARIFA ACTUAL ES LA MÃS COMPETITIVA DEL MERCADO</h2>
                            <p style="margin: 0; font-size: 14px; color: #555;">En este momento, no existe una oferta que mejore tu coste actual. Seguiremos estudiando.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 20px; text-align: center;">
                            <p style="font-size: 14px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-bottom: 5px;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block;">${eur(bd.originalBillAnnual)}</span>
                            <p style="font-size: 12px; color: #888;">/ AÃ‘O (basado en el consumo de ${bd.dias_facturados} dÃ­as)</p>
                            <p style="margin-top: 15px; font-size: 14px; color: #555;">[Colaborador: ${commercialCode}] | Este resumen es una simulaciÃ³n.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                    </table>`;
            }

            // --- PLANTILLA ESTÃNDAR (Ahorro Positivo) ---
            
            const currentTariffConfig = TARIFF_CONFIG[bd.tariffType];
            
            // Desglose: Potencia
            let desglosePotencia = bd.powerCosts.map(p => {
                if (p.period <= currentTariffConfig.powerPeriods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P${p.period} (${num(p.kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(p.cost, 2)} â‚¬</td></tr>`;
                }
                return '';
            }).join('');
            
            // Desglose: EnergÃ­a
            let desgloseEnergia = bd.energyCosts.map(e => {
                if (e.period <= currentTariffConfig.periods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E${e.period} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(e.cost, 2)} â‚¬</td></tr>`;
                }
                return '';
            }).join('');
            
            const discountRowsHtml = bd.discountAmount > 0 ? `
                <tr><td style="${rowLabel} font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(bd.discountRate * 100, 0)}%)</td><td style="${rowValue} font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(bd.discountAmount, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL ENERGÃA (Neto)</td><td style="${rowValue} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subEnergyNet, 2)} â‚¬</td></tr>
            ` : '';
            
            const desgloseRows = `
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">TÃ‰RMINO POTENCIA (Precio en â‚¬/kW DÃ­a)</div></td></tr>
                ${desglosePotencia}
                <tr><td style="${rowLabel} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL POTENCIA</td><td style="${rowValue} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subPower, 2)} â‚¬</td></tr>
                
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 10px 0 2px 0;">TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)</div></td></tr>
                ${desgloseEnergia}
                <tr><td style="${rowLabel} border-bottom: 2px solid #333; font-weight: bold; color: #555;">Subtotal EnergÃ­a (Bruto)</td><td style="${rowValue} border-bottom: 2px solid #333; font-weight: bold; color: #555; white-space: nowrap;">${num(bd.subEnergy, 2)} â‚¬</td></tr>
                
                ${discountRowsHtml}
                
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL BASE (P+E)</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subBase, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel}">Imp. ElÃ©c. (${num(bd.ieRate * 100, 3)}%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIE, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;">BASE IMPONIBLE</td><td style="${rowValue} font-weight: bold; white-space: nowrap;">${num(bd.baseImp, 2)} â‚¬</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIVA, 2)} â‚¬</td></tr>
                
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL FACTURA (${bd.dias_facturados} DÃAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalPeriod)}</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL AÃ‘O (PROYECTADO)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalAnnual)}</td></tr>
            `;

            const discountSummaryRow = bd.discountRate > 0 ? `
                <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #CC0000;">DESCUENTO ENERGÃA</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap; color: #CC0000;">${num(bd.discountRate * 100, 0)}%</td></tr>
            ` : '';
            
            const preciosResumenTable = `
                <tr><td colspan="2" style="padding-top: 20px;"><div style="${sectionTitle}">RESUMEN DE PRECIOS DE LA OFERTA ÃšNICA</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px; table-layout: fixed;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${D_PRIMARY_DARK}; width: 60%;">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${D_PRIMARY_DARK}; width: 40%;">PRECIO ${commercializadoraName}</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p1PricePerDay)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p2PricePerDay)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P3 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p3PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P4 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p4PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P5 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p5PricePerDay) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P6 (â‚¬/kW/dÃ­a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(p6PricePerDay) + '</td></tr>' : ''}
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E1 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e1Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E2 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e2Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E3 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e3Price)}</td></tr>
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E4 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e4Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E5 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e5Price) + '</td></tr>' : ''}
                        ${bd.tariffType === '3.0TD' ? '<tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">EnergÃ­a E6 (â‚¬/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">' + numPriceFormula(e6Price) + '</td></tr>' : ''}
                        ${discountSummaryRow}
                        <tr style="background-color: #eee; font-weight: bold;"><td style="padding: 8px; color: ${D_PRIMARY_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${GREEN_SAVE_COLOR}; white-space: nowrap;">${eur(bd.savings)}</td></tr>
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;

            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    ${bd.savings > 0 ? `
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">RESUMEN DE AHORRO FINAL</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">/ AÃ‘O</p>
                    </div>
                    ` : `
                    <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">Â¡ENHORABUENA!</p>
                        <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente estÃ¡s en una buena tarifa.</p>
                        <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                    </div>
                    `}
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email
            const isDrkBrand = brand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - ${D_BRAND_NAME.toUpperCase()}</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                        <p style="margin: 0; color: ${D_PRIMARY_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;">LA MEJOR OPCIÃ“N PARA TI ES</p>
                        <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 22px;">${commercialTariffName}</h2>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        ${bd.savings > 0 ? `
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">Â¡CONSIGUE TU AHORRO ANUAL!</p>
                        </div>
                        ` : `
                        <div style="background-color: #f0f9ff; padding: 25px; border-radius: 8px; border: 2px solid ${D_PRIMARY_DARK}; margin: 25px 0; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 18px; color: ${D_PRIMARY_DARK}; font-weight: bold;">Â¡ENHORABUENA!</p>
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #333; font-weight: bold;">Actualmente estÃ¡s en una buena tarifa.</p>
                            <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">Seguiremos estudiando el mercado y te avisaremos cuando encontremos alguna tarifa que se adapte a tu perfil de consumo.</p>
                        </div>
                        `}
                    </td></tr>

                    ${bd.savings > 0 ? `
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">TU FACTURA ACTUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ AÃ‘O</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">TU NUEVO COSTE ${commercializadoraName}</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">/ AÃ‘O</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    ` : ''}
                    
                    ${preciosResumenTable}
                    
                    <tr><td colspan="2"><div style="${sectionTitle}">DESGLOSE DETALLADO DE LA SIMULACIÃ“N (${commercialTariffName})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px; margin-bottom: 20px; table-layout: fixed;">
                            ${desgloseRows}
                        </table>
                    </td></tr>
                    
                    ${finalSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">ðŸ“§ Para confirmar esta oferta:</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. Haz clic en el botÃ³n de abajo<br>
                                2. Se abrirÃ¡ tu cliente de email<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">Adjunta la documentaciÃ³n requerida</strong><br>
                                4. EnvÃ­a el email
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">âœ… CONFIRMAR Y ENVIAR</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ðŸ“„ <strong>DocumentaciÃ³n necesaria:</strong><br>
                                DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaciÃ³n basada en su Ãºltima factura.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }


        function generateMultiStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult; // Resultado acumulado
            const offer = bd.offer;
            const individualResults = bd.individualResults;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Determine Dynamic Branding for Email Copy ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);

            let dynamicBrand = activeBrand; // Use the current active brand (set by comparison mode)
            
            const D_PRIMARY_DARK = dynamicBrand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = dynamicBrand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = dynamicBrand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = dynamicBrand.NAME;
            const BG_LIGHT = dynamicBrand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  

            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TELÃ‰FONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';

            // Generar tabla de desglose individual
            let individualBreakdowns = '';
            individualResults.forEach((resItem, index) => {
                // La lÃ³gica de cuÃ¡l es la mejor oferta ya se ha aplicado en saveSupply
                const isBest = resItem.isNegativeSavings === false;  
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                const appliedOfferName = resItem.offer.isDrk  
                    ? ((resItem.offer.description?.length > resItem.offer.name?.length) 
                        ? resItem.offer.description 
                        : resItem.offer.name)
                    : resItem.offer.name;

                // Desglose: Potencia
                let desglosePotencia = resItem.powerCosts.map(p => {
                    if (p.period <= powerPeriods) {
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">P${p.period} (${num(p.kw,2)} kW x ${resItem.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(p.cost, 2)} â‚¬</td></tr>`;
                    }
                    return '';
                }).join('');

                // Desglose: EnergÃ­a
                let desgloseEnergia = resItem.energyCosts.map(e => {
                    if (e.period <= periods) {
                        let label = `E${e.period}`;
                        if (resItem.originalTariffType === '2.0TD') {
                            if (e.period === 1) label += ' (Punta)';
                            if (e.period === 2) label += ' (Llano)';
                            if (e.period === 3) label += ' (Valle)';
                            }
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">${label} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(e.cost, 2)} â‚¬</td></tr>`;
                    }
                    return '';
                }).join('');
                
                const discountRowsHtml = resItem.discountAmount > 0 ? `
                    <tr><td style="padding: 5px 8px; font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(resItem.discountRate * 100, 0)}%)</td><td style="padding: 5px 8px; text-align: right; font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(resItem.discountAmount, 2)} â‚¬</td></tr>
                    ` : '';

                // MODIFICACIÃ“N #2: Ajuste para eliminar "Sin Ahorro" en el email copy si no hay ahorro, dejando solo el total.
                const ahorroAnualText = isBest
                    ? `. Ahorro Anual: <span style="color: ${GREEN_SAVE}; font-weight: bold;">${eur(resItem.savings)}</span>`
                    : '';

                individualBreakdowns += `
                    <tr><td colspan="2" style="padding: 15px 20px 0 20px; background-color: #f8fafc; border-top: 2px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px; color: ${D_PRIMARY_DARK}; font-weight: bold;">[${index + 1}] CUPS: ${resItem.cups} (${resItem.originalTariffType})</h4>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #555;">Tarifa Aplicada: <span style="font-weight: bold;">${appliedOfferName}</span></p>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #555;">DÃ­as Facturados: ${resItem.dias_facturados}${ahorroAnualText}</p>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="table-layout: fixed; margin-bottom: 10px; background-color: white; border: 1px solid #eee;">
                            <tr style="background-color: #f5f5f5;">
                                <th colspan="2" style="padding: 5px 8px; text-align: left; font-size: 12px; color: ${D_PRIMARY_MED}; border-bottom: 1px solid #ddd;">SIMULACIÃ“N DE COSTES POR PERIODO</th>
                            </tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">POTENCIA</td></tr>
                            ${desglosePotencia}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">ENERGÃA</td></tr>
                            ${desgloseEnergia}
                            ${discountRowsHtml}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK};">TOTAL FACTURA (PERIODO)</td><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK}; text-align: right;">${eur(resItem.totalPeriod)}</td></tr>
                        </table>
                    </td></tr>
                `;
            });
            
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // URL para formalizaciÃ³n
            const LB = '%0A';
            
            // MODIFICACIÃ“N: Nombre completo de la oferta consolidada
            const consolidatedTariffName = (offer.description?.length > offer.name?.length) 
                ? offer.description 
                : offer.name;

            const emailBody = `âœ… CONFIRMACIÃ“N OFERTA CONSOLIDADA - MULTICUPS${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaciÃ³n de la oferta energÃ©tica consolidada para mÃºltiples suministros:${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Š RESUMEN CONSOLIDADO${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `âš¡ OFERTA:${LB}${consolidatedTariffName}${LB}${LB}` +
                                 `ðŸŒ Zona GeogrÃ¡fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `ðŸ”Œ Total Suministros: ${individualResults.length} CUPS${LB}${LB}` +
                                 `ðŸ“‹ CUPS INCLUIDOS:${LB}${bd.multiCupsList}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’° BENEFICIO ECONÃ“MICO TOTAL${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ’µ Ahorro Anual Consolidado: ${eur(bd.savings)}${LB}` +
                                 `ðŸ“… Coste Mensual Total: ${eur(bd.totalAnnual / 12)}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ‘¤ DATOS DEL TITULAR${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `ðŸ“› Nombre completo: ${clientName}${LB}` +
                                 `ðŸ“± TelÃ©fono: ${clientPhone}${LB}` +
                                 `ðŸ“§ Email: ${clientEmail}${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ“Ž DOCUMENTACIÃ“N POR CUPS${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Adjunto la siguiente documentaciÃ³n para cada CUPS:${LB}${LB}` +
                                 `âœ“ 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `âœ“ 2. Ãšltima factura de cada suministro (mÃ­n. 3 meses)${LB}` +
                                 `âœ“ 3. Email de contacto${LB}` +
                                 `âœ“ 4. TelÃ©fono de contacto${LB}` +
                                 `âœ“ 5. NÃºmero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}` +
                                 `ðŸ’¬ COMENTARIOS ADICIONALES${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `[Escriba aquÃ­ cualquier observaciÃ³n o consulta adicional]${LB}${LB}` +
                                 `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${LB}${LB}` +
                                 `Quedo a la espera de la confirmaciÃ³n de la formalizaciÃ³n del contrato consolidado.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `âœ… FORMALIZACIÃ“N CONSOLIDADA - ${individualResults.length} CUPS`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';  
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            // --- Precios de la Oferta Consolidada (Dynamic Winner) ---
            
            let preciosConsolidadosHTML = '';
            let priceSectionHeader;
            if (hasDrkWinner && comparisonMode !== 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (DRK ENERGÃA)';
            } else if (!hasDrkWinner && comparisonMode === 'overall_best') {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS (POWER CUP GLOBAL)';
            } else {
                priceSectionHeader = 'PRECIOS DE LAS OFERTAS SELECCIONADAS';
            }

            // 2.0TD Prices - TODAS las ofertas Ãºnicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`; 
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;
                    
                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td style="padding: 2px 0; width: 60%; color: #555;">P1 (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p1)}</td></tr>
                                <tr><td style="padding: 2px 0; color: #555;">P2 (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p2)}</td></tr>
                                <tr style="height: 5px;"><td colspan="2"></td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E1 (Punta - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e1)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E2 (Llano - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e2)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERGÃA E3 (Valle - â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e3)}</td></tr>
                            </table>
                        </div>
                    `;
                });
            }

            // 3.0TD Prices - TODAS las ofertas Ãºnicas  
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<tr><td style="padding: 2px 0; color: #555;">P${i} (â‚¬/kW/dÃ­a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</td></tr>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">E${i} (â‚¬/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(offer30[`p${i}_price`])}</p></td></tr>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td colspan="2" style="font-weight: bold; color: ${RED_CTA}; padding: 5px 0 2px 0;">POTENCIA</td></tr>
                                ${pRows}
                                <tr><td colspan="2" style="font-weight: bold; color: ${GREEN_SAVE}; padding: 5px 0 2px 0; border-top: 1px dashed #ccc; margin-top: 5px;">ENERGÃA</td></tr>
                                ${eRows}
                            </table>
                        </div>
                    `;
                });
            }
            
            const preciosResumenSection = preciosConsolidadosHTML ? `
                <tr><td colspan="2" style="padding: 20px 20px 0 20px;"><div style="${sectionTitle}">${priceSectionHeader}</div></td></tr>
                <tr><td colspan="2" style="padding: 0 20px 20px 20px;">
                    ${preciosConsolidadosHTML}
                </td></tr>
            ` : '';
            
            // FIX 2: NUEVO RESUMEN DE AHORRO CONSOLIDADO justo antes del botÃ³n
            const finalMultiSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO TOTAL CONSOLIDADO</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">/ AÃ‘O</p>
                    </div>
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email MultiCups
            const isDrkBrand = dynamicBrand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERGÃA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">AsesorÃ­a EnergÃ©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO CONSOLIDADO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">ANÃLISIS DE ${individualResults.length} SUMINISTROS (2.0TD + 3.0TD)</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>TOTAL CUPS:</strong> ${individualResults.length}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>OFERTA CONSOLIDADA:</strong> ${consolidatedTariffName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO ANUAL CONSOLIDADO:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">Â¡AHORRO TOTAL PARA ${individualResults.length} SUMINISTROS!</p>
                        </div>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">COSTE ACTUAL ANUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ AÃ‘O</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">NUEVO COSTE ${D_BRAND_NAME.toUpperCase()} ANUAL</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">/ AÃ‘O</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    ${preciosResumenSection}
                    
                    <tr><td colspan="2"><div style="background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;">DESGLOSE INDIVIDUAL DE AHORRO</div></td></tr>
                    ${individualBreakdowns}
                    
                    ${finalMultiSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">ðŸ“Š Para formalizar esta oferta consolidada:</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. Haz clic en el botÃ³n de abajo<br>
                                2. Se abrirÃ¡ tu cliente de email<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">Adjunta documentaciÃ³n de los ${individualResults.length} CUPS</strong><br>
                                4. EnvÃ­a el email
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">âœ… CONFIRMAR OFERTA CONSOLIDADA</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                ðŸ“„ <strong>Por cada CUPS adjuntar:</strong><br>
                                DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaciÃ³n consolidada de ${individualResults.length} suministros.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 5px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }

        // --- MANEJO DE INPUTS MANUALES ---

        function handleManualInput() {
            try {
                console.log('handleManualInput called');
                console.log('currentTariffType:', currentTariffType);
                console.log('comparisonMode:', comparisonMode);
                
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';

                // Usar multiCupsAddType o currentTariffType para el cÃ¡lculo
                const tariffToUse = isMultiCupsMode ? multiCupsAddType : currentTariffType;
                console.log('tariffToUse:', tariffToUse);
                
                if (!tariffToUse) return window.showErrorModal("Error: Seleccione un tipo de tarifa (2.0TD o 3.0TD).");
                
                const getVal = id => parseFloat(document.getElementById(id).value.replace(',','.')) || 0;
                
                const data = {
                    cups: document.getElementById('input-cups').value || 'MANUAL',
                    dias_facturados: parseInt(document.getElementById('input-billing-days').value) || 30,
                    importe_total: getVal('input-total-bill'),
                    fechas: 'Entrada Manual',
                };

                for(let i=1; i<=6; i++) {
                    data[`potencia_p${i}_kw`] = getVal(`input-p${i}-kw`);
                    data[`consumo_p${i}`] = getVal(`input-e${i}-kwh`);
                }
                
                // Llenar consumo_punta/llano/valle para 2.0TD (basado en E1, E2, E3)
                data['consumo_punta'] = data.consumo_p1;
                data['consumo_llano'] = data.consumo_p2;
                data['consumo_valle'] = data.consumo_p3;
                
                console.log('Data prepared:', data);
                
                if (data.importe_total <= 0) return window.showErrorModal("Introduce el total de la factura.");
                
                closeManualInputModal();
                
                if (isMultiCupsMode) {
                    console.log('Saving supply for MultiCups');
                    saveSupply(data, tariffToUse);
                } else {
                    console.log('Comparing offers for single tariff');
                    compareOffers(data);
                }
            } catch (error) {
                console.error('Error in handleManualInput:', error);
                window.showErrorModal(`Error al procesar datos: ${error.message}`);
            }
        }
        
        function startManualInputFlow() {
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';
            const tariffToConfigure = isMultiCupsMode ? multiCupsAddType : currentTariffType;
            
            if (isMultiCupsMode && !tariffToConfigure) return window.showErrorModal("Error interno: Seleccione primero 2.0 TD o 3.0 TD en la pantalla anterior.");
            
            // 1. Limpiar inputs
            clearManualInputs('input');
            
            // 2. Configurar el modal para modo Individual o Multi
            const selectorWrapper = document.getElementById('manual-tariff-selector-wrapper');
            const selectEl = document.getElementById('manual-input-tariff-select');
            const modalTitleEl = document.getElementById('manual-modal-title');
            
            if (isMultiCupsMode) {
                // MODO MULTICUPS: Ocultamos el selector ya que el tipo es conocido
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = `AÃ±adir Suministro #${multiCupsData.length + 1} (${tariffToConfigure} Manual)`;
                document.getElementById('execute-manual-input-btn').textContent = "AÃ‘ADIR SUMINISTRO";
                
                // Forzar la selecciÃ³n del tipo de CUPS seleccionado en la vista SAGA
                // Solo si el tipo existe en el selector (2.0TD o 3.0TD)
                if (selectEl.querySelector(`option[value="${tariffToConfigure}"]`)) {
                    selectEl.value = tariffToConfigure;
                }
                toggleMultiCupsInputPeriods(tariffToConfigure, 'input');

            } else {
                // MODO INDIVIDUAL: Ocultar selector (solo se usa la tarifa seleccionada en el landing)
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = `Entrada de Datos Manual (${currentTariffType})`;
                document.getElementById('execute-manual-input-btn').textContent = "CALCULAR";
                toggleMultiCupsInputPeriods(currentTariffType, 'input');
            }

            // 3. Mostrar Modal
            document.getElementById('manual-input-modal').classList.remove('hidden');
            document.getElementById('manual-input-modal').classList.add('flex');
            document.getElementById('input-cups').focus();
        }

        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            let currentBrandForInput = BRANDS.DRK;
            if (newMode === 'overall_best') currentBrandForInput = BRANDS.POWER_CUP;
            // Aplicar estilos y branding a toda la app
            applyBrandStyles(currentBrandForInput);
            
            // Actualizar estilos especÃ­ficos de los selectores de modo
            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                const label = r.closest('label');
                const isSelected = r.value === newMode;
                const colorClass = r.value === 'overall_best' ? 'powercup' : 'drk';
                
                // Limpiar todas las clases de color
                label.className = 'mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2';

                if (isSelected) {
                    // BotÃ³n SELECCIONADO: fondo de color, texto blanco
                    label.classList.add(`border-${colorClass}-500`, `bg-${colorClass}-500`, 'text-white', `hover:bg-${colorClass}-600`);
                    label.querySelector('.checkmark-icon').classList.remove('hidden');
                } else {
                    // BotÃ³n NO SELECCIONADO: fondo blanco, texto de color oscuro
                    label.classList.add(`border-${colorClass}-300`, 'bg-white', `text-${colorClass}-700`, `hover:bg-${colorClass}-100`, `hover:border-${colorClass}-400`);
                    label.querySelector('.checkmark-icon').classList.add('hidden');
                }
            });
        }
        
        // --- NUEVA FUNCIONALIDAD: Tipo de SelecciÃ³n de Oferta ---
        
        function updateOfferSelectionType(newType) {
            offerSelectionType = newType;
            
            // Actualizar estilos de los botones de tipo de selecciÃ³n
            document.querySelectorAll('input[name="offer_selection_type"]').forEach(r => {
                const container = r.closest('.offer-type-selector').querySelector('div');
                const isSelected = r.value === newType;
                
                if (isSelected) {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-drk-500 bg-drk-500 text-white transition hover:bg-drk-600';
                } else {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-slate-300 bg-white text-slate-700 transition hover:bg-slate-50 hover:border-drk-400';
                }
            });
        }
        
        // --- NUEVO: Modal de DecisiÃ³n (Mejor vs Elegir) ---
        
        function showOfferDecisionModal() {
            document.getElementById('loading-status').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('hidden');
            document.getElementById('offer-decision-modal').classList.add('flex');
            
            // Ocultar el selector de tarifa al abrir el modal (se mostrarÃ¡ solo si es necesario)
            document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
            
            // IMPORTANTE: El checkbox de comparaciÃ³n siempre visible (para DRK y POWER CUP)
            const checkboxContainer = document.getElementById('powercup-indexed-comparison-checkbox');
            checkboxContainer?.classList.remove('hidden');
            
            // Resetear selector a FIJA por defecto
            const fijaRadio = document.querySelector('input[name="best-option-tariff-type"][value="fija"]');
            if (fijaRadio) {
                fijaRadio.checked = true;
                updateBestOptionTariffChoice('fija');
            }
        }
        
        function closeOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('flex');
        }
        
        // NUEVA: Manejar click en VER MEJOR OPCIÃ“N
        function handleBestOptionClick() {
            const selectorDiv = document.getElementById('best-option-tariff-selector');
            const checkboxContainer = document.getElementById('powercup-indexed-comparison-checkbox');
            
            // Detectar contexto
            const isDrkMode = comparisonMode !== 'overall_best';
            const isIndividual = currentTariffType !== 'MULTICUPS';
            
            if (isDrkMode) {
                // DRK (Individual o MULTICUPS)
                
                if (compareWithIndexed) {
                    // CHECK MARCADO: Comparar automÃ¡ticamente FIJO vs INDEXADO (NO mostrar selector)
                    console.log('DRK con CHECK marcado: Comparando automÃ¡ticamente FIJO vs INDEXADO');
                    selectorDiv?.classList.add('hidden');
                    if (checkboxContainer) checkboxContainer.classList.remove('hidden');
                    selectBestOptionDirect(); // Ejecutar directamente
                } else {
                    // CHECK NO MARCADO: Mostrar selector para elegir FIJA o INDEXADA
                    console.log('DRK sin CHECK: Mostrando selector de tipo de tarifa');
                    selectorDiv?.classList.remove('hidden');
                    // OCULTAR checkbox porque el usuario va a elegir un solo tipo
                    if (checkboxContainer) checkboxContainer.classList.add('hidden');
                }
            } else {
                // POWER CUP: Ejecutar directamente (respeta su propio checkbox)
                selectorDiv?.classList.add('hidden');
                if (checkboxContainer) checkboxContainer.classList.remove('hidden');
                selectBestOptionDirect();
            }
        }
        
        // NUEVA: Actualizar elecciÃ³n de tipo de tarifa
        function updateBestOptionTariffChoice(choice) {
            bestOptionTariffChoice = choice;
            console.log('Tipo de tarifa seleccionada en VER MEJOR OPCIÃ“N:', choice);
            
            // Actualizar estilos visuales de los labels
            const fijaLabel = document.getElementById('best-fija-label');
            const indexadaLabel = document.getElementById('best-indexada-label');
            
            if (choice === 'fija') {
                fijaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-drk-500 bg-drk-50 cursor-pointer transition hover:bg-drk-100';
                indexadaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-green-50';
            } else {
                fijaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-slate-200 bg-white cursor-pointer transition hover:bg-drk-50';
                indexadaLabel.className = 'flex items-center gap-3 p-3 rounded-lg border-2 border-green-500 bg-green-50 cursor-pointer transition hover:bg-green-100';
            }
        }
        
        // NUEVA: Ejecutar VER MEJOR OPCIÃ“N con la elecciÃ³n de tarifa
        function selectBestOptionWithChoice() {
            console.log('selectBestOptionWithChoice llamada con elecciÃ³n:', bestOptionTariffChoice);
            
            // Cerrar el selector
            document.getElementById('best-option-tariff-selector')?.classList.add('hidden');
            
            // CRÃTICO: Guardar el estado ORIGINAL del CHECK antes de modificarlo
            const checkboxOriginal = document.getElementById('compare-indexed-checkbox');
            const hadCheckMarked = checkboxOriginal ? checkboxOriginal.checked : compareWithIndexed;
            
            console.log('ðŸ” CHECK estaba marcado originalmente:', hadCheckMarked ? 'SÃ' : 'NO');
            console.log('Usuario eligiÃ³ tarifa:', bestOptionTariffChoice);
            
            // CRÃTICO: Preservar _multiCupsContext ANTES de reasignar lastComparisonResult
            const preservedContext = lastComparisonResult?._multiCupsContext 
                ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                : null;
            
            console.log('ðŸ” Contexto MULTICUPS preservado en selectBestOptionWithChoice:', preservedContext ? 'SÃ' : 'NO');
            
            // NUEVA LÃ“GICA: Determinar si estamos en modo DRK o POWER CUP
            const isDrkMode = activeBrand.NAME.includes('DRK');
            console.log('ðŸ” Modo activo:', isDrkMode ? 'DRK' : 'POWER CUP');
            
            // Filtrar availableOffers segÃºn la elecciÃ³n Y el modo
            let filteredOffersChosen = availableOffers.filter(offer => {
                const offerName = (offer.offer.name || '').toUpperCase();
                const offerDesc = (offer.offer.description || '').toUpperCase();
                const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                const isDrkOffer = offer.offer.isDrk === true;
                
                if (bestOptionTariffChoice === 'indexada') {
                    // Usuario eligiÃ³ INDEXADA â†’ Solo DRK INDEX (siempre)
                    return isIndexed && isDrkOffer;
                } else {
                    // Usuario eligiÃ³ FIJA
                    if (isDrkMode) {
                        // Modo DRK â†’ Solo tarifas FIJAS de DRK
                        return !isIndexed && isDrkOffer;
                    } else {
                        // Modo POWER CUP â†’ Tarifas FIJAS de cualquier comercializadora
                        return !isIndexed;
                    }
                }
            });
            
            console.log('Ofertas filtradas del tipo elegido:', filteredOffersChosen.length, 'de', availableOffers.length);
            
            if (filteredOffersChosen.length === 0) {
                let mensaje;
                if (bestOptionTariffChoice === 'indexada') {
                    mensaje = 'No se encontraron tarifas INDEXADAS de DRK con ahorro positivo.';
                } else {
                    const origen = isDrkMode ? 'de DRK' : 'de cualquier comercializadora';
                    mensaje = `No se encontraron tarifas FIJAS ${origen} con ahorro positivo.`;
                }
                window.showErrorModal(mensaje);
                closeOfferDecisionModal();
                return;
            }
            
            // Seleccionar la mejor de las filtradas (del tipo elegido)
            let bestChosen = filteredOffersChosen.reduce((best, current) => {
                return (current.totalAnnual < best.totalAnnual) ? current : best;
            }, filteredOffersChosen[0]);
            
            console.log('âœ… Mejor tarifa del tipo elegido:', bestChosen.offer.name, 'Ahorro:', bestChosen.savings);
            
            // SI EL CHECK ESTABA MARCADO: Calcular tambiÃ©n la mejor del tipo contrario
            let bestOtherType = null;
            if (hadCheckMarked) {
                console.log('ðŸ” CHECK estaba marcado â†’ Calculando mejor del tipo contrario para mantener comparaciÃ³n dual');
                
                // Filtrar ofertas del tipo contrario
                let filteredOffersOther = availableOffers.filter(offer => {
                    const offerName = (offer.offer.name || '').toUpperCase();
                    const offerDesc = (offer.offer.description || '').toUpperCase();
                    const isIndexed = offerName.includes('INDEX') || offerDesc.includes('INDEX');
                    const isDrkOffer = offer.offer.isDrk === true;
                    
                    if (bestOptionTariffChoice === 'indexada') {
                        // Usuario eligiÃ³ INDEXADA â†’ Calcular mejor FIJA
                        if (isDrkMode) {
                            // Modo DRK â†’ Solo tarifas FIJAS de DRK
                            return !isIndexed && isDrkOffer;
                        } else {
                            // Modo POWER CUP â†’ Tarifas FIJAS de cualquier comercializadora
                            return !isIndexed;
                        }
                    } else {
                        // Usuario eligiÃ³ FIJA â†’ Calcular mejor INDEXADA (siempre DRK INDEX)
                        return isIndexed && isDrkOffer;
                    }
                });
                
                if (filteredOffersOther.length > 0) {
                    bestOtherType = filteredOffersOther.reduce((best, current) => {
                        return (current.totalAnnual < best.totalAnnual) ? current : best;
                    }, filteredOffersOther[0]);
                    
                    console.log('âœ… Mejor del tipo contrario:', bestOtherType.offer.name, 'Ahorro:', bestOtherType.savings);
                } else {
                    console.warn('âš ï¸  No se encontraron ofertas del tipo contrario');
                }
            }
            
            // Decidir quÃ© es FIJO y quÃ© es INDEXADO segÃºn lo que eligiÃ³ el usuario
            let resFijo, resIndexado;
            if (bestOptionTariffChoice === 'indexada') {
                // Usuario eligiÃ³ INDEXADA
                resIndexado = bestChosen;
                resFijo = bestOtherType;
            } else {
                // Usuario eligiÃ³ FIJA
                resFijo = bestChosen;
                resIndexado = bestOtherType;
            }
            
            // Actualizar variables globales
            lastComparisonResult = resFijo || bestChosen;
            
            if (hadCheckMarked && resIndexado) {
                // Mantener comparaciÃ³n dual
                lastIndexedResult = resIndexado;
                compareWithIndexed = true;
                console.log('âœ… Manteniendo comparaciÃ³n DUAL: FIJO vs INDEXADO');
            } else {
                // Sin comparaciÃ³n dual
                lastIndexedResult = null;
                compareWithIndexed = false;
                console.log('âš ï¸  Sin comparaciÃ³n dual (CHECK no estaba marcado o no hay tarifa del otro tipo)');
            }
            
            // CRÃTICO: RESTAURAR el contexto preservado
            if (preservedContext) {
                lastComparisonResult._multiCupsContext = preservedContext;
                console.log('âœ… Contexto MULTICUPS restaurado en selectBestOptionWithChoice');
            } else {
                console.log('âš ï¸  No habÃ­a contexto MULTICUPS que restaurar');
            }
            
            // CRÃTICO: Ejecutar segÃºn si hay comparaciÃ³n dual o no
            if (hadCheckMarked && resIndexado) {
                // Con comparaciÃ³n dual
                selectBestOptionDirectDual();
            } else {
                // Sin comparaciÃ³n dual
                selectBestOptionDirectSingle();
            }
        }
        
        // Nueva funciÃ³n para ejecutar con COMPARACIÃ“N DUAL (cuando CHECK estaba marcado)
        function selectBestOptionDirectDual() {
            closeOfferDecisionModal();
            
            if (!lastComparisonResult || !lastIndexedResult) {
                window.showErrorModal('No hay resultados disponibles para comparaciÃ³n dual');
                return;
            }
            
            console.log('selectBestOptionDirectDual: Mostrando comparaciÃ³n DUAL (FIJO vs INDEXADO)');
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista CON comparaciÃ³n indexada
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // Contexto individual: Mostrar resultados CON comparaciÃ³n indexada
                renderResultsUI(lastComparisonResult, lastIndexedResult);
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        // Nueva funciÃ³n para ejecutar con UNA sola tarifa (sin comparativa)
        function selectBestOptionDirectSingle() {
            closeOfferDecisionModal();
            
            if (!lastComparisonResult) {
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            // FORZAR: No mostrar comparativa indexada
            lastIndexedResult = null;
            compareWithIndexed = false;
            
            // Desmarcar checkbox fÃ­sicamente
            const checkbox = document.getElementById('compare-indexed-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            console.log('selectBestOptionDirectSingle: Forzando vista SIMPLE (sin comparativa)');
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista (sin indexado)
                addSupplyToMultiCupsList(lastComparisonResult, null);
            } else {
                // Contexto individual: Mostrar resultados (sin indexado)
                renderResultsUI(lastComparisonResult, null);
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        function toggleIndexedComparison(checked) {
            compareWithIndexed = checked;
            console.log('ComparaciÃ³n con indexadas:', compareWithIndexed ? 'ACTIVADA' : 'DESACTIVADA');
        }
        
        // Nueva funciÃ³n para calcular la mejor oferta indexada (DRK INDEX)
        function calculateIndexedOffer(data, tariffType) {
            const tariffsToCompare = currentTariffs[tariffType] || [];
            
            // Filtrar solo tarifas DRK INDEX (SIEMPRE de DRK, independientemente del modo)
            const indexedTariffs = tariffsToCompare.filter(t => {
                const name = (t.name || '').toUpperCase();
                const description = (t.description || '').toUpperCase();
                const commercializer = (t.commercializer || '').toUpperCase();
                
                // CRÃTICO: Debe contener "INDEX" Y ser de DRK
                const hasIndex = name.includes('INDEX') || description.includes('INDEX') || commercializer.includes('INDEX');
                const isDrk = t.isDrk === true || commercializer.includes('DRK') || name.includes('DRK');
                
                return hasIndex && isDrk;
            });
            
            console.log(`ðŸ” Tarifas DRK INDEX encontradas para ${tariffType}:`, indexedTariffs.length);
            if (indexedTariffs.length > 0) {
                console.log('ðŸ“‹ Tarifas DRK INDEX:', indexedTariffs.map(t => t.name).join(', '));
            }
            
            if (indexedTariffs.length === 0) {
                console.warn('âš ï¸  No se encontraron tarifas DRK INDEX');
                return null;
            }
            
            // Calcular coste para cada tarifa indexada
            const indexedResults = indexedTariffs.map(t => {
                const result = calculateTariffCost(t, data, tariffType);
                // CRÃTICO: Asegurar que tiene originalTariffType
                if (!result.originalTariffType) {
                    result.originalTariffType = tariffType;
                }
                return result;
            });
            
            // Encontrar la mejor tarifa indexada (menor coste anual)
            let bestIndexed = null;
            indexedResults.forEach(r => {
                r.savings = r.originalBillAnnual - r.totalAnnual;
                if (r.savings > 0) {
                    if (!bestIndexed || r.totalAnnual < bestIndexed.totalAnnual) {
                        bestIndexed = r;
                    }
                }
            });
            
            if (bestIndexed) {
                bestIndexed.isIndexed = true; // Marcar como resultado indexado
                // CRÃTICO: Asegurar que tiene originalTariffType
                if (!bestIndexed.originalTariffType) {
                    bestIndexed.originalTariffType = tariffType;
                }
                console.log('âœ… Mejor tarifa DRK INDEX:', bestIndexed.offer.name, 'Ahorro:', bestIndexed.savings);
                console.log('âœ… originalTariffType asignado:', bestIndexed.originalTariffType);
            } else {
                console.warn('âš ï¸  No se encontrÃ³ ninguna tarifa DRK INDEX con ahorro positivo');
            }
            
            return bestIndexed;
        }
        
        function selectBestOptionDirect() {
            // Cerrar modal de decisiÃ³n
            closeOfferDecisionModal();
            
            // Usar el resultado que ya estaba calculado (lastComparisonResult)
            if (!lastComparisonResult) {
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ARREGLO: Cuando compareWithIndexed = true, calcular FIJO vs INDEXADO correctamente
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (compareWithIndexed) {
                console.log('ðŸ”§ ComparaciÃ³n FIJO vs INDEXADO activada');
                
                const tariffType = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.tariffType 
                    : lastComparisonResult.originalTariffType || currentTariffType;
                
                const dataForCalc = lastComparisonResult._multiCupsContext 
                    ? lastComparisonResult._multiCupsContext.dataForCalc 
                    : lastComparisonResult;
                
                // CRÃTICO: Preservar _multiCupsContext ANTES de recalcular
                const preservedContext = lastComparisonResult._multiCupsContext 
                    ? JSON.parse(JSON.stringify(lastComparisonResult._multiCupsContext))
                    : null;
                
                console.log('ðŸ” Contexto MULTICUPS preservado:', preservedContext ? 'SÃ' : 'NO');
                
                // PASO 1: Recalcular la MEJOR OFERTA FIJA (sin indexadas)
                console.log('ðŸ“Š Calculando mejor oferta FIJA...');
                console.log('ðŸ” Modo de comparaciÃ³n actual:', comparisonMode);
                console.log('ðŸ” Marca activa:', activeBrand.NAME);
                
                const tarifasDisponibles = currentTariffs[tariffType] || [];
                
                // Filtrar SOLO tarifas FIJAS (excluir indexadas)
                const tarifasFijas = tarifasDisponibles.filter(t => {
                    const name = (t.name || '').toUpperCase();
                    const desc = (t.description || '').toUpperCase();
                    return !name.includes('INDEX') && !desc.includes('INDEX');
                });
                
                console.log(`Tarifas FIJAS encontradas: ${tarifasFijas.length} de ${tarifasDisponibles.length}`);
                
                // NUEVA LÃ“GICA: Filtrar segÃºn DRK o POWER CUP
                const isDrkMode = activeBrand.NAME.includes('DRK');
                
                let tarifasFijasFiltradas;
                if (isDrkMode) {
                    // MODO DRK: Solo tarifas FIJAS de DRK
                    tarifasFijasFiltradas = tarifasFijas.filter(t => t.isDrk);
                    console.log('ðŸ”µ Modo DRK: Filtrando solo tarifas FIJAS de DRK');
                } else {
                    // MODO POWER CUP: Todas las tarifas FIJAS (cualquier comercializadora)
                    tarifasFijasFiltradas = tarifasFijas;
                    console.log('ðŸŸ¢ Modo POWER CUP: Aceptando tarifas FIJAS de cualquier comercializadora');
                }
                
                console.log(`Tarifas FIJAS despuÃ©s de filtro DRK/POWER: ${tarifasFijasFiltradas.length}`);
                
                // Calcular la mejor oferta FIJA
                const resultadosFijos = tarifasFijasFiltradas.map(t => calculateTariffCost(t, dataForCalc, tariffType));
                let mejorFija = null;
                
                resultadosFijos.forEach(r => {
                    if (!mejorFija || r.totalAnnual < mejorFija.totalAnnual) {
                        mejorFija = r;
                    }
                });
                
                if (!mejorFija) {
                    const modoTexto = isDrkMode ? 'DRK' : 'cualquier comercializadora';
                    window.showErrorModal(`No se encontraron tarifas FIJAS de ${modoTexto}.`);
                    return;
                }
                
                console.log('âœ… Mejor oferta FIJA:', mejorFija.offer.name, mejorFija.totalAnnual);
                
                // PASO 2: Calcular la MEJOR OFERTA INDEXADA
                console.log('ðŸ“Š Calculando mejor oferta INDEXADA...');
                lastIndexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                
                if (!lastIndexedResult) {
                    window.showErrorModal('No se encontraron tarifas indexadas DRK INDEX para comparar.');
                    lastIndexedResult = null;
                    compareWithIndexed = false;
                    document.getElementById('compare-indexed-checkbox').checked = false;
                    return;
                }
                
                console.log('âœ… Mejor oferta INDEXADA:', lastIndexedResult.offer.name, lastIndexedResult.totalAnnual);
                
                // PASO 3: Actualizar lastComparisonResult con la mejor FIJA
                lastComparisonResult = mejorFija;
                
                // CRÃTICO: RESTAURAR el contexto preservado
                if (preservedContext) {
                    lastComparisonResult._multiCupsContext = preservedContext;
                    console.log('âœ… Contexto MULTICUPS restaurado correctamente');
                } else {
                    console.log('âš ï¸  No habÃ­a contexto MULTICUPS que restaurar');
                }
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIN ARREGLO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: AÃ±adir a la lista
                addSupplyToMultiCupsList(lastComparisonResult, lastIndexedResult);
            } else {
                // Contexto individual: Mostrar resultados
                renderResultsUI(lastComparisonResult, lastIndexedResult);
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        function selectFromResults() {
            // Cerrar modal de decisiÃ³n
            closeOfferDecisionModal();
            
            // Mostrar modal de selecciÃ³n de ofertas
            if (lastComparisonResult && availableOffers.length > 0) {
                showOfferSelectionModal(lastComparisonResult.cups);
            } else {
                window.showErrorModal('No hay ofertas disponibles para seleccionar');
            }
        }
        
        // NUEVA: FunciÃ³n para hacer copia profunda de una oferta
        function deepCopyOffer(offer) {
            if (!offer) return offer;
            
            // Hacer copia profunda del objeto oferta
            return JSON.parse(JSON.stringify(offer));
        }
        
        // NUEVA: FunciÃ³n para recalcular energyCosts y powerCosts correctamente
        function recalculateCostsForOffer(baseData, selectedOffer) {
            const tariffType = baseData.originalTariffType;
            
            console.log('Recalculating costs for:', selectedOffer.name, '(', tariffType, ')');
            
            // CRÃTICO: Buscar la tarifa ORIGINAL en currentTariffs
            // en lugar de usar selectedOffer que puede estar contaminado
            const originalTariff = currentTariffs[tariffType]?.find(t => 
                t.name === selectedOffer.name && t.description === selectedOffer.description
            );
            
            if (!originalTariff) {
                console.error('âŒ Original tariff not found in currentTariffs for:', selectedOffer.name);
                // Fallback: usar selectedOffer si no se encuentra
                return recalculateCostsFromOffer(baseData, selectedOffer, tariffType);
            }
            
            console.log('âœ… Using original tariff from CSV');
            
            // Usar la tarifa ORIGINAL, no selectedOffer
            return recalculateCostsFromOffer(baseData, originalTariff, tariffType);
        }
        
        // FunciÃ³n auxiliar que hace el cÃ¡lculo real
        function recalculateCostsFromOffer(baseData, tariffOffer, tariffType) {
            const recalculatedEnergyCosts = [];
            const recalculatedPowerCosts = [];
            
            // CRÃTICO: Extraer valores primitivos ANTES de usarlos
            // Esto evita cualquier referencia compartida
            const offerPrices = {
                p1_price: Number(tariffOffer.p1_price) || 0,
                p2_price: Number(tariffOffer.p2_price) || 0,
                p3_price: Number(tariffOffer.p3_price) || 0,
                p4_price: Number(tariffOffer.p4_price) || 0,
                p5_price: Number(tariffOffer.p5_price) || 0,
                p6_price: Number(tariffOffer.p6_price) || 0,
                p_potencia_1: Number(tariffOffer.p_potencia_1) || 0,
                p_potencia_2: Number(tariffOffer.p_potencia_2) || 0,
                p_potencia_3: Number(tariffOffer.p_potencia_3) || 0,
                p_potencia_4: Number(tariffOffer.p_potencia_4) || 0,
                p_potencia_5: Number(tariffOffer.p_potencia_5) || 0,
                p_potencia_6: Number(tariffOffer.p_potencia_6) || 0
            };
            
            console.log('Extracted prices (primitives):', offerPrices);
            
            if (tariffType === '2.0TD') {
                // Calcular energÃ­a para 2.0TD (3 periodos)
                const consumos = [
                    baseData.consumo_punta || 0,
                    baseData.consumo_llano || 0,
                    baseData.consumo_valle || 0
                ];
                const preciosEnergia = [
                    offerPrices.p1_price,
                    offerPrices.p2_price,
                    offerPrices.p3_price
                ];
                
                console.log('2.0TD Consumos:', consumos);
                console.log('2.0TD Precios:', preciosEnergia);
                
                for (let i = 0; i < 3; i++) {
                    recalculatedEnergyCosts.push({
                        period: i + 1,
                        kwh: consumos[i],
                        price: preciosEnergia[i],
                        cost: consumos[i] * preciosEnergia[i]
                    });
                }
                
                // Calcular potencia para 2.0TD (2 periodos)
                const potencias = [
                    baseData.potencia_p1_kw || 0,
                    baseData.potencia_p2_kw || 0
                ];
                const preciosPotencia = [
                    offerPrices.p_potencia_1 / 365,
                    offerPrices.p_potencia_2 / 365
                ];
                const diasFacturados = baseData.dias_facturados || 30;
                
                for (let i = 0; i < 2; i++) {
                    recalculatedPowerCosts.push({
                        period: i + 1,
                        kw: potencias[i],
                        priceDay: preciosPotencia[i],
                        cost: potencias[i] * preciosPotencia[i] * diasFacturados
                    });
                }
            } else if (tariffType === '3.0TD') {
                // IMPORTANTE: Algunas tarifas 3.0TD solo tienen 3 precios definidos
                // Necesitamos propagar los precios existentes a los 6 periodos
                
                // Detectar si la tarifa tiene 6 precios o solo 3
                const hasFull6Periods = offerPrices.p4_price > 0;
                
                let prices = [];
                if (hasFull6Periods) {
                    // Tarifa con 6 periodos completos
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p4_price,
                        offerPrices.p5_price,
                        offerPrices.p6_price
                    ];
                } else {
                    // Tarifa con solo 3 precios: propagar P1->P1/P4, P2->P2/P5, P3->P3/P6
                    prices = [
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price,
                        offerPrices.p1_price,
                        offerPrices.p2_price,
                        offerPrices.p3_price
                    ];
                    console.log('3.0TD tariff has only 3 periods, propagating prices:', prices);
                }
                
                // Detectar si la tarifa tiene 6 precios de potencia o solo 2
                const hasFull6PowerPrices = offerPrices.p_potencia_3 > 0;
                
                let powerPrices = [];
                if (hasFull6PowerPrices) {
                    powerPrices = [
                        offerPrices.p_potencia_1 / 365,
                        offerPrices.p_potencia_2 / 365,
                        offerPrices.p_potencia_3 / 365,
                        offerPrices.p_potencia_4 / 365,
                        offerPrices.p_potencia_5 / 365,
                        offerPrices.p_potencia_6 / 365
                    ];
                } else {
                    // Solo tiene P1 y P2: propagar P1->P1/P3/P5, P2->P2/P4/P6
                    const p1 = offerPrices.p_potencia_1 / 365;
                    const p2 = offerPrices.p_potencia_2 / 365;
                    powerPrices = [p1, p2, p1, p2, p1, p2];
                    console.log('3.0TD tariff has only 2 power prices, propagating:', powerPrices);
                }
                
                // Calcular energÃ­a para 3.0TD (6 periodos)
                for (let i = 1; i <= 6; i++) {
                    const kwh = baseData[`consumo_p${i}`] || 0;
                    const price = prices[i - 1];
                    console.log(`Period ${i}: kwh=${kwh}, price=${price}`);
                    recalculatedEnergyCosts.push({
                        period: i,
                        kwh: kwh,
                        price: price,
                        cost: kwh * price
                    });
                }
                
                // Calcular potencia para 3.0TD (6 periodos)
                const diasFacturados = baseData.dias_facturados || 30;
                console.log('DÃ­as facturados:', diasFacturados);
                
                for (let i = 1; i <= 6; i++) {
                    const kw = baseData[`potencia_p${i}_kw`] || 0;
                    const priceDay = powerPrices[i - 1];
                    console.log(`Power P${i}: kw=${kw}, priceDay=${priceDay}`);
                    recalculatedPowerCosts.push({
                        period: i,
                        kw: kw,
                        priceDay: priceDay,
                        cost: kw * priceDay * diasFacturados
                    });
                }
            }
            
            console.log('Recalculated energy costs periods:', recalculatedEnergyCosts.length);
            console.log('Recalculated power costs periods:', recalculatedPowerCosts.length);
            
            // Calcular subtotales
            const subPower = recalculatedPowerCosts.reduce((sum, p) => sum + p.cost, 0);
            const subEnergyNet = recalculatedEnergyCosts.reduce((sum, e) => sum + e.cost, 0);
            
            console.log('Recalculated subPower:', subPower);
            console.log('Recalculated subEnergyNet:', subEnergyNet);
            console.log('=== END RECALCULATE DEBUG ===');
            
            return {
                energyCosts: recalculatedEnergyCosts,
                powerCosts: recalculatedPowerCosts,
                subPower: subPower,
                subEnergyNet: subEnergyNet
            };
        }
        
        // Nueva funciÃ³n para aÃ±adir suministro a MultiCups despuÃ©s de elegir
        function addSupplyToMultiCupsList(result, resultIndexed = null) {
            console.log('addSupplyToMultiCupsList called with result:', result);
            console.log('Result offer:', result.offer);
            console.log('Result originalTariffType:', result.originalTariffType);
            console.log('Result tiene indexedComparison?:', !!result.indexedComparison);
            
            if (result.indexedComparison) {
                console.log('indexedComparison encontrado en result:', result.indexedComparison);
                console.log('indexedComparison tiene powerCosts?:', !!result.indexedComparison.powerCosts);
                console.log('indexedComparison tiene energyCosts?:', !!result.indexedComparison.energyCosts);
            }
            
            if (resultIndexed) {
                console.log('TambiÃ©n recibido resultado indexado como parÃ¡metro:', resultIndexed.offer.name);
            }
            
            // IMPORTANTE: Preservar indexedComparison ANTES de recalcular
            // Usar copia profunda para evitar modificaciones por referencia
            const preservedIndexedComparison = result.indexedComparison 
                ? JSON.parse(JSON.stringify(result.indexedComparison))
                : null;
            
            // Asegurar que el originalTariffType estÃ© presente
            if (!result.originalTariffType && result._multiCupsContext) {
                result.originalTariffType = result._multiCupsContext.tariffType;
                console.log('Set originalTariffType from context:', result.originalTariffType);
            }
            
            // IMPORTANTE: Recalcular costes para asegurar que 3.0TD tenga 6 periodos
            if (result.offer && result.originalTariffType) {
                const recalculated = recalculateCostsForOffer(result, result.offer);
                result.energyCosts = recalculated.energyCosts;
                result.powerCosts = recalculated.powerCosts;
                result.subPower = recalculated.subPower;
                result.subEnergyNet = recalculated.subEnergyNet;
                console.log('Costs recalculated for', result.originalTariffType);
                console.log('New subPower:', result.subPower, 'New subEnergyNet:', result.subEnergyNet);
            }
            
            // RESTAURAR indexedComparison preservado
            if (preservedIndexedComparison) {
                result.indexedComparison = preservedIndexedComparison;
                console.log('Restaurado indexedComparison preservado');
            }
            
            // Si hay resultado indexado como parÃ¡metro, tambiÃ©n recalcular sus costes
            if (resultIndexed && resultIndexed.offer && resultIndexed.originalTariffType) {
                console.log('ðŸ” Recalculando costes para resultado INDEXADO:', resultIndexed.offer.name);
                console.log('ðŸ” originalTariffType del indexado:', resultIndexed.originalTariffType);
                console.log('ðŸ” totalAnnual del indexado ANTES de recalcular:', resultIndexed.totalAnnual);
                console.log('ðŸ” savings del indexado ANTES de recalcular:', resultIndexed.savings);
                
                const recalculatedIndexed = recalculateCostsForOffer(resultIndexed, resultIndexed.offer);
                resultIndexed.energyCosts = recalculatedIndexed.energyCosts;
                resultIndexed.powerCosts = recalculatedIndexed.powerCosts;
                resultIndexed.subPower = recalculatedIndexed.subPower;
                resultIndexed.subEnergyNet = recalculatedIndexed.subEnergyNet;
                console.log('âœ… Costs recalculated for indexed:', resultIndexed.originalTariffType);
                console.log('âœ… subPower indexado:', resultIndexed.subPower);
                console.log('âœ… subEnergyNet indexado:', resultIndexed.subEnergyNet);
                console.log('âœ… Ahorro indexado:', resultIndexed.savings);
                console.log('âœ… Total anual indexado:', resultIndexed.totalAnnual);
                
                // AÃ±adirlo al resultado principal
                result.indexedComparison = resultIndexed;
                console.log('âœ… indexedComparison asignado a result');
                console.log('âœ… indexedComparison final:', {
                    offer: result.indexedComparison.offer.name,
                    totalAnnual: result.indexedComparison.totalAnnual,
                    savings: result.indexedComparison.savings,
                    originalTariffType: result.indexedComparison.originalTariffType
                });
            } else if (resultIndexed) {
                console.error('âŒâŒâŒ resultIndexed no tiene offer o originalTariffType âŒâŒâŒ');
                console.error('resultIndexed recibido:', resultIndexed);
                console.error('Details:', {
                    hasOffer: !!resultIndexed.offer,
                    hasOriginalTariffType: !!resultIndexed.originalTariffType,
                    offer: resultIndexed.offer,
                    originalTariffType: resultIndexed.originalTariffType
                });
            } else {
                console.warn('âš ï¸  resultIndexed es null/undefined - NO hay comparaciÃ³n indexada');
            }
            
            // Limpiar el contexto temporal
            delete result._multiCupsContext;
            
            // LOGS FINALES antes de aÃ±adir
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“‹ SUMINISTRO LISTO PARA AÃ‘ADIR A multiCupsData:');
            console.log('  CUPS:', result.cups);
            console.log('  Oferta FIJA:', result.offer.name);
            console.log('  Total Annual FIJO:', result.totalAnnual);
            console.log('  Savings FIJO:', result.savings);
            console.log('  originalTariffType FIJO:', result.originalTariffType);
            if (result.indexedComparison) {
                console.log('  âœ… TIENE indexedComparison:');
                console.log('    Oferta INDEXADA:', result.indexedComparison.offer.name);
                console.log('    Total Annual INDEXADO:', result.indexedComparison.totalAnnual);
                console.log('    Savings INDEXADO:', result.indexedComparison.savings);
                console.log('    originalTariffType INDEXADO:', result.indexedComparison.originalTariffType);
            } else {
                console.log('  âŒ NO tiene indexedComparison');
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // AÃ±adir a la lista
            multiCupsData.push(result);
            console.log('multiCupsData after push:', multiCupsData);
            
            // Actualizar UI y volver a la vista SAGA
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length;
            
            window.showMessageModal(`Suministro ${result.cups} (${result.offer.name}) aÃ±adido. Total: ${multiCupsData.length}`, "Suministro AÃ±adido");
            
            document.getElementById('initial-view').classList.add('hidden');
            showMultiCupsSagaView();
        }
        
        // Funciones para el modal de selecciÃ³n de ofertas
        function showOfferSelectionModal(cups) {
            // Mostrar CUPS en el modal
            document.getElementById('modal-selection-cups').textContent = cups;
            
            // Inicializar contadores y limpiar filtros
            document.getElementById('offers-total-count').textContent = availableOffers.length;
            document.getElementById('offers-visible-count').textContent = availableOffers.length;
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            
            // Renderizar ofertas
            renderOffersList();
            
            // Mostrar modal
            document.getElementById('offer-selection-modal').classList.remove('hidden');
            document.getElementById('offer-selection-modal').classList.add('flex');
            
            // Deshabilitar botÃ³n de confirmar inicialmente
            document.getElementById('confirm-offer-selection-btn').disabled = true;
            manuallySelectedOffer = null;
        }
        
        // NUEVA: FunciÃ³n para renderizar la lista de ofertas
        function renderOffersList() {
            const searchTerm = document.getElementById('offer-search-input').value.toLowerCase();
            const sortBy = document.getElementById('offer-sort-select').value;
            
            const container = document.getElementById('offers-radio-list');
            const noResultsMsg = document.getElementById('no-offers-message');
            
            // Filtrar ofertas
            let filteredOffers = availableOffers.map((offer, originalIndex) => ({
                offer: offer,
                originalIndex: originalIndex
            })).filter(item => {
                if (searchTerm === '') return true;
                
                const offerName = item.offer.offer.name.toLowerCase();
                const commercializer = item.offer.offer.isDrk ? 'drk energÃ­a' : (item.offer.offer.commercializer || '').toLowerCase();
                const description = (item.offer.offer.description || '').toLowerCase();
                
                return offerName.includes(searchTerm) || 
                       commercializer.includes(searchTerm) || 
                       description.includes(searchTerm);
            });
            
            // Ordenar ofertas filtradas
            filteredOffers.sort((a, b) => {
                switch(sortBy) {
                    case 'savings_desc':
                        return b.offer.savings - a.offer.savings;
                    case 'savings_asc':
                        return a.offer.savings - b.offer.savings;
                    case 'name_asc':
                        return a.offer.offer.name.localeCompare(b.offer.offer.name);
                    case 'name_desc':
                        return b.offer.offer.name.localeCompare(a.offer.offer.name);
                    default:
                        return 0;
                }
            });
            
            // Actualizar contador
            document.getElementById('offers-visible-count').textContent = filteredOffers.length;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Mostrar/ocultar mensaje de "no hay resultados"
            if (filteredOffers.length === 0) {
                noResultsMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            } else {
                noResultsMsg.classList.add('hidden');
                container.classList.remove('hidden');
            }
            
            // Renderizar ofertas
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            
            filteredOffers.forEach(item => {
                const offer = item.offer;
                const originalIndex = item.originalIndex;
                const commercializer = offer.offer.isDrk ? 'DRK EnergÃ­a' : (offer.offer.commercializer || 'Otra comercializadora');
                const description = offer.offer.description || '';
                const name = offer.offer.name || '';
                
                // Para DRK, usar el campo que tenga mÃ¡s informaciÃ³n como tÃ­tulo
                let displayTitle, displaySubtitle;
                if (offer.offer.isDrk) {
                    // Si description es mÃ¡s largo que name, usarlo como tÃ­tulo
                    if (description.length > name.length) {
                        displayTitle = description;
                        displaySubtitle = name; // Usar name como subtÃ­tulo
                    } else {
                        // Si name es mÃ¡s largo o igual, usarlo como tÃ­tulo
                        displayTitle = name;
                        displaySubtitle = description; // Usar description como subtÃ­tulo
                    }
                } else {
                    displayTitle = name;
                    displaySubtitle = `${commercializer}${description && description !== name ? ' - ' + description : ''}`;
                }
                
                const offerCard = document.createElement('label');
                offerCard.className = 'offer-radio-card block cursor-pointer';
                offerCard.innerHTML = `
                    <input type="radio" name="selected_offer" value="${originalIndex}" class="hidden">
                    <div class="offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50">
                        <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400 checkmark-offer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div class="flex-1">
                            <p class="font-bold text-base text-slate-900">${displayTitle}</p>
                            <p class="text-sm text-slate-600">${displaySubtitle}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs text-slate-500">Ahorro anual</p>
                            <p class="text-xl font-black text-green-600">${eur(offer.savings)}</p>
                        </div>
                    </div>
                `;
                container.appendChild(offerCard);
            });
            
            // AÃ±adir event listeners a los radio buttons
            document.querySelectorAll('input[name="selected_offer"]').forEach(radio => {
                radio.addEventListener('change', handleOfferRadioChange);
            });
        }
        
        // NUEVAS FUNCIONES: Filtrado y ordenaciÃ³n de ofertas
        function filterAndSortOffers() {
            renderOffersList();
        }
        
        function clearOfferFilters() {
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            renderOffersList();
        }
        
        function handleOfferRadioChange(e) {
            const selectedIndex = parseInt(e.target.value);
            
            // CRÃTICO: No guardar el objeto completo de availableOffers
            // Solo guardar la informaciÃ³n necesaria para buscar la tarifa original despuÃ©s
            const selectedOffer = availableOffers[selectedIndex];
            manuallySelectedOffer = {
                ...selectedOffer,
                // Guardar identificadores para buscar la tarifa original
                _needsOriginalLookup: true,
                _tariffName: selectedOffer.offer.name,
                _tariffDescription: selectedOffer.offer.description,
                _tariffType: selectedOffer.originalTariffType || lastComparisonResult?.originalTariffType
            };
            
            // Actualizar estilos visuales
            document.querySelectorAll('.offer-radio-card').forEach((card) => {
                const radio = card.querySelector('input[type="radio"]');
                const radioValue = parseInt(radio.value);
                const content = card.querySelector('.offer-card-content');
                const check = card.querySelector('.checkmark-offer');
                
                // Comparar por el VALUE del radio, no por el Ã­ndice del DOM
                if (radioValue === selectedIndex) {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-drk-500 bg-drk-50 transition';
                    check.classList.remove('hidden');
                    check.classList.add('text-drk-600');
                } else {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50';
                    check.classList.add('hidden');
                }
            });
            
            // Habilitar botÃ³n de confirmar
            document.getElementById('confirm-offer-selection-btn').disabled = false;
        }
        
        function closeOfferSelectionModal() {
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            // NO limpiar manuallySelectedOffer aquÃ­, se limpiarÃ¡ despuÃ©s de usarlo
        }
        
        function confirmOfferSelection() {
            if (!manuallySelectedOffer) return;
            
            // Cerrar modal
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            
            // Continuar con el flujo normal mostrando el resultado
            continueWithSelectedOffer();
        }
        
        function continueWithSelectedOffer() {
            console.log('continueWithSelectedOffer called');
            console.log('manuallySelectedOffer:', manuallySelectedOffer);
            console.log('lastComparisonResult:', lastComparisonResult);
            
            // Usar la oferta seleccionada manualmente
            let result = manuallySelectedOffer;
            
            if (!result) {
                console.error('No result available!');
                return;
            }
            
            console.log('Result offer:', result.offer.name);
            
            // Verificar si estamos en contexto MultiCups
            const isMultiCupsContext = lastComparisonResult && lastComparisonResult._multiCupsContext;
            
            if (isMultiCupsContext) {
                // Contexto MultiCups: Necesitamos TODOS los datos de lastComparisonResult
                // pero con la OFERTA seleccionada manualmente
                console.log('MultiCups context: recalculating costs for selected offer');
                
                // CRÃTICO: Si la oferta viene de selecciÃ³n manual, buscar la tarifa ORIGINAL
                let offerToUse = result.offer;
                
                if (result._needsOriginalLookup) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    console.log('ðŸ” Looking up original tariff in currentTariffs[' + tariffType + ']');
                    console.log('Searching for:', result.offer.name, '/', result.offer.description);
                    
                    const originalTariff = currentTariffs[tariffType]?.find(t => 
                        t.name === result.offer.name && t.description === result.offer.description
                    );
                    
                    if (originalTariff) {
                        console.log('âœ… Found original tariff, using it instead of contaminated offer');
                        offerToUse = originalTariff;
                    } else {
                        console.error('âŒ Original tariff not found, using provided offer (may be contaminated)');
                    }
                }
                
                // Usar la funciÃ³n centralizada para recalcular costes
                const recalculated = recalculateCostsForOffer(lastComparisonResult, offerToUse);
                
                // CRÃTICO: Recalcular totalAnnual y savings usando los costes recalculados
                // No usar result.totalAnnual que puede estar contaminado
                const IVA_RATE = 0.21;
                const IE_RATE = 0.05113;
                const diasFacturados = lastComparisonResult.dias_facturados || 30;
                const factorAnual = 365 / diasFacturados;
                
                const subBase = recalculated.subPower + recalculated.subEnergyNet;
                const costIE = subBase * IE_RATE;
                const baseImp = subBase + costIE;
                const costIVA = baseImp * IVA_RATE;
                const totalPeriod = baseImp + costIVA;
                const totalAnnual = totalPeriod * factorAnual;
                const originalBillAnnual = lastComparisonResult.originalBillAnnual;
                const savings = originalBillAnnual - totalAnnual;
                
                console.log('Recalculated totalAnnual:', totalAnnual, 'savings:', savings);
                
                // Crear un nuevo objeto combinando lastComparisonResult (datos base) 
                // con la oferta elegida manualmente y los costes recalculados
                const combinedResult = {
                    ...lastComparisonResult,  // Todos los datos base (CUPS, consumos, potencias, etc.)
                    offer: deepCopyOffer(offerToUse),  // COPIA PROFUNDA de la oferta ORIGINAL
                    totalAnnual: totalAnnual,  // Coste anual RECALCULADO
                    totalPeriod: totalPeriod,  // Coste periodo RECALCULADO
                    savings: savings,          // Ahorro RECALCULADO
                    energyCosts: recalculated.energyCosts,  // Desglose RECALCULADO de energÃ­a
                    powerCosts: recalculated.powerCosts,    // Desglose RECALCULADO de potencia
                    subPower: recalculated.subPower,        // Subtotal RECALCULADO de potencia
                    subEnergyNet: recalculated.subEnergyNet, // Subtotal RECALCULADO de energÃ­a
                    subBase: subBase,
                    costIE: costIE,
                    baseImp: baseImp,
                    costIVA: costIVA,
                    isNegativeSavings: savings <= 0
                };
                
                console.log('Combined result with recalculated costs:', combinedResult);
                console.log('Energy costs periods:', combinedResult.energyCosts.length);
                console.log('Power costs periods:', combinedResult.powerCosts.length);
                
                // IMPORTANTE: Si compareWithIndexed estÃ¡ activo, calcular resultado indexado ANTES de aÃ±adir a la lista
                if (compareWithIndexed) {
                    const tariffType = lastComparisonResult.originalTariffType;
                    const dataForCalc = lastComparisonResult;
                    const indexedResult = calculateIndexedOffer(dataForCalc, tariffType);
                    
                    if (indexedResult) {
                        // Recalcular costes para resultado indexado
                        const recalculatedIndexed = recalculateCostsForOffer(indexedResult, indexedResult.offer);
                        indexedResult.energyCosts = recalculatedIndexed.energyCosts;
                        indexedResult.powerCosts = recalculatedIndexed.powerCosts;
                        indexedResult.subPower = recalculatedIndexed.subPower;
                        indexedResult.subEnergyNet = recalculatedIndexed.subEnergyNet;
                        
                        // Calcular todos los costes adicionales para indexedResult
                        const subEnergyNetIndexed = indexedResult.subEnergyNet || 0;
                        const subPowerIndexed = indexedResult.subPower || 0;
                        const subBaseIndexed = subPowerIndexed + subEnergyNetIndexed;
                        const costIEIndexed = subBaseIndexed * IE_RATE;
                        const baseImpIndexed = subBaseIndexed + costIEIndexed;
                        const costIVAIndexed = baseImpIndexed * IVA_RATE;
                        const totalPeriodIndexed = baseImpIndexed + costIVAIndexed;
                        const totalAnnualIndexed = totalPeriodIndexed * factorAnual;
                        const savingsIndexed = originalBillAnnual - totalAnnualIndexed;
                        
                        // AÃ±adir los campos calculados al indexedResult
                        indexedResult.subBase = subBaseIndexed;
                        indexedResult.costIE = costIEIndexed;
                        indexedResult.baseImp = baseImpIndexed;
                        indexedResult.costIVA = costIVAIndexed;
                        indexedResult.totalPeriod = totalPeriodIndexed;
                        indexedResult.totalAnnual = totalAnnualIndexed;
                        indexedResult.savings = savingsIndexed;
                        indexedResult.dias_facturados = combinedResult.dias_facturados;
                        indexedResult.originalBillAnnual = originalBillAnnual;
                        indexedResult.originalBillPeriod = lastComparisonResult.originalBillPeriod;
                        indexedResult.cups = combinedResult.cups;
                        indexedResult.originalTariffType = combinedResult.originalTariffType; // CRÃTICO
                        indexedResult.ieRate = IE_RATE; // AÃ±adir la tasa del impuesto elÃ©ctrico
                        indexedResult.discountAmount = indexedResult.discountAmount || 0; // Preservar o inicializar
                        indexedResult.discountRate = indexedResult.discountRate || 0; // Preservar o inicializar
                        indexedResult.subEnergy = indexedResult.subEnergy || indexedResult.subEnergyNet; // Por compatibilidad
                        
                        console.log('indexedResult completo con todos los campos:', {
                            originalTariffType: indexedResult.originalTariffType,
                            powerCosts: indexedResult.powerCosts?.length,
                            energyCosts: indexedResult.energyCosts?.length,
                            dias_facturados: indexedResult.dias_facturados
                        });
                        
                        // AÃ±adir al resultado combinado ANTES de aÃ±adir a la lista
                        combinedResult.indexedComparison = indexedResult;
                        console.log('AÃ±adido resultado indexado completo al combinedResult:', indexedResult);
                    }
                }
                
                // Ahora sÃ­, aÃ±adir a la lista (ya con indexedComparison si corresponde)
                addSupplyToMultiCupsList(combinedResult);
            } else {
                // Contexto individual: Mostrar resultados
                console.log('Individual context, showing results');
                
                // CRÃTICO: Aplicar branding segÃºn el modo de comparaciÃ³n
                // Si el usuario eligiÃ³ "POWER CUP Global", SIEMPRE usar POWER CUP
                // Si eligiÃ³ "DRK Prioritario", usar la marca de la tarifa ganadora
                let brand;
                if (comparisonMode === 'overall_best') {
                    // POWER CUP Global: SIEMPRE verde, independiente de quiÃ©n gane
                    brand = BRANDS.POWER_CUP;
                    console.log('Modo POWER CUP Global: Forzando branding POWER CUP (verde)');
                } else {
                    // DRK Prioritario: Usar marca de la tarifa ganadora
                    brand = result.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                    console.log('Modo DRK Prioritario: Branding segÃºn ganador:', brand.NAME);
                }
                
                console.log('Applying brand:', brand.NAME);
                applyBrandStyles(brand);
                activeBrand = brand;
                
                // Asignar como resultado final
                lastComparisonResult = result;
                lastComparisonResult.isMulti = false;
                
                // Si compareWithIndexed estÃ¡ activo, calcular resultado indexado
                let indexedResult = null;
                if (compareWithIndexed) {
                    const tariffType = result.originalTariffType || currentTariffType;
                    indexedResult = calculateIndexedOffer(result, tariffType);
                    
                    if (indexedResult) {
                        lastIndexedResult = indexedResult;
                        console.log('Calculado resultado indexado para contexto individual:', indexedResult.offer.name);
                    }
                }
                
                console.log('About to render results UI');
                // Mostrar resultados (pasando indexedResult si existe)
                renderResultsUI(result, indexedResult);
                
                console.log('Hiding initial-view and showing results-view');
                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                console.log('Done showing results');
            }
        }
        
        function populateOfferSelector() {
            // Esta funciÃ³n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        function handleManualOfferSelection(e) {
            // Esta funciÃ³n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        // --- FIX: CancelaciÃ³n del EscÃ¡ner ---
        function cancelScanner() {
            stopScanner(); // Detiene el stream de la cÃ¡mara
            document.getElementById('scanner-view').classList.add('hidden');
            // Vuelve a la vista de selecciÃ³n de entrada (initial-view)
            document.getElementById('initial-view').classList.remove('hidden');
            document.getElementById('loading-status').classList.add('hidden');
        }

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup Event Listeners
            document.getElementById('manual-input-btn').onclick = startManualInputFlow;
            document.getElementById('execute-manual-input-btn').onclick = handleManualInput;
            
            // FIX APLICADO: El botÃ³n de cancelar del escÃ¡ner ahora vuelve a la vista de input, no a resetToLanding
            document.getElementById('stop-scan-btn').onclick = cancelScanner;  
            
            document.getElementById('start-scan-btn').onclick = startScanner;
            document.getElementById('capture-photo-btn').onclick = capturePhoto;
            
            // ModificaciÃ³n del botÃ³n de volver para la vista de entrada
            document.querySelector('#initial-view button:first-child').onclick = () => {
                currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : resetToLanding();
            };
            
            document.getElementById('upload-menu-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.remove('hidden');
                document.getElementById('qr-options-modal').classList.add('flex');
            };
            
            // BotÃ³n de Finalizar MULTICUPS (en la nueva vista SAGA)
            document.getElementById('multicups-finalize-btn-saga').onclick = finalizeMultiCups;

            // BotÃ³n para subir imagen
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click());
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                if (e.target.files[0]) decodeQRFromImage(e.target.files[0]);
                e.target.value = '';
            });
            
            setupPasteCatcher(); // <-- Llamada ahora segura

            document.getElementById('send-offer-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    // Aplicar focus ring de la marca a los inputs
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            };
            
            document.getElementById('execute-send-offer-btn').addEventListener('click', handleCopyOffer);
            document.getElementById('execute-pdf-offer-btn').addEventListener('click', handleGeneratePDF);

            document.getElementById('qr-toggle-checkbox').addEventListener('change', (e) => {
                const wrapper = document.getElementById('qr-content-wrapper');
                if (e.target.checked) {
                    generateQRCode(activeBrand);
                    wrapper.classList.add('active');
                } else {
                    wrapper.classList.remove('active');
                }
            });

            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                r.addEventListener('change', (e) => updateComparisonMode(e.target.value));
            });
            
            // Event listener para botÃ³n de confirmar selecciÃ³n de oferta
            document.getElementById('confirm-offer-selection-btn').addEventListener('click', confirmOfferSelection);
            
            // Disparar evento de cambio inicial para aplicar el branding pre-seleccionado
            const initialModeInput = document.querySelector('input[name="comparison_mode"]:checked');
            if (initialModeInput) {
                updateComparisonMode(initialModeInput.value);
            }
        });
        
        function decodeQRFromImage(imageFileOrBlob) {
            document.getElementById('loading-status').textContent = "Procesando imagen...";
            document.getElementById('loading-status').classList.remove('hidden');
            
            const img = new Image();
            const url = URL.createObjectURL(imageFileOrBlob);
            img.onload = () => {
                URL.revokeObjectURL(url);
                const localCanvas = document.createElement('canvas');
                const ctx = localCanvas.getContext('2d');
                localCanvas.width = img.width; localCanvas.height = img.height;
                ctx.drawImage(img, 0, 0, localCanvas.width, localCanvas.height); // Usar dimensiones reales de la imagen

                try {
                    const imageData = ctx.getImageData(0, 0, localCanvas.width, localCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    document.getElementById('loading-status').classList.add('hidden');

                    if (code) handleQRRead(code.data);
                    else window.showErrorModal("No se pudo detectar un cÃ³digo QR vÃ¡lido en la imagen.");
                } catch (e) {
                    document.getElementById('loading-status').classList.add('hidden');
                    window.showErrorModal("Error al procesar la imagen.");
                }
            };
            img.onerror = () => {
                URL.revokeObjectURL(url);
                document.getElementById('loading-status').classList.add('hidden');
                window.showErrorModal("No se pudo cargar la imagen para el escaneo QR.");
            };
            img.src = url;
        }

        function startScanner() {
            // Use multiCupsAddType for the check if we are in MultiCups mode
            const currentTypeCheck = currentTariffType === 'MULTICUPS' ? multiCupsAddType : currentTariffType;

            if (currentTypeCheck !== '2.0TD') {
                return window.showErrorModal("El escÃ¡ner QR solo es compatible con la tarifa 2.0 TD.");
            }
            if (currentTariffs['2.0TD'].length === 0) {
                 return window.showErrorModal("Cargando tarifas para esta modalidad. Por favor, espere.");
            }
            if (scannerRunning) return;
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.remove('hidden');
            document.getElementById('scanner-view').classList.add('flex');
            
            scannerRunning = true;
            video = document.createElement('video');
            video.autoplay = true; video.playsInline = true;
            canvas = document.createElement('canvas'); canvasCtx = canvas.getContext('2d');
            document.getElementById('interactive').innerHTML = '';
            document.getElementById('interactive').appendChild(video);
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1920 },      // Mayor resoluciÃ³n
                    height: { ideal: 1080 },
                    focusMode: { ideal: "continuous" }, // Autofocus continuo
                    aspectRatio: { ideal: 16/9 }
                } 
            }).then(s => {
                stream = s; video.srcObject = s;
                video.onloadedmetadata = () => { video.play(); scanLoop(); };
            }).catch(e => { 
                // Si falla con las opciones ideales, intentar sin ellas
                console.warn('Fallo con configuraciÃ³n ideal, intentando bÃ¡sica:', e);
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                }).then(s => {
                    stream = s; video.srcObject = s;
                    video.onloadedmetadata = () => { video.play(); scanLoop(); };
                }).catch(err => {
                    console.error(err); 
                    stopScanner(); 
                    cancelScanner(); 
                    window.showErrorModal("Error al acceder a la cÃ¡mara. Intente subir una imagen.");
                });
            });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { 
                animationFrameId = requestAnimationFrame(scanLoop); 
                return; 
            }
            
            if (canvas.width !== video.videoWidth) { 
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight; 
            }
            
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            
            // MEJORA 1: Intentar lectura normal
            let code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert" // MÃ¡s rÃ¡pido
            });
            
            if (!code) {
                // MEJORA 2: Intentar con inversiÃ³n de colores (QR oscuros en fondo claro)
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "invertFirst"
                });
            }
            
            if (!code) {
                // MEJORA 3: Intentar con TODAS las inversiones posibles
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            if (!code && canvas.width > 640) {
                // MEJORA 4: Si la imagen es grande, probar con resoluciÃ³n reducida
                // (a veces funciona mejor con imÃ¡genes mÃ¡s pequeÃ±as)
                const smallCanvas = document.createElement('canvas');
                const smallCtx = smallCanvas.getContext('2d');
                smallCanvas.width = Math.floor(canvas.width / 2);
                smallCanvas.height = Math.floor(canvas.height / 2);
                smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
                
                const smallImageData = smallCtx.getImageData(0, 0, smallCanvas.width, smallCanvas.height);
                code = jsQR(smallImageData.data, smallImageData.width, smallImageData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            if (!code) {
                // MEJORA 5: Aumentar contraste y volver a intentar
                const contrastedData = increaseContrast(imageData);
                code = jsQR(contrastedData.data, contrastedData.width, contrastedData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            if (code) { 
                handleQRRead(code.data); 
            } else { 
                animationFrameId = requestAnimationFrame(scanLoop); 
            }
        }
        
        // Nueva funciÃ³n para aumentar contraste
        function increaseContrast(imageData) {
            const data = new Uint8ClampedArray(imageData.data);
            const factor = 1.5; // Factor de contraste (1.5 = +50%)
            const intercept = 128 * (1 - factor);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = data[i] * factor + intercept;         // R
                data[i + 1] = data[i + 1] * factor + intercept; // G
                data[i + 2] = data[i + 2] * factor + intercept; // B
                // Alpha (i+3) no se toca
            }
            
            return new ImageData(data, imageData.width, imageData.height);
        }
        function stopScanner() {
            scannerRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null; stream = null;
        }
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            stopScanner();
            document.getElementById('loading-status').textContent = "Procesando foto...";
            document.getElementById('loading-status').classList.remove('hidden');
            
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            
            // MEJORA: Intentar mÃºltiples tÃ©cnicas de lectura
            let code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert"
            });
            
            if (!code) {
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "invertFirst"
                });
            }
            
            if (!code) {
                code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            if (!code && canvas.width > 640) {
                // Probar con resoluciÃ³n reducida
                const smallCanvas = document.createElement('canvas');
                const smallCtx = smallCanvas.getContext('2d');
                smallCanvas.width = Math.floor(canvas.width / 2);
                smallCanvas.height = Math.floor(canvas.height / 2);
                smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
                
                const smallImageData = smallCtx.getImageData(0, 0, smallCanvas.width, smallCanvas.height);
                code = jsQR(smallImageData.data, smallImageData.width, smallImageData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            if (!code) {
                // Aumentar contraste y volver a intentar
                const contrastedData = increaseContrast(imageData);
                code = jsQR(contrastedData.data, contrastedData.width, contrastedData.height, {
                    inversionAttempts: "attemptBoth"
                });
            }
            
            document.getElementById('loading-status').classList.add('hidden');
            if (code) {
                handleQRRead(code.data);
            } else {  
                window.showErrorModal("No se detectÃ³ ningÃºn QR. AsegÃºrese de que el cÃ³digo estÃ© bien enfocado.");  
                startScanner();  
            }
        }
        
        function handleQRRead(raw) {
            stopScanner();
            const p = {};
            raw.split('&').forEach(part => {  
                let [key, ...rest] = part.split('=');
                let value = rest.join('=');
                try { p[key] = decodeURIComponent(value || '').replace(',', '.'); } catch (e) { p[key] = value || ''; }
            });
            
            let billingDays = 30;  
            let dateRangeStr = "No disponible";  
            let startDateStr = null;  
            let endDateStr = null;
            const isoDateRegex = /(\d{4}-\d{2}-\d{2})/i;
            const dmyDateRegex = /(\d{2}\/\d{2}\/\d{4})/i;  
            
            const iniF_key = Object.keys(p).find(k => k.toLowerCase() === 'inif');
            const finF_key = Object.keys(p).find(k => k.toLowerCase() === 'finf');  
            const iniA_key = Object.keys(p).find(k => k.toLowerCase() === 'inia');  
            let rawStartDate = iniF_key ? p[iniF_key] : null;
            let rawEndDate = finF_key ? p[finF_key] : (iniA_key ? p[iniA_key] : null);  
            
            if (rawStartDate) { let match = rawStartDate.match(isoDateRegex); if (match) { startDateStr = formatIsoToDmy(match[1]); } else { match = rawStartDate.match(dmyDateRegex); if (match) startDateStr = match[1]; } }
            if (rawEndDate) { let match = rawEndDate.match(isoDateRegex); if (match) { endDateStr = formatIsoToDmy(match[1]); } else { match = rawEndDate.match(dmyDateRegex); if (match) endDateStr = match[1]; } }
            
            if (startDateStr && endDateStr) {
                billingDays = calculateDays(startDateStr, endDateStr);
                dateRangeStr = `${startDateStr} - ${endDateStr}`;
            }

            const directData = {
                cups: p.cups || 'QR SCAN',
                dias_facturados: billingDays,
                importe_total: parseFloat(p.imp || 0), // FIX: asegurar que es float, default a 0
                potencia_p1_kw: parseFloat(p.pP1 || 0),
                potencia_p2_kw: parseFloat(p.pP2 || 0),
                // Solo se reciben 3 consumos del QR de la CNMC (P1, P2, P3 -> Punta, Llano, Valle)
                consumo_punta: parseFloat(p.cfP1 || 0),
                consumo_llano: parseFloat(p.cfP2 || 0),
                consumo_valle: parseFloat(p.cfP3 || 0),
                fechas: dateRangeStr,
                rawQR: raw  
            };
            
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';

            if (directData.importe_total <= 0) return window.showErrorModal("QR incompleto. No se detectÃ³ el Importe Total de la factura.");

            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('loading-status').classList.add('hidden');

            if (isMultiCupsMode) {
                // En modo MultiCups, el QR solo puede ser 2.0TD
                // Creamos un objeto que imita el input manual
                const dataForSave = { ...directData, originalTariffType: '2.0TD' };  

                // Forzamos 2.0TD para la confirmaciÃ³n
                tempQrData = dataForSave;
                // El tipo de tarifa a sugerir para la confirmaciÃ³n es el seleccionado en la vista saga (o 2.0TD por defecto si es QR)
                const defaultTariffForConfirmation = multiCupsAddType || '2.0TD';
                document.getElementById('confirm-tariff-select').value = defaultTariffForConfirmation;  
                document.getElementById('confirm-tariff-select').innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos - Se mapearÃ¡n P1/P2/P3)</option>`;

                // Mostrar modal de confirmaciÃ³n (permitiendo al usuario cambiar a 3.0TD si lo necesita)
                showQRConfirmationModal(dataForSave);
            } else {
                // Modo Individual: Precarga inputs y compara directamente si es 2.0TD
                document.getElementById('input-cups').value = directData.cups;
                document.getElementById('input-total-bill').value = directData.importe_total;
                document.getElementById('input-billing-days').value = directData.dias_facturados;
                document.getElementById('input-p1-kw').value = directData.potencia_p1_kw;
                document.getElementById('input-p2-kw').value = directData.potencia_p2_kw;
                document.getElementById('input-e1-kwh').value = directData.consumo_punta;
                document.getElementById('input-e2-kwh').value = directData.consumo_llano;
                document.getElementById('input-e3-kwh').value = directData.consumo_valle;
                
                // Aseguramos que los 6 periodos estÃ©n ocultos si es 2.0TD.
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                if (currentTariffType === '2.0TD' && currentTariffs['2.0TD'].length > 0) {
                    compareOffers(directData);
                } else if (currentTariffs[currentTariffType]?.length > 0) {
                     window.showMessageModal(`QR leÃ­do. Por favor, revise y complete los datos faltantes para tarifas ${currentTariffType}.`, "Completar Datos Manuales");
                     document.getElementById('manual-input-modal').classList.remove('hidden');
                     document.getElementById('manual-input-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Las tarifas no han cargado aÃºn. Por favor, intente de nuevo.");
                }
            }
        }

        // --- FUNCIONES MULTICUPS AÃ‘ADIDAS ---

        function showQRConfirmationModal(data) {
            tempQrData = data;
            const modal = document.getElementById('qr-confirm-modal');
            const summaryEl = document.getElementById('qr-data-summary');
            const selectEl = document.getElementById('confirm-tariff-select');
            const selectorWrapper = document.getElementById('tariff-selector-wrapper');
            
            // Si estamos en MultiCups Mode, ocultamos el selector
            if (currentTariffType === 'MULTICUPS') {
                // OCULTAR el selector completo
                selectorWrapper.style.display = 'none';
                
                // Establecer el valor (aunque estÃ© oculto)
                selectEl.value = multiCupsAddType;
                
                // Actualizar tÃ­tulo y descripciÃ³n
                modal.querySelector('h3').textContent = `Confirmar Suministro MultiCups (${multiCupsAddType})`;
                modal.querySelector('p').textContent = `Revisa los datos extraÃ­dos del QR antes de aÃ±adir este suministro a la lista.`;
            } else {
                // Modo Individual: MOSTRAR el selector
                selectorWrapper.style.display = 'block';
                
                // Opciones del selector
                selectEl.innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos)</option>`;
                selectEl.value = data.originalTariffType && data.originalTariffType !== '6.1TD' ? data.originalTariffType : '2.0TD';
                
                // Textos originales
                modal.querySelector('h3').textContent = `Confirmar Suministro`;
                modal.querySelector('p').textContent = `Revisa los datos extraÃ­dos y selecciona el tipo de tarifa para aÃ±adir a la lista.`;
            }

            summaryEl.innerHTML = `
                <p class="font-bold text-slate-800 mb-2">Datos ExtraÃ­dos del QR</p>
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <span>CUPS:</span><span class="font-mono text-right">${data.cups}</span>
                    <span>DÃ­as Fact:</span><span class="font-mono text-right">${data.dias_facturados}</span>
                    <span>Total Factura:</span><span class="font-mono text-right">${data.importe_total.toFixed(2)} â‚¬</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">Potencias (kW):</span>
                    <span>P1:</span><span class="font-mono text-right">${data.potencia_p1_kw.toFixed(2)}</span>
                    <span>P2:</span><span class="font-mono text-right">${data.potencia_p2_kw.toFixed(2)}</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">Consumos (kWh):</span>
                    <span>Punta (E1):</span><span class="font-mono text-right">${data.consumo_punta}</span>
                    <span>Llano (E2):</span><span class="font-mono text-right">${data.consumo_llano}</span>
                    <span>Valle (E3):</span><span class="font-mono text-right">${data.consumo_valle}</span>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('confirm-save-supply-btn').onclick = () => {
            if (!tempQrData) return;
            const tariffType = document.getElementById('confirm-tariff-select').value;
            
            saveSupply(tempQrData, tariffType);
            
            document.getElementById('qr-confirm-modal').classList.add('hidden');
            tempQrData = null;  
        };

        function saveSupply(data, tariffType) {
            // CRÃTICO: Limpiar variables globales para evitar contaminaciÃ³n de CUPS anteriores
            availableOffers = [];
            lastComparisonResult = null;
            manuallySelectedOffer = null;  // â† CRÃTICO: Limpiar selecciÃ³n manual anterior
            
            console.log('=== VERIFICACIÃ“N CURRENTTARIFFS ===');
            console.log('currentTariffs keys:', Object.keys(currentTariffs));
            console.log('currentTariffs[2.0TD] length:', currentTariffs['2.0TD']?.length);
            console.log('currentTariffs[3.0TD] length:', currentTariffs['3.0TD']?.length);
            if (currentTariffs['2.0TD']?.[0]) {
                console.log('Primera tarifa 2.0TD - name:', currentTariffs['2.0TD'][0].name);
                console.log('Primera tarifa 2.0TD - p1_price:', currentTariffs['2.0TD'][0].p1_price);
            }
            if (currentTariffs['3.0TD']?.[0]) {
                console.log('Primera tarifa 3.0TD - name:', currentTariffs['3.0TD'][0].name);
                console.log('Primera tarifa 3.0TD - p1_price:', currentTariffs['3.0TD'][0].p1_price);
            }
            
            const tariffsToCompare = currentTariffs[tariffType];
            if (!tariffsToCompare || tariffsToCompare.length === 0) {
                window.showErrorModal(`Las tarifas ${tariffType} no estÃ¡n cargadas.`);
                return;
            }
            
            console.log('=== SAVE SUPPLY DEBUG ===');
            console.log('TariffType:', tariffType);
            console.log('Tarifas disponibles:', tariffsToCompare.length);
            console.log('Primera tarifa name:', tariffsToCompare[0]?.name);
            console.log('Primera tarifa p1_price:', tariffsToCompare[0]?.p1_price);
            console.log('Primera tarifa p_potencia_1:', tariffsToCompare[0]?.p_potencia_1);
            
            // Creamos un nuevo objeto de datos para el cÃ¡lculo, ya que el cÃ¡lculo interno necesita los campos correctos (consumo_p1, consumo_p2, etc.)
            let dataForCalc = { ...data };
            
            const p1_kw = data.potencia_p1_kw || 0;
            const p2_kw = data.potencia_p2_kw || 0;
            const p3_kw_input = data.potencia_p3_kw || 0;
            const e4_kwh_input = data.consumo_p4 || 0;

            // 1. Manejo de mapeo de Potencias y Consumos
            // Simplificamos la condiciÃ³n, ya que solo 3.0TD es de alto voltaje
            if (tariffType === '3.0TD') {
                // Verificar si se introdujeron manualmente los 6 periodos
                const isManual6PeriodInput = p3_kw_input > 0 || e4_kwh_input > 0 || (data.consumo_p4 > 0 || data.consumo_p5 > 0 || data.consumo_p6 > 0);
                
                if (!isManual6PeriodInput) {
                    // Si es QR o Input Manual simplificado (solo 3 consumos/2 potencias)
                    // IMPORTANTE: Para 3.0TD las facturas muestran solo Punta/Llano/Valle
                    // pero la tarifa tiene 6 periodos de precios
                    
                    // Potencias: Propagar P1 y P2 a los 6 periodos
                    dataForCalc.potencia_p1_kw = p1_kw;
                    dataForCalc.potencia_p2_kw = p2_kw;
                    dataForCalc.potencia_p3_kw = p1_kw;
                    dataForCalc.potencia_p4_kw = p2_kw;
                    dataForCalc.potencia_p5_kw = p1_kw;  
                    dataForCalc.potencia_p6_kw = p2_kw;  
                    
                    // Consumos: Distribuir Punta/Llano/Valle entre los 6 periodos
                    // Estrategia: Asignar cada consumo a 2 periodos (duplicar)
                    const punta = data.consumo_punta || 0;
                    const llano = data.consumo_llano || 0;
                    const valle = data.consumo_valle || 0;
                    
                    // DistribuciÃ³n tÃ­pica en tarifas 3.0TD:
                    // P1, P4 = Punta (horas mÃ¡s caras)
                    // P2, P5 = Llano (horas medias)
                    // P3, P6 = Valle (horas mÃ¡s baratas)
                    dataForCalc.consumo_p1 = punta / 2;  // Mitad de punta
                    dataForCalc.consumo_p2 = llano / 2;  // Mitad de llano
                    dataForCalc.consumo_p3 = valle / 2;  // Mitad de valle
                    dataForCalc.consumo_p4 = punta / 2;  // Otra mitad de punta
                    dataForCalc.consumo_p5 = llano / 2;  // Otra mitad de llano
                    dataForCalc.consumo_p6 = valle / 2;  // Otra mitad de valle
                    
                    console.log('3.0TD QR Mode: Distributing consumptions across 6 periods');
                    console.log('Original - Punta:', punta, 'Llano:', llano, 'Valle:', valle);
                    console.log('Distributed - P1:', dataForCalc.consumo_p1, 'P2:', dataForCalc.consumo_p2, 'P3:', dataForCalc.consumo_p3);
                    console.log('Distributed - P4:', dataForCalc.consumo_p4, 'P5:', dataForCalc.consumo_p5, 'P6:', dataForCalc.consumo_p6);
                    
                } else {
                    // Es una entrada manual completa de 6 periodos
                    for(let i=1; i<=6; i++) {
                        dataForCalc[`consumo_p${i}`] = data[`consumo_p${i}`] || 0;
                        dataForCalc[`potencia_p${i}_kw`] = data[`potencia_p${i}_kw`] || 0;
                    }
                }
            } else if (tariffType === '2.0TD') {
                 // Para 2.0TD, aseguramos que los campos 'consumo_punta/llano/valle' estÃ¡n llenos.
                 dataForCalc.consumo_punta = data.consumo_punta !== undefined ? data.consumo_punta : (data.consumo_p1 || 0);
                 dataForCalc.consumo_llano = data.consumo_llano !== undefined ? data.consumo_llano : (data.consumo_p2 || 0);
                 dataForCalc.consumo_valle = data.consumo_valle !== undefined ? data.consumo_valle : (data.consumo_p3 || 0);
                 // Solo usamos potencias P1 y P2
                 dataForCalc.potencia_p1_kw = data.potencia_p1_kw || 0;
                 dataForCalc.potencia_p2_kw = data.potencia_p2_kw || 0;
            }
            
            // 2. Ejecutar la comparaciÃ³n con el objeto de datos corregido
            const results = tariffsToCompare.map(t => calculateTariffCost(t, dataForCalc, tariffType));
            
            let bestOverall = null; // Absolute best (DRK or Power Cup)
            let bestDrk = null;  // Best DRK only
            
            results.forEach(r => {
                // Siempre comparamos por el coste anual
                const annualCost = r.totalAnnual;
                
                // Best overall is the one with the lowest annual cost
                if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                    bestOverall = r;
                }

                // Best DRK is the DRK one with the lowest annual cost
                if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                    if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                    }
                }
            });
            
            let finalIndividualResult = bestOverall;
            
            // --- GUARDAR OFERTAS PARA SELECCIÃ“N MANUAL ---
            // En MultiCups, permitir elegir entre TODAS las ofertas (con o sin ahorro)
            // para dar al usuario la mÃ¡xima flexibilidad
            // CRÃTICO: Verificar currentTariffType (que indica el modo general)
            // NO tariffType (que es el tipo especÃ­fico del CUPS actual: 2.0TD o 3.0TD)
            const isInMultiCupsFlow = currentTariffType === 'MULTICUPS';
            
            console.log('=== FILTER AVAILABLE OFFERS ===');
            console.log('currentTariffType (flow):', currentTariffType);
            console.log('tariffType (this CUPS):', tariffType);
            console.log('isInMultiCupsFlow:', isInMultiCupsFlow);
            console.log('comparisonMode:', comparisonMode);
            console.log('Total results:', results.length);
            
            availableOffers = results.filter(r => {
                // Si modo es "DRK ÃšNICAMENTE", filtrar solo ofertas DRK
                if (comparisonMode === 'drk_only') {
                    // En MultiCups: mostrar TODAS las ofertas DRK (con o sin ahorro)
                    // En Individual: solo ofertas DRK con ahorro positivo
                    if (isInMultiCupsFlow) {
                        return r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual';
                    } else {
                        const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                }
                
                // En otros modos, mostrar ofertas con ahorro
                const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                return hasPositiveSavings;
            });
            
            console.log('Filtered availableOffers.length:', availableOffers.length);
            
            console.log('=== AVAILABLE OFFERS DEBUG ===');
            console.log('Total availableOffers:', availableOffers.length);
            availableOffers.forEach((offer, idx) => {
                console.log(`Offer ${idx}: ${offer.offer.name}, p1_price: ${offer.offer.p1_price}, p_potencia_1: ${offer.offer.p_potencia_1}`);
            });
            
            // --- LÃ“GICA DE SELECCIÃ“N INDIVIDUAL SEGÃšN MODO DE COMPARACIÃ“N ---
            let brand = activeBrand;
            
            // Si hay una oferta seleccionada manualmente (desde el modal), usarla
            if (manuallySelectedOffer) {
                finalIndividualResult = manuallySelectedOffer;
                
                // Aplicar branding segÃºn la oferta seleccionada
                if (finalIndividualResult.offer.isDrk) {
                    brand = BRANDS.DRK;
                } else {
                    brand = BRANDS.POWER_CUP;
                }
            } else {
                // Modo automÃ¡tico segÃºn el modo de comparaciÃ³n
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    finalIndividualResult = bestOverall;
                    
                    // Aplicar branding segÃºn quiÃ©n ganÃ³
                    if (finalIndividualResult.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        finalIndividualResult = bestDrk || bestOverall;
                        // DRK ÃšNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        finalIndividualResult = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si ganÃ³ una comercializadora NO-DRK
                        if (finalIndividualResult.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
            }

            if (!finalIndividualResult) return window.showErrorModal("No se pudo calcular el ahorro para esta CUPS.");
            
            // Recalcular el ahorro basado en el resultado final seleccionado
            finalIndividualResult.savings = finalIndividualResult.originalBillAnnual - finalIndividualResult.totalAnnual;
            
            // Manejar casos sin ahorro
            if (finalIndividualResult.savings <= 0) {
                finalIndividualResult.isNegativeSavings = true;
                finalIndividualResult.savings = 0;
                finalIndividualResult.totalAnnual = finalIndividualResult.originalBillAnnual;
                finalIndividualResult.offer = { 
                    name: "Tu Tarifa Actual", 
                    description: "Es la mejor opciÃ³n detectada", 
                    isDrk: false 
                };
                // Mantener el branding segÃºn el modo seleccionado
                brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            }

            // Apply branding here just for consistency before saving/showing modal
            applyBrandStyles(brand);
            
            // Ensure the correct tariff type used for calculation is stored
            finalIndividualResult.originalTariffType = tariffType;
            
            // Copiar datos base del suministro (CUPS, dÃ­as facturados, importe, etc.)
            finalIndividualResult.cups = data.cups || '';
            finalIndividualResult.importe_total = data.importe_total || 0;
            finalIndividualResult.dias_facturados = data.dias_facturados || 30;

            // Copy back the 6-period power and consumption values in case they were generated (for 3.0TD)
            if (tariffType === '3.0TD') {
                for (let i = 1; i <= 6; i++) {
                    finalIndividualResult[`consumo_p${i}`] = dataForCalc[`consumo_p${i}`] || 0;
                    finalIndividualResult[`potencia_p${i}_kw`] = dataForCalc[`potencia_p${i}_kw`] || 0;
                }
            } else if (tariffType === '2.0TD') {
                // Para 2.0TD tambiÃ©n copiar los datos
                finalIndividualResult.consumo_punta = dataForCalc.consumo_punta || 0;
                finalIndividualResult.consumo_llano = dataForCalc.consumo_llano || 0;
                finalIndividualResult.consumo_valle = dataForCalc.consumo_valle || 0;
                finalIndividualResult.potencia_p1_kw = dataForCalc.potencia_p1_kw || 0;
                finalIndividualResult.potencia_p2_kw = dataForCalc.potencia_p2_kw || 0;
            }
            
            // --- NUEVA LÃ“GICA: Modal de decisiÃ³n en MultiCups (TODOS LOS MODOS) ---
            // Si hay mÃ¡s de 1 oferta, permitir elegir (en cualquier modo)
            if (availableOffers.length > 1) {
                console.log('MultiCups: Showing decision modal with', availableOffers.length, 'offers');
                
                // Guardar temporalmente el resultado para usarlo despuÃ©s
                lastComparisonResult = finalIndividualResult;
                lastComparisonResult.isMulti = false;
                lastComparisonResult._multiCupsContext = {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                };
                
                // Mostrar modal de decisiÃ³n
                showOfferDecisionModal();
                return; // No aÃ±adir todavÃ­a, esperar decisiÃ³n del usuario
            }
            
            // AÃ±adir directamente si solo hay 1 oferta o ninguna
            // CRÃTICO: Asegurar que el resultado tenga el contexto MULTICUPS
            finalIndividualResult._multiCupsContext = {
                tariffType: tariffType,
                dataForCalc: dataForCalc
            };
            
            // IMPORTANTE: Usar addSupplyToMultiCupsList para que recalcule costes correctamente
            addSupplyToMultiCupsList(finalIndividualResult);
            
            // La funciÃ³n addSupplyToMultiCupsList ya actualiza la UI, pero como estamos
            // en saveSupply, NO llamamos a showMultiCupsSagaView aquÃ­
            // (se llama dentro de addSupplyToMultiCupsList)
            return; // Salir para no ejecutar cÃ³digo duplicado
        }

        // --- FETCH & PARSE (Actualizado para MÃºltiples Tarifas) ---

        async function fetchTariffsForMultiCups() {
            const statusEl = document.getElementById('loading-status-saga');
            statusEl.textContent = `Cargando tarifas 2.0TD y 3.0TD...`;
            updateMultiCupsSagaView(); // Update visibility to show loading
            
            // Fetch 2.0TD and 3.0TD tariffs simultaneously
            await Promise.all([
                fetchTariffsFromSheet('2.0TD'),
                fetchTariffsFromSheet('3.0TD')  
            ]);
            
            updateMultiCupsSagaView(); // Update visibility to hide loading and enable buttons
            
            if (currentTariffs['2.0TD'].length === 0 || currentTariffs['3.0TD'].length === 0) {
                 // Use a more specific error message based on which failed
                 const failed = [];
                 if (currentTariffs['2.0TD'].length === 0) failed.push('2.0TD');
                 if (currentTariffs['3.0TD'].length === 0) failed.push('3.0TD');
                 window.showErrorModal(`Error: Las tarifas ${failed.join(' y ')} para MultiCups no se han cargado correctamente. Intente de nuevo.`);
            }
        }
        
        async function fetchTariffsFromSheet(tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            const sheetId = config.sheetId;

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error red para ${tariffType}`);
                const text = await response.text();
                currentTariffs[tariffType] = parseCSV(text, tariffType);
                
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    const count = currentTariffs[currentTariffType].length;
                    document.getElementById('tariff-display-badge').textContent = count;
                }

            } catch (e) {
                console.error(`Error al cargar ${tariffType}:`, e);
                currentTariffs[tariffType] = [];  
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('tariff-display-badge').textContent = 'Error';
                }
            } finally {
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('loading-status').classList.add('hidden');
                }
            }
        }

        function parseCSV(text, tariffType) {
             const lines = text.trim().split('\n');
             if (lines.length < 2) return [];
             
             const rawHeader = lines[0];
             const delimiter = rawHeader.includes(';') ? ';' : ',';
             
             const headers = rawHeader.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
             const data = [];

             for(let i=1; i<lines.length; i++) {
                 const row = lines[i].trim();
                 if(!row) continue;
                 
                 const regex = new RegExp(`(?:^|${delimiter})(\"(?:[^\"]|\"\")*\"|[^${delimiter}]*)`,"g");
                 const values = [];
                 let match = null;
                 regex.lastIndex = 0;  
                 // Custom parsing to handle quoted fields correctly
                 let lastIndex = 0;
                 while(match = regex.exec(row)){
                      let val = match[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                      // If the first capture group starts with the delimiter, it means the content is empty or the previous field was empty.
                      if (match.index > lastIndex) {
                           // Add empty string for missed fields
                           for (let j = 0; j < (match.index - lastIndex) / delimiter.length; j++) {
                                values.push('');
                           }
                      }
                      values.push(val.trim());
                      lastIndex = match.index + match[0].length;
                 }
                 // Add trailing empty fields
                 if (values.length < headers.length) {
                      for (let j = values.length; j < headers.length; j++) {
                           values.push('');
                      }
                 }


                 if(values.length < headers.length) continue;

                 let item = { cups_match: [tariffType] };
                 headers.forEach((h, idx) => {
                      let val = values[idx];
                       if (h.includes('price') || h.includes('potencia') || h === 'descuento') {
                            val = parseFloat(val?.replace(',', '.') || 0);
                             if(isNaN(val)) val = 0;
                       }
                       item[h] = val;
                 });

                 // Marcar como DRK si el nombre O la descripciÃ³n O commercializer contienen "DRK"
                 item.isDrk = item.name?.toUpperCase().includes('DRK') || 
                              item.description?.toUpperCase().includes('DRK') ||
                              item.commercializer?.toUpperCase().includes('DRK');
                 
                 // Check a mandatory field to ensure it's a valid row (using p1_price as a key indicator)
                 if(item.p1_price !== undefined) {
                     data.push(item);
                 }
               }
               return data;
        }
        
        // ===== FUNCIONES DE NAVEGACIÃ“N =====
        function hideAllScreens() {
            document.getElementById('screen-inicio').classList.remove('active');
            document.getElementById('screen-electricidad').classList.remove('active');
            document.getElementById('screen-gas').classList.remove('active');
            document.getElementById('screen-gas-results').classList.remove('active');
        }

        function goToInicio() {
            hideAllScreens();
            document.getElementById('screen-inicio').classList.add('active');
            // Mostrar el modo de comparaciÃ³n
            document.getElementById('modo-comparacion-section').style.display = 'block';
        }

        function goToElectricidad() {
            hideAllScreens();
            document.getElementById('screen-electricidad').classList.add('active');
            // Ocultar el modo de comparaciÃ³n (ya estÃ¡ seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }

        function goToGas() {
            hideAllScreens();
            document.getElementById('screen-gas').classList.add('active');
            // Ocultar el modo de comparaciÃ³n (ya estÃ¡ seleccionado)
            document.getElementById('modo-comparacion-section').style.display = 'none';
        }
        
        // ===== CALCULADOR DE GAS =====
        
        // Variables globales para GAS
        let currentGasTariff = '';
        let gasTariffsData = [];
        let gasCalculationParams = {}; // Guardar parÃ¡metros de cÃ¡lculo
        const GAS_SHEET_ID = '1P_OSzj-sqDgT7_3KAdp7Y6ySA3ytsFHQKFvfZjAjsjE';
        
        // FunciÃ³n: Actualizar UI segÃºn modo de selecciÃ³n
        function updateGasSelectionUI() {
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            const typeButtons = document.getElementById('gas-type-buttons');
            const calculateBtn = document.getElementById('gas-calculate-btn');
            const bestDescription = document.getElementById('gas-best-description');
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija: mostrar botÃ³n calcular
                    typeButtons.style.display = 'none';
                    calculateBtn.style.display = 'block'; // MOSTRAR el botÃ³n
                    calculateBtn.textContent = 'Calcular';
                    bestDescription.textContent = 'CompararÃ¡ automÃ¡ticamente la mejor tarifa indexada DRK vs la mejor tarifa fija DRK.';
                } else {
                    // Usuario elige tipo: mostrar botones
                    typeButtons.style.display = 'block';
                    calculateBtn.style.display = 'none'; // Ocultar botÃ³n principal
                    bestDescription.textContent = 'Elige si quieres ver la mejor tarifa fija o indexada.';
                }
            } else {
                // Modo "Elegir entre resultados"
                typeButtons.style.display = 'none';
                calculateBtn.style.display = 'block';
                calculateBtn.textContent = 'Ver tarifas disponibles';
            }
        }
        
        // FunciÃ³n: Toggle modo de comparaciÃ³n
        function toggleGasComparisonMode() {
            updateGasSelectionUI();
        }
        
        // FunciÃ³n: Calcular con tipo especÃ­fico (fija o indexada)
        function calculateGasWithType(type) {
            // Validar inputs
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            // Guardar parÃ¡metros
            gasCalculationParams = { dias, kwh, totalCliente, type, mode: 'best' };
            
            // Cerrar modal y calcular
            closeGasModal();
            performGasCalculation();
        }
        
        // FunciÃ³n: Proceder a cÃ¡lculo segÃºn configuraciÃ³n
        function proceedToGasCalculation() {
            // Validar inputs
            const dias = parseFloat(document.getElementById('gas-dias').value);
            const kwh = parseFloat(document.getElementById('gas-kwh').value);
            const totalCliente = parseFloat(document.getElementById('gas-total-cliente').value);
            
            if (!dias || !kwh || !totalCliente) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            if (dias <= 0 || kwh <= 0 || totalCliente <= 0) {
                alert('Los valores deben ser mayores a 0');
                return;
            }
            
            const selectionMode = document.querySelector('input[name="gas-selection-mode"]:checked').value;
            const compareChecked = document.getElementById('gas-compare-indexed-fixed').checked;
            
            // Guardar parÃ¡metros
            gasCalculationParams = {
                dias,
                kwh,
                totalCliente,
                mode: selectionMode,
                compareIndexedVsFixed: compareChecked
            };
            
            // Cerrar modal
            closeGasModal();
            
            if (selectionMode === 'best') {
                // Modo "Mejores tarifas"
                if (compareChecked) {
                    // Comparar indexada vs fija automÃ¡ticamente
                    performGasCalculation();
                }
            } else {
                // Modo "Elegir entre resultados" - mostrar selector de tarifas
                showGasTariffSelector();
            }
        }
        
        // FunciÃ³n: Realizar cÃ¡lculo de GAS
        function performGasCalculation() {
            const { dias, kwh, totalCliente, type, mode, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            
            // Convertir RL1 â†’ RL.1 para buscar en el Excel
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            console.log(`ðŸ” Buscando tarifa: ${currentGasTariff} â†’ ${searchTariff}`);
            console.log(`ðŸ“‹ Modo: ${mode}, Tipo: ${type || 'auto'}, Comparar: ${compareIndexedVsFixed}`);
            
            // Buscar en la columna "Tarifa"
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                const searchValue = searchTariff.toUpperCase();
                return tariffValue === searchValue;
            });
            
            console.log(`ðŸ“Š Tarifas encontradas para ${searchTariff}: ${filteredTariffs.length}`);
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
                console.log(`ðŸ“Š DespuÃ©s de filtro DRK: ${filteredTariffs.length}`);
            }
            
            if (filteredTariffs.length === 0) {
                alert(`No se encontraron tarifas DRK para ${searchTariff}`);
                return;
            }
            
            let results = [];
            
            if (compareIndexedVsFixed) {
                // MODO: Comparar Indexada vs Fija
                // Indexada = name contiene "INDEX" o "DRK INDEX"
                // Fija = name NO contiene "INDEX" o description contiene "FIJO"/"FIJA"
                const indexedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                const fixedTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripciÃ³n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
                
                console.log(`ðŸŸ  Indexadas: ${indexedTariffs.length}, ðŸ”µ Fijas: ${fixedTariffs.length}`);
                
                // Encontrar mejor indexada (normalmente solo hay 1 DRK INDEX por categorÃ­a)
                if (indexedTariffs.length > 0) {
                    const bestIndexed = indexedTariffs[0]; // Primera DRK INDEX
                    results.push(calculateGasTariff(bestIndexed, dias, kwh, totalCliente));
                }
                
                // Encontrar mejor fija
                if (fixedTariffs.length > 0) {
                    const calculatedFixed = fixedTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                    const bestFixed = calculatedFixed.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                    results.push(bestFixed);
                }
                
            } else if (mode === 'best' && type) {
                // MODO: Mejores tarifas - Usuario eligiÃ³ Fija o Indexada
                let targetTariffs;
                
                if (type === 'fija') {
                    // Buscar FIJAS: name NO contiene INDEX, o description contiene FIJO
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        const desc = (t.description || t.Description || '').toUpperCase();
                        return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                    });
                } else {
                    // Buscar INDEXADAS: name contiene INDEX
                    targetTariffs = filteredTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toUpperCase();
                        return name.includes('INDEX');
                    });
                }
                
                console.log(`ðŸ“Š Tarifas ${type}: ${targetTariffs.length}`);
                
                if (targetTariffs.length === 0) {
                    alert(`No se encontraron tarifas ${type} para esta categorÃ­a`);
                    return;
                }
                
                // Calcular todas y encontrar la mejor
                const calculated = targetTariffs.map(t => calculateGasTariff(t, dias, kwh, totalCliente));
                const best = calculated.sort((a, b) => b.ahorro_anual - a.ahorro_anual)[0];
                results = [best];
            }
            
            if (results.length === 0) {
                alert('No se pudieron calcular resultados');
                return;
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // FunciÃ³n: Seleccionar tarifa de GAS y abrir modal
        function selectGasTariff(tariff) {
            currentGasTariff = tariff;
            // Mostrar con formato correcto (Rl1 en lugar de RL1)
            const displayTariff = tariff.charAt(0).toUpperCase() + tariff.charAt(1).toLowerCase() + tariff.slice(2);
            document.getElementById('gas-selected-tariff').textContent = displayTariff;
            
            // Resetear formulario
            document.getElementById('gas-dias').value = '';
            document.getElementById('gas-kwh').value = '';
            document.getElementById('gas-total-cliente').value = '';
            document.getElementById('gas-compare-indexed-fixed').checked = false;
            document.querySelector('input[name="gas-selection-mode"][value="best"]').checked = true;
            
            // Actualizar UI
            updateGasSelectionUI();
            
            // Mostrar modal
            document.getElementById('gas-manual-input-modal').classList.remove('hidden');
            document.getElementById('gas-manual-input-modal').classList.add('flex');
            
            // Cargar datos si no estÃ¡n cargados
            if (gasTariffsData.length === 0) {
                loadGasData();
            }
            
            console.log(`ðŸ“‹ Tarifa seleccionada: ${tariff} (buscarÃ¡: ${tariff.toLowerCase()})`);
        }
        
        // FunciÃ³n: Mostrar selector de tarifas manual
        function showGasTariffSelector() {
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
            
            // Filtrar tarifas disponibles
            let filteredTariffs = gasTariffsData.filter(t => {
                const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                return tariffValue === searchTariff.toUpperCase();
            });
            
            // Aplicar filtro DRK si corresponde
            if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toLowerCase();
                    return name.includes('drk') || name.includes('direct');
                });
            }
            
            // Si comparar indexada vs fija, solo mostrar FIJAS para selecciÃ³n manual
            if (compareIndexedVsFixed) {
                filteredTariffs = filteredTariffs.filter(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    const desc = (t.description || t.Description || '').toUpperCase();
                    // Es FIJA si NO tiene INDEX en name, o si tiene FIJO/FIJA en descripciÃ³n
                    return !name.includes('INDEX') || desc.includes('FIJO') || desc.includes('FIJA');
                });
            }
            
            if (filteredTariffs.length === 0) {
                alert('No hay tarifas disponibles para selecciÃ³n manual');
                return;
            }
            
            // CALCULAR TODAS LAS TARIFAS PARA MOSTRAR AHORRO
            const calculatedTariffs = filteredTariffs.map(tariff => {
                const result = calculateGasTariff(tariff, dias, kwh, totalCliente);
                return {
                    tariff: tariff,
                    calculation: result,
                    name: tariff.name || tariff.Name,
                    description: tariff.description || tariff.Description || (tariff.name || tariff.Name),
                    isIndexed: (tariff.name || tariff.Name || '').toUpperCase().includes('INDEX'),
                    ahorro: result.ahorro_anual
                };
            });
            
            console.log(`ðŸ’° Tarifas calculadas: ${calculatedTariffs.length}`);
            
            // Guardar para usar en ordenamiento
            window.gasCalculatedTariffs = calculatedTariffs;
            
            // Renderizar UI con ordenamiento por defecto (mayor ahorro)
            renderGasTariffSelector('ahorro-desc');
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
        }
        
        // FunciÃ³n: Renderizar selector de tarifas con ordenamiento
        function renderGasTariffSelector(sortBy = 'ahorro-desc') {
            const calculatedTariffs = window.gasCalculatedTariffs;
            const compareIndexedVsFixed = gasCalculationParams.compareIndexedVsFixed;
            
            // Ordenar segÃºn criterio
            let sortedTariffs = [...calculatedTariffs];
            
            if (sortBy === 'ahorro-desc') {
                sortedTariffs.sort((a, b) => b.ahorro - a.ahorro);
            } else if (sortBy === 'ahorro-asc') {
                sortedTariffs.sort((a, b) => a.ahorro - b.ahorro);
            } else if (sortBy === 'nombre') {
                sortedTariffs.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Crear UI de selecciÃ³n
            const container = document.getElementById('gas-results-container');
            let html = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-drk-900 mb-4">Selecciona las tarifas a comparar:</h3>
                    <p class="text-sm text-slate-600 mb-4">
                        ${compareIndexedVsFixed ? 'La tarifa indexada DRK se compararÃ¡ automÃ¡ticamente con las tarifas fijas que selecciones.' : 'Selecciona una o mÃ¡s tarifas para comparar.'}
                    </p>
                    
                    <!-- Buscador de texto -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ðŸ” Buscar comercializadora:</label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="gas-search-input"
                                placeholder="Escribe el nombre de la comercializadora..."
                                onkeyup="applyGasSearch()"
                                class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-red-500 focus:outline-none"
                            >
                            <button 
                                onclick="clearGasSearch()"
                                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition"
                                title="Limpiar bÃºsqueda"
                            >
                                âœ•
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="gas-search-count"></p>
                    </div>
                    
                    <!-- Filtros de ordenamiento -->
                    <div class="mb-4 p-4 bg-slate-50 rounded-lg">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ordenar por:</label>
                        <div class="flex gap-2 flex-wrap">
                            <button 
                                onclick="renderGasTariffSelector('ahorro-desc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-desc' ? 'bg-green-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-green-300'}"
                            >
                                ðŸ’° Mayor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('ahorro-asc')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'ahorro-asc' ? 'bg-red-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-red-300'}"
                            >
                                ðŸ“‰ Menor ahorro primero
                            </button>
                            <button 
                                onclick="renderGasTariffSelector('nombre')"
                                class="px-4 py-2 rounded-lg text-sm font-bold transition ${sortBy === 'nombre' ? 'bg-blue-500 text-white' : 'bg-white text-slate-700 border-2 border-slate-200 hover:border-blue-300'}"
                            >
                                ðŸ”¤ Por nombre
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
            `;
            
            sortedTariffs.forEach((item, index) => {
                const typeLabel = item.isIndexed ? 'ðŸŸ  INDEXADA' : 'ðŸ”µ FIJA';
                const ahorroAnual = item.ahorro;
                const isPositive = ahorroAnual > 0;
                const ahorroClass = isPositive ? 'text-green-600' : 'text-red-600';
                const ahorroSign = isPositive ? '+' : '';
                
                html += `
                    <label class="flex items-center gap-3 p-4 border-2 ${isPositive ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-lg hover:border-red-300 cursor-pointer transition">
                        <input 
                            type="checkbox" 
                            class="gas-tariff-checkbox w-5 h-5 text-red-600 rounded flex-shrink-0"
                            data-index="${index}"
                        >
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-drk-900">${item.name}</span>
                                <span class="text-xs px-2 py-1 rounded ${item.isIndexed ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${typeLabel}</span>
                            </div>
                            <p class="text-sm text-slate-600">${item.description}</p>
                        </div>
                        <div class="flex flex-col items-end text-right flex-shrink-0 ml-2">
                            <span class="text-xs text-slate-500 font-semibold">Ahorro anual:</span>
                            <span class="text-lg font-black ${ahorroClass}">${ahorroSign}${ahorroAnual.toFixed(2)}â‚¬</span>
                        </div>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    
                    <button 
                        onclick="calculateSelectedGasTariffs()"
                        class="w-full mt-6 px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition"
                    >
                        Calcular tarifas seleccionadas
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Guardar ordenamiento actual
            window.gasSortedTariffs = sortedTariffs;
        }
        
        // FunciÃ³n: Calcular tarifas seleccionadas manualmente
        function calculateSelectedGasTariffs() {
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Selecciona al menos una tarifa');
                return;
            }
            
            const { dias, kwh, totalCliente, compareIndexedVsFixed } = gasCalculationParams;
            
            // Usar las tarifas ya ordenadas
            const sortedTariffs = window.gasSortedTariffs || window.gasCalculatedTariffs;
            
            const selectedCalculations = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return sortedTariffs[index].calculation;
            });
            
            let results = selectedCalculations;
            
            // Si comparar indexada vs fija, agregar la indexada DRK al inicio
            if (compareIndexedVsFixed) {
                const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
                const searchTariff = currentGasTariff.replace(/RL(\d)/, 'RL.$1');
                
                let allTariffs = gasTariffsData.filter(t => {
                    const tariffValue = (t.Tarifa || '').trim().toUpperCase();
                    return tariffValue === searchTariff.toUpperCase();
                });
                
                if (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized') {
                    allTariffs = allTariffs.filter(t => {
                        const name = (t.name || t.Name || '').toLowerCase();
                        return name.includes('drk') || name.includes('direct');
                    });
                }
                
                // Buscar indexada por name (contiene INDEX)
                const indexedTariff = allTariffs.find(t => {
                    const name = (t.name || t.Name || '').toUpperCase();
                    return name.includes('INDEX');
                });
                
                if (indexedTariff) {
                    results.unshift(calculateGasTariff(indexedTariff, dias, kwh, totalCliente));
                }
            }
            
            // Mostrar resultados
            showGasResults(results, dias, kwh, totalCliente);
        }
        
        // FunciÃ³n: Cerrar modal
        function closeGasModal() {
            document.getElementById('gas-manual-input-modal').classList.add('hidden');
            document.getElementById('gas-manual-input-modal').classList.remove('flex');
        }
        
        // FunciÃ³n: Cargar datos del Google Sheets de GAS
        async function loadGasData() {
            console.log('ðŸ”„ Cargando datos de GAS desde Google Sheets...');
            const url = `https://docs.google.com/spreadsheets/d/${GAS_SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                
                if (!text || text.length < 10) {
                    throw new Error('El archivo CSV estÃ¡ vacÃ­o o no se pudo cargar');
                }
                
                console.log('ðŸ“¥ CSV recibido, primeras 200 caracteres:', text.substring(0, 200));
                
                gasTariffsData = parseGasCSV(text);
                
                if (gasTariffsData.length === 0) {
                    console.error('âŒ No se pudieron parsear datos del CSV');
                    alert('Error: No se encontraron datos en el Excel de GAS');
                } else {
                    console.log(`âœ… Cargadas ${gasTariffsData.length} tarifas de GAS`);
                }
            } catch (error) {
                console.error('âŒ Error al cargar datos de GAS:', error);
                gasTariffsData = [];
                alert('Error al cargar datos de GAS. Verifica la conexiÃ³n y permisos del Excel.');
            }
        }
        
        // FunciÃ³n: Parsear CSV de GAS
        function parseGasCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            // Limpiar y extraer headers (mantener nombres exactos)
            const headerLine = lines[0];
            const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            console.log('ðŸ“‹ Headers del Excel:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parsear CSV manejando comillas
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim().replace(/^"|"$/g, ''));
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim().replace(/^"|"$/g, ''));
                
                // Crear objeto manteniendo nombres exactos de headers
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Verificar que tenga datos vÃ¡lidos
                // Columnas crÃ­ticas: name, p1_price, Tarifa
                const hasName = row.name || row.Name;
                const hasPrice = row.p1_price || row.P1_price;
                const hasTarifa = row.Tarifa;
                
                if (hasName && hasPrice && hasTarifa) {
                    data.push(row);
                    
                    // Log de las primeras 3 filas para debug
                    if (data.length <= 3) {
                        console.log(`ðŸ“Š Fila ${data.length}:`, {
                            name: row.name || row.Name,
                            description: row.description || row.Description,
                            Tarifa: row.Tarifa,
                            p1_price: row.p1_price,
                            p_fijo_1: row.p_fijo_1
                        });
                    }
                }
            }
            
            console.log(`âœ… Parseadas ${data.length} tarifas de GAS`);
            
            // Mostrar las tarifas Ãºnicas encontradas
            const uniqueTariffs = [...new Set(data.map(d => d.Tarifa))].sort();
            console.log('ðŸ·ï¸ Tarifas Ãºnicas encontradas:', uniqueTariffs);
            
            return data;
        }
        
        /* FUNCIÃ“N ANTIGUA - YA NO SE USA
        // FunciÃ³n: Realizar cÃ¡lculos de GAS
        function calculateGas() {
            // ... cÃ³digo comentado ...
        }
        */
        
        // FunciÃ³n: Calcular una tarifa especÃ­fica de GAS
        function calculateGasTariff(tariff, dias, kwh, totalCliente) {
            // FunciÃ³n auxiliar para convertir string europeo a nÃºmero
            const parseEuropeanNumber = (value) => {
                if (!value) return 0;
                // Convertir coma a punto y luego parsear
                const cleanValue = String(value).replace(',', '.');
                return parseFloat(cleanValue) || 0;
            };
            
            // Extraer datos de la tarifa (usando nombres exactos del Excel)
            const p1_price = parseEuropeanNumber(tariff.p1_price || tariff.P1_price);
            const descuento_energia = parseEuropeanNumber(tariff.Descuento_Energia) / 100;
            const p_fijo_anual = parseEuropeanNumber(tariff.p_fijo_1 || tariff.P_fijo_1);
            const descuento_potencia = parseEuropeanNumber(tariff.Descuento_Potencia) / 100;
            
            console.log('ðŸ§® Calculando:', {
                name: tariff.name || tariff.Name,
                p1_price: p1_price + ' (original: ' + (tariff.p1_price || tariff.P1_price) + ')',
                descuento_energia: (descuento_energia * 100) + '%',
                p_fijo_anual: p_fijo_anual + ' (original: ' + (tariff.p_fijo_1 || tariff.P_fijo_1) + ')',
                descuento_potencia: (descuento_potencia * 100) + '%',
                dias: dias
            });
            
            // 1. TÃ‰RMINO FIJO
            const p_fijo_diario = p_fijo_anual / 365;
            const p_fijo_descuento = p_fijo_diario * descuento_potencia;
            const p_fijo_diario_final = p_fijo_diario - p_fijo_descuento;
            const total_fijo = p_fijo_diario_final * dias;
            
            console.log('ðŸ“Š TÃ©rmino fijo:', {
                'p_fijo_anual': p_fijo_anual.toFixed(6),
                'p_fijo_diario': p_fijo_diario.toFixed(6),
                'descuento_por_dia': p_fijo_descuento.toFixed(6),
                'p_fijo_diario_final': p_fijo_diario_final.toFixed(6),
                'dias': dias,
                'total_fijo': total_fijo.toFixed(2)
            });
            
            // 2. ENERGÃA
            const p1_descuento = p1_price * descuento_energia;
            const total_energia = kwh * (p1_price - p1_descuento);
            
            // 3. IMPUESTO DE HIDROCARBUROS
            const impuesto_hidrocarburo = 0.00234 * kwh;
            
            // 4. ALQUILER DE CONTADOR - QUITADO (ya no se incluye)
            // const alquiler_contador = 1.07;
            
            // 5. SUBTOTAL (antes de IVA) - SIN alquiler contador
            const subtotal = total_fijo + total_energia + impuesto_hidrocarburo;
            
            // 6. IVA
            const iva = 0.21 * subtotal;
            
            // 7. TOTAL FINAL
            const total = subtotal + iva;
            
            // 8. AHORRO
            const ahorro_periodo = totalCliente - total;
            const ahorro_mensual = dias !== 30 ? (ahorro_periodo * 30) / dias : ahorro_periodo;
            const ahorro_anual = ahorro_mensual * 12;
            
            console.log('ðŸ’° Resultado:', {
                total_fijo: total_fijo.toFixed(2) + 'â‚¬',
                total_energia: total_energia.toFixed(2) + 'â‚¬',
                subtotal: subtotal.toFixed(2) + 'â‚¬',
                iva: iva.toFixed(2) + 'â‚¬',
                total: total.toFixed(2) + 'â‚¬',
                ahorro_anual: ahorro_anual.toFixed(2) + 'â‚¬'
            });
            
            return {
                name: tariff.name || tariff.Name,
                descripcion: tariff.description || tariff.Description || tariff.name || tariff.Name,
                tarifa: tariff.Tarifa,
                // Desglose
                p_fijo_diario: p_fijo_diario,
                p_fijo_descuento: p_fijo_descuento,
                total_fijo: total_fijo,
                p1_price: p1_price,
                p1_descuento: p1_descuento,
                total_energia: total_energia,
                impuesto_hidrocarburo: impuesto_hidrocarburo,
                alquiler_contador: 0, // Quitado
                subtotal: subtotal,
                iva: iva,
                total: total,
                // Ahorro
                ahorro_periodo: ahorro_periodo,
                ahorro_mensual: ahorro_mensual,
                ahorro_anual: ahorro_anual
            };
        }
        
        // FunciÃ³n: Mostrar resultados de GAS
        function showGasResults(results, dias, kwh, totalCliente) {
            const container = document.getElementById('gas-results-container');
            
            // Ordenar por mejor ahorro
            results.sort((a, b) => b.ahorro_anual - a.ahorro_anual);
            
            let html = '';
            
            results.forEach((result, index) => {
                const isPositiveSaving = result.ahorro_anual > 0;
                const savingClass = isPositiveSaving ? 'text-green-600' : 'text-red-600';
                
                html += `
                <div class="mb-6 p-4 border-2 ${isPositiveSaving ? 'border-green-200 bg-green-50' : 'border-slate-200'} rounded-xl">
                    <h3 class="text-xl font-bold text-drk-900 mb-2">${result.name}</h3>
                    <p class="text-sm text-slate-600 mb-4">${result.descripcion}</p>
                    
                    <table class="w-full text-sm">
                        <tr class="border-b">
                            <td class="py-2">TÃ©rmino fijo (${dias} dÃ­as)</td>
                            <td class="text-right font-bold">${result.total_fijo.toFixed(2)} â‚¬</td>
                        </tr>
                        ${result.p_fijo_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">â†³ Descuento potencia</td>
                            <td class="text-right font-bold">-${(dias * result.p_fijo_descuento).toFixed(2)} â‚¬</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">EnergÃ­a (${kwh} kWh)</td>
                            <td class="text-right font-bold">${result.total_energia.toFixed(2)} â‚¬</td>
                        </tr>
                        ${result.p1_descuento > 0 ? `
                        <tr class="border-b text-green-600">
                            <td class="py-2 pl-4">â†³ Descuento energÃ­a</td>
                            <td class="text-right font-bold">-${(kwh * result.p1_descuento).toFixed(2)} â‚¬</td>
                        </tr>
                        ` : ''}
                        <tr class="border-b">
                            <td class="py-2">Impuesto hidrocarburos</td>
                            <td class="text-right">${result.impuesto_hidrocarburo.toFixed(2)} â‚¬</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-2">IVA (21%)</td>
                            <td class="text-right">${result.iva.toFixed(2)} â‚¬</td>
                        </tr>
                        <tr class="border-t-2 border-drk-500 font-bold text-lg">
                            <td class="py-2">TOTAL</td>
                            <td class="text-right">${result.total.toFixed(2)} â‚¬</td>
                        </tr>
                    </table>
                    
                    <div class="mt-4 p-3 bg-slate-100 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">Tu factura actual:</span>
                            <span class="font-bold">${totalCliente.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-bold">Con esta tarifa:</span>
                            <span class="font-bold">${result.total.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-lg ${savingClass}">
                            <span class="font-bold">Ahorro mensual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_mensual.toFixed(2)} â‚¬</span>
                        </div>
                        <div class="flex justify-between items-center mt-1 text-xl ${savingClass}">
                            <span class="font-bold">Ahorro anual:</span>
                            <span class="font-bold">${isPositiveSaving ? '+' : ''}${result.ahorro_anual.toFixed(2)} â‚¬</span>
                        </div>
                    </div>
                </div>
                `;
            });
            
            // GUARDAR DATOS PARA EXPORTAR (NUEVO)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked')?.value || 'drk_only';
            window.gasExportData = { results, dias, kwh, totalCliente, comparisonMode };
            
            // AGREGAR BOTONES DE EXPORTAR (NUEVO)
            html += `
                <div class="mt-8 p-6 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200">
                    <h3 class="text-xl font-bold text-drk-900 mb-4 text-center">ðŸ“¤ Exportar PresentaciÃ³n</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- BotÃ³n PDF -->
                        <button
                            onclick="generateGasPDF()"
                            class="flex items-center justify-center gap-3 px-6 py-4 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition shadow-lg"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span>Generar PDF</span>
                        </button>
                        
                        <!-- BotÃ³n HTML -->
                        <button
                            onclick="generateGasHTML()"
                            class="flex items-center justify-center gap-3 px-6 py-4 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition shadow-lg"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span>Generar HTML para Email</span>
                        </button>
                    </div>
                    
                    <p class="text-xs text-slate-500 text-center mt-4">
                        Genera documentos profesionales para presentar al cliente
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Mostrar pantalla de resultados
            hideAllScreens();
            document.getElementById('screen-gas-results').classList.add('active');
        }
        
        // ===== FUNCIONES DE BÃšSQUEDA (filtran DOM sin re-renderizar) =====
        
        function applyGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (!searchInput) return;
            
            const searchText = searchInput.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.gas-tariff-checkbox');
            let visibleCount = 0;
            let totalCount = checkboxes.length;
            
            checkboxes.forEach(checkbox => {
                const label = checkbox.closest('label');
                if (!label) return;
                
                const name = label.querySelector('.font-bold')?.textContent.toLowerCase() || '';
                const desc = label.querySelector('.text-sm.text-slate-600')?.textContent.toLowerCase() || '';
                
                if (searchText === '' || name.includes(searchText) || desc.includes(searchText)) {
                    label.style.display = '';
                    visibleCount++;
                } else {
                    label.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const countEl = document.getElementById('gas-search-count');
            if (countEl) {
                if (searchText === '') {
                    countEl.textContent = '';
                } else {
                    countEl.textContent = `Mostrando ${visibleCount} de ${totalCount} tarifas`;
                }
            }
        }
        
        function clearGasSearch() {
            const searchInput = document.getElementById('gas-search-input');
            if (searchInput) {
                searchInput.value = '';
                applyGasSearch();
            }
        }
        
        // ========== FUNCIONES DE EXPORTACIÃ“N PDF PARA GAS ==========
        
        async function generateGasPDF() {
            if (!window.gasExportData) {
                alert('No hay datos para exportar');
                return;
            }
            
            const { results, dias, kwh, totalCliente, comparisonMode } = window.gasExportData;
            
            try {
                // Detectar si es POWER CUP o DRK basado en comparisonMode
                const isPowerCup = comparisonMode === 'overall_best';
                
                const isDual = results.length === 2 && 
                              results.some(r => r.name.toUpperCase().includes('INDEX')) &&
                              results.some(r => !r.name.toUpperCase().includes('INDEX'));
                
                if (isDual) {
                    const resIndexed = results.find(r => r.name.toUpperCase().includes('INDEX'));
                    const resFijo = results.find(r => !r.name.toUpperCase().includes('INDEX'));
                    
                    if (isPowerCup) {
                        await generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente);
                    } else {
                        await generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente);
                    }
                } else {
                    if (isPowerCup) {
                        await generateGasPDF_Simple_PowerCup(results[0], dias, kwh, totalCliente);
                    } else {
                        await generateGasPDF_Simple(results[0], dias, kwh, totalCliente);
                    }
                }
            } catch (error) {
                console.error('Error generando PDF:', error);
                window.showMessageModal("âŒ Error: " + error.message, false);
            }
        }
        
        async function generateGasHTML() {
            if (!window.gasExportData) {
                window.showMessageModal("âš ï¸ No hay datos para exportar", false);
                return;
            }
            
            const { results, dias, kwh, totalCliente } = window.gasExportData;
            
            // Detectar si es modo comparativo (Fija vs Indexada)
            const isComparisonMode = document.getElementById('gas-compare-indexed-fixed') && 
                                     document.getElementById('gas-compare-indexed-fixed').checked;
            
            if (isComparisonMode && results.length === 2) {
                // Modo comparativo: mostrar ambas tarifas lado a lado
                generateGasHTMLComparison(results, dias, kwh, totalCliente);
            } else {
                // Modo individual: mostrar solo la mejor tarifa
                generateGasHTMLSingle(results[0], dias, kwh, totalCliente);
            }
        }
        
        // FunciÃ³n para generar HTML individual (una sola tarifa)
        function generateGasHTMLSingle(result, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores segÃºn marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            const tariffName = result.name;
            const ahorroAnual = result.ahorro_anual;
            const ahorroMensual = result.ahorro_mensual;
            
            // Calcular valores anuales y mensuales
            const facturaActualMes = totalCliente * 30 / dias;
            const facturaActualAnio = totalCliente * 365 / dias;
            const nuevoMes = result.total * 30 / dias;
            const nuevoAnio = result.total * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERGÃA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
                
                <!-- BANNER ESTUDIO DE AHORRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; color: white;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">ESTUDIO DE AHORRO - GAS</h2>
                            <p style="margin: 4px 0 0 0; font-size: 14px;">COMPARATIVA PROFESIONAL - ${brandName}</p>
                        </td>
                    </tr>
                </table>
                
                <!-- DATOS DEL CLIENTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: white; border: 1px solid #e0e0e0; margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px;">
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>CLIENTE:</strong> [NOMBRE COMPLETO CLIENTE]</p>
                            <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>CUPS:</strong> ES0021000020679723GY</p>
                            <p style="margin: 0; font-size: 14px;"><strong>COMERCIAL:</strong> zdvxzc</p>
                        </td>
                    </tr>
                </table>
                
                <!-- LA MEJOR OPCIÃ“N -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 30px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;">LA MEJOR OPCIÃ“N PARA TI ES</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${tariffName}</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- TU AHORRO ANUAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px; color: #666; font-weight: bold;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 12px; margin: 0 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <h1 style="margin: 0; font-size: 48px; font-weight: bold; color: white;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 18px; color: white; font-weight: bold;">Â¡CONSIGUE TU AHORRO ANUAL!</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA FACTURA ACTUAL VS NUEVO COSTE -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">TU FACTURA ACTUAL</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ AÃ‘O</p>
                        </td>
                        <td style="width: 4%;"></td>
                        <td style="width: 48%; padding: 20px; border: 2px solid #e0e0e0; text-align: center; vertical-align: top;">
                            <p style="margin: 0 0 15px 0; font-size: 14px; color: #888; font-weight: bold;">TU NUEVO COSTE ${brandName}</p>
                            <h2 style="margin: 0; font-size: 32px; font-weight: bold; color: ${primaryColor};">${eur(nuevoAnio)}</h2>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">/ AÃ‘O</p>
                            <p style="margin: 8px 0 0 0; font-size: 16px; color: ${primaryColor}; font-weight: bold;">${eur(nuevoMes)} / MES</p>
                        </td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE PRECIOS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">RESUMEN DE PRECIOS DE LA OFERTA ÃšNICA</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr style="background-color: #f5f5f5;">
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px;">CONCEPTO</td>
                        <td style="padding: 12px 40px; font-weight: bold; font-size: 14px; text-align: right;">PRECIO ${brandName}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">Precio fijo (â‚¬/dÃ­a)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p_fijo_diario / 365)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px;">EnergÃ­a (â‚¬/kWh)</td>
                        <td style="padding: 10px 40px; border-top: 1px solid #e0e0e0; font-size: 13px; text-align: right;">${num(result.p1_price)}</td>
                    </tr>
                    <tr style="background-color: #f0fdf4;">
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px;">AHORRO ANUAL</td>
                        <td style="padding: 12px 40px; border-top: 2px solid ${accentColor}; font-weight: bold; font-size: 14px; text-align: right; color: #16a34a;">${eur(ahorroAnual)}</td>
                    </tr>
                </table>
                
                <!-- DESGLOSE DETALLADO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 30px;">
                    <tr>
                        <td style="padding: 15px 40px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">DESGLOSE DETALLADO DE LA SIMULACIÃ“N (${tariffName})</h3>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 1px solid #e0e0e0; border-top: none;">
                    <tr>
                        <td style="padding: 15px 40px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Precio fijo (${dias} dÃ­as x ${num(result.p_fijo_diario / 365)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">SUBTOTAL POTENCIA</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px;" colspan="2">
                            <p style="margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: ${primaryColor};">TÃ‰RMINO ENERGÃA (Precio en â‚¬/kWh)</p>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">EnergÃ­a (${kwh} kWh x ${num(result.p1_price)})</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">Subtotal EnergÃ­a (Bruto)</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_energia)}</td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 15px 40px; padding-top: 20px; font-size: 15px; font-weight: bold; color: ${primaryColor};" colspan="2">SUBTOTAL BASE (P+E)</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">Imp. Hidrocarburos (â‚¬0,00234 x ${kwh} kWh)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                        <td style="padding: 10px 40px; font-size: 14px; font-weight: bold;">BASE IMPONIBLE</td>
                        <td style="padding: 10px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(result.total_fijo + result.total_energia + result.impuesto_hidrocarburo)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 40px; padding-left: 60px; font-size: 13px;">IVA (21%)</td>
                        <td style="padding: 8px 40px; font-size: 13px; text-align: right;">${eur(result.iva)}</td>
                    </tr>
                    <tr style="background-color: ${primaryColor}; color: white;">
                        <td style="padding: 15px 40px; font-size: 16px; font-weight: bold;">TOTAL FACTURA (${dias} DÃAS)</td>
                        <td style="padding: 15px 40px; font-size: 16px; text-align: right; font-weight: bold;">${eur(result.total)}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <td style="padding: 12px 40px; font-size: 14px; font-weight: bold;">TOTAL AÃ‘O (PROYECTADO)</td>
                        <td style="padding: 12px 40px; font-size: 14px; text-align: right; font-weight: bold;">${eur(nuevoAnio)}</td>
                    </tr>
                </table>
                
                <!-- RESUMEN DE AHORRO FINAL -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #333;">RESUMEN DE AHORRO FINAL</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${lightBg}; border: 2px solid ${accentColor}; border-radius: 12px; margin: 0 40px 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 16px; color: #666;">TU AHORRO ANUAL ESTIMADO ES:</p>
                            <h1 style="margin: 0; font-size: 42px; font-weight: bold; color: #16a34a;">${eur(ahorroAnual)}</h1>
                            <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">/ AÃ‘O</p>
                        </td>
                    </tr>
                </table>
                
                <!-- PARA CONFIRMAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${primaryColor}; border-radius: 12px; margin: 30px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">ðŸ“§ Para confirmar esta oferta:</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 1.8; color: #333;">
                                <li>Haz clic en el botÃ³n de abajo</li>
                                <li>Se abrirÃ¡ tu cliente de email</li>
                                <li><strong style="color: ${primaryColor};">Adjunta la documentaciÃ³n requerida</strong></li>
                                <li>EnvÃ­a el email</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=ConfirmaciÃ³n Oferta GAS - ${tariffName}&body=Adjunto documentaciÃ³n requerida para confirmar la oferta." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            âœ“ CONFIRMAR Y ENVIAR
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 20px 0 0 0; font-size: 12px; color: #888;">ðŸ“Ž <strong>DocumentaciÃ³n necesaria:</strong><br>DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN</p>
                        </td>
                    </tr>
                </table>
                
                <!-- FOOTER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 30px; padding: 20px 40px; background-color: #f5f5f5;">
                    <tr>
                        <td style="text-align: center; font-size: 12px; color: #888;">
                            <p style="margin: 0;">[Colaborador: zdvxzc] | Este resumen es una simulaciÃ³n basada en su Ãºltima factura.</p>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // FunciÃ³n para generar HTML comparativo (Fija vs Indexada)
        function generateGasHTMLComparison(results, dias, kwh, totalCliente) {
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=6) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // Determinar marca (DRK o POWER CUP)
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            // Colores segÃºn marca
            const primaryColor = isDrk ? '#3b5875' : '#4d7c0f';
            const accentColor = isDrk ? '#4a90e2' : '#84cc16';
            const lightBg = isDrk ? '#e8f4fd' : '#f0fdf4';
            const brandName = isDrk ? 'DRK' : 'POWER CUP';
            
            // Identificar cuÃ¡l es fija y cuÃ¡l indexada
            const resFijo = results.find(r => r.name.includes('FIJO') || r.name.includes('META')) || results[0];
            const resIndexed = results.find(r => r.name.includes('INDEX')) || results[1];
            
            // Calcular valores anuales
            const facturaActualAnio = totalCliente * 365 / dias;
            
            const htmlContent = `
            <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; background: white;">
                
                <!-- HEADER -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white;">
                    <tr>
                        <td style="padding: 30px 40px;">
                            <h1 style="margin: 0; font-size: 32px; font-weight: bold;">${brandName} ENERGÃA</h1>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">Liderando el ahorro y la eficiencia energÃ©tica.</p>
                        </td>
                        <td style="padding: 30px 40px; text-align: right;">
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 4px 0 0 0; font-size: 16px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 1: LA MEJOR OPCIÃ“N Y COMPARATIVA 3 COLUMNAS -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 20px;">
                    <tr>
                        <td style="padding: 25px 40px; text-align: center;">
                            <p style="margin: 0 0 10px 0; font-size: 16px;">LA MEJOR OPCIÃ“N PARA TI ES</p>
                            <h2 style="margin: 0; font-size: 36px; font-weight: bold;">${brandName}</h2>
                            <p style="margin: 10px 0 0 0; font-size: 14px;">Ofrece el mayor ahorro consolidado con ${brandName}.</p>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA 3 COLUMNAS: FACTURA ACTUAL vs FIJO vs INDEXADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 30px;">
                    <tr>
                        <!-- COLUMNA 1: FACTURA ACTUAL -->
                        <td style="width: 30%; vertical-align: top; text-align: center;">
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #888; font-weight: bold;">TU FACTURA ACTUAL</p>
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626; text-decoration: line-through;">0,00 â‚¬</h2>
                            <p style="margin: 8px 0; font-size: 11px; color: #888;">Total Periodo</p>
                            <h2 style="margin: 0; font-size: 22px; font-weight: bold; color: #dc2626; text-decoration: line-through;">${eur(facturaActualAnio)}/aÃ±o</h2>
                        </td>
                        
                        <!-- COLUMNA 2: AHORRO FIJO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${accentColor}; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">TU AHORRO ANUAL FIJO</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resFijo.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">TU NUEVO COSTE ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 30 / dias)}/mes</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;">Estimado Mensual</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: ${primaryColor};">${eur(resFijo.total * 365 / dias)}/aÃ±o</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        
                        <!-- COLUMNA 3: AHORRO INDEXADO -->
                        <td style="width: 35%; vertical-align: top;">
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #16a34a; border-radius: 8px;">
                                <tr>
                                    <td style="padding: 10px; text-align: center; color: white;">
                                        <p style="margin: 0; font-size: 11px; font-weight: bold;">TU AHORRO ANUAL INDEXADO</p>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #16a34a;">${eur(resIndexed.ahorro_anual)}</h2>
                                    </td>
                                </tr>
                            </table>
                            <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px;">
                                <tr>
                                    <td style="text-align: center;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px; color: #666;">TU NUEVO COSTE ${brandName}</p>
                                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 30 / dias)}/mes</p>
                                        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;">Estimado Mensual</p>
                                        <p style="margin: 5px 0 0 0; font-size: 16px; font-weight: bold; color: #16a34a;">${eur(resIndexed.total * 365 / dias)}/aÃ±o</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 2: DESGLOSE DETALLADO POR SUMINISTRO -->
                <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 40px;">
                    <tr>
                        <td style="padding: 15px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: bold;">DESGLOSE DETALLADO POR SUMINISTRO</h2>
                        </td>
                    </tr>
                </table>
                
                <!-- COMPARATIVA LADO A LADO -->
                <table width="100%" cellpadding="20" cellspacing="0" style="margin-top: 20px;">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | DÃ­as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${brandName} - ${brandName}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resFijo.p_fijo_diario / 365)} â‚¬/kW/dÃ­a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERGÃA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resFijo.p1_price)} â‚¬/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} dÃ­as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERGÃA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">EnergÃ­a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resFijo.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} DÃAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resFijo.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Fija -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resFijo.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                        
                        <!-- COLUMNA DERECHA: INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            
                            <!-- Header Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; border-radius: 8px; margin-bottom: 15px;">
                                <tr>
                                    <td style="padding: 15px;">
                                        <p style="margin: 0 0 5px 0; font-size: 11px;">[ES0021000020679723GY]</p>
                                        <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">Tipo: 2.0TD | DÃ­as: ${dias}</p>
                                        <p style="margin: 0; font-size: 12px; font-weight: bold;">${brandName} INDEX - ${brandName} INDEX</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Precios Aplicados Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">PRECIOS APLICADOS:</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; padding: 10px; border: 1px solid #e0e0e0;">
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px;">POTENCIA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">P1: ${num(resIndexed.p_fijo_diario / 365)} â‚¬/kW/dÃ­a</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 11px; font-weight: bold; padding: 5px; padding-top: 10px;">ENERGÃA:</td>
                                </tr>
                                <tr>
                                    <td style="font-size: 10px; padding: 2px 5px;">E1: ${num(resIndexed.p1_price)} â‚¬/kWh</td>
                                </tr>
                            </table>
                            
                            <!-- Desglose Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">POTENCIA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">Precio fijo (${dias} dÃ­as)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_fijo)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #6c7a89; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 10px; font-size: 12px; font-weight: bold;">ENERGÃA</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f8fafc; border: 1px solid #e0e0e0; border-top: none;">
                                <tr>
                                    <td style="padding: 8px; font-size: 11px;">EnergÃ­a (${kwh} kWh)</td>
                                    <td style="padding: 8px; font-size: 11px; text-align: right; font-weight: bold;">${eur(resIndexed.total_energia)}</td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: ${primaryColor}; color: white; margin-top: 10px;">
                                <tr>
                                    <td style="padding: 12px; font-size: 13px; font-weight: bold;">TOTAL (${dias} DÃAS)</td>
                                    <td style="padding: 12px; font-size: 13px; text-align: right; font-weight: bold;">${eur(resIndexed.total)}</td>
                                </tr>
                            </table>
                            
                            <!-- Ahorro Anual Indexada -->
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #dc2626; border-radius: 8px; margin-top: 15px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center; color: white;">
                                        <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: bold;">AHORRO:</p>
                                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${eur(resIndexed.ahorro_anual)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 3: CUAL ES LA DIFERENCIA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 40px;">
                    <tr>
                        <td style="padding: 20px 40px; text-align: center;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">CUAL ES LA DIFERENCIA?</h2>
                        </td>
                    </tr>
                </table>
                
                <table width="100%" cellpadding="20" cellspacing="0">
                    <tr>
                        <!-- COLUMNA IZQUIERDA: POR QUE TARIFA FIJA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${accentColor};">POR QUE TARIFA FIJA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio fijo por los kilovatios que consumes (kWh).</li>
                                <li>El precio se mantiene estable, independientemente de cÃ³mo se comporten los precios en el mercado elÃ©ctrico.</li>
                                <li>Cuando el precio del mercado estÃ¡ alto, el cliente estÃ¡ protegido frente a sobresaltos.</li>
                                <li>No tendrÃ¡s que estar pendiente de las variaciones del mercado y podrÃ¡s seguir usando la electricidad como siempre.</li>
                            </ul>
                        </td>
                        
                        <!-- COLUMNA DERECHA: POR QUE TARIFA INDEXADA -->
                        <td style="width: 48%; vertical-align: top;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: #16a34a;">POR QUE TARIFA INDEXADA?</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #333;">
                                <li>Implica un precio variable por los kilovatios que consumes (kWh) cada mes.</li>
                                <li>Es la tarifa mÃ¡s justa, ya que pagas el coste real de la energÃ­a mes a mes.</li>
                                <li>Al contratarla, el cliente evita pagar mÃ¡rgenes adicionales cuando el precio de la electricidad es mÃ¡s barato.</li>
                                <li>A largo plazo, con un indexado 100% funcional, se puede obtener un ahorro aproximado de hasta un 20% en Ã©pocas de mejor precio.</li>
                            </ul>
                        </td>
                    </tr>
                </table>
                
                <!-- SECCIÃ“N 4: PARA FORMALIZAR ESTA OFERTA -->
                <table width="100%" cellpadding="0" cellspacing="0" style="border: 3px solid ${accentColor}; border-radius: 12px; margin: 30px 40px 40px 40px; width: calc(100% - 80px);">
                    <tr>
                        <td style="padding: 30px; text-align: center;">
                            <p style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: ${primaryColor};">ðŸ“Š Para formalizar esta oferta:</p>
                            <ol style="text-align: left; display: inline-block; font-size: 14px; line-height: 2; color: #333; margin: 0 0 20px 0;">
                                <li>Haz clic en el botÃ³n de abajo</li>
                                <li>Se abrirÃ¡ tu cliente de email</li>
                                <li><strong style="color: ${primaryColor};">Adjunta documentaciÃ³n del CUPS</strong></li>
                                <li>EnvÃ­a el email</li>
                            </ol>
                            
                            <table cellpadding="0" cellspacing="0" style="margin: 20px auto;">
                                <tr>
                                    <td style="background-color: #dc2626; border-radius: 8px; text-align: center;">
                                        <a href="mailto:contratacion@example.com?subject=ConfirmaciÃ³n Oferta GAS Comparativa&body=Adjunto documentaciÃ³n requerida." style="display: inline-block; padding: 15px 40px; color: white; text-decoration: none; font-weight: bold; font-size: 16px;">
                                            âœ“ CONFIRMAR OFERTA CONSOLIDADA
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; border-radius: 8px; margin-top: 20px;">
                                <tr>
                                    <td style="padding: 15px; text-align: center;">
                                        <p style="margin: 0; font-size: 11px; color: #888;">ðŸ“Ž Por cada CUPS adjuntar:</p>
                                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #333;">DNI/CIF Â· Ãšltima factura Â· Email Â· TelÃ©fono Â· IBAN</p>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                
            </div>
            `;
            
            showHTMLPreview(htmlContent);
        }
        
        // FunciÃ³n para mostrar el preview HTML y permitir copiar
        function showHTMLPreview(htmlContent) {
            // Crear modal si no existe
            let modal = document.getElementById('html-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'html-preview-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; overflow: auto; padding: 20px;';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto; position: relative;">
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0; color: #0c4a6e;">ðŸ“§ HTML para Email - GAS</h2>
                            <button onclick="closeHTMLPreview()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">âœ• Cerrar</button>
                        </div>
                        <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; line-height: 1.6;">
                            <strong>ðŸ“‹ Instrucciones:</strong><br>
                            <span style="color: #16a34a; font-weight: bold;">OPCIÃ“N 1:</span> Haz clic en "Copiar HTML" (automÃ¡tico)<br>
                            <span style="color: #f59e0b; font-weight: bold;">OPCIÃ“N 2:</span> Si no funciona, usa "Seleccionar Todo" y luego Ctrl+C
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="copyHTMLToClipboard()" style="background: #0ea5e9; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                ðŸ“‹ Copiar HTML
                            </button>
                            <button onclick="selectAllContent()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                                âœ¨ Seleccionar Todo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview del HTML -->
                    <div id="html-preview-content" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        ${htmlContent}
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Guardar el HTML content para copiar
            window.currentHTMLContent = htmlContent;
        }
        
        // FunciÃ³n para seleccionar todo el contenido
        window.selectAllContent = function() {
            const contentDiv = document.getElementById('html-preview-content');
            if (!contentDiv) return;
            
            const range = document.createRange();
            range.selectNodeContents(contentDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Cambiar el botÃ³n para indicar que ya estÃ¡ seleccionado
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ… Â¡Seleccionado! Ahora Ctrl+C';
            btn.style.background = '#16a34a';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#f59e0b';
            }, 3000);
            
            // Mostrar alerta con instrucciones
            setTimeout(() => {
                alert('âœ… Contenido seleccionado\n\nðŸ“‹ Ahora presiona:\nâ€¢ Ctrl+C (Windows/Linux)\nâ€¢ Cmd+C (Mac)\n\nLuego pega en tu correo con Ctrl+V');
            }, 100);
        };
        
        // FunciÃ³n para cerrar el preview
        window.closeHTMLPreview = function() {
            const modal = document.getElementById('html-preview-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        // FunciÃ³n para copiar HTML al portapapeles
        window.copyHTMLToClipboard = async function() {
            try {
                const htmlContent = window.currentHTMLContent;
                
                // MÃ‰TODO 1: Intentar con ClipboardItem (navegadores modernos)
                try {
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob
                    });
                    await navigator.clipboard.write([clipboardItem]);
                    
                    // Mostrar mensaje de Ã©xito
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… Â¡Copiado! Pega en tu email';
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                    
                    return;
                } catch (clipboardError) {
                    console.log('ClipboardItem fallÃ³, intentando mÃ©todo alternativo...');
                }
                
                // MÃ‰TODO 2: Usar execCommand (mÃ¡s compatible)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                tempDiv.style.position = 'fixed';
                tempDiv.style.left = '-9999px';
                tempDiv.contentEditable = true;
                document.body.appendChild(tempDiv);
                
                // Seleccionar el contenido
                const range = document.createRange();
                range.selectNodeContents(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Copiar
                const success = document.execCommand('copy');
                
                // Limpiar
                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
                
                if (success) {
                    // Mostrar mensaje de Ã©xito
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… Â¡Copiado! Pega en tu email';
                    btn.style.background = '#16a34a';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#0ea5e9';
                    }, 3000);
                } else {
                    throw new Error('execCommand fallÃ³');
                }
                
            } catch (err) {
                console.error('Error al copiar:', err);
                
                // Mostrar instrucciones al usuario
                alert('No se pudo copiar automÃ¡ticamente.\n\nâœ… SOLUCIÃ“N:\n\n1. Haz clic derecho sobre el contenido abajo\n2. Selecciona "Copiar"\n3. Pega en tu correo electrÃ³nico\n\nO usa Ctrl+A para seleccionar todo y luego Ctrl+C para copiar.');
            }
        };

        
        // PDF INDIVIDUAL
        async function generateGasPDF_Simple(bestResult, dias, kwh, totalCliente) {
            window.showMessageModal("â³ Generando PDF... Por favor espere.");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const comparisonMode = document.querySelector('input[name="comparison_mode"]:checked').value;
            const isDrk = (comparisonMode === 'drk_only' || comparisonMode === 'drk_prioritized');
            
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            
            const pageWidth = 210;
            const margin = 12;
            let yPos = 0;
            
            // === PÃGINA 1: RESUMEN ===
            
            // CABECERA con degradado gris azulado
            const headerHeight = 55;
            for (let i = 0; i < pageWidth; i++) {
                const ratio = i / pageWidth;
                const r = Math.round(107 + (180 - 107) * ratio);
                const g = Math.round(125 + (190 - 125) * ratio);
                const b = Math.round(142 + (200 - 142) * ratio);
                doc.setFillColor(r, g, b);
                doc.rect(i, 0, 1, headerHeight, 'F');
            }
            
            // Logo DRK (anillo multicolor)
            const logoX = margin + 15;
            const logoY = 18;
            const logoRadius = 8;
            
            doc.setFillColor(219, 68, 55);
            doc.circle(logoX - 1.5, logoY + 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(66, 133, 244);
            doc.circle(logoX + 1.5, logoY - 1.5, logoRadius * 0.8, 'F');
            doc.setFillColor(244, 180, 0);
            doc.circle(logoX - 1.5, logoY - 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(15, 157, 88);
            doc.circle(logoX + 1.5, logoY + 1.5, logoRadius * 0.7, 'F');
            doc.setFillColor(255, 255, 255);
            doc.circle(logoX, logoY, logoRadius * 0.4, 'F');
            
            // Texto DRK ENERGÃA
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('DRK', logoX + logoRadius + 6, logoY - 4);
            doc.text('ENERGÃA', logoX + logoRadius + 6, logoY + 5);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Liderando el ahorro y la', logoX + logoRadius + 6, logoY + 13);
            doc.text('eficiencia energÃ©tica.', logoX + logoRadius + 6, logoY + 18);
            
            // Texto derecha
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(100, 120, 140);
            doc.text('ESTUDIO DE AHORRO', pageWidth - margin, 15, { align: 'right' });
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text('COMPARATIVA', pageWidth - margin, 25, { align: 'right' });
            doc.setFontSize(12);
            doc.setTextColor(100, 120, 140);
            doc.text('PROFESIONAL', pageWidth - margin, 35, { align: 'right' });
            
            yPos = headerHeight + 8;
            
            // CAJA VERDE "ESTUDIO DE AHORRO"
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ESTUDIO DE AHORRO', margin + 5, yPos + 7);
            
            yPos += 12;
            
            // Info del cliente (caja con borde)
            doc.setDrawColor(76, 175, 80);
            doc.setLineWidth(1.5);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 22, 2, 2, 'S');
            
            doc.setTextColor(75, 85, 99);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('COMPARATIVA PROFESIONAL GAS - DRK', margin + 5, yPos + 7);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('CLIENTE: [NOMBRE COMPLETO CLIENTE]', margin + 5, yPos + 13);
            doc.text('TARIFA: ' + currentGasTariff, margin + 5, yPos + 18);
            
            doc.setFont('helvetica', 'bold');
            doc.text('COMERCIAL: zdc', pageWidth - margin - 45, yPos + 13);
            
            yPos += 28;
            
            // CAJA GRIS "LA MEJOR OPCIÃ“N"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 3, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text(bestResult.name.toUpperCase(), pageWidth / 2, yPos + 20, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(bestResult.descripcion, pageWidth / 2, yPos + 28, { align: 'center' });
            
            yPos += 42;
            
            // AHORRO ANUAL
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('TU AHORRO ANUAL ESTIMADO', pageWidth / 2, yPos + 8, { align: 'center' });
            
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(36);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, yPos + 25, { align: 'center' });
            
            yPos += 40;
            
            // COMPARATIVA ACTUAL VS NUEVA
            const colWidth = (pageWidth - (2 * margin) - 10) / 2;
            
            // Izquierda: Factura actual
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('TU FACTURA ACTUAL', margin + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(220, 38, 38);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const facturaActualMes = totalCliente * 30 / dias;
            doc.text(eur(facturaActualMes) + '/mes', margin + colWidth / 2, yPos + 10, { align: 'center' });
            
            // LÃ­nea tachada
            const textWidth = doc.getTextWidth(eur(facturaActualMes) + '/mes');
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.2);
            doc.line(
                margin + (colWidth - textWidth) / 2,
                yPos + 7,
                margin + (colWidth + textWidth) / 2,
                yPos + 7
            );
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Total Periodo (' + dias + ' dÃ­as)', margin + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const facturaActualAnio = totalCliente * 365 / dias;
            doc.text(eur(facturaActualAnio) + '/aÃ±o', margin + colWidth / 2, yPos + 24, { align: 'center' });
            
            const textWidth2 = doc.getTextWidth(eur(facturaActualAnio) + '/aÃ±o');
            doc.line(
                margin + (colWidth - textWidth2) / 2,
                yPos + 21,
                margin + (colWidth + textWidth2) / 2,
                yPos + 21
            );
            
            // Derecha: Nuevo coste
            doc.setTextColor(100, 120, 140);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('TU NUEVO COSTE DRK', margin + colWidth + 10 + colWidth / 2, yPos, { align: 'center' });
            
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const nuevaCosteMes = bestResult.total * 30 / dias;
            doc.text(eur(nuevaCosteMes) + '/mes', margin + colWidth + 10 + colWidth / 2, yPos + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Estimado Mensual', margin + colWidth + 10 + colWidth / 2, yPos + 16, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            const nuevaCosteAnio = bestResult.total * 365 / dias;
            doc.text(eur(nuevaCosteAnio) + '/aÃ±o', margin + colWidth + 10 + colWidth / 2, yPos + 24, { align: 'center' });
            
            yPos += 32;
            
            // PRECIOS DE LA OFERTA
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('PRECIOS DE LA OFERTA: DRK - ' + bestResult.descripcion.toUpperCase(), margin + 5, yPos + 7);
            
            yPos += 13;
            
            // TABLA PRECIOS
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 35, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO:', margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio fijo diario (â‚¬/dÃ­a):', margin + 10, yPos + 15);
            doc.text(num(bestResult.p_fijo_diario / 365, 6), pageWidth - margin - 5, yPos + 15, { align: 'right' });
            
            yPos += 20;
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('ENERGÃA:', margin + 5, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Precio energÃ­a (â‚¬/kWh):', margin + 10, yPos + 7);
            doc.text(num(bestResult.p1_price, 6), pageWidth - margin - 5, yPos + 7, { align: 'right' });
            
            // === PÃGINA 2: DESGLOSE ===
            doc.addPage();
            yPos = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO DE LA SIMULACIÃ“N (DRK - ' + bestResult.descripcion.toUpperCase() + ')', margin + 5, yPos + 8);
            
            yPos += 18;
            
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            const p_fijo_diario = bestResult.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(p_fijo_diario, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', margin + 5, yPos);
            doc.text(eur(bestResult.total_fijo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', margin, yPos);
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', margin + 5, yPos);
            doc.text(eur(bestResult.total_energia), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', margin, yPos);
            doc.text(eur(subtotalBase), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', margin, yPos);
            doc.text(eur(bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', margin, yPos);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', margin, yPos);
            doc.text(eur(bestResult.iva), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 10;
            
            // TOTAL FACTURA
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos - 3, pageWidth - (2 * margin), 12, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', margin + 5, yPos + 5);
            doc.text(eur(bestResult.total), pageWidth - margin - 5, yPos + 5, { align: 'right' });
            
            yPos += 14;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', margin, yPos);
            doc.text(eur(bestResult.total * 365 / dias), pageWidth - margin - 5, yPos, { align: 'right' });
            
            yPos += 15;
            
            // AHORRO
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 25, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', margin + 5, yPos + 10);
            
            doc.setFontSize(20);
            doc.text(eur(bestResult.ahorro_anual) + '/ AÃ‘O', margin + 5, yPos + 20);
            
            yPos += 35;
            
            // FORMALIZAR CONTRATO
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(margin, yPos, pageWidth - (2 * margin), 60, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('PARA FORMALIZAR ESTE CONTRATO:', margin + 5, yPos + 8);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('Responde a este email adjuntando la siguiente documentaciÃ³n:', margin + 5, yPos + 15);
            
            const docList = [
                '1. Foto del DNI/CIF (anverso y reverso)',
                '2. Ãšltima factura (mÃ­nimo 3 meses de antigÃ¼edad)',
                '3. Email de contacto para validaciÃ³n',
                '4. TelÃ©fono de contacto',
                '5. NÃºmero de cuenta bancaria (IBAN)'
            ];
            
            let listY = yPos + 22;
            docList.forEach(item => {
                doc.text(item, margin + 8, listY);
                listY += 5;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('EnvÃ­a la documentaciÃ³n al comercial:', margin + 5, listY + 5);
            doc.setFontSize(11);
            doc.text('zdc', margin + 5, listY + 11);
            
            // Pie de pÃ¡gina
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.text('Documento generado automÃ¡ticamente - DRK EnergÃ­a', pageWidth / 2, 285, { align: 'center' });
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), pageWidth / 2, 290, { align: 'center' });
            
            // Descargar
            doc.save('Comparativa_GAS_' + currentGasTariff + '_DRK_' + new Date().toISOString().slice(0,10) + '.pdf');
            
            window.showMessageModal("âœ… PDF generado correctamente", false);
        }
        
        // PDF DUAL
        async function generateGasPDF_Dual(resFijo, resIndexed, dias, kwh, totalCliente) {
            window.showMessageModal("â³ Generando PDF comparativo...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            // PÃGINA 1: DISEÃ‘O PROFESIONAL BONITO
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER CON RAYAS VERTICALES (fondo gris con patrÃ³n)
            doc.setFillColor(107, 125, 142);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Rayas verticales mÃ¡s claras
            doc.setDrawColor(120, 140, 155);
            doc.setLineWidth(0.3);
            for (let i = 0; i < pageWidth; i += 2) {
                doc.line(i, 0, i, 40);
            }
            
            // Logo DRK multicolor (izquierda)
            const logoX = 25;
            const logoY = 20;
            const logoR = 8;
            doc.setFillColor(219, 68, 55); // Rojo
            doc.circle(logoX - 2, logoY + 2, logoR * 0.75, 'F');
            doc.setFillColor(66, 133, 244); // Azul
            doc.circle(logoX + 2, logoY - 2, logoR * 0.75, 'F');
            doc.setFillColor(244, 180, 0); // Amarillo
            doc.circle(logoX - 2, logoY - 2, logoR * 0.65, 'F');
            doc.setFillColor(15, 157, 88); // Verde
            doc.circle(logoX + 2, logoY + 2, logoR * 0.65, 'F');
            doc.setFillColor(255, 255, 255); // Centro blanco
            doc.circle(logoX, logoY, logoR * 0.35, 'F');
            
            // Texto DRK (izquierda del logo)
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.text('DRK', logoX + 15, 18);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('Liderando el ahorro y la', logoX + 15, 24);
            doc.text('eficiencia energÃ©tica.', logoX + 15, 28);
            
            // Texto derecha del header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('ESTUDIO DE AHORRO', pageWidth - 12, 12, { align: 'right' });
            
            doc.setTextColor(200, 210, 220);
            doc.setFontSize(10);
            doc.text('COMPARATIVA', pageWidth - 12, 20, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('PROFESIONAL', pageWidth - 12, 28, { align: 'right' });
            
            // TÃTULO Y INFO CLIENTE
            y = 52;
            doc.setTextColor(40, 50, 60);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('COMPARATIVA PROFESIONAL - DRK', 12, y);
            
            y += 9;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 110, 120);
            doc.text('CLIENTE: [NOMBRE COMPLETO CLIENTE]', 12, y);
            y += 5;
            doc.text('CUPS TOTALES: 1', 12, y);
            
            y += 15;
            
            // CAJA GRIS "LA MEJOR OPCIÃ“N"
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(40, y, 130, 38, 4, 4, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, y + 10, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(28);
            doc.text('DRK', pageWidth / 2, y + 24, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Ofrece el mayor ahorro consolidado con DRK ENERGÃA.', pageWidth / 2, y + 33, { align: 'center' });
            
            y += 55;
            
            // CÃLCULOS
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            // LAYOUT 3 COLUMNAS CON SEPARADORES VERTICALES
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // LÃ­neas separadoras verticales (muy suaves)
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 90);
            doc.line(140, y - 5, 140, y + 90);
            
            // COLUMNA 1: TU FACTURA ACTUAL (izquierda)
            doc.setTextColor(70, 80, 90);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TU FACTURA ACTUAL', col1X, y);
            
            y += 10;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            
            // LÃ­nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 5, col1X + wMes, y - 5);
            
            y += 6;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text('Total Periodo (' + dias + ' dÃ­as)', col1X, y);
            
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + '/aÃ±o';
            doc.text(txtAnio, col1X, y);
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.8);
            doc.line(col1X, y - 4, col1X + wAnio, y - 4);
            
            y -= 26;
            
            // COLUMNA 2: TU AHORRO ANUAL FIJO (centro)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col2X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('TU NUEVO COSTE DRK', col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(59, 130, 246);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(fijoMes) + '/mes', col2X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text('Estimado Mensual', col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(59, 130, 246);
            doc.text(eur(fijoAnio) + '/aÃ±o', col2X + 30, y, { align: 'center' });
            
            y -= 44;
            
            // COLUMNA 3: TU AHORRO ANUAL INDEXADO (derecha)
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(col3X, y - 4, 60, 9, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7.5);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 12;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(22);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 10;
            doc.setTextColor(100, 110, 120);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('TU NUEVO COSTE DRK', col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.text(eur(indexMes) + '/mes', col3X + 30, y, { align: 'center' });
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(120, 130, 140);
            doc.text('Estimado Mensual', col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + '/aÃ±o', col3X + 30, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + '/ AÃ‘O', leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('DRK INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(107, 125, 142);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + '/ AÃ‘O', rightX + 3, rightY + 15);
            
            // PÃGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA FIJA?', leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                'â€¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                'â€¢ El precio se mantiene estable,',
                '  independientemente de cÃ³mo se comporten los',
                '  precios en el mercado elÃ©ctrico.',
                '',
                'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                '  cliente estÃ¡ protegido frente a sobresaltos.',
                '',
                'â€¢ No tendrÃ¡s que estar pendiente de las',
                '  variaciones del mercado y podrÃ¡s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(line, leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA INDEXADA?', rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                'â€¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                '  real de la energÃ­a mes a mes.',
                '',
                'â€¢ Al contratarla, el cliente evita pagar',
                '  mÃ¡rgenes adicionales cuando el precio de la',
                '  electricidad es mÃ¡s barato.',
                '',
                'â€¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en Ã©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(line, rightX, y);
                y += 4;
            });
            
            doc.save('GAS_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("âœ… PDF generado", false);
        }
        
        // ============================================
        // FUNCIONES PDF PARA POWER CUP
        // ============================================
        
        // PDF INDIVIDUAL POWER CUP
        async function generateGasPDF_Simple_PowerCup(bestResult, dias, kwh, totalCliente) {
            window.showMessageModal("â³ Generando PDF POWER CUP...");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            const pageHeight = 297;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (estÃ©tica mejorada)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAFÃ‰ PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (cafÃ©) - color mÃ¡s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (lÃ­neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (lÃ­neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERGÃA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERGÃA', logoX + 30, 32);
            
            // SubtÃ­tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text('Liderando el ahorro y la', logoX + 30, 40);
            doc.text('eficiencia energÃ©tica.', logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ESTUDIO DE AHORRO', pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(215, 230, 215);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 12, 4, 4, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ESTUDIO DE AHORRO', 105, y + 8, { align: 'center' });
            
            // Recuadro con borde verde oliva para info del cliente
            y += 18;
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(2);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'D');
            
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
            
            y += 8;
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 110, 100);
            doc.text('CLIENTE: [NOMBRE COMPLETO CLIENTE]', 25, y);
            
            y += 5;
            doc.text('CUPS: ES0021000020679723GY', 25, y);
            
            // Texto "COMERCIAL: <cz" en la esquina derecha
            doc.setTextColor(130, 140, 130);
            doc.setFontSize(8);
            doc.text('COMERCIAL: <cz', 185, y, { align: 'right' });
            
            y += 15;
            
            // Caja verde oliva "LA MEJOR OPCIÃ“N" (mÃ¡s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            const tariffName = bestResult.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            // Caja blanca con borde gris suave para ahorro y comparaciÃ³n
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1.5);
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 95, 5, 5, 'FD');
            
            y += 15;
            doc.setTextColor(120, 130, 120);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TU AHORRO ANUAL ESTIMADO', pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(34);
            doc.text(eur(bestResult.ahorro_anual), pageWidth / 2, y, { align: 'center' });
            
            y += 18;
            
            // Separador vertical
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(1);
            doc.line(pageWidth / 2, y - 30, pageWidth / 2, y + 35);
            
            // Columna izquierda: Factura actual
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TU FACTURA ACTUAL', 57, y, { align: 'center' });
            
            y += 10;
            const factMes = totalCliente * 30 / dias;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(18);
            const txtMes = eur(factMes);
            doc.text(txtMes, 57, y, { align: 'center' });
            
            // LÃ­nea tachada
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(2);
            doc.line(57 - wMes/2, y - 5, 57 + wMes/2, y - 5);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text('Total Periodo (' + dias + ' dÃ­as)', 57, y, { align: 'center' });
            
            y += 11;
            const factAnio = totalCliente * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + '/aÃ±o';
            doc.text(txtAnio, 57, y, { align: 'center' });
            
            const wAnio = doc.getTextWidth(txtAnio);
            doc.setLineWidth(2);
            doc.line(57 - wAnio/2, y - 4, 57 + wAnio/2, y - 4);
            
            y -= 28;
            
            // Columna derecha: Nuevo coste POWER CUP
            doc.setTextColor(110, 120, 110);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TU NUEVO COSTE POWER CUP', 153, y, { align: 'center' });
            
            y += 10;
            const nuevoMes = bestResult.total * 30 / dias;
            doc.setTextColor(119, 132, 109);
            doc.setFontSize(18);
            doc.text(eur(nuevoMes) + '/mes', 153, y, { align: 'center' });
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(140, 150, 140);
            doc.text('Estimado Mensual', 153, y, { align: 'center' });
            
            y += 11;
            const nuevoAnio = bestResult.total * 365 / dias;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(15);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(nuevoAnio) + '/aÃ±o', 153, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE
            doc.addPage();
            y = 15;
            
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO DE LA SIMULACIÃ“N (' + tariffName + ')', 105, y + 8, { align: 'center' });
            
            y += 18;
            
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const pFijoDiario = bestResult.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(pFijoDiario, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', 15, y);
            doc.text(eur(bestResult.total_fijo), 195, y, { align: 'right' });
            y += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFontSize(10);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', 12, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(bestResult.p1_price, 6) + ')', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', 15, y);
            doc.text(eur(bestResult.total_energia), 195, y, { align: 'right' });
            y += 10;
            
            // SUBTOTAL BASE
            const subtotalBase = bestResult.total_fijo + bestResult.total_energia;
            doc.setFontSize(10);
            doc.text('SUBTOTAL BASE (P+E)', 12, y);
            doc.text(eur(subtotalBase), 195, y, { align: 'right' });
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', 12, y);
            doc.text(eur(bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', 12, y);
            doc.text(eur(subtotalBase + bestResult.impuesto_hidrocarburo), 195, y, { align: 'right' });
            y += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', 12, y);
            doc.text(eur(bestResult.iva), 195, y, { align: 'right' });
            y += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(12, y - 3, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', 15, y + 5);
            doc.text(eur(bestResult.total), 195, y + 5, { align: 'right' });
            
            y += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', 12, y);
            doc.text(eur(bestResult.total * 365 / dias), 195, y, { align: 'right' });
            
            y += 12;
            doc.setFillColor(211, 47, 47);
            doc.roundedRect(12, y, 186, 20, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', 15, y + 8);
            doc.setFontSize(16);
            doc.text(eur(bestResult.ahorro_anual) + '/ AÃ‘O', 15, y + 16);
            
            doc.save('GAS_PowerCup_' + tariffName + '_' + new Date().toISOString().slice(0,10) + '.pdf');
            window.showMessageModal("âœ… PDF POWER CUP generado", false);
        }
        
        // PDF DUAL POWER CUP
        async function generateGasPDF_Dual_PowerCup(resFijo, resIndexed, dias, kwh, totalCliente) {
            window.showMessageModal("â³ Generando PDF comparativo POWER CUP...");
            const { jsPDF} = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const eur = n => new Intl.NumberFormat('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n || 0) + ' â‚¬';
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', {minimumFractionDigits: d, maximumFractionDigits: d}).format(n || 0);
            
            const pageWidth = 210;
            let y = 0;
            
            // HEADER VERDE OLIVA CON RAYAS (estÃ©tica mejorada - Dual)
            doc.setFillColor(119, 132, 109);
            doc.rect(0, 0, pageWidth, 55, 'F');
            
            // Rayas verticales sutiles y elegantes
            doc.setDrawColor(130, 145, 120);
            doc.setLineWidth(0.5);
            for (let i = 0; i < pageWidth; i += 2.5) {
                doc.line(i, 0, i, 55);
            }
            
            // LOGO TAZA DE CAFÃ‰ PROFESIONAL
            const logoX = 40;
            const logoY = 27.5;
            
            // Cuerpo de la taza (rectangular con bordes redondeados)
            doc.setFillColor(70, 80, 65);
            doc.roundedRect(logoX - 12, logoY - 8, 24, 16, 2, 2, 'F');
            
            // Interior de la taza (cafÃ©) - color mÃ¡s claro
            doc.setFillColor(95, 108, 90);
            doc.roundedRect(logoX - 10, logoY - 6, 20, 10, 1.5, 1.5, 'F');
            
            // Asa de la taza (lÃ­neas elegantes)
            doc.setDrawColor(70, 80, 65);
            doc.setLineWidth(2.2);
            doc.line(logoX + 12, logoY - 3, logoX + 16, logoY - 1);
            doc.line(logoX + 16, logoY - 1, logoX + 16.5, logoY + 2);
            doc.line(logoX + 16.5, logoY + 2, logoX + 12, logoY + 3);
            
            // Vapor (lÃ­neas sutiles amarillas/naranjas)
            doc.setDrawColor(255, 190, 50);
            doc.setLineWidth(1.5);
            
            // Vapor izquierda
            doc.line(logoX - 4, logoY - 10, logoX - 3, logoY - 14);
            
            // Vapor centro
            doc.line(logoX, logoY - 10, logoX, logoY - 15);
            
            // Vapor derecha  
            doc.line(logoX + 4, logoY - 10, logoX + 3, logoY - 14);
            
            // TEXTO "POWER CUP ENERGÃA"
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('POWER CUP', logoX + 30, 20);
            
            doc.setFontSize(22);
            doc.text('ENERGÃA', logoX + 30, 32);
            
            // SubtÃ­tulo descriptivo
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.setTextColor(230, 240, 230);
            doc.text('Liderando el ahorro y la', logoX + 30, 40);
            doc.text('eficiencia energÃ©tica.', logoX + 30, 44.5);
            
            // TEXTO DERECHA DEL HEADER
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ESTUDIO DE AHORRO', pageWidth - 12, 16, { align: 'right' });
            
            doc.setTextColor(215, 230, 215);
            doc.setFontSize(13);
            doc.text('COMPARATIVA', pageWidth - 12, 27, { align: 'right' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.text('PROFESIONAL', pageWidth - 12, 37, { align: 'right' });
            
            // Banner verde "ESTUDIO DE AHORRO"
            y = 63;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(20, y, 170, 12, 4, 4, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ESTUDIO DE AHORRO', 105, y + 8, { align: 'center' });
            
            // Recuadro con borde verde oliva para info del cliente
            y += 18;
            doc.setDrawColor(119, 132, 109);
            doc.setLineWidth(2);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'D');
            
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, y, 170, 25, 3, 3, 'F');
            
            y += 8;
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.text('COMPARATIVA PROFESIONAL - POWER CUP', 25, y);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(100, 110, 100);
            doc.text('CLIENTE: [NOMBRE COMPLETO CLIENTE]', 25, y);
            
            y += 5;
            doc.text('CUPS: ES0021000020679723GY', 25, y);
            
            // Texto "COMERCIAL: <cz" en la esquina derecha
            doc.setTextColor(130, 140, 130);
            doc.setFontSize(8);
            doc.text('COMERCIAL: <cz', 185, y, { align: 'right' });
            
            y += 15;
            
            // Caja verde oliva "LA MEJOR OPCIÃ“N" (mÃ¡s grande)
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(20, y, 170, 50, 5, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('LA MEJOR OPCIÃ“N PARA TI ES', pageWidth / 2, y + 13, { align: 'center' });
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(32);
            // Extraer el nombre de la tarifa (ej: "ELEIA" de "ELEIA - Tarifa XYZ")
            const bestTariff = resFijo.ahorro_anual > resIndexed.ahorro_anual ? resFijo : resIndexed;
            const tariffName = bestTariff.name.split('-')[0].trim();
            doc.text(tariffName, pageWidth / 2, y + 30, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('POWER CUP', pageWidth / 2, y + 42, { align: 'center' });
            
            y += 63;
            
            const factMes = totalCliente * 30 / dias;
            const factAnio = totalCliente * 365 / dias;
            const fijoMes = resFijo.total * 30 / dias;
            const fijoAnio = resFijo.total * 365 / dias;
            const indexMes = resIndexed.total * 30 / dias;
            const indexAnio = resIndexed.total * 365 / dias;
            
            const col1X = 12;
            const col2X = 75;
            const col3X = 145;
            
            // Separadores verticales
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(70, y - 5, 70, y + 85);
            doc.line(140, y - 5, 140, y + 85);
            
            // COLUMNA 1: ACTUAL
            doc.setTextColor(70, 80, 70);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TU FACTURA ACTUAL', col1X, y);
            
            y += 9;
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(16);
            const txtMes = eur(factMes);
            doc.text(txtMes, col1X, y);
            const wMes = doc.getTextWidth(txtMes);
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(1.5);
            doc.line(col1X, y - 4, col1X + wMes, y - 4);
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text('Total Periodo (' + dias + ' dÃ­as)', col1X, y);
            
            y += 9;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(220, 38, 38);
            const txtAnio = eur(factAnio) + '/aÃ±o';
            doc.text(txtAnio, col1X, y);
            const wAnio = doc.getTextWidth(txtAnio);
            doc.line(col1X, y - 3, col1X + wAnio, y - 3);
            
            y -= 23;
            
            // COLUMNA 2: FIJO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col2X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL FIJO', col2X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resFijo.ahorro_anual), col2X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('TU NUEVO COSTE POWER CUP', col2X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(119, 132, 109);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(fijoMes) + '/mes', col2X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text('Estimado Mensual', col2X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(119, 132, 109);
            doc.text(eur(fijoAnio) + '/aÃ±o', col2X + 30, y, { align: 'center' });
            
            y -= 39;
            
            // COLUMNA 3: INDEXADO
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(col3X, y - 3, 60, 8, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL INDEXADO', col3X + 30, y + 2, { align: 'center' });
            
            y += 11;
            doc.setTextColor(76, 175, 80);
            doc.setFontSize(20);
            doc.text(eur(resIndexed.ahorro_anual), col3X + 30, y, { align: 'center' });
            
            y += 9;
            doc.setTextColor(100, 110, 100);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text('TU NUEVO COSTE POWER CUP', col3X + 30, y, { align: 'center' });
            
            y += 7;
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(eur(indexMes) + '/mes', col3X + 30, y, { align: 'center' });
            
            y += 4;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6);
            doc.setTextColor(120, 130, 120);
            doc.text('Estimado Mensual', col3X + 30, y, { align: 'center' });
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(76, 175, 80);
            doc.text(eur(indexAnio) + '/aÃ±o', col3X + 30, y, { align: 'center' });
            
            // PÃGINA 2: DESGLOSE DETALLADO
            doc.addPage();
            y = 15;
            
            // TÃ­tulo verde
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(12, y, 186, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('DESGLOSE DETALLADO POR SUMINISTRO', 105, y + 8, { align: 'center' });
            
            y += 18;
            const colW = 90;
            const leftX = 12;
            const rightX = 110;
            
            // COLUMNA IZQUIERDA: FIJA
            let leftY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', leftX + 3, leftY + 5);
            doc.text('Tipo: ' + currentGasTariff, leftX + colW - 3, leftY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, leftX + colW - 3, leftY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP - ' + resFijo.name, leftX + 3, leftY + 13);
            
            leftY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pFijoDiario = resFijo.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(pFijoDiario, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', leftX + 3, leftY);
            doc.text(eur(resFijo.total_fijo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', leftX, leftY);
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resFijo.p1_price, 6) + ')', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', leftX + 3, leftY);
            doc.text(eur(resFijo.total_energia), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBase = resFijo.total_fijo + resFijo.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', leftX, leftY);
            doc.text(eur(subtotalBase), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', leftX, leftY);
            doc.text(eur(resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', leftX, leftY);
            doc.text(eur(subtotalBase + resFijo.impuesto_hidrocarburo), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', leftX, leftY);
            doc.text(eur(resFijo.iva), leftX + colW - 2, leftY, { align: 'right' });
            leftY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(leftX, leftY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', leftX + 3, leftY + 5);
            doc.text(eur(resFijo.total), leftX + colW - 3, leftY + 5, { align: 'right' });
            
            leftY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', leftX, leftY);
            doc.text(eur(resFijo.total * 365 / dias), leftX + colW - 2, leftY, { align: 'right' });
            
            leftY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(leftX, leftY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', leftX + 3, leftY + 8);
            doc.setFontSize(13);
            doc.text(eur(resFijo.ahorro_anual) + '/ AÃ‘O', leftX + 3, leftY + 15);
            
            // COLUMNA DERECHA: INDEXADA
            let rightY = y;
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('[ES0021000020679723GY]', rightX + 3, rightY + 5);
            doc.text('Tipo: ' + currentGasTariff, rightX + colW - 3, rightY + 5, { align: 'right' });
            doc.text('DÃ­as: ' + dias, rightX + colW - 3, rightY + 10, { align: 'right' });
            doc.setFontSize(8);
            doc.text('POWER CUP INDEX - ' + resIndexed.name, rightX + 3, rightY + 13);
            
            rightY += 22;
            // TÃ‰RMINO FIJO
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO FIJO (Precio en â‚¬/dÃ­a)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            const pIndexDiario = resIndexed.p_fijo_diario / 365;
            doc.text('Precio fijo (' + dias + ' dÃ­as x ' + num(pIndexDiario, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('SUBTOTAL POTENCIA', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_fijo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TÃ‰RMINO ENERGÃA
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('TÃ‰RMINO ENERGÃA (Precios en â‚¬/kWh)', rightX, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('EnergÃ­a (' + kwh + ' kWh x ' + num(resIndexed.p1_price, 6) + ')', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal EnergÃ­a (Bruto)', rightX + 3, rightY);
            doc.text(eur(resIndexed.total_energia), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // SUBTOTAL BASE
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            const subtotalBaseIndex = resIndexed.total_fijo + resIndexed.total_energia;
            doc.text('SUBTOTAL BASE (P+E)', rightX, rightY);
            doc.text(eur(subtotalBaseIndex), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7.5);
            doc.text('Imp. Hidrocarburos (â‚¬0,00234 x ' + kwh + ' kWh)', rightX, rightY);
            doc.text(eur(resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text('BASE IMPONIBLE', rightX, rightY);
            doc.text(eur(subtotalBaseIndex + resIndexed.impuesto_hidrocarburo), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 5;
            
            doc.setFont('helvetica', 'normal');
            doc.text('IVA (21%)', rightX, rightY);
            doc.text(eur(resIndexed.iva), rightX + colW - 2, rightY, { align: 'right' });
            rightY += 10;
            
            // TOTAL
            doc.setFillColor(119, 132, 109);
            doc.roundedRect(rightX, rightY - 3, colW, 12, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('TOTAL FACTURA (' + dias + ' DÃAS)', rightX + 3, rightY + 5);
            doc.text(eur(resIndexed.total), rightX + colW - 3, rightY + 5, { align: 'right' });
            
            rightY += 14;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(8);
            doc.text('TOTAL AÃ‘O (PROYECTADO)', rightX, rightY);
            doc.text(eur(resIndexed.total * 365 / dias), rightX + colW - 2, rightY, { align: 'right' });
            
            rightY += 12;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(rightX, rightY, colW, 18, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.text('TU AHORRO ANUAL ESTIMADO ES:', rightX + 3, rightY + 8);
            doc.setFontSize(13);
            doc.text(eur(resIndexed.ahorro_anual) + '/ AÃ‘O', rightX + 3, rightY + 15);
            
            // PÃGINA 3: CUAL ES LA DIFERENCIA
            doc.addPage();
            y = 40;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('CUAL ES LA DIFERENCIA?', 105, y, { align: 'center' });
            
            y += 15;
            
            // Columna izquierda: FIJA
            doc.setTextColor(59, 130, 246);
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA FIJA?', leftX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const fijaTexts = [
                'â€¢ Implica un precio fijo por los kilovatios que',
                '  consumes (kWh).',
                '',
                'â€¢ El precio se mantiene estable,',
                '  independientemente de cÃ³mo se comporten los',
                '  precios en el mercado elÃ©ctrico.',
                '',
                'â€¢ Cuando el precio del mercado estÃ¡ alto, el',
                '  cliente estÃ¡ protegido frente a sobresaltos.',
                '',
                'â€¢ No tendrÃ¡s que estar pendiente de las',
                '  variaciones del mercado y podrÃ¡s seguir',
                '  usando la electricidad como siempre.'
            ];
            
            fijaTexts.forEach(line => {
                doc.text(line, leftX, y);
                y += 4;
            });
            
            y = 55;
            
            // Columna derecha: INDEXADA
            doc.setTextColor(76, 175, 80);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('POR QUE TARIFA INDEXADA?', rightX, y);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const indexTexts = [
                'â€¢ Implica un precio variable por los kilovatios',
                '  que consumes (kWh) cada mes.',
                '',
                'â€¢ Es la tarifa mÃ¡s justa, ya que pagas el coste',
                '  real de la energÃ­a mes a mes.',
                '',
                'â€¢ Al contratarla, el cliente evita pagar',
                '  mÃ¡rgenes adicionales cuando el precio de la',
                '  electricidad es mÃ¡s barato.',
                '',
                'â€¢ A largo plazo, con un indexado 100%',
                '  funcional, se puede obtener un ahorro',
                '  aproximado de hasta un 20% en Ã©pocas de',
                '  mejor precio.'
            ];
            
            indexTexts.forEach(line => {
                doc.text(line, rightX, y);
                y += 4;
            });
            
            doc.save('GAS_PowerCup_Dual_' + currentGasTariff + '.pdf');
            window.showMessageModal("âœ… PDF comparativo POWER CUP generado", false);
        }
    </script>
</body>
